# –ü–õ–ê–ù –†–ï–§–ê–ö–¢–û–†–ò–ù–ì–ê –ú–û–î–£–õ–Ø AGED POSITION MANAGER

**–î–∞—Ç–∞:** 2025-10-17
**–¶–µ–ª—å:** –ü–µ—Ä–µ—Ä–∞–±–æ—Ç–∞—Ç—å –ª–æ–≥–∏–∫—É –º–æ–¥—É–ª—è —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º –Ω–∞ PnL –ø–æ–∑–∏—Ü–∏–π
**–°—Ç–∞—Ç—É—Å:** –ü–õ–ê–ù–ò–†–û–í–ê–ù–ò–ï (–ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–Ø –ö–û–î–ê)

---

## 1. –†–ï–ó–£–õ–¨–¢–ê–¢–´ –î–ï–¢–ê–õ–¨–ù–û–ì–û –†–ê–°–°–õ–ï–î–û–í–ê–ù–ò–Ø

### 1.1 –¢–µ–∫—É—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –º–æ–¥—É–ª—è

**–§–∞–π–ª—ã:**
- `core/aged_position_manager.py` (510 —Å—Ç—Ä–æ–∫) - –æ—Å–Ω–æ–≤–Ω–æ–π –º–æ–¥—É–ª—å
- `core/exchange_manager_enhanced.py` - —Å–æ–∑–¥–∞–Ω–∏–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ä–¥–µ—Ä–æ–≤

**–¢–µ–∫—É—â–∏–µ —Ñ–∞–∑—ã –ª–∏–∫–≤–∏–¥–∞—Ü–∏–∏:**
```
–§–∞–∑–∞ 1: GRACE_PERIOD (0-8—á –ø–æ—Å–ª–µ MAX_AGE=3—á)
‚îú‚îÄ –õ–æ–≥–∏–∫–∞: –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –≤ –±–µ–∑—É–±—ã—Ç–æ–∫ (entry ¬± –¥–≤–æ–π–Ω–∞—è –∫–æ–º–∏—Å—Å–∏—è)
‚îî‚îÄ –¢–∏–ø –æ—Ä–¥–µ—Ä–∞: LIMIT –ø–æ —Ü–µ–ª–µ–≤–æ–π —Ü–µ–Ω–µ

–§–∞–∑–∞ 2: PROGRESSIVE (8-28—á –ø–æ—Å–ª–µ MAX_AGE)
‚îú‚îÄ –õ–æ–≥–∏–∫–∞: –£–≤–µ–ª–∏—á–µ–Ω–∏–µ —Ç–µ—Ä–ø–∏–º–æ—Å—Ç–∏ –∫ —É–±—ã—Ç–∫—É (0.5% –∑–∞ —á–∞—Å, –∞–∫—Å–µ–ª–µ—Ä–∞—Ü–∏—è –ø–æ—Å–ª–µ 10—á)
‚îî‚îÄ –¢–∏–ø –æ—Ä–¥–µ—Ä–∞: LIMIT –ø–æ —Ü–µ–ª–µ–≤–æ–π —Ü–µ–Ω–µ

–§–∞–∑–∞ 3: EMERGENCY (28—á+ –ø–æ—Å–ª–µ MAX_AGE)
‚îú‚îÄ –õ–æ–≥–∏–∫–∞: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—É—â–µ–π —Ä—ã–Ω–æ—á–Ω–æ–π —Ü–µ–Ω—ã
‚îî‚îÄ –¢–∏–ø –æ—Ä–¥–µ—Ä–∞: LIMIT –ø–æ —Ä—ã–Ω–æ—á–Ω–æ–π —Ü–µ–Ω–µ (!)
```

### 1.2 –í—ã—è–≤–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ä–µ–∞–ª—å–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞

**–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–∑ 10-–º–∏–Ω—É—Ç–Ω–æ–≥–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞:**
- –í—Å–µ–≥–æ —Å—Ç–∞—Ä—ã—Ö –ø–æ–∑–∏—Ü–∏–π: 82
- **–ü—Ä–∏–±—ã–ª—å–Ω—ã—Ö: 58 (70.7%)**
- –£–±—ã—Ç–æ—á–Ω—ã—Ö: 24 (29.3%)
- –ó–∞–∫—Ä—ã—Ç–æ –∑–∞ —Ç–µ—Å—Ç: 0 (0%)

**–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–∏–±—ã–ª—å–Ω—ã—Ö –ø–æ —Ñ–∞–∑–∞–º:**
- GRACE_PERIOD: 17 –ø–æ–∑–∏—Ü–∏–π (29.3%)
- PROGRESSIVE: 14 –ø–æ–∑–∏—Ü–∏–π (24.1%)
- EMERGENCY: 27 –ø–æ–∑–∏—Ü–∏–π (46.6%)

**–¢–æ–ø –ø—Ä–∏–±—ã–ª—å–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏:**
1. AXLUSDT (short): +15.04%, 25.9—á, PROGRESSIVE
2. MANAUSDT (short): +13.49%, 31.2—á, EMERGENCY
3. COTIUSDT (short): +13.32%, 32.5—á, EMERGENCY
4. PROMPTUSDT (short): +12.98%, 31.7—á, EMERGENCY
5. KAVAUSDT (short): +12.65%, 30.7—á, PROGRESSIVE

**–¢–æ–ø —É–±—ã—Ç–æ—á–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏:**
1. 10000WENUSDT (long): -10.73%, 39.3—á, EMERGENCY
2. CLOUDUSDT (short): -9.67%, 39.5—á, EMERGENCY
3. HNTUSDT (long): -8.84%, 39.5—á, EMERGENCY

### 1.3 –ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–æ–±–ª–µ–º–∞

**–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –ë–ê–ì: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ç–∏–ø –æ—Ä–¥–µ—Ä–∞**

–ú–æ–¥—É–ª—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –¢–û–õ–¨–ö–û LIMIT –æ—Ä–¥–µ—Ä–∞ –¥–ª—è –≤—Å–µ—Ö —Ñ–∞–∑. –≠—Ç–æ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –æ—Ç–∫–∞–∑–∞–º –±–∏—Ä–∂–∏:

```python
# –¢–µ–∫—É—â–∏–π –∫–æ–¥ (—Å—Ç—Ä–æ–∫–∞ 355-361)
order = await enhanced_manager.create_or_update_exit_order(
    symbol=position.symbol,
    side=order_side,  # 'buy' –¥–ª—è SHORT, 'sell' –¥–ª—è LONG
    amount=abs(float(position.quantity)),
    price=precise_price,  # ‚Üê –í—Å–µ–≥–¥–∞ LIMIT!
    min_price_diff_pct=0.5
)
```

**–ü–æ—á–µ–º—É —ç—Ç–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:**

| –°—Ü–µ–Ω–∞—Ä–∏–π | –°—Ç–æ—Ä–æ–Ω–∞ –ø–æ–∑–∏—Ü–∏–∏ | –î–µ–π—Å—Ç–≤–∏–µ –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è | –¶–µ–ª–µ–≤–∞—è —Ü–µ–Ω–∞ | –†—ã–Ω–æ–∫ | –ü—Ä–æ–±–ª–µ–º–∞ |
|----------|----------------|----------------------|--------------|-------|----------|
| SHORT –≤ –ø—Ä–∏–±—ã–ª–∏ | SHORT | BUY | –í—ã—à–µ —Ä—ã–Ω–∫–∞ | –ù–∏–∂–µ –≤—Ö–æ–¥–∞ | BUY LIMIT –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å < —Ä—ã–Ω–∫–∞ ‚ùå |
| LONG –≤ —É–±—ã—Ç–∫–µ | LONG | SELL | –ù–∏–∂–µ —Ä—ã–Ω–∫–∞ | –ù–∏–∂–µ –≤—Ö–æ–¥–∞ | SELL LIMIT –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å > —Ä—ã–Ω–∫–∞ ‚ùå |
| SHORT –≤ —É–±—ã—Ç–∫–µ | SHORT | BUY | –í—ã—à–µ –≤—Ö–æ–¥–∞ | –í—ã—à–µ –≤—Ö–æ–¥–∞ | –ú–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å ‚úì |
| LONG –≤ –ø—Ä–∏–±—ã–ª–∏ | LONG | SELL | –í—ã—à–µ —Ä—ã–Ω–∫–∞ | –í—ã—à–µ –≤—Ö–æ–¥–∞ | –†–∞–±–æ—Ç–∞–µ—Ç ‚úì |

**–í—ã–≤–æ–¥:** LIMIT –æ—Ä–¥–µ—Ä–∞ —Ä–∞–±–æ—Ç–∞—é—Ç —Ç–æ–ª—å–∫–æ –¥–ª—è ~50% —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤.

### 1.4 –ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—É—â–µ–π –ª–æ–≥–∏–∫–∏ —Ä–∞—Å—á—ë—Ç–∞ —Ü–µ–ª–µ–≤–æ–π —Ü–µ–Ω—ã

**–ú–µ—Ç–æ–¥ `_calculate_target_price()` (—Å—Ç—Ä–æ–∫–∏ 258-317):**

```python
# GRACE PERIOD
if position.side in ['long', 'buy']:
    target_price = entry_price * (1 + double_commission)  # –ü—Ä–æ–¥–∞—Ç—å –≤—ã—à–µ
else:  # short
    target_price = entry_price * (1 - double_commission)  # –ö—É–ø–∏—Ç—å –Ω–∏–∂–µ

# PROGRESSIVE
if position.side in ['long', 'buy']:
    target_price = entry_price * (1 - loss_percent / 100)  # –ü—Ä–æ–¥–∞—Ç—å –Ω–∏–∂–µ (—É–±—ã—Ç–æ–∫)
else:  # short
    target_price = entry_price * (1 + loss_percent / 100)  # –ö—É–ø–∏—Ç—å –≤—ã—à–µ (—É–±—ã—Ç–æ–∫)

# EMERGENCY
target_price = current_price_decimal  # –†—ã–Ω–æ—á–Ω–∞—è —Ü–µ–Ω–∞
```

**–û—Ü–µ–Ω–∫–∞ –ª–æ–≥–∏–∫–∏ —Ä–∞—Å—á—ë—Ç–∞:** ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–ê–Ø

–†–∞—Å—á—ë—Ç —Ü–µ–ª–µ–≤—ã—Ö —Ü–µ–Ω –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω. –ü—Ä–æ–±–ª–µ–º–∞ —Ç–æ–ª—å–∫–æ –≤ –≤—ã–±–æ—Ä–µ —Ç–∏–ø–∞ –æ—Ä–¥–µ—Ä–∞.

### 1.5 –ê–Ω–∞–ª–∏–∑ EnhancedExchangeManager

**–ú–µ—Ç–æ–¥ `create_or_update_exit_order()` (—Å—Ç—Ä–æ–∫–∏ 182-254):**
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –æ—Ä–¥–µ—Ä–∞
- –û–±–Ω–æ–≤–ª—è–µ—Ç –µ—Å–ª–∏ —Ä–∞–∑–Ω–∏—Ü–∞ —Ü–µ–Ω—ã > 0.5%
- –í—ã–∑—ã–≤–∞–µ—Ç `create_limit_exit_order()`

**–ú–µ—Ç–æ–¥ `create_limit_exit_order()` (—Å—Ç—Ä–æ–∫–∏ 118-180):**
- –í—Å–µ–≥–¥–∞ —Å–æ–∑–¥–∞—ë—Ç LIMIT –æ—Ä–¥–µ—Ä–∞
- –ù–µ—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ü–µ–Ω—ã –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Ä—ã–Ω–∫–∞
- –ù–µ—Ç –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞ –æ—Ä–¥–µ—Ä–∞

**–û—Ü–µ–Ω–∫–∞:** ‚ö†Ô∏è –ß–ê–°–¢–ò–ß–ù–û –ü–†–ê–í–ò–õ–¨–ù–ê–Ø
- –õ–æ–≥–∏–∫–∞ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏: ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ä–¥–µ—Ä–∞–º–∏: ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç
- –í—ã–±–æ—Ä —Ç–∏–ø–∞ –æ—Ä–¥–µ—Ä–∞: ‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç

---

## 2. –ù–û–í–ê–Ø –°–¢–†–ê–¢–ï–ì–ò–Ø –° –ü–†–ò–û–†–ò–¢–ï–¢–û–ú –ù–ê PnL

### 2.1 –û—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–∏–Ω—Ü–∏–ø

**–ü–†–ò–û–†–ò–¢–ï–¢ #1: –ü–†–ò–ë–´–õ–¨ –í–ê–ñ–ù–ï–ï –í–û–ó–†–ê–°–¢–ê**

```
–ü–†–ê–í–ò–õ–û: –ï—Å–ª–∏ –ø–æ–∑–∏—Ü–∏—è –≤ –ø—Ä–∏–±—ã–ª–∏ (PnL > 0%), –∑–∞–∫—Ä—ã–≤–∞—Ç—å –ù–ï–ú–ï–î–õ–ï–ù–ù–û –ø–æ MARKET
–Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –≤–æ–∑—Ä–∞—Å—Ç–∞ –∏ —Ñ–∞–∑—ã.
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**
- –ò–∑ —Ç–µ—Å—Ç–∞: 70.7% —Å—Ç–∞—Ä—ã—Ö –ø–æ–∑–∏—Ü–∏–π –≤ –ø—Ä–∏–±—ã–ª–∏
- –ú–Ω–æ–≥–∏–µ –ø—Ä–∏–±—ã–ª—å–Ω—ã–µ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ EMERGENCY (27 –ø–æ–∑–∏—Ü–∏–π, –¥–æ 32—á –≤–æ–∑—Ä–∞—Å—Ç–∞)
- –¢–µ–∫—É—â–∞—è –ª–æ–≥–∏–∫–∞ –ø—ã—Ç–∞–µ—Ç—Å—è –∂–¥–∞—Ç—å "–ª—É—á—à–µ–π —Ü–µ–Ω—ã", –Ω–æ —Ç–µ—Ä–ø–∏—Ç –Ω–µ—É–¥–∞—á—É
- MARKET –æ—Ä–¥–µ—Ä –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç —Ñ–∏–∫—Å–∞—Ü–∏—é –ø—Ä–∏–±—ã–ª–∏

### 2.2 –ù–æ–≤–∞—è –∏–µ—Ä–∞—Ä—Ö–∏—è —Ä–µ—à–µ–Ω–∏–π

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –®–ê–ì–ò –ü–†–ò–ù–Ø–¢–ò–Ø –†–ï–®–ï–ù–ò–Ø –û –ó–ê–ö–†–´–¢–ò–ò                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

–®–ê–ì 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ PnL
‚îú‚îÄ PnL > 0% ‚Üí MARKET ORDER (–Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ)
‚îî‚îÄ PnL ‚â§ 0% ‚Üí –ü–µ—Ä–µ—Ö–æ–¥ –∫ –®–ê–ì 2

–®–ê–ì 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ–∑—Ä–∞—Å—Ç–∞ –∏ —Ñ–∞–∑—ã
‚îú‚îÄ GRACE_PERIOD (0-8—á) ‚Üí –ü–æ–ø—ã—Ç–∫–∞ –±–µ–∑—É–±—ã—Ç–∫–∞ (LIMIT –∏–ª–∏ MARKET)
‚îú‚îÄ PROGRESSIVE (8-28—á) ‚Üí –ü—Ä–æ–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è –ª–∏–∫–≤–∏–¥–∞—Ü–∏—è (LIMIT –∏–ª–∏ MARKET)
‚îî‚îÄ EMERGENCY (28—á+) ‚Üí MARKET ORDER (–ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ)

–®–ê–ì 3: –í—ã–±–æ—Ä —Ç–∏–ø–∞ –æ—Ä–¥–µ—Ä–∞ (–¥–ª—è PnL ‚â§ 0%)
‚îú‚îÄ –ü—Ä–æ–≤–µ—Ä–∫–∞: –º–æ–∂–µ—Ç –ª–∏ LIMIT –±—ã—Ç—å —Ä–∞–∑–º–µ—â—ë–Ω?
‚îÇ   ‚îú‚îÄ –î–ª—è BUY: target < market * 0.999 ‚Üí LIMIT OK
‚îÇ   ‚îú‚îÄ –î–ª—è SELL: target > market * 1.001 ‚Üí LIMIT OK
‚îÇ   ‚îî‚îÄ –ò–Ω–∞—á–µ ‚Üí MARKET ORDER
‚îî‚îÄ –†–∞–∑–º–µ—â–µ–Ω–∏–µ –æ—Ä–¥–µ—Ä–∞
```

### 2.3 –î–µ—Ç–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è –∫–∞–∂–¥–æ–π —Ñ–∞–∑—ã

#### –§–ê–ó–ê 0: –ü–†–û–í–ï–†–ö–ê –ü–†–ò–ë–´–õ–¨–ù–û–°–¢–ò (–ù–û–í–ê–Ø!)

```python
# –ü—Å–µ–≤–¥–æ–∫–æ–¥
if position.pnl_percentage > 0:
    logger.info(f"üéØ {symbol} –≤ –ø—Ä–∏–±—ã–ª–∏ {pnl}% - –∑–∞–∫—Ä—ã–≤–∞–µ–º –ø–æ MARKET")
    return 'IMMEDIATE_PROFIT_CLOSE', current_price, 'MARKET'
```

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- PnL –ø–æ—Ä–æ–≥: > 0% (–ª—é–±–∞—è –ø—Ä–∏–±—ã–ª—å)
- –¢–∏–ø –æ—Ä–¥–µ—Ä–∞: MARKET
- –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –í–´–°–®–ò–ô

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- 58 –∏–∑ 82 –ø–æ–∑–∏—Ü–∏–π (70.7%) –±—É–¥—É—Ç –∑–∞–∫—Ä—ã—Ç—ã –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ
- –§–∏–∫—Å–∞—Ü–∏—è –ø—Ä–∏–±—ã–ª–∏ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∞

#### –§–ê–ó–ê 1: GRACE PERIOD (–¥–ª—è PnL ‚â§ 0%)

```python
# –ü—Å–µ–≤–¥–æ–∫–æ–¥
if hours_over_limit <= grace_period_hours:
    # –†–∞—Å—á—ë—Ç —Ü–µ–ª–µ–≤–æ–π —Ü–µ–Ω—ã –±–µ–∑—É–±—ã—Ç–∫–∞
    target_price = calculate_breakeven_price(entry, commission)

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ LIMIT
    if can_place_limit_order(side, target_price, current_price):
        return 'GRACE_PERIOD_BREAKEVEN', target_price, 'LIMIT'
    else:
        # LIMIT –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω - –∏—Å–ø–æ–ª—å–∑—É–µ–º MARKET
        logger.warning(f"LIMIT –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω –¥–ª—è {symbol}, –∏—Å–ø–æ–ª—å–∑—É–µ–º MARKET")
        return 'GRACE_PERIOD_MARKET', current_price, 'MARKET'
```

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: 0-8—á –ø–æ—Å–ª–µ MAX_AGE
- –¶–µ–ª—å: –ó–∞–∫—Ä—ã—Ç–∏–µ –≤ –±–µ–∑—É–±—ã—Ç–æ–∫ (entry ¬± –¥–≤–æ–π–Ω–∞—è –∫–æ–º–∏—Å—Å–∏—è)
- –¢–∏–ø –æ—Ä–¥–µ—Ä–∞: LIMIT (–µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ), –∏–Ω–∞—á–µ MARKET
- PnL: ‚â§ 0%

**–õ–æ–≥–∏–∫–∞ –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞:**
- –ï—Å–ª–∏ —Ü–µ–ª–µ–≤–∞—è —Ü–µ–Ω–∞ –≤–∞–ª–∏–¥–Ω–∞ –¥–ª—è LIMIT ‚Üí LIMIT
- –ï—Å–ª–∏ —Ü–µ–ª–µ–≤–∞—è —Ü–µ–Ω–∞ –Ω–∞—Ä—É—à–∞–µ—Ç –ø—Ä–∞–≤–∏–ª–∞ –±–∏—Ä–∂–∏ ‚Üí MARKET

#### –§–ê–ó–ê 2: PROGRESSIVE (–¥–ª—è PnL ‚â§ 0%)

```python
# –ü—Å–µ–≤–¥–æ–∫–æ–¥
elif hours_over_limit <= grace_period_hours + 20:
    hours_after_grace = hours_over_limit - grace_period_hours

    # –ü—Ä–æ–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π —Ä–∞—Å—á—ë—Ç —É–±—ã—Ç–∫–∞
    loss_percent = calculate_progressive_loss(hours_after_grace)
    target_price = calculate_target_with_loss(entry, side, loss_percent)

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ LIMIT
    if can_place_limit_order(side, target_price, current_price):
        return 'PROGRESSIVE_LIQUIDATION', target_price, 'LIMIT'
    else:
        # LIMIT –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω - –∏—Å–ø–æ–ª—å–∑—É–µ–º MARKET
        logger.warning(f"Progressive: LIMIT –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º MARKET")
        return 'PROGRESSIVE_MARKET', current_price, 'MARKET'
```

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: 8-28—á –ø–æ—Å–ª–µ MAX_AGE
- –ù–∞—á–∞–ª—å–Ω—ã–π —É–±—ã—Ç–æ–∫: 0.5% –∑–∞ —á–∞—Å
- –ê–∫—Å–µ–ª–µ—Ä–∞—Ü–∏—è: √ó1.2 –ø–æ—Å–ª–µ 10—á –≤ –ø—Ä–æ–≥—Ä–µ—Å—Å–∏–∏
- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —É–±—ã—Ç–æ–∫: 10%
- –¢–∏–ø –æ—Ä–¥–µ—Ä–∞: LIMIT (–µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ), –∏–Ω–∞—á–µ MARKET
- PnL: ‚â§ 0%

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –ï—Å–ª–∏ —Ç–µ–∫—É—â–∏–π —É–±—ã—Ç–æ–∫ —É–∂–µ –±–æ–ª—å—à–µ –¥–æ–ø—É—Å—Ç–∏–º–æ–≥–æ ‚Üí MARKET –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ
- –ï—Å–ª–∏ —Ä—ã–Ω–æ–∫ –¥–≤–∏–∂–µ—Ç—Å—è –ø—Ä–æ—Ç–∏–≤ ‚Üí MARKET –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ

#### –§–ê–ó–ê 3: EMERGENCY (–¥–ª—è –≤—Å–µ—Ö PnL)

```python
# –ü—Å–µ–≤–¥–æ–∫–æ–¥
else:  # hours_over_limit > 28
    # EMERGENCY: –≤—Å–µ–≥–¥–∞ MARKET
    logger.critical(f"üö® EMERGENCY {symbol} (–≤–æ–∑—Ä–∞—Å—Ç {age}—á) - MARKET –∑–∞–∫—Ä—ã—Ç–∏–µ")
    return 'EMERGENCY_MARKET_CLOSE', current_price, 'MARKET'
```

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: 28—á+ –ø–æ—Å–ª–µ MAX_AGE
- –¢–∏–ø –æ—Ä–¥–µ—Ä–∞: MARKET (–ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ)
- PnL: –ª—é–±–æ–π
- –¶–µ–ª—å: –ó–∞–∫—Ä—ã—Ç—å –ø–æ–∑–∏—Ü–∏—é –ª—é–±–æ–π —Ü–µ–Ω–æ–π

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**
- 28—á+ –≤–æ–∑—Ä–∞—Å—Ç = –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è —Å–∏—Ç—É–∞—Ü–∏—è
- –ù–µ–ª—å–∑—è –∂–¥–∞—Ç—å "—Ö–æ—Ä–æ—à–µ–π —Ü–µ–Ω—ã"
- –†–∏—Å–∫ –¥–∞–ª—å–Ω–µ–π—à–∏—Ö —É–±—ã—Ç–∫–æ–≤ > —Ä–∏—Å–∫ –ø—Ä–æ—Å–∫–∞–ª—å–∑—ã–≤–∞–Ω–∏—è

### 2.4 –¢–∞–±–ª–∏—Ü–∞ –ø—Ä–∏–Ω—è—Ç–∏—è —Ä–µ—à–µ–Ω–∏–π

| –£—Å–ª–æ–≤–∏–µ | PnL | –í–æ–∑—Ä–∞—Å—Ç | –§–∞–∑–∞ | –î–µ–π—Å—Ç–≤–∏–µ | –¢–∏–ø –æ—Ä–¥–µ—Ä–∞ |
|---------|-----|---------|------|----------|------------|
| –õ—é–±–æ–π –≤–æ–∑—Ä–∞—Å—Ç | > 0% | –õ—é–±–æ–π | PROFIT | –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ | MARKET |
| 3-11—á | ‚â§ 0% | 0-8—á | GRACE | –ë–µ–∑—É–±—ã—Ç–æ–∫ (–µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ LIMIT) | LIMIT/MARKET |
| 11-31—á | ‚â§ 0% | 8-28—á | PROGRESSIVE | –ü—Ä–æ–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π —É–±—ã—Ç–æ–∫ | LIMIT/MARKET |
| 31—á+ | –õ—é–±–æ–π | 28—á+ | EMERGENCY | –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ | MARKET |

---

## 3. –ê–†–•–ò–¢–ï–ö–¢–£–†–ê –°–ò–°–¢–ï–ú–´ –í–´–ë–û–†–ê –¢–ò–ü–ê –û–†–î–ï–†–ê

### 3.1 –ù–æ–≤—ã–π –º–µ—Ç–æ–¥ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ü–µ–Ω—ã

```python
def _validate_limit_price(
    self,
    side: str,
    target_price: float,
    current_price: float,
    buffer_pct: float = 0.1
) -> bool:
    """
    –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –º–æ–∂–µ—Ç –ª–∏ LIMIT –æ—Ä–¥–µ—Ä –±—ã—Ç—å —Ä–∞–∑–º–µ—â—ë–Ω –ø–æ —Ü–µ–ª–µ–≤–æ–π —Ü–µ–Ω–µ

    Args:
        side: 'buy' –∏–ª–∏ 'sell'
        target_price: –ñ–µ–ª–∞–µ–º–∞—è —Ü–µ–Ω–∞ –æ—Ä–¥–µ—Ä–∞
        current_price: –¢–µ–∫—É—â–∞—è —Ä—ã–Ω–æ—á–Ω–∞—è —Ü–µ–Ω–∞
        buffer_pct: –ë—É—Ñ–µ—Ä –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 0.1%)

    Returns:
        True –µ—Å–ª–∏ LIMIT –æ—Ä–¥–µ—Ä –≤–∞–ª–∏–¥–µ–Ω, False –∏–Ω–∞—á–µ
    """
    if side == 'buy':
        # BUY LIMIT –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ù–ò–ñ–ï —Ä—ã–Ω–∫–∞
        max_allowed = current_price * (1 - buffer_pct / 100)
        return target_price <= max_allowed
    else:  # sell
        # SELL LIMIT –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –í–´–®–ï —Ä—ã–Ω–∫–∞
        min_allowed = current_price * (1 + buffer_pct / 100)
        return target_price >= min_allowed
```

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `buffer_pct`: 0.1% –±—É—Ñ–µ—Ä –¥–ª—è —É—á—ë—Ç–∞ –¥–≤–∏–∂–µ–Ω–∏—è —Ä—ã–Ω–∫–∞
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: bool (True = LIMIT –≤–æ–∑–º–æ–∂–µ–Ω)

### 3.2 –ù–æ–≤—ã–π –º–µ—Ç–æ–¥ —Å–æ–∑–¥–∞–Ω–∏—è MARKET –æ—Ä–¥–µ—Ä–∞

```python
async def _create_market_exit_order(
    self,
    exchange,
    symbol: str,
    side: str,
    amount: float,
    reason: str = "MARKET_CLOSE"
) -> Optional[Dict]:
    """
    –°–æ–∑–¥–∞—Ç—å MARKET –æ—Ä–¥–µ—Ä –¥–ª—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ–∑–∏—Ü–∏–∏

    Args:
        exchange: –û–±—ä–µ–∫—Ç –±–∏—Ä–∂–∏
        symbol: –¢–æ—Ä–≥–æ–≤–∞—è –ø–∞—Ä–∞
        side: 'buy' –∏–ª–∏ 'sell'
        amount: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ
        reason: –ü—Ä–∏—á–∏–Ω–∞ –∑–∞–∫—Ä—ã—Ç–∏—è (–¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è)

    Returns:
        –°–ª–æ–≤–∞—Ä—å –æ—Ä–¥–µ—Ä–∞ –∏–ª–∏ None
    """
    try:
        logger.info(f"üì§ MARKET {reason}: {side} {amount} {symbol}")

        params = {
            'reduceOnly': True  # –ö–†–ò–¢–ò–ß–ï–°–ö–ò –≤–∞–∂–Ω–æ!
        }

        if exchange.id == 'bybit':
            params['positionIdx'] = 0

        order = await exchange.exchange.create_order(
            symbol=symbol,
            type='market',  # ‚Üê MARKET —Ç–∏–ø
            side=side,
            amount=amount,
            params=params
        )

        if order:
            logger.info(f"‚úÖ MARKET –æ—Ä–¥–µ—Ä –∏—Å–ø–æ–ª–Ω–µ–Ω: {order['id']}")
            self.stats['market_orders_created'] += 1
            return order

    except Exception as e:
        logger.error(f"‚ùå MARKET –æ—Ä–¥–µ—Ä –Ω–µ –ø—Ä–æ—à—ë–ª –¥–ª—è {symbol}: {e}")
        self.stats['market_orders_failed'] += 1
        return None
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- `type='market'` - –∫–ª—é—á–µ–≤–æ–π –ø–∞—Ä–∞–º–µ—Ç—Ä
- `reduceOnly=True` - –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —É–≤–µ–ª–∏—á–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏–∏
- –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ–µ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–æ –ª—É—á—à–µ–π –¥–æ—Å—Ç—É–ø–Ω–æ–π —Ü–µ–Ω–µ
- –ù–µ—Ç –≥–∞—Ä–∞–Ω—Ç–∏–∏ —Ç–æ—á–Ω–æ–π —Ü–µ–Ω—ã, –Ω–æ –≥–∞—Ä–∞–Ω—Ç–∏—è –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è

### 3.3 –û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π –º–µ—Ç–æ–¥ `_update_single_exit_order()`

```python
async def _update_single_exit_order(
    self,
    position,
    target_price: float,
    phase: str,
    order_type: str  # –ù–û–í–´–ô –ø–∞—Ä–∞–º–µ—Ç—Ä: 'LIMIT' –∏–ª–∏ 'MARKET'
):
    """
    –°–æ–∑–¥–∞—Ç—å –∏–ª–∏ –æ–±–Ω–æ–≤–∏—Ç—å exit –æ—Ä–¥–µ—Ä —Å –≤—ã–±–æ—Ä–æ–º —Ç–∏–ø–∞

    –ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê:
    - –ï—Å–ª–∏ order_type == 'MARKET': —Å–æ–∑–¥–∞—Ç—å MARKET –æ—Ä–¥–µ—Ä
    - –ï—Å–ª–∏ order_type == 'LIMIT': —Å–æ–∑–¥–∞—Ç—å/–æ–±–Ω–æ–≤–∏—Ç—å LIMIT –æ—Ä–¥–µ—Ä
    """
    try:
        position_id = f"{position.symbol}_{position.exchange}"
        exchange = self.exchanges.get(position.exchange)

        if not exchange:
            logger.error(f"Exchange {position.exchange} –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞")
            return

        # –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Å—Ç–æ—Ä–æ–Ω—É –æ—Ä–¥–µ—Ä–∞
        order_side = 'sell' if position.side in ['long', 'buy'] else 'buy'

        # –ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê: –í—ã–±–æ—Ä –º–µ–∂–¥—É MARKET –∏ LIMIT
        if order_type == 'MARKET':
            # –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å MARKET –æ—Ä–¥–µ—Ä
            order = await self._create_market_exit_order(
                exchange=exchange,
                symbol=position.symbol,
                side=order_side,
                amount=abs(float(position.quantity)),
                reason=phase
            )

            if order:
                self.managed_positions[position_id] = {
                    'last_update': datetime.now(),
                    'order_id': order['id'],
                    'phase': phase,
                    'order_type': 'MARKET'
                }
                logger.info(f"‚úÖ MARKET –∑–∞–∫—Ä—ã—Ç–∏–µ: {position.symbol} –≤ —Ñ–∞–∑–µ {phase}")

        else:  # LIMIT
            # –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –ª–æ–≥–∏–∫—É LIMIT –æ—Ä–¥–µ—Ä–æ–≤
            precise_price = self._apply_price_precision(
                float(target_price),
                position.symbol,
                position.exchange
            )

            # –í—ã–∑–æ–≤ EnhancedExchangeManager
            from core.exchange_manager_enhanced import EnhancedExchangeManager
            enhanced_manager = EnhancedExchangeManager(exchange.exchange)

            order = await enhanced_manager.create_or_update_exit_order(
                symbol=position.symbol,
                side=order_side,
                amount=abs(float(position.quantity)),
                price=precise_price,
                min_price_diff_pct=0.5
            )

            if order:
                self.managed_positions[position_id] = {
                    'last_update': datetime.now(),
                    'order_id': order['id'],
                    'phase': phase,
                    'order_type': 'LIMIT'
                }

                if order.get('_was_updated'):
                    self.stats['orders_updated'] += 1
                else:
                    self.stats['orders_created'] += 1

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è exit –æ—Ä–¥–µ—Ä–∞: {e}", exc_info=True)
        self.stats['orders_failed'] += 1
```

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
1. –ù–æ–≤—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä `order_type`
2. –£—Å–ª–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞: MARKET vs LIMIT
3. –û—Ç–¥–µ–ª—å–Ω—ã–π –ø—É—Ç—å –¥–ª—è MARKET –æ—Ä–¥–µ—Ä–æ–≤
4. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–∏–ø–∞ –æ—Ä–¥–µ—Ä–∞ –≤ `managed_positions`

### 3.4 –û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π –º–µ—Ç–æ–¥ `_calculate_target_price()`

```python
def _calculate_target_price(
    self,
    position,
    hours_over_limit: float,
    current_price: float
) -> Tuple[str, float, float, str]:  # –ù–û–í–´–ô –≤–æ–∑–≤—Ä–∞—Ç: + order_type
    """
    –†–∞—Å—Å—á–∏—Ç–∞—Ç—å —Ü–µ–ª–µ–≤—É—é —Ü–µ–Ω—É –∏ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–∏–ø –æ—Ä–¥–µ—Ä–∞

    –ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê:
    1. –ü—Ä–æ–≤–µ—Ä–∫–∞ PnL ‚Üí –µ—Å–ª–∏ –ø—Ä–∏–±—ã–ª—å ‚Üí MARKET
    2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–∑—ã ‚Üí —Ä–∞—Å—á—ë—Ç —Ü–µ–ª–µ–≤–æ–π —Ü–µ–Ω—ã
    3. –í–∞–ª–∏–¥–∞—Ü–∏—è LIMIT ‚Üí –≤—ã–±–æ—Ä —Ç–∏–ø–∞ –æ—Ä–¥–µ—Ä–∞

    Returns:
        Tuple of (phase_name, target_price, loss_percent, order_type)
    """
    entry_price = Decimal(str(position.entry_price))
    current_price_decimal = Decimal(str(current_price))

    # –®–ê–ì 1: –ü–†–û–í–ï–†–ö–ê –ü–†–ò–ë–´–õ–¨–ù–û–°–¢–ò (–ù–û–í–û–ï!)
    current_pnl_percent = self._calculate_current_pnl_percent(
        position.side,
        entry_price,
        current_price_decimal
    )

    if current_pnl_percent > 0:
        # –ü–û–ó–ò–¶–ò–Ø –í –ü–†–ò–ë–´–õ–ò - –ó–ê–ö–†–´–í–ê–ï–ú –ù–ï–ú–ï–î–õ–ï–ù–ù–û –ü–û MARKET
        logger.info(
            f"üí∞ {position.symbol} –≤ –ø—Ä–∏–±—ã–ª–∏ {current_pnl_percent:.2f}% "
            f"(–≤–æ–∑—Ä–∞—Å—Ç {hours_over_limit:.1f}—á) - MARKET –∑–∞–∫—Ä—ã—Ç–∏–µ"
        )
        return (
            f"IMMEDIATE_PROFIT_CLOSE (PnL: +{current_pnl_percent:.2f}%)",
            current_price_decimal,
            Decimal('0'),
            'MARKET'
        )

    # –®–ê–ì 2: –†–ê–°–ß–Å–¢ –ü–û –§–ê–ó–ê–ú (–¥–ª—è PnL ‚â§ 0%)
    if hours_over_limit <= self.grace_period_hours:
        # –§–ê–ó–ê 1: GRACE PERIOD
        double_commission = 2 * self.commission_percent

        if position.side in ['long', 'buy']:
            target_price = entry_price * (1 + double_commission)
        else:
            target_price = entry_price * (1 - double_commission)

        phase = f"GRACE_PERIOD_BREAKEVEN ({hours_over_limit:.1f}/{self.grace_period_hours}h)"
        loss_percent = Decimal('0')

    elif hours_over_limit <= self.grace_period_hours + 20:
        # –§–ê–ó–ê 2: PROGRESSIVE
        hours_after_grace = hours_over_limit - self.grace_period_hours
        loss_percent = hours_after_grace * self.loss_step_percent

        if hours_after_grace > 10:
            extra_hours = hours_after_grace - 10
            acceleration_loss = extra_hours * self.loss_step_percent * (self.acceleration_factor - 1)
            loss_percent += acceleration_loss

        loss_percent = min(loss_percent, self.max_loss_percent)

        if position.side in ['long', 'buy']:
            target_price = entry_price * (1 - loss_percent / 100)
        else:
            target_price = entry_price * (1 + loss_percent / 100)

        phase = f"PROGRESSIVE_LIQUIDATION (loss: {loss_percent:.1f}%)"

    else:
        # –§–ê–ó–ê 3: EMERGENCY - –í–°–ï–ì–î–ê MARKET
        target_price = current_price_decimal
        phase = "EMERGENCY_MARKET_CLOSE"

        if position.side in ['long', 'buy']:
            loss_percent = ((entry_price - current_price_decimal) / entry_price) * 100
        else:
            loss_percent = ((current_price_decimal - entry_price) / entry_price) * 100

        # EMERGENCY –≤—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç MARKET
        return (phase, target_price, loss_percent, 'MARKET')

    # –®–ê–ì 3: –í–ê–õ–ò–î–ê–¶–ò–Ø LIMIT –î–õ–Ø GRACE –ò PROGRESSIVE
    order_side = 'sell' if position.side in ['long', 'buy'] else 'buy'

    can_use_limit = self._validate_limit_price(
        side=order_side,
        target_price=float(target_price),
        current_price=float(current_price_decimal),
        buffer_pct=0.1
    )

    if can_use_limit:
        order_type = 'LIMIT'
    else:
        logger.warning(
            f"‚ö†Ô∏è LIMIT –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω –¥–ª—è {position.symbol} "
            f"(target=${target_price:.4f}, market=${current_price:.4f}) "
            f"- –∏—Å–ø–æ–ª—å–∑—É–µ–º MARKET"
        )
        order_type = 'MARKET'
        target_price = current_price_decimal  # –û–±–Ω–æ–≤–∏—Ç—å –Ω–∞ —Ä—ã–Ω–æ—á–Ω—É—é —Ü–µ–Ω—É

    return (phase, target_price, loss_percent, order_type)
```

**–ö–ª—é—á–µ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:**
1. –ù–æ–≤—ã–π –®–ê–ì 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ PnL –ø–µ—Ä–µ–¥ –≤—Å–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–º
2. –í–æ–∑–≤—Ä–∞—Ç 4-–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è: `order_type`
3. –í–∞–ª–∏–¥–∞—Ü–∏—è LIMIT –¥–ª—è GRACE –∏ PROGRESSIVE
4. EMERGENCY –≤—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç MARKET

### 3.5 –ù–æ–≤—ã–π –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–π –º–µ—Ç–æ–¥

```python
def _calculate_current_pnl_percent(
    self,
    side: str,
    entry_price: Decimal,
    current_price: Decimal
) -> Decimal:
    """
    –†–∞—Å—Å—á–∏—Ç–∞—Ç—å —Ç–µ–∫—É—â–∏–π PnL –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö

    Args:
        side: 'long' –∏–ª–∏ 'short'
        entry_price: –¶–µ–Ω–∞ –≤—Ö–æ–¥–∞
        current_price: –¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞

    Returns:
        PnL –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö (–ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π = –ø—Ä–∏–±—ã–ª—å, –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π = —É–±—ã—Ç–æ–∫)
    """
    if side in ['long', 'buy']:
        # LONG: –ø—Ä–∏–±—ã–ª—å –∫–æ–≥–¥–∞ current > entry
        pnl_percent = ((current_price - entry_price) / entry_price) * 100
    else:  # short
        # SHORT: –ø—Ä–∏–±—ã–ª—å –∫–æ–≥–¥–∞ current < entry
        pnl_percent = ((entry_price - current_price) / entry_price) * 100

    return pnl_percent
```

---

## 4. –ü–û–î–†–û–ë–ù–´–ô –ü–õ–ê–ù –†–ï–§–ê–ö–¢–û–†–ò–ù–ì–ê

### 4.1 –≠—Ç–∞–ø—ã —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

#### –≠–¢–ê–ü 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è (1-2 —á–∞—Å–∞)

**–ó–∞–¥–∞—á–∏:**
1. ‚úÖ –°–æ–∑–¥–∞—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é `aged_position_manager.py`
2. ‚úÖ –°–æ–∑–¥–∞—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é `exchange_manager_enhanced.py`
3. ‚úÖ –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é –≤–µ—Ç–∫—É git
4. ‚úÖ –ó–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è:**
- –ö–æ–¥ –≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- –ü–ª–∞–Ω —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω
- –û–∫—Ä—É–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ

#### –≠–¢–ê–ü 2: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã—Ö –º–µ—Ç–æ–¥–æ–≤ (1-2 —á–∞—Å–∞)

**–§–∞–π–ª:** `core/aged_position_manager.py`

**–î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥—ã:**
1. `_calculate_current_pnl_percent()` - —Ä–∞—Å—á—ë—Ç PnL
2. `_validate_limit_price()` - –≤–∞–ª–∏–¥–∞—Ü–∏—è LIMIT —Ü–µ–Ω—ã
3. `_create_market_exit_order()` - —Å–æ–∑–¥–∞–Ω–∏–µ MARKET –æ—Ä–¥–µ—Ä–æ–≤

**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** –ü–æ—Å–ª–µ –º–µ—Ç–æ–¥–∞ `_apply_price_precision()` (—Å—Ç—Ä–æ–∫–∞ 100)

**–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**
- Unit —Ç–µ—Å—Ç—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –º–µ—Ç–æ–¥–∞
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥—Ä–∞–Ω–∏—á–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤
- –í–∞–ª–∏–¥–∞—Ü–∏—è –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è:**
- –í—Å–µ 3 –º–µ—Ç–æ–¥–∞ –¥–æ–±–∞–≤–ª–µ–Ω—ã
- Unit —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç
- –ö–æ–¥ –Ω–µ –ª–æ–º–∞–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

#### –≠–¢–ê–ü 3: –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ `_calculate_target_price()` (2-3 —á–∞—Å–∞)

**–§–∞–π–ª:** `core/aged_position_manager.py`
**–ú–µ—Ç–æ–¥:** `_calculate_target_price()` (—Å—Ç—Ä–æ–∫–∏ 258-317)

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
1. –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É PnL –≤ –Ω–∞—á–∞–ª–æ –º–µ—Ç–æ–¥–∞
2. –ò–∑–º–µ–Ω–∏—Ç—å –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—ã–π tuple: –¥–æ–±–∞–≤–∏—Ç—å 4-–π —ç–ª–µ–º–µ–Ω—Ç `order_type`
3. –î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é LIMIT –¥–ª—è GRACE –∏ PROGRESSIVE
4. –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å MARKET –¥–ª—è EMERGENCY

**–ü—Å–µ–≤–¥–æ–∫–æ–¥ –∏–∑–º–µ–Ω–µ–Ω–∏–π:**
```python
def _calculate_target_price(...) -> Tuple[str, float, float, str]:
    # –ù–û–í–û–ï: –ü—Ä–æ–≤–µ—Ä–∫–∞ PnL
    current_pnl = self._calculate_current_pnl_percent(...)
    if current_pnl > 0:
        return (..., 'MARKET')

    # –°—É—â–µ—Å—Ç–≤—É—é—â–∞—è –ª–æ–≥–∏–∫–∞ —Ä–∞—Å—á—ë—Ç–∞ —Ü–µ–Ω—ã
    if grace_period:
        ...
    elif progressive:
        ...
    else:  # emergency
        return (..., 'MARKET')  # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ

    # –ù–û–í–û–ï: –í–∞–ª–∏–¥–∞—Ü–∏—è LIMIT
    if self._validate_limit_price(...):
        return (..., 'LIMIT')
    else:
        return (..., 'MARKET')
```

**–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**
- –¢–µ—Å—Ç—ã –¥–ª—è –≤—Å–µ—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ PnL
- –¢–µ—Å—Ç—ã –¥–ª—è –≤—Å–µ—Ö —Ñ–∞–∑
- –¢–µ—Å—Ç—ã –≤–∞–ª–∏–¥–∞—Ü–∏–∏ LIMIT

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è:**
- –ú–µ—Ç–æ–¥ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 4 –∑–Ω–∞—á–µ–Ω–∏—è
- –õ–æ–≥–∏–∫–∞ PnL —Ä–∞–±–æ—Ç–∞–µ—Ç
- –í–∞–ª–∏–¥–∞—Ü–∏—è LIMIT —Ä–∞–±–æ—Ç–∞–µ—Ç
- –¢–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç

#### –≠–¢–ê–ü 4: –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ `_update_single_exit_order()` (2-3 —á–∞—Å–∞)

**–§–∞–π–ª:** `core/aged_position_manager.py`
**–ú–µ—Ç–æ–¥:** `_update_single_exit_order()` (—Å—Ç—Ä–æ–∫–∏ 319-438)

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
1. –î–æ–±–∞–≤–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä `order_type: str`
2. –î–æ–±–∞–≤–∏—Ç—å —É—Å–ª–æ–≤–Ω—É—é –ª–æ–≥–∏–∫—É: if order_type == 'MARKET'
3. –í—ã–∑–≤–∞—Ç—å `_create_market_exit_order()` –¥–ª—è MARKET
4. –°–æ—Ö—Ä–∞–Ω—è—Ç—å —Ç–∏–ø –æ—Ä–¥–µ—Ä–∞ –≤ `managed_positions`

**–ü—Å–µ–≤–¥–æ–∫–æ–¥ –∏–∑–º–µ–Ω–µ–Ω–∏–π:**
```python
async def _update_single_exit_order(..., order_type: str):
    ...
    if order_type == 'MARKET':
        order = await self._create_market_exit_order(...)
        self.managed_positions[...] = {..., 'order_type': 'MARKET'}
    else:  # LIMIT
        # –°—É—â–µ—Å—Ç–≤—É—é—â–∞—è –ª–æ–≥–∏–∫–∞
        order = await enhanced_manager.create_or_update_exit_order(...)
        self.managed_positions[...] = {..., 'order_type': 'LIMIT'}
```

**–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**
- –¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è MARKET –æ—Ä–¥–µ—Ä–∞
- –¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è LIMIT –æ—Ä–¥–µ—Ä–∞
- –¢–µ—Å—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è LIMIT –æ—Ä–¥–µ—Ä–∞
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ç–µ—Å—Ç —Å –±–∏—Ä–∂–µ–π (TESTNET)

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è:**
- MARKET –æ—Ä–¥–µ—Ä–∞ —Å–æ–∑–¥–∞—é—Ç—Å—è
- LIMIT –æ—Ä–¥–µ—Ä–∞ —Å–æ–∑–¥–∞—é—Ç—Å—è/–æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è
- –û–±–∞ —Ç–∏–ø–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è

#### –≠–¢–ê–ü 5: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ `process_aged_position()` (1 —á–∞—Å)

**–§–∞–π–ª:** `core/aged_position_manager.py`
**–ú–µ—Ç–æ–¥:** `process_aged_position()` (—Å—Ç—Ä–æ–∫–∏ 162-256)

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
1. –û–±–Ω–æ–≤–∏—Ç—å –≤—ã–∑–æ–≤ `_calculate_target_price()` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è 4-–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è
2. –ü–µ—Ä–µ–¥–∞—Ç—å `order_type` –≤ `_update_single_exit_order()`

**–ö–æ–¥ –∏–∑–º–µ–Ω–µ–Ω–∏–π:**
```python
# –ë—ã–ª–æ:
phase, target_price, loss_percent = self._calculate_target_price(...)

# –°—Ç–∞–ª–æ:
phase, target_price, loss_percent, order_type = self._calculate_target_price(...)

# –ë—ã–ª–æ:
await self._update_single_exit_order(position, target_price, phase)

# –°—Ç–∞–ª–æ:
await self._update_single_exit_order(position, target_price, phase, order_type)
```

**–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ç–µ—Å—Ç –ø–æ–ª–Ω–æ–≥–æ –ø–æ—Ç–æ–∫–∞
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è –≤—Å–µ—Ö —Ñ–∞–∑

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è:**
- –ü–æ—Ç–æ–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç end-to-end
- –í—Å–µ —Ñ–∞–∑—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ

#### –≠–¢–ê–ü 6: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ (30 –º–∏–Ω—É—Ç)

**–§–∞–π–ª:** `core/aged_position_manager.py`
**–ú–µ—Ç–æ–¥:** `__init__()` (—Å—Ç—Ä–æ–∫–∏ 34-75)

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
```python
self.stats = {
    'positions_checked': 0,
    'aged_positions': 0,
    'grace_period_positions': 0,
    'progressive_positions': 0,
    'emergency_closes': 0,
    'orders_updated': 0,
    'orders_created': 0,
    'orders_failed': 0,  # –ù–û–í–û–ï
    'market_orders_created': 0,  # –ù–û–í–û–ï
    'limit_orders_created': 0,  # –ù–û–í–û–ï
    'profit_closes': 0,  # –ù–û–í–û–ï
    'breakeven_closes': 0,
    'gradual_liquidations': 0
}
```

**–û–±–Ω–æ–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:**
```python
# –í _update_single_exit_order()
if order_type == 'MARKET':
    self.stats['market_orders_created'] += 1
    if 'PROFIT' in phase:
        self.stats['profit_closes'] += 1
else:
    self.stats['limit_orders_created'] += 1
```

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è:**
- –ù–æ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ
- –ú–µ—Ç–æ–¥ `get_statistics()` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–æ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏

#### –≠–¢–ê–ü 7: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ TESTNET (2-3 —á–∞—Å–∞)

**–°—Ü–µ–Ω–∞—Ä–∏–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:**

1. **–¢–µ—Å—Ç –ø—Ä–∏–±—ã–ª—å–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏:**
   - –°–æ–∑–¥–∞—Ç—å SHORT –ø–æ–∑–∏—Ü–∏—é
   - –î–æ–∂–¥–∞—Ç—å—Å—è —Å—Ç–∞—Ä–µ–Ω–∏—è (3—á+)
   - –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ —Ä—ã–Ω–æ–∫ —É–ø–∞–ª (–ø—Ä–∏–±—ã–ª—å)
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å: MARKET –æ—Ä–¥–µ—Ä —Å–æ–∑–¥–∞–Ω
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å: –ü–æ–∑–∏—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∞

2. **–¢–µ—Å—Ç —É–±—ã—Ç–æ—á–Ω–æ–π GRACE –ø–æ–∑–∏—Ü–∏–∏:**
   - –°–æ–∑–¥–∞—Ç—å SHORT –ø–æ–∑–∏—Ü–∏—é
   - –î–æ–∂–¥–∞—Ç—å—Å—è —Å—Ç–∞—Ä–µ–Ω–∏—è (3-11—á)
   - –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ —Ä—ã–Ω–æ–∫ –≤—ã—Ä–æ—Å (—É–±—ã—Ç–æ–∫)
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å: LIMIT –æ—Ä–¥–µ—Ä —Å–æ–∑–¥–∞–Ω (–µ—Å–ª–∏ –≤–∞–ª–∏–¥–µ–Ω) –∏–ª–∏ MARKET

3. **–¢–µ—Å—Ç EMERGENCY –ø–æ–∑–∏—Ü–∏–∏:**
   - –ù–∞–π—Ç–∏ –æ—á–µ–Ω—å —Å—Ç–∞—Ä—É—é –ø–æ–∑–∏—Ü–∏—é (31—á+)
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å: MARKET –æ—Ä–¥–µ—Ä —Å–æ–∑–¥–∞–Ω –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç PnL

4. **–¢–µ—Å—Ç –ø–µ—Ä–µ—Ö–æ–¥–∞ —Ñ–∞–∑:**
   - –û—Ç—Å–ª–µ–¥–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é —á–µ—Ä–µ–∑ –≤—Å–µ 3 —Ñ–∞–∑—ã
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π

**–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:**
- –ó–∞–ø—É—Å—Ç–∏—Ç—å `aged_position_monitor.py` –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
- –°–æ–±–∏—Ä–∞—Ç—å —Å–Ω–∏–º–∫–∏ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
- –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è:**
- –í—Å–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –ø—Ä–æ—Ö–æ–¥—è—Ç —É—Å–ø–µ—à–Ω–æ
- 0 –æ—à–∏–±–æ–∫ -4016 –≤ –ª–æ–≥–∞—Ö
- –ü–æ–∑–∏—Ü–∏–∏ –∑–∞–∫—Ä—ã–≤–∞—é—Ç—Å—è –∫–∞–∫ –æ–∂–∏–¥–∞–µ—Ç—Å—è

#### –≠–¢–ê–ü 8: –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∏ –æ—á–∏—Å—Ç–∫–∞ –∫–æ–¥–∞ (1 —á–∞—Å)

**–ó–∞–¥–∞—á–∏:**
1. –û–±–Ω–æ–≤–∏—Ç—å docstrings –≤—Å–µ—Ö –∏–∑–º–µ–Ω—ë–Ω–Ω—ã—Ö –º–µ—Ç–æ–¥–æ–≤
2. –î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∫ —Å–ª–æ–∂–Ω—ã–º —É—á–∞—Å—Ç–∫–∞–º
3. –û–±–Ω–æ–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –≤ –Ω–∞—á–∞–ª–µ —Ñ–∞–π–ª–∞
4. –°–æ–∑–¥–∞—Ç—å CHANGELOG.md —Å –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è:**
- –ö–æ–¥ —Ö–æ—Ä–æ—à–æ –∑–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω
- CHANGELOG —Å–æ–∑–¥–∞–Ω
- README –æ–±–Ω–æ–≤–ª—ë–Ω (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)

### 4.2 –û—Ü–µ–Ω–∫–∞ –≤—Ä–µ–º–µ–Ω–∏

| –≠—Ç–∞–ø | –û–ø–∏—Å–∞–Ω–∏–µ | –í—Ä–µ–º—è |
|------|----------|-------|
| 1 | –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ | 1-2—á |
| 2 | –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã | 1-2—á |
| 3 | –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ _calculate_target_price | 2-3—á |
| 4 | –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ _update_single_exit_order | 2-3—á |
| 5 | –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ process_aged_position | 1—á |
| 6 | –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ | 0.5—á |
| 7 | –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ TESTNET | 2-3—á |
| 8 | –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è | 1—á |
| **–ò–¢–û–ì–û** | | **11-16 —á–∞—Å–æ–≤** |

### 4.3 –†–∏—Å–∫–∏ –∏ –º–∏—Ç–∏–≥–∞—Ü–∏—è

| –†–∏—Å–∫ | –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å | –í–ª–∏—è–Ω–∏–µ | –ú–∏—Ç–∏–≥–∞—Ü–∏—è |
|------|-------------|---------|-----------|
| MARKET –æ—Ä–¥–µ—Ä–∞ –∏—Å–ø–æ–ª–Ω—è—é—Ç—Å—è —Å –±–æ–ª—å—à–∏–º –ø—Ä–æ—Å–∫–∞–ª—å–∑—ã–≤–∞–Ω–∏–µ–º | –°—Ä–µ–¥–Ω—è—è | –°—Ä–µ–¥–Ω–µ–µ | –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Å–∫–∞–ª—å–∑—ã–≤–∞–Ω–∏—è, –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ |
| MARKET –æ—Ä–¥–µ—Ä–∞ –Ω–µ –ø—Ä–æ—Ö–æ–¥—è—Ç –Ω–∞ –±–∏—Ä–∂–µ | –ù–∏–∑–∫–∞—è | –í—ã—Å–æ–∫–æ–µ | Try-catch —Å –æ—Ç–∫–∞—Ç–æ–º –∫ LIMIT, –∞–ª–µ—Ä—Ç—ã |
| –ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ —Å–æ–∑–¥–∞—ë—Ç –¥—É–±–ª–∏—Ä—É—é—â–∏–µ –æ—Ä–¥–µ—Ä–∞ | –°—Ä–µ–¥–Ω—è—è | –í—ã—Å–æ–∫–æ–µ | –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –æ—Ä–¥–µ—Ä–æ–≤ –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º |
| PnL —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ | –ù–∏–∑–∫–∞—è | –ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ | Unit —Ç–µ—Å—Ç—ã, –≤–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö |
| EMERGENCY –Ω–µ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –ø–æ–∑–∏—Ü–∏–∏ | –ù–∏–∑–∫–∞—è | –ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ | –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π MARKET, –∞–ª–µ—Ä—Ç—ã –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –ø–æ–∑–∏—Ü–∏–π |

### 4.4 –ü–ª–∞–Ω –æ—Ç–∫–∞—Ç–∞

**–ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ–π–¥—ë—Ç –Ω–µ —Ç–∞–∫:**

1. **–ë—ã—Å—Ç—Ä—ã–π –æ—Ç–∫–∞—Ç (5 –º–∏–Ω—É—Ç):**
   ```bash
   git checkout main
   git revert <commit-hash>
   sudo systemctl restart trading_bot
   ```

2. **–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ –±—ç–∫–∞–ø–∞ (10 –º–∏–Ω—É—Ç):**
   ```bash
   cp backup/aged_position_manager.py.backup core/aged_position_manager.py
   sudo systemctl restart trading_bot
   ```

3. **–ü–æ–ª–Ω–æ–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ –º–æ–¥—É–ª—è (1 –º–∏–Ω—É—Ç–∞):**
   ```bash
   # –í main.py –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—ã–∑–æ–≤
   # await aged_position_manager.check_and_process_aged_positions()
   ```

---

## 5. –ù–û–í–ê–Ø –î–û–ö–£–ú–ï–ù–¢–ê–¶–ò–Ø –õ–û–ì–ò–ö–ò

### 5.1 –ë–ª–æ–∫-—Å—Ö–µ–º–∞ –Ω–æ–≤–æ–π –ª–æ–≥–∏–∫–∏

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –í–•–û–î: –°—Ç–∞—Ä–∞—è –ø–æ–∑–∏—Ü–∏—è (–≤–æ–∑—Ä–∞—Å—Ç > MAX_AGE)                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                        ‚îÇ
                        ‚ñº
             ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
             ‚îÇ –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â—É—é —Ü–µ–Ω—É ‚îÇ
             ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                        ‚îÇ
                        ‚ñº
             ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
             ‚îÇ –†–∞—Å—Å—á–∏—Ç–∞—Ç—å PnL %     ‚îÇ
             ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                        ‚îÇ
                        ‚ñº
             ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
             ‚îÇ   PnL > 0% ?         ‚îÇ
             ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                    ‚îÇ
         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚îÇ –î–ê                  ‚îÇ –ù–ï–¢
         ‚ñº                     ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ MARKET –∑–∞–∫—Ä—ã—Ç–∏–µ    ‚îÇ  ‚îÇ –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ–∑—Ä–∞—Å—Ç–∞    ‚îÇ
‚îÇ –ü—Ä–∏—á–∏–Ω–∞: PROFIT    ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò             ‚îÇ
                                   ‚ñº
                        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                        ‚îÇ –í–æ–∑—Ä–∞—Å—Ç 0-8—á ?       ‚îÇ
                        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                               ‚îÇ
                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ –î–ê                  ‚îÇ –ù–ï–¢
                    ‚ñº                     ‚ñº
         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚îÇ GRACE PERIOD         ‚îÇ  ‚îÇ –í–æ–∑—Ä–∞—Å—Ç 8-28—á ?      ‚îÇ
         ‚îÇ –¶–µ–ª—å: –±–µ–∑—É–±—ã—Ç–æ–∫      ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îÇ
                    ‚îÇ            ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚ñº            ‚îÇ –î–ê                ‚îÇ –ù–ï–¢
         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê‚ñº                   ‚ñº
         ‚îÇ LIMIT –≤–∞–ª–∏–¥–µ–Ω ?      ‚îÇ‚îÇ PROGRESSIVE       ‚îÇ EMERGENCY
         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò‚îÇ –¶–µ–ª—å: —É–±—ã—Ç–æ–∫ N%   ‚îÇ MARKET –∑–∞–∫—Ä—ã—Ç–∏–µ
                ‚îÇ                 ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê            ‚îÇ
     ‚îÇ –î–ê                  ‚îÇ –ù–ï–¢        ‚ñº
     ‚ñº                     ‚ñº   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§ LIMIT –≤–∞–ª–∏–¥–µ–Ω ?      ‚îÇ
‚îÇ LIMIT –æ—Ä–¥–µ—Ä    ‚îÇ ‚îÇ MARKET –æ—Ä–¥–µ—Ä‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê       ‚îÇ
                                 ‚îÇ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                                 ‚îÇ‚îÇ –î–ê              ‚îÇ –ù–ï–¢
                                 ‚îÇ‚ñº                 ‚ñº
                                 ‚îÇ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                                 ‚îÇ‚îÇ LIMIT  ‚îÇ ‚îÇ MARKET     ‚îÇ
                                 ‚îÇ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                 ‚îÇ
                                 ‚ñº
                      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                      ‚îÇ –í–´–•–û–î: –û—Ä–¥–µ—Ä —Å–æ–∑–¥–∞–Ω  ‚îÇ
                      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### 5.2 –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤

**–ü—Ä–∏–Ω—Ü–∏–ø—ã –Ω–æ–≤–æ–π –ª–æ–≥–∏–∫–∏:**

1. **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –ø—Ä–∏–±—ã–ª–∏:** –ü—Ä–∏–±—ã–ª—å–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏ –∑–∞–∫—Ä—ã–≤–∞—é—Ç—Å—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ –ø–æ MARKET
2. **–ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π –≤—ã–±–æ—Ä —Ç–∏–ø–∞:** LIMIT –µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ, MARKET –µ—Å–ª–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ
3. **–ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ:** EMERGENCY –≤—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç MARKET
4. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:** `reduceOnly=True` –¥–ª—è –≤—Å–µ—Ö –æ—Ä–¥–µ—Ä–æ–≤

**–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:**

```python
MAX_POSITION_AGE_HOURS = 3        # –ö–æ–≥–¥–∞ –ø–æ–∑–∏—Ü–∏—è —Å—á–∏—Ç–∞–µ—Ç—Å—è —Å—Ç–∞—Ä–æ–π
AGED_GRACE_PERIOD_HOURS = 8       # –ü–µ—Ä–∏–æ–¥ –ø–æ–ø—ã—Ç–æ–∫ –±–µ–∑—É–±—ã—Ç–∫–∞
AGED_LOSS_STEP_PERCENT = 0.5      # –®–∞–≥ —É–±—ã—Ç–∫–∞ –≤ progressive
AGED_MAX_LOSS_PERCENT = 10.0      # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –¥–æ–ø—É—Å—Ç–∏–º—ã–π —É–±—ã—Ç–æ–∫
AGED_ACCELERATION_FACTOR = 1.2    # –ê–∫—Å–µ–ª–µ—Ä–∞—Ü–∏—è –ø–æ—Å–ª–µ 10—á
COMMISSION_PERCENT = 0.1          # –ö–æ–º–∏—Å—Å–∏—è –±–∏—Ä–∂–∏
```

**–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:**

–í—Å–µ –∫–ª—é—á–µ–≤—ã–µ —Ä–µ—à–µ–Ω–∏—è –ª–æ–≥–∏—Ä—É—é—Ç—Å—è:
- `üí∞ PROFIT –∑–∞–∫—Ä—ã—Ç–∏–µ` - –ø–æ–∑–∏—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∞ —Å –ø—Ä–∏–±—ã–ª—å—é
- `‚ö†Ô∏è LIMIT –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω` - –æ—Ç–∫–∞—Ç –∫ MARKET
- `üö® EMERGENCY` - –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ
- `‚úÖ MARKET –æ—Ä–¥–µ—Ä –∏—Å–ø–æ–ª–Ω–µ–Ω` - —É—Å–ø–µ—à–Ω–æ–µ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ
- `‚ùå MARKET –æ—Ä–¥–µ—Ä –Ω–µ –ø—Ä–æ—à—ë–ª` - –æ—à–∏–±–∫–∞ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è

### 5.3 –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –∞–ª–µ—Ä—Ç–∏–Ω–≥

**–ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è:**

1. **–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ MARKET –∑–∞–∫—Ä—ã—Ç–∏–π:**
   - `market_orders_created` - –¥–æ–ª–∂–Ω–æ —Ä–∞—Å—Ç–∏
   - –¶–µ–ª—å: > 70% —Å—Ç–∞—Ä—ã—Ö –ø–æ–∑–∏—Ü–∏–π (–ø—Ä–∏–±—ã–ª—å–Ω—ã–µ)

2. **–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ PROFIT –∑–∞–∫—Ä—ã—Ç–∏–π:**
   - `profit_closes` - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–∫—Ä—ã—Ç–∏–π —Å –ø—Ä–∏–±—ã–ª—å—é
   - –û–∂–∏–¥–∞–µ–º–æ–µ: ~70% –æ—Ç aged_positions

3. **–ü—Ä–æ—Ü–µ–Ω—Ç –æ—Ç–∫–∞–∑–æ–≤:**
   - `orders_failed / (orders_created + orders_failed)`
   - –¶–µ–ª—å: < 5%

4. **–°—Ä–µ–¥–Ω–∏–π –≤–æ–∑—Ä–∞—Å—Ç –∑–∞–∫—Ä—ã–≤–∞–µ–º—ã—Ö –ø–æ–∑–∏—Ü–∏–π:**
   - –î–æ–ª–∂–µ–Ω —Å–Ω–∏–∑–∏—Ç—å—Å—è —Å 39—á –¥–æ < 12—á

**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∞–ª–µ—Ä—Ç—ã:**

1. **–ü–æ–∑–∏—Ü–∏—è —Å—Ç–∞—Ä—à–µ 48—á:**
   - –£—Ä–æ–≤–µ–Ω—å: CRITICAL
   - –î–µ–π—Å—Ç–≤–∏–µ: –†—É—á–Ω–æ–µ –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–æ

2. **> 10% –æ—Ç–∫–∞–∑–æ–≤ –æ—Ä–¥–µ—Ä–æ–≤:**
   - –£—Ä–æ–≤–µ–Ω—å: WARNING
   - –î–µ–π—Å—Ç–≤–∏–µ: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–∏–∫–∏

3. **EMERGENCY –Ω–µ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –ø–æ–∑–∏—Ü–∏–∏:**
   - –£—Ä–æ–≤–µ–Ω—å: CRITICAL
   - –î–µ–π—Å—Ç–≤–∏–µ: –ù–µ–º–µ–¥–ª–µ–Ω–Ω—ã–π –æ—Ç–∫–∞—Ç –º–æ–¥—É–ª—è

---

## 6. –ö–û–ù–¢–†–û–õ–¨–ù–´–ô –ß–ï–ö–õ–ò–°–¢

### –ü–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞:
- [ ] –°–æ–∑–¥–∞–Ω –±—ç–∫–∞–ø –≤—Å–µ—Ö –∏–∑–º–µ–Ω—è–µ–º—ã—Ö —Ñ–∞–π–ª–æ–≤
- [ ] –°–æ–∑–¥–∞–Ω–∞ git –≤–µ—Ç–∫–∞ `feature/aged-pnl-priority`
- [ ] –ü–ª–∞–Ω —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω –∏ —É—Ç–≤–µ—Ä–∂–¥—ë–Ω
- [ ] TESTNET –∞–∫–∫–∞—É–Ω—Ç –≥–æ—Ç–æ–≤
- [ ] –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –Ω–∞—Å—Ç—Ä–æ–µ–Ω

### –ü–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ —ç—Ç–∞–ø–∞:
- [ ] –ö–æ–¥ –ø—Ä–æ–≤–µ—Ä–µ–Ω (code review)
- [ ] Unit —Ç–µ—Å—Ç—ã –Ω–∞–ø–∏—Å–∞–Ω—ã –∏ –ø—Ä–æ—Ö–æ–¥—è—Ç
- [ ] –ò–∑–º–µ–Ω–µ–Ω–∏—è –∑–∞–∫–æ–º–º–∏—á–µ–Ω—ã –≤ git
- [ ] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞

### –ü–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º –≤ –ø—Ä–æ–¥–∞–∫—à–Ω:
- [ ] –í—Å–µ —Ç–µ—Å—Ç—ã –Ω–∞ TESTNET –ø—Ä–æ—à–ª–∏ —É—Å–ø–µ—à–Ω–æ
- [ ] –ù–µ—Ç –æ—à–∏–±–æ–∫ -4016 –≤ –ª–æ–≥–∞—Ö
- [ ] –ü–æ–∑–∏—Ü–∏–∏ –∑–∞–∫—Ä—ã–≤–∞—é—Ç—Å—è –∫–∞–∫ –æ–∂–∏–¥–∞–µ—Ç—Å—è
- [ ] –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- [ ] –ü–ª–∞–Ω –æ—Ç–∫–∞—Ç–∞ –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω
- [ ] –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –Ω–∞—Å—Ç—Ä–æ–µ–Ω
- [ ] –ö–æ–º–∞–Ω–¥–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∞ –æ –¥–µ–ø–ª–æ–µ

### –ü–æ—Å–ª–µ –¥–µ–ø–ª–æ—è:
- [ ] –ú–æ–¥—É–ª—å –∑–∞–ø—É—â–µ–Ω –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ
- [ ] –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–æ—Ä–º–∞–ª—å–Ω—É—é —Ä–∞–±–æ—Ç—É
- [ ] –ü–µ—Ä–≤—ã–µ 10 –ø–æ–∑–∏—Ü–∏–π –∑–∞–∫—Ä—ã—Ç—ã —É—Å–ø–µ—à–Ω–æ
- [ ] –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –æ–∂–∏–¥–∞–Ω–∏—è–º
- [ ] –ù–µ—Ç –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫ –≤ –ª–æ–≥–∞—Ö

---

## 7. –û–ñ–ò–î–ê–ï–ú–´–ï –†–ï–ó–£–õ–¨–¢–ê–¢–´

### 7.1 –ö–æ–ª–∏—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏

**–î–æ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞:**
- –ó–∞–∫—Ä—ã—Ç–æ –ø–æ–∑–∏—Ü–∏–π: 0 –∏–∑ 82 (0%)
- –û—à–∏–±–∫–∏ -4016: 486
- –°—Ä–µ–¥–Ω–∏–π –≤–æ–∑—Ä–∞—Å—Ç: 39—á

**–ü–æ—Å–ª–µ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞ (–ø—Ä–æ–≥–Ω–æ–∑):**
- –ó–∞–∫—Ä—ã—Ç–æ –ø–æ–∑–∏—Ü–∏–π: 58+ –∏–∑ 82 (70%+)
- –û—à–∏–±–∫–∏ -4016: 0
- –°—Ä–µ–¥–Ω–∏–π –≤–æ–∑—Ä–∞—Å—Ç: < 12—á

### 7.2 –ö–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

1. **–§–∏–∫—Å–∞—Ü–∏—è –ø—Ä–∏–±—ã–ª–∏:**
   - 70% —Å—Ç–∞—Ä—ã—Ö –ø–æ–∑–∏—Ü–∏–π –≤ –ø—Ä–∏–±—ã–ª–∏ –∑–∞–∫—Ä–æ—é—Ç—Å—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ
   - –ü—Ä–∏–±—ã–ª—å –Ω–µ –±—É–¥–µ—Ç "—É–ø—É—â–µ–Ω–∞"

2. **–ù–∞–¥—ë–∂–Ω–æ—Å—Ç—å:**
   - MARKET –æ—Ä–¥–µ—Ä–∞ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É—é—Ç –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ
   - –ù–µ—Ç –æ—Ç–∫–∞–∑–æ–≤ –æ—Ç –±–∏—Ä–∂–∏

3. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:**
   - EMERGENCY –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø–æ–∑–∏—Ü–∏–∏
   - –ù–µ—Ç –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ –≤–∏—Å—è—â–∏—Ö –ø–æ–∑–∏—Ü–∏–π

4. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:**
   - –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ç–∏–ø–∞–º –∑–∞–∫—Ä—ã—Ç–∏–π
   - –ê–ª–µ—Ä—Ç–∏–Ω–≥ –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Å–∏—Ç—É–∞—Ü–∏–π

### 7.3 –ë–∏–∑–Ω–µ—Å-—ç—Ñ—Ñ–µ–∫—Ç

**–û—Ü–µ–Ω–∫–∞ –ø—Ä–∏–±—ã–ª–∏ –æ—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
- 58 –ø—Ä–∏–±—ã–ª—å–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–π √ó —Å—Ä–µ–¥–Ω–∏–π PnL 8% √ó —Å—Ä–µ–¥–Ω–∏–π —Ä–∞–∑–º–µ—Ä $50 = **$232 –ø—Ä–∏–±—ã–ª–∏**
- –ë–µ–∑ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è: —ç—Ç–∏ –ø–æ–∑–∏—Ü–∏–∏ –º–æ–≥–ª–∏ —É–π—Ç–∏ –≤ —É–±—ã—Ç–æ–∫
- ROI —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞: –≤—ã—Å–æ–∫–∏–π

---

## 8. –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï

–î–∞–Ω–Ω—ã–π –ø–ª–∞–Ω —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞ —Ä–µ—à–∞–µ—Ç –∫—Ä–∏—Ç–∏—á–µ—Å–∫—É—é –ø—Ä–æ–±–ª–µ–º—É –º–æ–¥—É–ª—è Aged Position Manager –ø—É—Ç—ë–º –≤–≤–µ–¥–µ–Ω–∏—è –Ω–æ–≤–æ–π –ª–æ–≥–∏–∫–∏ —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º –Ω–∞ PnL –ø–æ–∑–∏—Ü–∏–π. –û—Å–Ω–æ–≤–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:

1. **–ü—Ä–∏–±—ã–ª—å–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏ –∑–∞–∫—Ä—ã–≤–∞—é—Ç—Å—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ –ø–æ MARKET** –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –≤–æ–∑—Ä–∞—Å—Ç–∞
2. **–ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π –≤—ã–±–æ—Ä —Ç–∏–ø–∞ –æ—Ä–¥–µ—Ä–∞:** LIMIT –µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ, MARKET –µ—Å–ª–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ
3. **EMERGENCY –≤—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç MARKET** –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∑–∞–∫—Ä—ã—Ç–∏—è

–ü–ª–∞–Ω –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω, —Ä–∞–∑–±–∏—Ç –Ω–∞ —ç—Ç–∞–ø—ã, —Å–æ–¥–µ—Ä–∂–∏—Ç –æ—Ü–µ–Ω–∫–∏ –≤—Ä–µ–º–µ–Ω–∏ –∏ –∫—Ä–∏—Ç–µ—Ä–∏–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è. –†–∏—Å–∫–∏ –∏–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω—ã –∏ –∏–º–µ—é—Ç —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –º–∏—Ç–∏–≥–∞—Ü–∏–∏.

**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** –ü–æ–ª—É—á–∏—Ç—å –æ–¥–æ–±—Ä–µ–Ω–∏–µ –ø–ª–∞–Ω–∞ –∏ –Ω–∞—á–∞—Ç—å –≠–¢–ê–ü 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞.

---

**–í–ê–ñ–ù–û:** –≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç —è–≤–ª—è–µ—Ç—Å—è –ø–ª–∞–Ω–æ–º. –ò–∑–º–µ–Ω–µ–Ω–∏–µ –∫–æ–¥–∞ –±—É–¥–µ—Ç –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç—å –¢–û–õ–¨–ö–û –ø–æ—Å–ª–µ –æ–¥–æ–±—Ä–µ–Ω–∏—è.
