# МОДУЛЬ УПРАВЛЕНИЯ СТАРЫМИ ПОЗИЦИЯМИ - КОМПЛЕКСНЫЙ АУДИТОРСКИЙ ОТЧЕТ

**Дата:** 2025-10-17
**Длительность:** 10-минутный live-тест в продакшене (600 секунд)
**Аудитор:** Мониторинг в реальном времени с независимым симулятором логики
**Режим теста:** TESTNET (Binance + Bybit)

---

## РЕЗЮМЕ

### КРИТИЧЕСКИЙ ВЕРДИКТ: МОДУЛЬ ПОЛНОСТЬЮ НЕ РАБОТАЕТ ❌

Модуль управления старыми позициями **НЕ СМОГ ЗАКРЫТЬ НИ ОДНОЙ ПОЗИЦИИ** за 10-минутный производственный тест, несмотря на наличие:
- **82 старых позиций**, требующих закрытия
- **43 позиций в фазе EMERGENCY** (39+ часов, ~36 часов сверх лимита)
- **91 попытка обработки позиций**
- **81 попытка обновления ордеров**
- **486 отказов от биржи**

### Корневая причина
**КРИТИЧЕСКИЙ БАГ: Неправильное использование типа ордера для закрытия позиций**

Модуль пытается размещать LIMIT-ордера по целевым ценам, которые нарушают правила биржи:
- Для SHORT позиций: Размещает BUY LIMIT выше рыночной цены → Отклонено (код -4016)
- Для LONG позиций (продажа в убыток): Размещает SELL LIMIT ниже рынка → Отклонено (код -4016)

### Последствия
- **100% процент отказов** при закрытии позиций
- Старые позиции накапливаются бесконечно
- Риск-экспозиция продолжается без контроля
- Логика grace period и прогрессивной ликвидации полностью неэффективна
- Фаза EMERGENCY (рыночное закрытие) также не работает

---

## МЕТОДОЛОГИЯ ТЕСТИРОВАНИЯ

### 1. Настройка мониторинга
- **Скрипт:** `scripts/aged_position_monitor.py` (450 строк)
- **Частота:** Итерации каждые 5 секунд
- **Снимки:** Каждые 30 секунд (собрано 19 снимков)
- **Собранные данные:** 8,525 записей состояния позиций
- **Независимый симулятор:** Валидирует расчёты aged-логики

### 2. Продакшн-бот
- **Режим:** TESTNET с продакшн-конфигурацией
- **Биржи:** Binance + Bybit
- **Позиции:** 86 активных позиций (82 старых)
- **Конфигурация:**
  - `MAX_POSITION_AGE_HOURS=3`
  - `AGED_GRACE_PERIOD_HOURS=8`
  - `AGED_LOSS_STEP_PERCENT=0.5`
  - `AGED_MAX_LOSS_PERCENT=10.0`
  - `AGED_ACCELERATION_FACTOR=1.2`
  - `COMMISSION_PERCENT=0.1`

---

## ДЕТАЛЬНЫЕ НАХОДКИ

### КРИТИЧЕСКИЙ БАГ #1: Неправильное размещение лимитных ордеров

**Файл:** `core/aged_position_manager.py:319-380`
**Метод:** `_update_single_exit_order()`
**Серьёзность:** КРИТИЧЕСКАЯ ⚠️

#### Описание проблемы
Модуль использует LIMIT-ордера для закрытия старых позиций по рассчитанным целевым ценам. Однако правила биржи требуют:
- **BUY LIMIT:** Цена должна быть НИЖЕ текущей рыночной цены
- **SELL LIMIT:** Цена должна быть ВЫШЕ текущей рыночной цены

Модуль нарушает эти правила когда:
1. **SHORT позиции в прибыли:** Целевая цена ВЫШЕ рынка (пытается купить дорого)
2. **LONG позиции в убытке:** Целевая цена НИЖЕ рынка (пытается продать дёшево)

#### Доказательства - Пример: AEROUSDT

```
Символ: AEROUSDT
Сторона: SHORT
Вход: $0.7947
Текущая: $0.7353 (позиция в прибыли!)
Цель: $0.7931 (безубыток + комиссия)
Фаза: GRACE_PERIOD_BREAKEVEN (2.3/8ч)
Возраст: 5.3ч (2.3ч сверх лимита)

Попытка действия: BUY LIMIT по $0.7931
Результат: ОТКЛОНЕНО Binance
Ошибка: {"code":-4016,"msg":"Limit price can't be higher than 0.7720058."}
```

**Анализ:**
- Для закрытия SHORT, боту нужно КУПИТЬ
- Текущий рынок: $0.7353
- Бот пытается BUY LIMIT по $0.7931 (на 8% ВЫШЕ рынка)
- Binance отклоняет: BUY LIMIT должен быть НИЖЕ рынка
- **Позиция остаётся открытой бесконечно**

#### Статистика ошибок
- **Всего ошибок ордеров:** 81
- **Нарушений лимита цены:** 486
- **Процент успеха:** 0%
- **Закрыто позиций:** 0 из 82

#### Затронутый участок кода

```python
# core/aged_position_manager.py:355-361
order = await enhanced_manager.create_or_update_exit_order(
    symbol=position.symbol,
    side=order_side,  # 'buy' для SHORT, 'sell' для LONG
    amount=abs(float(position.quantity)),
    price=precise_price,  # ← ПРОБЛЕМА: Использует LIMIT ордер
    min_price_diff_pct=0.5
)
```

#### Анализ корневой причины

Модуль реализует три фазы ликвидации:

**1. GRACE PERIOD (0-8ч после максимального возраста):**
```python
# Строки 274-277
if position.side in ['long', 'buy']:
    target_price = entry_price * (1 + double_commission)  # Продать ВЫШЕ
else:  # short/sell
    target_price = entry_price * (1 - double_commission)  # Купить НИЖЕ
```

**Проблема:**
- SHORT: Пытается купить по цене НИЖЕ входа
- Если рынок упал (прибыль), цель ВЫШЕ текущего рынка → НЕДОПУСТИМЫЙ LIMIT ОРДЕР

**2. ФАЗА PROGRESSIVE (8-28ч после максимального возраста):**
```python
# Строки 299-302
if position.side in ['long', 'buy']:
    target_price = entry_price * (1 - loss_percent / 100)  # Продать НИЖЕ (принять убыток)
else:  # short/sell
    target_price = entry_price * (1 + loss_percent / 100)  # Купить ВЫШЕ (принять убыток)
```

**Проблема:**
- SHORT: Пытается купить по цене ВЫШЕ входа (принимая убыток)
- Если рынок вырос (убыток), это работает
- Если рынок упал (прибыль), цель всё ещё ВЫШЕ рынка → НЕДОПУСТИМЫЙ LIMIT ОРДЕР

**3. ФАЗА EMERGENCY (28ч+ после максимального возраста):**
```python
# Строки 307-309
target_price = current_price_decimal
phase = "EMERGENCY_MARKET_CLOSE"
```

**Проблема:**
- Устанавливает цель = текущей рыночной цене
- Всё ещё использует LIMIT ордер по рыночной цене
- Для быстро движущихся рынков это сразу же терпит неудачу

---

### КРИТИЧЕСКИЙ БАГ #2: Нет отката к рыночным ордерам

**Файл:** `core/aged_position_manager.py:319-380`
**Серьёзность:** КРИТИЧЕСКАЯ ⚠️

#### Описание проблемы
После отклонения LIMIT ордера, модуль логирует ошибку, но НЕ предпринимает корректирующих действий:
```python
except ImportError:
    logger.warning("Enhanced ExchangeManager not available, using standard method")
    # ... fallback код ...
```

**Но НЕТ обработки исключений для ошибок BadRequest от биржи!**

#### Доказательства
Из логов (строка 355 в aged_position_manager.py):
```
2025-10-17 17:56:21,606 - core.aged_position_manager - ERROR - Error updating exit order:
binance {"code":-4016,"msg":"Limit price can't be higher than 0.7720058."}
Traceback (most recent call last):
  File ".../core/aged_position_manager.py", line 355, in _update_single_exit_order
    order = await enhanced_manager.create_or_update_exit_order(...)
  File ".../core/exchange_manager_enhanced.py", line 245, in create_or_update_exit_order
    ...
ccxt.base.errors.BadRequest: binance {"code":-4016,...}
```

**Нет механизма повтора, нет отката к рыночному ордеру, нет альтернативной стратегии.**

---

### СЕРЬЁЗНАЯ ПРОБЛЕМА #1: Фаза Emergency всё ещё использует лимитные ордера

**Файл:** `core/aged_position_manager.py:306-317`
**Серьёзность:** СЕРЬЁЗНАЯ ⚠️

#### Описание проблемы
Фаза EMERGENCY документирована как "market close", но всё ещё использует лимитные ордера:
```python
else:
    # PHASE 3: EMERGENCY - Use current market price
    target_price = current_price_decimal
    phase = "EMERGENCY_MARKET_CLOSE"
```

Комментарий говорит "market close", но реализация использует `target_price` в LIMIT ордере.

#### Доказательства
Из снимка мониторинга:
```json
{
  "symbol": "XDCUSDT",
  "age_hours": "39.47h",
  "phase": "EMERGENCY",
  "target_price": 0.06,
  "should_close": true,
  "reason": "Emergency market close"
}
```

Лог бота показывает те же ошибки LIMIT ордеров для EMERGENCY позиций.

#### Ожидаемое поведение
Фаза EMERGENCY должна:
1. Использовать MARKET ордера для немедленного исполнения
2. Игнорировать толерантность к проскальзыванию для старых позиций
3. Закрывать позицию по любой доступной цене

---

### СЕРЬЁЗНАЯ ПРОБЛЕМА #2: Логика симулятора правильная, логика бота сломана

**Серьёзность:** СЕРЬЁЗНАЯ ⚠️

#### Проверочный тест
Логика симулятора в `scripts/aged_position_monitor.py` правильно рассчитывает:

```python
# Пример AEROUSDT
Вход: $0.7947 (SHORT)
Текущая: $0.7314
Цель (симулятор): $0.7931
Должна закрыться: TRUE
Причина: "Breakeven attempt (5.3/8h)"
```

**Вердикт симулятора:** ✅ Позиция может быть закрыта с прибылью

**Результат бота:** ❌ НЕ УДАЛОСЬ закрыть из-за неправильного типа ордера

#### Расхождение
- **Симулятор:** Правильно определяет возможность закрытия
- **Бот:** Использует неправильный тип ордера, получает отказ
- **Логика:** Расчёт правильный
- **Реализация:** Размещение ордера сломано

---

### УМЕРЕННАЯ ПРОБЛЕМА #1: Нет логики выбора типа ордера

**Файл:** `core/aged_position_manager.py:337-340`
**Серьёзность:** УМЕРЕННАЯ ⚠️

#### Описание проблемы
Сторона ордера определяется правильно:
```python
# Определить сторону ордера (противоположную позиции)
order_side = 'sell' if position.side in ['long', 'buy'] else 'buy'
```

Но НЕТ логики выбора между:
- LIMIT ордерами (для выгодных цен)
- MARKET ордерами (для немедленного исполнения)
- STOP-LIMIT ордерами (для конкретных триггеров)

Все ордера по умолчанию LIMIT независимо от рыночных условий.

---

### УМЕРЕННАЯ ПРОБЛЕМА #2: Отсутствует валидация цены

**Файл:** `core/aged_position_manager.py:341-345`
**Серьёзность:** УМЕРЕННАЯ ⚠️

#### Описание проблемы
Применяется точность цены:
```python
precise_price = self._apply_price_precision(
    float(target_price),
    position.symbol,
    position.exchange
)
```

Но НЕТ валидации что:
1. LIMIT цена соблюдает правила биржи (выше/ниже рынка)
2. Цена в пределах допустимого отклонения от рынка
3. Ордер будет принят перед отправкой

---

### МИНОРНАЯ ПРОБЛЕМА #1: Неточное отслеживание статистики

**Файл:** `core/aged_position_manager.py:369-373`
**Серьёзность:** МИНОРНАЯ ⚠️

#### Проблема
```python
if order.get('_was_updated'):
    self.stats['orders_updated'] += 1
else:
    self.stats['orders_created'] += 1
```

Когда создание ордера терпит неудачу, статистика не отражает отказы. Должно быть:
- `self.stats['orders_failed'] += 1`
- `self.stats['exchange_errors'] += 1`

---

## АНАЛИЗ СНИМКОВ МОНИТОРИНГА

### Прогресс позиций (10-минутный тест)

| Метрика | Начало (t=0) | Конец (t=600с) | Изменение |
|---------|--------------|----------------|-----------|
| Всего старых позиций | 82 | 82 | **0 закрыто** |
| Фаза EMERGENCY | 43 | 43 | 0 |
| Фаза PROGRESSIVE | 15 | 15 | 0 |
| Фаза GRACE_PERIOD | 24 | 24 | 0 |
| Возраст старейшей позиции | 39.3ч | 39.5ч | +0.2ч |
| Закрыто позиций | 0 | 0 | **0%** |

### Накопление ошибок

| Тип ошибки | Количество | Процент |
|------------|------------|---------|
| Всего ERROR логов | 576 | 100% |
| Ошибки aged модуля | 153 | 26.6% |
| Ошибки обновления ордеров | 81 | 14.1% |
| Нарушения лимита цены | 486 | 84.4% |
| Другие ошибки | 90 | 15.6% |

### Метрики производительности

- **Обнаружено старых позиций:** 127 случаев (некоторые повторяются в циклах)
- **Обработано старых позиций:** 91 попытка
- **Попыток exit ордеров:** 81
- **Отказов биржи:** 81 (100% процент отказов)
- **Успешных закрытий:** 0
- **Среднее время обработки:** ~2 секунды на позицию
- **Общее время CPU:** Процесс бота потребил 5 секунд за 10 минут

---

## СРАВНЕНИЕ С ДОКУМЕНТАЦИЕЙ

### Документированное поведение (из TECHNICAL_DOCUMENTATION.md)

> **Aged Position Manager:** Отслеживает возраст позиций и реализует прогрессивную ликвидацию:
> 1. Grace period: Только попытки безубытка
> 2. Progressive: Увеличивающаяся толерантность к убыткам
> 3. Emergency: Рыночное закрытие по текущей цене

### Фактическое поведение

| Фаза | Документация | Реальность | Статус |
|------|--------------|------------|--------|
| Grace Period | "Только попытки безубытка" | Пытается LIMIT ордера, получает отказ | ❌ СЛОМАНО |
| Progressive | "Увеличивающаяся толерантность к убыткам" | Пытается LIMIT ордера, получает отказ | ❌ СЛОМАНО |
| Emergency | "Рыночное закрытие по текущей цене" | Пытается LIMIT ордера, получает отказ | ❌ СЛОМАНО |

**Вердикт:** Реализация НЕ СООТВЕТСТВУЕТ документации. Модуль полностью не функционален.

---

## ШАГИ ВОСПРОИЗВЕДЕНИЯ

### Воспроизведение бага

1. Создать старую позицию (3+ часов)
2. Убедиться, что позиция прибыльная (рынок двигался выгодно)
3. Дождаться цикла aged position manager
4. Наблюдать ошибку в логах:
   ```
   ERROR - Error updating exit order: binance {"code":-4016,"msg":"Limit price can't be higher than X"}
   ```

### Тест-кейс: SHORT позиция в прибыли

```python
# Условия входа
position_side = "short"
entry_price = 1.0000
current_price = 0.9000  # Рынок упал на 10% (прибыль!)
age_hours = 5.0  # 2ч сверх лимита
phase = "GRACE_PERIOD"

# Ожидаемое поведение
target_price = entry_price * (1 - 0.002)  # 0.9980 (безубыток)
should_close = True  # Текущая 0.9000 < Цель 0.9980

# Баг: Бот пытается BUY LIMIT по 0.9980
# Проблема: Текущий рынок 0.9000
# Результат: Binance отклоняет (BUY LIMIT должен быть < 0.9000)
# Позиция: Остаётся открытой бесконечно
```

---

## РЕКОМЕНДУЕМЫЕ ИСПРАВЛЕНИЯ

### ИСПРАВЛЕНИЕ #1: Реализовать правильный выбор типа ордера (КРИТИЧЕСКОЕ)

**Файл:** `core/aged_position_manager.py:319-380`

```python
async def _update_single_exit_order(self, position, target_price: float, phase: str):
    """
    Обновить или создать exit ордер с правильным типом ордера
    """
    try:
        position_id = f"{position.symbol}_{position.exchange}"
        exchange = self.exchanges.get(position.exchange)
        if not exchange:
            logger.error(f"Exchange {position.exchange} not available")
            return

        # Получить текущую рыночную цену
        current_price = await self._get_current_price(position.symbol, position.exchange)
        if not current_price:
            logger.error(f"Could not get current price for {position.symbol}")
            return

        # Определить сторону ордера (противоположную позиции)
        order_side = 'sell' if position.side in ['long', 'buy'] else 'buy'

        # НОВОЕ: Определить правильный тип ордера на основе соотношения цен
        use_market_order = False

        if "EMERGENCY" in phase:
            # EMERGENCY: Всегда использовать рыночный ордер
            use_market_order = True
            logger.info(f"🚨 EMERGENCY закрытие для {position.symbol} - используем MARKET ордер")
        else:
            # Проверить, валидна ли целевая цена для LIMIT ордера
            if order_side == 'buy':
                # BUY ордера: цель должна быть НИЖЕ текущего рынка
                if target_price >= current_price * 0.999:  # Буфер 0.1%
                    logger.warning(
                        f"⚠️ BUY цель ${target_price} слишком близко/выше рынка ${current_price} "
                        f"для {position.symbol} - используем MARKET ордер"
                    )
                    use_market_order = True
            else:  # sell
                # SELL ордера: цель должна быть ВЫШЕ текущего рынка
                if target_price <= current_price * 1.001:  # Буфер 0.1%
                    logger.warning(
                        f"⚠️ SELL цель ${target_price} слишком близко/ниже рынка ${current_price} "
                        f"для {position.symbol} - используем MARKET ордер"
                    )
                    use_market_order = True

        # Выполнить ордер с подходящим типом
        if use_market_order:
            # Использовать MARKET ордер для немедленного исполнения
            order = await self._create_market_exit_order(
                exchange=exchange,
                symbol=position.symbol,
                side=order_side,
                amount=abs(float(position.quantity))
            )
            self.stats['market_orders_created'] += 1
        else:
            # Использовать LIMIT ордер по целевой цене
            precise_price = self._apply_price_precision(
                float(target_price),
                position.symbol,
                position.exchange
            )

            from core.exchange_manager_enhanced import EnhancedExchangeManager
            enhanced_manager = EnhancedExchangeManager(exchange.exchange)

            order = await enhanced_manager.create_or_update_exit_order(
                symbol=position.symbol,
                side=order_side,
                amount=abs(float(position.quantity)),
                price=precise_price,
                min_price_diff_pct=0.5
            )

            if order.get('_was_updated'):
                self.stats['orders_updated'] += 1
            else:
                self.stats['orders_created'] += 1

        if order:
            self.managed_positions[position_id] = {
                'last_update': datetime.now(),
                'order_id': order['id'],
                'phase': phase,
                'order_type': 'MARKET' if use_market_order else 'LIMIT'
            }
            logger.info(
                f"✅ Exit ордер размещён для {position.symbol}: "
                f"{'MARKET' if use_market_order else f'LIMIT @ ${precise_price}'}"
            )

    except ccxt.base.errors.BadRequest as e:
        # Обработать ошибки, специфичные для биржи
        logger.error(f"Биржа отклонила ордер для {position.symbol}: {e}")
        self.stats['orders_failed'] += 1

        # Повторить с рыночным ордером, если лимитный ордер не прошёл
        if "Limit price can't be" in str(e):
            logger.warning(f"🔄 Повторная попытка {position.symbol} с MARKET ордером")
            try:
                order = await self._create_market_exit_order(
                    exchange=exchange,
                    symbol=position.symbol,
                    side=order_side,
                    amount=abs(float(position.quantity))
                )
                if order:
                    logger.info(f"✅ Market ордер успешен для {position.symbol}")
                    self.stats['market_orders_created'] += 1
            except Exception as retry_error:
                logger.error(f"❌ Market ордер также не прошёл для {position.symbol}: {retry_error}")

    except Exception as e:
        logger.error(f"Ошибка обновления exit ордера для {position.symbol}: {e}", exc_info=True)
        self.stats['orders_failed'] += 1
```

### ИСПРАВЛЕНИЕ #2: Добавить метод рыночного ордера (КРИТИЧЕСКОЕ)

**Файл:** `core/aged_position_manager.py` (новый метод)

```python
async def _create_market_exit_order(self, exchange, symbol: str, side: str, amount: float):
    """
    Создать MARKET ордер для немедленного закрытия позиции

    Args:
        exchange: Объект биржи
        symbol: Символ торговой пары
        side: 'buy' или 'sell'
        amount: Количество позиции

    Returns:
        Словарь ордера если успешно, None иначе
    """
    try:
        logger.info(f"📤 Создание MARKET {side} ордера для {symbol}: {amount}")

        # Создать рыночный ордер
        order = await exchange.exchange.create_order(
            symbol=symbol,
            type='market',
            side=side,
            amount=amount,
            params={'reduceOnly': True}  # Убедиться, что только закрываем позицию
        )

        logger.info(
            f"✅ MARKET ордер создан: {order['id']} "
            f"({side} {amount} {symbol})"
        )

        return order

    except Exception as e:
        logger.error(f"Не удалось создать рыночный ордер для {symbol}: {e}", exc_info=True)
        return None
```

### ИСПРАВЛЕНИЕ #3: Добавить отслеживание статистики (УМЕРЕННОЕ)

**Файл:** `core/aged_position_manager.py:__init__`

```python
self.stats = {
    'aged_positions': 0,
    'orders_created': 0,
    'orders_updated': 0,
    'orders_failed': 0,  # НОВОЕ
    'market_orders_created': 0,  # НОВОЕ
    'limit_orders_created': 0,  # НОВОЕ
    'exchange_errors': 0  # НОВОЕ
}
```

### ИСПРАВЛЕНИЕ #4: Обновить логику фазы EMERGENCY (СЕРЬЁЗНОЕ)

**Файл:** `core/aged_position_manager.py:306-317`

```python
else:
    # ФАЗА 3: EMERGENCY - MARKET ордер по текущей цене
    target_price = current_price_decimal
    phase = "EMERGENCY_MARKET_CLOSE"

    # Рассчитать фактический убыток для логирования
    if position.side in ['long', 'buy']:
        loss_percent = ((entry_price - current_price_decimal) / entry_price) * 100
    else:
        loss_percent = ((current_price_decimal - entry_price) / entry_price) * 100

    # КРИТИЧЕСКИ: Принудительно использовать рыночный ордер в фазе emergency
    # (обрабатывается в _update_single_exit_order проверкой "EMERGENCY" в phase)
```

---

## ВЫЯВЛЕННЫЕ ГРАНИЧНЫЕ СЛУЧАИ

### Граничный случай #1: Расчёт возраста позиции
- Обнаружены позиции возрастом 39+ часов, но не закрыты
- Grace period 8ч кажется неэффективным
- Нужно проверить, учитывает ли расчёт возраста разницу часовых поясов

### Граничный случай #2: Ошибки получения цены
Найдено в логах:
```
ERROR - Error fetching price for IDEXUSDT: 'NoneType' object is not subscriptable
ERROR - Could not get price for IDEXUSDT
```

Позиции не могут быть обработаны, если получение цены терпит неудачу. Нужен механизм отката.

### Граничный случай #3: Быстрое движение рынка
Если рынок движется между:
1. Расчётом целевой цены
2. Попыткой размещения ордера

Ордер может не пройти даже с правильной логикой. Нужно:
- Получать свежую цену перед размещением ордера
- Добавить логику повтора с обновлённой ценой

---

## АНАЛИЗ ИНТЕГРАЦИИ

### Зависимости модулей

1. **ExchangeManager:** ✅ Работает (данные позиций получаются корректно)
2. **PositionManager:** ✅ Работает (позиции отслеживаются корректно)
3. **Database:** ✅ Работает (состояние позиций сохраняется)
4. **WebSocket:** ✅ Работает (обновления цен получаются)
5. **Enhanced ExchangeManager:** ⚠️ ЧАСТИЧНО (создание ордеров не работает)

### Проблемы интеграции

**Проблема:** `create_or_update_exit_order()` EnhancedExchangeManager не валидирует цены ордеров перед отправкой.

**Рекомендация:** Добавить предполётную валидацию в `core/exchange_manager_enhanced.py`:

```python
async def create_or_update_exit_order(
    self,
    symbol: str,
    side: str,
    amount: float,
    price: float,
    min_price_diff_pct: float = 0.5
):
    """Создать или обновить exit ордер с валидацией цены"""

    # НОВОЕ: Валидировать цену перед отправкой
    current_price = await self._fetch_current_price(symbol)
    if current_price:
        if side == 'buy' and price >= current_price * 0.999:
            logger.warning(
                f"⚠️ BUY LIMIT цена ${price} слишком близко/выше рынка ${current_price} "
                f"- рассмотрите использование MARKET ордера"
            )
            # Можно авто-корректировать или вернуть None для принуждения к рыночному ордеру
        elif side == 'sell' and price <= current_price * 1.001:
            logger.warning(
                f"⚠️ SELL LIMIT цена ${price} слишком близко/ниже рынка ${current_price} "
                f"- рассмотрите использование MARKET ордера"
            )

    # ... остальной существующий код ...
```

---

## РЕКОМЕНДАЦИИ ПО ТЕСТИРОВАНИЮ

### Необходимые юнит-тесты

1. **Тест выбора типа ордера:**
```python
def test_order_type_selection_buy_above_market():
    """BUY ордер с целью выше рынка должен использовать MARKET ордер"""
    position = create_short_position(entry=1.0, current=0.9)
    target = 0.95  # Выше текущего 0.9
    order_type = determine_order_type(position, target, 0.9)
    assert order_type == "MARKET"
```

2. **Тест валидации цены:**
```python
def test_price_validation_buy_limit():
    """BUY LIMIT должен быть ниже рынка"""
    is_valid = validate_limit_price(side='buy', target=1.1, market=1.0)
    assert is_valid == False
```

3. **Тест переходов фаз:**
```python
def test_emergency_phase_uses_market_order():
    """Фаза emergency должна использовать MARKET ордера"""
    phase = calculate_phase(age_hours=30)  # > 28ч
    order_type = get_order_type_for_phase(phase)
    assert order_type == "MARKET"
```

### Необходимые интеграционные тесты

1. **Тест потока закрытия старой позиции:**
   - Создать старую позицию
   - Запустить aged position manager
   - Проверить выбор типа ордера
   - Проверить размещение ордера
   - Проверить закрытие позиции в БД

2. **Тест восстановления после ошибки:**
   - Симулировать отказ биржи
   - Проверить откат к рыночному ордеру
   - Проверить, что позиция в итоге закрывается

3. **Тест всех трёх фаз:**
   - Grace period с прибыльной позицией
   - Progressive с толерантностью к убыткам
   - Emergency с рыночным ордером

---

## АНАЛИЗ ПРОИЗВОДИТЕЛЬНОСТИ

### Текущая производительность
- **Использование CPU:** Минимальное (5с за 600с)
- **Память:** Стабильная (~80MB)
- **Запросы к БД:** Эффективные (пакетное получение)
- **API вызовы:** ~91 проверка позиций, 81 неудачная попытка ордера

### Узкие места
- **Восстановление после ошибок:** Нет (терпит неудачу и останавливается)
- **Логика повтора:** Отсутствует
- **Валидация ордеров:** Отсутствует (тратит API вызовы)

### Рекомендации по оптимизации
1. Добавить валидацию цены ПЕРЕД отправкой ордера (экономит API вызовы)
2. Реализовать экспоненциальную задержку для повторов
3. Пакетно обрабатывать позиции по биржам для снижения задержки
4. Кэшировать рыночные цены на 5-10 секунд для уменьшения fetch вызовов

---

## СООБРАЖЕНИЯ БЕЗОПАСНОСТИ

### Оценка рисков

1. **Экспозиция позиций:** ВЫСОКАЯ
   - Незакрывающиеся старые позиции означают неограниченную экспозицию
   - 43 позиции в фазе EMERGENCY (39+ часов) неприемлемо
   - Потенциал неограниченных убытков при неблагоприятном движении рынка

2. **Безопасность API ключа:** ОК
   - Учётные данные правильно хранятся в .env
   - Режим TestNet используется правильно

3. **Утечка информации об ошибках:** УМЕРЕННАЯ
   - Логи содержат полные сообщения об ошибках от биржи
   - Рассмотрите санитизацию перед логированием

### Рекомендации
1. Реализовать автоматический выключатель для максимального убытка
2. Добавить оповещения для позиций старше 24ч
3. Рассмотреть требование ручного вмешательства для фазы EMERGENCY
4. Добавить ограничение частоты для предотвращения злоупотребления API во время шторма ошибок

---

## ФИНАЛЬНЫЕ РЕКОМЕНДАЦИИ

### Приоритет 1 (КРИТИЧЕСКИЙ - Реализовать немедленно)
1. ✅ Исправить логику выбора типа ордера (ИСПРАВЛЕНИЕ #1)
2. ✅ Добавить метод рыночного ордера (ИСПРАВЛЕНИЕ #2)
3. ✅ Добавить обработку исключений для ошибок биржи
4. ✅ Реализовать повтор с откатом к рыночному ордеру

### Приоритет 2 (СЕРЬЁЗНЫЙ - Реализовать в течение 24ч)
1. Исправить фазу EMERGENCY для принудительного использования рыночных ордеров
2. Добавить валидацию цены перед отправкой ордера
3. Реализовать оповещение о возрасте позиций (>24ч = критическое оповещение)
4. Добавить юнит-тесты для выбора типа ордера

### Приоритет 3 (УМЕРЕННЫЙ - Реализовать в течение недели)
1. Добавить комплексное отслеживание статистики ошибок
2. Реализовать логику повтора с экспоненциальной задержкой
3. Добавить интеграционные тесты для полного потока закрытия
4. Оптимизировать использование API вызовов с кэшированием цен

### Приоритет 4 (ЖЕЛАТЕЛЬНО)
1. Добавить дашборд для мониторинга старых позиций
2. Реализовать настраиваемые предпочтения типа ордера
3. Добавить возможность ручного переопределения для критических позиций
4. Создать интеграцию вебхука для оповещений

---

## ЗАКЛЮЧЕНИЕ

Модуль управления старыми позициями **ПОЛНОСТЬЮ НЕ ФУНКЦИОНАЛЕН** из-за критического бага в выборе типа ордера. Модуль пытается использовать LIMIT ордера в сценариях, которые нарушают правила биржи, что приводит к 100% проценту отказов при закрытии позиций.

### Ключевые метрики
- **Функциональность:** 0% (не закрыто позиций)
- **Процент ошибок:** 100% (все попытки ордеров не прошли)
- **Качество кода:** УМЕРЕННОЕ (логика правильная, реализация сломана)
- **Соответствие документации:** 0% (документированное поведение не достигнуто)
- **Готовность к продакшену:** ❌ НЕ ГОТОВ

### Требуется немедленное действие
1. **ПРЕКРАТИТЬ использование этого модуля в продакшене** до применения исправлений
2. **Вручную закрыть старые позиции** старше 24 часов
3. **Реализовать ИСПРАВЛЕНИЕ #1 и #2** перед повторным включением
4. **Добавить мониторинговые оповещения** для возраста позиций

### Оценка сложности исправления
- **Изменения кода:** ~100 строк
- **Требуется тестирование:** 2-4 часа
- **Риск развёртывания:** УМЕРЕННЫЙ (затрагивает создание ордеров)
- **План отката:** Полностью отключить aged position manager

---

**Конец отчёта**

*Данные мониторинга и логи доступны в:*
- `/monitoring_data/aged_monitor_*.json` (19 снимков)
- `/bot_output.log` (24,898 строк)
- `/monitoring_output.log` (полная сессия мониторинга)
