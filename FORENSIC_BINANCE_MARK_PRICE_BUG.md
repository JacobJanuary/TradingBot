# üî¥ FORENSIC INVESTIGATION: Binance Mark Price Updates Stopped
**–î–∞—Ç–∞ —Ä–∞—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è**: 2025-10-25
**–°—Ç–∞—Ç—É—Å**: –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –ë–ê–ì –ù–ê–ô–î–ï–ù
**–í–æ–∑–¥–µ–π—Å—Ç–≤–∏–µ**: Trailing Stop –ù–ï —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è 6 –∏–∑ 7 –ø–æ–∑–∏—Ü–∏–π Binance

---

## üìä –°–∏–º–ø—Ç–æ–º—ã –ø—Ä–æ–±–ª–µ–º—ã

### –ñ–∞–ª–æ–±–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
> "–ù–∞ Binance –æ—Ç–∫—Ä—ã—Ç–æ 6 –ø–æ–∑–∏—Ü–∏–π. TS –¥–ª—è –Ω–∏—Ö –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Ü–µ–Ω—ã —É–∂–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç. –°–ø–µ—Ä–≤–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —É –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤ –±—ã–ª–∞, –Ω–æ –∑–∞—Ç–µ–º –æ–Ω–∞ –ø—Ä–æ–ø–∞–ª–∞ —Å–æ–≤—Å–µ–º."

### –ù–∞–±–ª—é–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ
- **–ü–æ–∑–∏—Ü–∏–π –Ω–∞ Binance**: 7 (ZBTUSDT, ZRXUSDT, SFPUSDT, ALICEUSDT, WOOUSDT, REZUSDT, KAITOUSDT)
- **–ü–æ–ª—É—á–∞—é—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è**: 1 (—Ç–æ–ª—å–∫–æ KAITOUSDT)
- **–ù–ï –ø–æ–ª—É—á–∞—é—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è**: 6 (–≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ)
- **–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø—Ä–æ–±–ª–µ–º—ã**: ~4 –º–∏–Ω—É—Ç—ã (—Å 23:21:07)

---

## üîç Timeline —Ä–∞—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è

### –§–∞–∑–∞ 1: –ù–æ—Ä–º–∞–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ (22:51 - 23:21)

#### 22:51:37 - –ü–µ—Ä–≤–∞—è –ø–æ–∑–∏—Ü–∏—è
```
22:51:37 - ‚úÖ [MARK] Subscribed to ZBTUSDT
22:51:42 - ‚úÖ Added ZBTUSDT to tracked positions (total: 1)
```

#### 22:51:51 - –í—Ç–æ—Ä–∞—è –ø–æ–∑–∏—Ü–∏—è
```
22:51:51 - ‚úÖ [MARK] Subscribed to ZRXUSDT
22:51:56 - ‚úÖ Added ZRXUSDT to tracked positions (total: 2)
```

#### 22:52:07 - –¢—Ä–µ—Ç—å—è –ø–æ–∑–∏—Ü–∏—è
```
22:52:07 - ‚úÖ [MARK] Subscribed to SFPUSDT
22:52:11 - ‚úÖ Added SFPUSDT to tracked positions (total: 3)
```

#### 22:52:19 - –ß–µ—Ç–≤—ë—Ä—Ç–∞—è –ø–æ–∑–∏—Ü–∏—è
```
22:52:19 - ‚úÖ [MARK] Subscribed to ALICEUSDT
22:52:23 - ‚úÖ Added ALICEUSDT to tracked positions (total: 4)
```

#### 22:52:29 - –ü—è—Ç–∞—è –ø–æ–∑–∏—Ü–∏—è
```
22:52:29 - ‚úÖ [MARK] Subscribed to WOOUSDT
22:52:33 - ‚úÖ Added WOOUSDT to tracked positions (total: 5)
```

#### 23:05:13 - –®–µ—Å—Ç–∞—è –ø–æ–∑–∏—Ü–∏—è
```
23:05:13 - ‚úÖ [MARK] Subscribed to REZUSDT
23:05:19 - ‚úÖ Added REZUSDT to tracked positions (total: 6)
```

#### 23:19:10 - –°–µ–¥—å–º–∞—è –ø–æ–∑–∏—Ü–∏—è
```
23:19:10 - ‚úÖ [MARK] Subscribed to KAITOUSDT
23:19:15 - ‚úÖ Added KAITOUSDT to tracked positions (total: 7)
```

**‚úÖ –í—Å–µ 7 –ø–æ–∑–∏—Ü–∏–π –ø–æ–¥–ø–∏—Å–∞–Ω—ã –∏ –ø–æ–ª—É—á–∞—é—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è**

---

### –§–∞–∑–∞ 2: –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è (22:46 - 23:21)

#### –ò—Å—Ç–æ—Ä–∏—è –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π Mark Price stream:
```
22:46:13 - [MARK] Reconnecting in 5s...
22:57:30 - [MARK] Reconnecting in 5s...
23:08:18 - [MARK] Reconnecting in 5s...
23:21:07 - [MARK] Reconnecting in 5s...  ‚Üê –ü–û–°–õ–ï–î–ù–ï–ï –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
```

**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ**: –ü–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è WebSocket —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è.

---

### –§–∞–∑–∞ 3: –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –º–æ–º–µ–Ω—Ç (23:21:07)

#### 23:21:07 - Mark Price stream –æ—Ç–∫–ª—é—á–∏–ª—Å—è
```
23:21:07,467 - [MARK] Reconnecting in 5s...
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏–ª–æ –î–û –æ—Ç–∫–ª—é—á–µ–Ω–∏—è:**
```
23:21:01 - position.update: KAITOUSDT, mark_price=1.16060000
23:21:02 - position.update: KAITOUSDT, mark_price=1.16070000
23:21:03 - position.update: KAITOUSDT, mark_price=1.16040539
23:21:04 - position.update: KAITOUSDT, mark_price=1.16090000
23:21:05 - position.update: KAITOUSDT, mark_price=1.16100000
23:21:06 - position.update: KAITOUSDT, mark_price=1.16060000
23:21:07 - position.update: KAITOUSDT, mark_price=1.16075647
```

–¢–æ–ª—å–∫–æ KAITOUSDT –ø–æ–ª—É—á–∞–ª –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (–ø–æ—Å–ª–µ–¥–Ω–∏–π –ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–π —Å–∏–º–≤–æ–ª).

#### 23:21:12 - Mark Price stream –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏–ª—Å—è
```
23:21:12,468 - üåê [MARK] Connecting...
23:21:13,448 - ‚úÖ [MARK] Connected
```

#### 23:21:13+ - –ü–†–û–ë–õ–ï–ú–ê: –ù–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫!
```
[–ù–ï–¢ –õ–û–ì–û–í]
‚úó –ù–µ—Ç "Subscribed to ZBTUSDT"
‚úó –ù–µ—Ç "Subscribed to ZRXUSDT"
‚úó –ù–µ—Ç "Subscribed to SFPUSDT"
‚úó –ù–µ—Ç "Subscribed to ALICEUSDT"
‚úó –ù–µ—Ç "Subscribed to WOOUSDT"
‚úó –ù–µ—Ç "Subscribed to REZUSDT"
‚úó –ù–µ—Ç "Subscribed to KAITOUSDT"
```

**‚ùå –ü–æ—Å–ª–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏ –ù–ï –±—ã–ª–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã!**

---

### –§–∞–∑–∞ 4: –ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è (23:21+ –¥–æ —Å–µ–π—á–∞—Å)

#### –ü–æ–∑–∏—Ü–∏–∏ –≤ –ë–î (–ø—Ä–æ–≤–µ—Ä–∫–∞ –≤ 23:26:32):
```sql
  symbol   | current_price | seconds_since_update
-----------+---------------+----------------------
 KAITOUSDT |    1.16075647 |            85.607374  ‚Üê ~86 —Å–µ–∫—É–Ω–¥ –Ω–∞–∑–∞–¥
 REZUSDT   |    0.01041000 |            85.975045  ‚Üê ~86 —Å–µ–∫—É–Ω–¥ –Ω–∞–∑–∞–¥
 WOOUSDT   |    0.04145000 |            86.347748  ‚Üê ~86 —Å–µ–∫—É–Ω–¥ –Ω–∞–∑–∞–¥
 ALICEUSDT |    0.33043725 |            86.724610  ‚Üê ~86 —Å–µ–∫—É–Ω–¥ –Ω–∞–∑–∞–¥
 SFPUSDT   |    0.38195154 |            87.087771  ‚Üê ~87 —Å–µ–∫—É–Ω–¥ –Ω–∞–∑–∞–¥
 ZRXUSDT   |    0.19740000 |            87.458001  ‚Üê ~87 —Å–µ–∫—É–Ω–¥ –Ω–∞–∑–∞–¥
 ZBTUSDT   |    0.27110000 |            87.833999  ‚Üê ~88 —Å–µ–∫—É–Ω–¥ –Ω–∞–∑–∞–¥
```

**–í—Å–µ –ø–æ–∑–∏—Ü–∏–∏ "–∑–∞–º–æ—Ä–æ–∂–µ–Ω–Ω—ã–µ" –≤ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Ü–µ–Ω–µ –ø–µ—Ä–µ–¥ 23:21:07!**

#### Trailing Stop Manager:
```
TS symbols in memory: ['ZBTUSDT', 'ZRXUSDT', 'SFPUSDT', 'ALICEUSDT', 'WOOUSDT', 'REZUSDT', 'KAITOUSDT']
```

**TS Manager –∂–¥—ë—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π, –Ω–æ –æ–Ω–∏ –Ω–µ –ø—Ä–∏—Ö–æ–¥—è—Ç!**

---

## üêõ Root Cause Analysis

### –ù–∞–π–¥–µ–Ω–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞ –≤ –∫–æ–¥–µ

**–§–∞–π–ª**: `websocket/binance_hybrid_stream.py`
**–ú–µ—Ç–æ–¥**: `async def _run_mark_stream()` (—Å—Ç—Ä–æ–∫–∏ 383-446)

#### –ü—Ä–æ–±–ª–µ–º–Ω—ã–π –∫–æ–¥:
```python
async def _run_mark_stream(self):
    """Run Mark Price Stream (combined stream for all subscribed symbols)"""
    reconnect_delay = 5

    while self.running:
        try:
            # Binance combined streams use /stream endpoint
            url = f"{self.mark_ws_url}/stream"

            logger.info("üåê [MARK] Connecting...")

            # Create session if needed
            if not self.mark_session or self.mark_session.closed:
                timeout = aiohttp.ClientTimeout(total=30, connect=10)
                self.mark_session = aiohttp.ClientSession(timeout=timeout)

            # Connect
            self.mark_ws = await self.mark_session.ws_connect(
                url,
                heartbeat=None,
                autoping=False,
                autoclose=False
            )

            self.mark_connected = True
            logger.info("‚úÖ [MARK] Connected")

            # Reset reconnect delay
            reconnect_delay = 5

            # ‚ùå –ü–†–û–ë–õ–ï–ú–ê: –ù–ï–¢ –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–Ø –ü–û–î–ü–ò–°–û–ö!
            # –ü–æ—Å–ª–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–µ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è

            # Receive loop
            async for msg in self.mark_ws:
                # ... –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
```

### –ü–æ—á–µ–º—É —ç—Ç–æ –∫—Ä–∏—Ç–∏—á–Ω–æ

1. **WebSocket - stateless —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ**: –ü–æ—Å–ª–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —Å–µ—Ä–≤–µ—Ä "–∑–∞–±—ã–≤–∞–µ—Ç" –≤—Å–µ –ø–æ–¥–ø–∏—Å–∫–∏
2. **subscribed_symbols —Ö—Ä–∞–Ω–∏—Ç —Å–ø–∏—Å–æ–∫**: –°–ø–∏—Å–æ–∫ –µ—Å—Ç—å –≤ –ø–∞–º—è—Ç–∏, –Ω–æ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä
3. **subscription_queue –Ω–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç**: –û—á–µ—Ä–µ–¥—å –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã

### –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å working Bybit implementation

–ù—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–∞–∫ Bybit Hybrid –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –ø–æ–¥–ø–∏—Å–∫–∏ –ø–æ—Å–ª–µ reconnect.

---

## üí• –í–æ–∑–¥–µ–π—Å—Ç–≤–∏–µ –Ω–∞ —Å–∏—Å—Ç–µ–º—É

### –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:

1. **Trailing Stop –ù–ï —Ä–∞–±–æ—Ç–∞–µ—Ç**
   - TS Manager –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è mark_price
   - Stop Loss –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è
   - –ü–æ–∑–∏—Ü–∏–∏ –Ω–µ –∑–∞—â–∏—â–µ–Ω—ã –æ—Ç –ø–æ—Ç–µ—Ä—å

2. **Aged Position Monitor –ù–ï —Ä–∞–±–æ—Ç–∞–µ—Ç**
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç current_price –¥–ª—è —Ä–∞—Å—á—ë—Ç–æ–≤
   - "–ó–∞–º–æ—Ä–æ–∂–µ–Ω–Ω–∞—è" —Ü–µ–Ω–∞ –¥–∞—ë—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π PnL
   - –ú–æ–∂–µ—Ç –∑–∞–∫—Ä—ã—Ç—å –ø–æ–∑–∏—Ü–∏–∏ –ø–æ –Ω–µ–≤–µ—Ä–Ω—ã–º –¥–∞–Ω–Ω—ã–º

3. **Position Manager –≤ "—Å–ª–µ–ø—É—é" –∑–æ–Ω—É**
   - unrealized_pnl –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è
   - –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –ø—Ä–∏–Ω–∏–º–∞—Ç—å —Ä–µ—à–µ–Ω–∏—è
   - –ü–æ–∑–∏—Ü–∏–∏ "–∂–∏–≤—É—Ç" —Å —É—Å—Ç–∞—Ä–µ–≤—à–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏

4. **–§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —Ä–∏—Å–∫–∏**
   - –ë–µ–∑ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è Stop Loss –ø–æ–∑–∏—Ü–∏–∏ –º–æ–≥—É—Ç —É–π—Ç–∏ –≥–ª—É–±–∂–µ –≤ –º–∏–Ω—É—Å
   - Trailing Stop –Ω–µ "—Ç—è–Ω–µ—Ç" —Å—Ç–æ–ø –∑–∞ —Ü–µ–Ω–æ–π
   - –†—ã–Ω–æ–∫ –º–æ–∂–µ—Ç —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å—Å—è –ø—Ä–æ—Ç–∏–≤ –ø–æ–∑–∏—Ü–∏–π

### –ó–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ –ø–æ–∑–∏—Ü–∏–∏:
```
ZBTUSDT   - $5.95  (short, -0.22 USDT unrealized PnL)
ZRXUSDT   - $5.98  (short, -0.23 USDT unrealized PnL)
SFPUSDT   - $5.73  (short, -0.15 USDT unrealized PnL)
ALICEUSDT - $5.97  (short, -1.74 USDT unrealized PnL)
WOOUSDT   - $5.97  (short, 0.00 USDT unrealized PnL)
REZUSDT   - $6.00  (long,  0.00 USDT unrealized PnL)

–ò—Ç–æ–≥–æ: ~$35.60 USD –≤ –∑–æ–Ω–µ —Ä–∏—Å–∫–∞
```

---

## üîß Plan –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### –≠—Ç–∞–ø 1: –ö–æ–¥-–∞—É–¥–∏—Ç (‚úÖ COMPLETED)

- [x] –ò—Å—Å–ª–µ–¥–æ–≤–∞—Ç—å –ª–æ–≥–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∑–∞–ø—É—Å–∫–∞
- [x] –ù–∞–π—Ç–∏ –º–æ–º–µ–Ω—Ç –æ—Ç–∫–∞–∑–∞ (23:21:07)
- [x] –ò–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å root cause (–Ω–µ—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–æ–∫)
- [x] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ë–î –∏ –ø–æ–∑–∏—Ü–∏–π
- [x] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å TS Manager state

### –≠—Ç–∞–ø 2: –î–∏–∑–∞–π–Ω —Ä–µ—à–µ–Ω–∏—è

#### –†–µ—à–µ–Ω–∏–µ A: Resubscribe –ø–æ—Å–ª–µ reconnect (–†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø)

**–î–æ–±–∞–≤–∏—Ç—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–æ–∫ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:**

```python
async def _run_mark_stream(self):
    """Run Mark Price Stream (combined stream for all subscribed symbols)"""
    reconnect_delay = 5

    while self.running:
        try:
            # ... –∫–æ–¥ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è ...

            self.mark_connected = True
            logger.info("‚úÖ [MARK] Connected")

            # ‚úÖ FIX: –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫–∏ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
            await self._restore_subscriptions()

            # Reset reconnect delay
            reconnect_delay = 5

            # Receive loop
            async for msg in self.mark_ws:
                # ... –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
```

**–ù–æ–≤—ã–π –º–µ—Ç–æ–¥:**
```python
async def _restore_subscriptions(self):
    """Restore all subscriptions after reconnect"""
    if not self.subscribed_symbols:
        logger.debug("[MARK] No subscriptions to restore")
        return

    logger.info(f"üîÑ [MARK] Restoring {len(self.subscribed_symbols)} subscriptions...")

    for symbol in list(self.subscribed_symbols):
        try:
            # Temporarily remove from set to allow resubscribe
            self.subscribed_symbols.discard(symbol)

            # Resubscribe
            await self._subscribe_mark_price(symbol)

            # Small delay to avoid rate limits
            await asyncio.sleep(0.1)

        except Exception as e:
            logger.error(f"Failed to restore subscription for {symbol}: {e}")

    logger.info(f"‚úÖ [MARK] Restored {len(self.subscribed_symbols)} subscriptions")
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –ü—Ä–æ—Å—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ
- ‚úÖ –ù–µ —Ç—Ä–µ–±—É–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã
- ‚úÖ –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

**–†–∏—Å–∫–∏:**
- ‚ö†Ô∏è –ö–æ—Ä–æ—Ç–∫–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ (~0.7s –¥–ª—è 7 —Å–∏–º–≤–æ–ª–æ–≤)
- ‚ö†Ô∏è –ù—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å rate limits Binance

#### –†–µ—à–µ–Ω–∏–µ B: Keep-alive with ping (–î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–û)

**–£–º–µ–Ω—å—à–∏—Ç—å —á–∞—Å—Ç–æ—Ç—É –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π:**

```python
# –í _run_mark_stream –¥–æ–±–∞–≤–∏—Ç—å heartbeat
self.mark_ws = await self.mark_session.ws_connect(
    url,
    heartbeat=20,  # Ping –∫–∞–∂–¥—ã–µ 20 —Å–µ–∫—É–Ω–¥
    autoping=True,  # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π pong
    autoclose=False
)
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –ú–µ–Ω—å—à–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π
- ‚úÖ –°—Ç–∞–±–∏–ª—å–Ω–µ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ

**–ù–æ**:
- ‚ùå –ù–ï —Ä–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
- ‚ùå –¢–æ–ª—å–∫–æ —É–º–µ–Ω—å—à–∞–µ—Ç —á–∞—Å—Ç–æ—Ç—É

#### –†–µ—à–µ–Ω–∏–µ C: Subscription state tracking (OVER-ENGINEERING)

–•—Ä–∞–Ω–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–¥–ø–∏—Å–æ–∫ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –º–µ–Ω–µ–¥–∂–µ—Ä–µ. **–ù–ï –†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø** –¥–ª—è —Ç–µ–∫—É—â–µ–π –ø—Ä–æ–±–ª–µ–º—ã.

---

### –≠—Ç–∞–ø 3: –†–µ–∞–ª–∏–∑–∞—Ü–∏—è (–†–ï–ö–û–ú–ï–ù–î–£–ï–ú–´–ô –ü–õ–ê–ù)

#### –®–∞–≥ 3.1: –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥ _restore_subscriptions

**–§–∞–π–ª**: `websocket/binance_hybrid_stream.py`

**–ì–¥–µ –≤—Å—Ç–∞–≤–∏—Ç—å**: –ü–æ—Å–ª–µ –º–µ—Ç–æ–¥–∞ `_subscribe_mark_price()` (–æ–∫–æ–ª–æ —Å—Ç—Ä–æ–∫–∏ 545)

**–ö–æ–¥**:
```python
async def _restore_subscriptions(self):
    """Restore all mark price subscriptions after reconnect"""
    if not self.subscribed_symbols:
        logger.debug("[MARK] No subscriptions to restore")
        return

    symbols_to_restore = list(self.subscribed_symbols)
    logger.info(f"üîÑ [MARK] Restoring {len(symbols_to_restore)} subscriptions...")

    # Clear subscribed set to allow resubscribe
    self.subscribed_symbols.clear()

    restored = 0
    for symbol in symbols_to_restore:
        try:
            await self._subscribe_mark_price(symbol)
            restored += 1

            # Small delay to avoid overwhelming the connection
            if restored < len(symbols_to_restore):
                await asyncio.sleep(0.1)

        except Exception as e:
            logger.error(f"‚ùå [MARK] Failed to restore subscription for {symbol}: {e}")

    logger.info(f"‚úÖ [MARK] Restored {restored}/{len(symbols_to_restore)} subscriptions")
```

#### –®–∞–≥ 3.2: –í—ã–∑–≤–∞—Ç—å _restore_subscriptions –ø–æ—Å–ª–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è

**–§–∞–π–ª**: `websocket/binance_hybrid_stream.py`
**–ú–µ—Ç–æ–¥**: `_run_mark_stream()`
**–°—Ç—Ä–æ–∫–∞**: ~408 (–ø–æ—Å–ª–µ `logger.info("‚úÖ [MARK] Connected")`)

**–ò–∑–º–µ–Ω–µ–Ω–∏–µ**:
```python
# –ë–´–õ–û:
self.mark_connected = True
logger.info("‚úÖ [MARK] Connected")

# Reset reconnect delay
reconnect_delay = 5

# –°–¢–ê–õ–û:
self.mark_connected = True
logger.info("‚úÖ [MARK] Connected")

# Restore subscriptions after reconnect
await self._restore_subscriptions()

# Reset reconnect delay
reconnect_delay = 5
```

#### –®–∞–≥ 3.3: (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –î–æ–±–∞–≤–∏—Ç—å heartbeat

**–§–∞–π–ª**: `websocket/binance_hybrid_stream.py`
**–ú–µ—Ç–æ–¥**: `_run_mark_stream()`
**–°—Ç—Ä–æ–∫–∞**: ~400

**–ò–∑–º–µ–Ω–µ–Ω–∏–µ**:
```python
# –ë–´–õ–û:
self.mark_ws = await self.mark_session.ws_connect(
    url,
    heartbeat=None,
    autoping=False,
    autoclose=False
)

# –°–¢–ê–õ–û (–µ—Å–ª–∏ —Ö–æ—Ç–∏–º —Å—Ç–∞–±–∏–ª—å–Ω–µ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ):
self.mark_ws = await self.mark_session.ws_connect(
    url,
    heartbeat=20,      # Ping –∫–∞–∂–¥—ã–µ 20s
    autoping=True,     # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π pong
    autoclose=False
)
```

---

### –≠—Ç–∞–ø 4: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

#### –¢–µ—Å—Ç 4.1: Unit test –¥–ª—è _restore_subscriptions

**–§–∞–π–ª**: –ù–æ–≤—ã–π `tests/unit/test_binance_hybrid_reconnect.py`

```python
import pytest
import asyncio
from unittest.mock import AsyncMock, MagicMock
from websocket.binance_hybrid_stream import BinanceHybridStream


class TestReconnectLogic:
    """Test subscription restoration after reconnect"""

    @pytest.mark.asyncio
    async def test_restore_subscriptions_empty(self):
        """Test restoration with no subscriptions"""
        stream = BinanceHybridStream("key", "secret", testnet=True)

        # No subscriptions
        stream.subscribed_symbols = set()

        # Should not raise error
        await stream._restore_subscriptions()

        assert len(stream.subscribed_symbols) == 0

    @pytest.mark.asyncio
    async def test_restore_subscriptions_single(self):
        """Test restoration with one subscription"""
        stream = BinanceHybridStream("key", "secret", testnet=True)

        # Mock subscribe method
        stream._subscribe_mark_price = AsyncMock()

        # Add one subscription
        stream.subscribed_symbols = {'BTCUSDT'}

        # Restore
        await stream._restore_subscriptions()

        # Verify resubscribed
        stream._subscribe_mark_price.assert_called_once_with('BTCUSDT')
        assert 'BTCUSDT' in stream.subscribed_symbols

    @pytest.mark.asyncio
    async def test_restore_subscriptions_multiple(self):
        """Test restoration with multiple subscriptions"""
        stream = BinanceHybridStream("key", "secret", testnet=True)

        # Mock subscribe method
        stream._subscribe_mark_price = AsyncMock()

        # Add multiple subscriptions
        symbols = {'BTCUSDT', 'ETHUSDT', 'BNBUSDT'}
        stream.subscribed_symbols = symbols.copy()

        # Restore
        await stream._restore_subscriptions()

        # Verify all resubscribed
        assert stream._subscribe_mark_price.call_count == 3
        assert len(stream.subscribed_symbols) == 3

    @pytest.mark.asyncio
    async def test_restore_subscriptions_with_error(self):
        """Test restoration handles errors gracefully"""
        stream = BinanceHybridStream("key", "secret", testnet=True)

        # Mock subscribe method to fail on second symbol
        call_count = 0
        async def mock_subscribe(symbol):
            nonlocal call_count
            call_count += 1
            if call_count == 2:
                raise Exception("Connection error")

        stream._subscribe_mark_price = mock_subscribe

        # Add multiple subscriptions
        stream.subscribed_symbols = {'BTCUSDT', 'ETHUSDT', 'BNBUSDT'}

        # Restore (should not raise)
        await stream._restore_subscriptions()

        # Should have attempted all 3
        assert call_count == 3
```

#### –¢–µ—Å—Ç 4.2: Integration test - —Å–∏–º—É–ª—è—Ü–∏—è reconnect

**–§–∞–π–ª**: `tests/integration/test_binance_hybrid_reconnect.py`

```python
import pytest
import asyncio
from unittest.mock import AsyncMock, patch
from websocket.binance_hybrid_stream import BinanceHybridStream


@pytest.mark.asyncio
async def test_reconnect_restores_subscriptions():
    """Test that subscriptions are restored after reconnect"""
    stream = BinanceHybridStream("key", "secret", testnet=True)

    subscribed_symbols = []

    # Mock _subscribe_mark_price to track calls
    async def mock_subscribe(symbol):
        subscribed_symbols.append(symbol)
        stream.subscribed_symbols.add(symbol)

    stream._subscribe_mark_price = mock_subscribe

    # Simulate initial subscriptions
    await stream._request_mark_subscription('BTCUSDT', subscribe=True)
    await stream._request_mark_subscription('ETHUSDT', subscribe=True)
    await asyncio.sleep(0.2)  # Wait for subscription_manager

    assert len(stream.subscribed_symbols) == 2
    initial_count = len(subscribed_symbols)

    # Simulate reconnect
    await stream._restore_subscriptions()

    # Verify resubscribed
    assert len(subscribed_symbols) == initial_count + 2
    assert 'BTCUSDT' in stream.subscribed_symbols
    assert 'ETHUSDT' in stream.subscribed_symbols
```

#### –¢–µ—Å—Ç 4.3: Manual test - —Ä–µ–∞–ª—å–Ω–æ–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ

**–§–∞–π–ª**: `tests/manual/test_binance_hybrid_reconnect.py`

```python
"""
Manual test to verify reconnection logic
Artificially closes Mark WS and verifies restoration

Usage:
    BINANCE_API_KEY=xxx BINANCE_API_SECRET=yyy python tests/manual/test_binance_hybrid_reconnect.py
"""

import asyncio
import os
import logging
from websocket.binance_hybrid_stream import BinanceHybridStream

logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')
logger = logging.getLogger(__name__)


async def test_reconnect():
    api_key = os.getenv('BINANCE_API_KEY')
    api_secret = os.getenv('BINANCE_API_SECRET')

    if not api_key or not api_secret:
        logger.error("Credentials required")
        return

    events = []

    async def handler(event_type, data):
        events.append((event_type, data))
        logger.info(f"Event: {event_type} | {data.get('symbol')} | {data.get('mark_price')}")

    stream = BinanceHybridStream(api_key, api_secret, handler, testnet=False)

    # Start
    await stream.start()
    await asyncio.sleep(5)

    logger.info("=" * 80)
    logger.info("Phase 1: Initial subscriptions (simulating positions)")
    logger.info("=" * 80)

    # Simulate position opens (trigger subscriptions)
    stream.positions['BTCUSDT'] = {'symbol': 'BTCUSDT', 'side': 'LONG'}
    await stream._request_mark_subscription('BTCUSDT', subscribe=True)
    await asyncio.sleep(2)

    stream.positions['ETHUSDT'] = {'symbol': 'ETHUSDT', 'side': 'LONG'}
    await stream._request_mark_subscription('ETHUSDT', subscribe=True)
    await asyncio.sleep(2)

    logger.info(f"Subscribed symbols: {stream.subscribed_symbols}")
    logger.info(f"Events received: {len(events)}")

    initial_event_count = len(events)

    logger.info("=" * 80)
    logger.info("Phase 2: Force reconnect (close Mark WebSocket)")
    logger.info("=" * 80)

    # Force close Mark WS to simulate reconnect
    if stream.mark_ws:
        await stream.mark_ws.close()
        logger.info("‚úÖ Closed Mark WebSocket")

    # Wait for automatic reconnect
    await asyncio.sleep(10)

    logger.info(f"Mark connected: {stream.mark_connected}")
    logger.info(f"Subscribed symbols after reconnect: {stream.subscribed_symbols}")

    logger.info("=" * 80)
    logger.info("Phase 3: Verify events are flowing again")
    logger.info("=" * 80)

    # Wait for events
    await asyncio.sleep(10)

    new_events = len(events) - initial_event_count
    logger.info(f"New events after reconnect: {new_events}")

    # Stop
    await stream.stop()

    # Summary
    logger.info("=" * 80)
    logger.info("TEST SUMMARY")
    logger.info("=" * 80)
    logger.info(f"Total events: {len(events)}")
    logger.info(f"Events after reconnect: {new_events}")

    if new_events > 0:
        logger.info("‚úÖ TEST PASSED - Events flowing after reconnect")
    else:
        logger.error("‚ùå TEST FAILED - No events after reconnect")


if __name__ == '__main__':
    asyncio.run(test_reconnect())
```

---

### –≠—Ç–∞–ø 5: Deployment

#### 5.1 Pre-deployment checklist
- [ ] –ö–æ–¥ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω (`_restore_subscriptions` –¥–æ–±–∞–≤–ª–µ–Ω)
- [ ] –í—ã–∑–æ–≤ –≤ `_run_mark_stream` –¥–æ–±–∞–≤–ª–µ–Ω
- [ ] Unit tests –ø—Ä–æ–π–¥–µ–Ω—ã
- [ ] Integration tests –ø—Ä–æ–π–¥–µ–Ω—ã
- [ ] Manual reconnect test –ø—Ä–æ–π–¥–µ–Ω
- [ ] Code review completed
- [ ] Git commit —Å–æ–∑–¥–∞–Ω

#### 5.2 Deployment steps
1. –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–æ—Ç–∞
2. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
3. –ó–∞–ø—É—Å—Ç–∏—Ç—å manual reconnect test
4. –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞
5. –ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å –ª–æ–≥–∏ 30 –º–∏–Ω—É—Ç

#### 5.3 Rollback plan
- Backup: –¢–µ–∫—É—â–∏–π –∫–æ–¥ —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ Git
- Rollback: `git revert HEAD`
- Restart bot

---

### –≠—Ç–∞–ø 6: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è

#### –ú–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è:

1. **Mark Price reconnects**:
   ```bash
   grep "MARK.*Reconnecting" logs/trading_bot.log | tail -10
   ```

2. **Subscription restorations**:
   ```bash
   grep "Restoring.*subscriptions" logs/trading_bot.log | tail -10
   ```

3. **Position updates frequency**:
   ```sql
   SELECT symbol,
          COUNT(*) as updates,
          MAX(updated_at) as last_update,
          EXTRACT(EPOCH FROM (NOW() - MAX(updated_at))) as seconds_ago
   FROM monitoring.positions
   WHERE exchange = 'binance' AND status = 'active'
   GROUP BY symbol;
   ```

4. **Trailing Stop activity**:
   ```bash
   grep "TS_DEBUG.*binance" logs/trading_bot.log | tail -20
   ```

#### –û–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –ø–æ—Å–ª–µ —Ñ–∏–∫—Å–∞:

```
23:45:30 - [MARK] Reconnecting in 5s...
23:45:35 - üåê [MARK] Connecting...
23:45:36 - ‚úÖ [MARK] Connected
23:45:36 - üîÑ [MARK] Restoring 7 subscriptions...
23:45:36 - ‚úÖ [MARK] Subscribed to ZBTUSDT
23:45:36 - ‚úÖ [MARK] Subscribed to ZRXUSDT
23:45:36 - ‚úÖ [MARK] Subscribed to SFPUSDT
23:45:37 - ‚úÖ [MARK] Subscribed to ALICEUSDT
23:45:37 - ‚úÖ [MARK] Subscribed to WOOUSDT
23:45:37 - ‚úÖ [MARK] Subscribed to REZUSDT
23:45:37 - ‚úÖ [MARK] Subscribed to KAITOUSDT
23:45:37 - ‚úÖ [MARK] Restored 7/7 subscriptions
23:45:38 - position.update: ZBTUSDT, mark_price=0.27120000
23:45:38 - position.update: ZRXUSDT, mark_price=0.19750000
```

---

## üìã Summary

### –ü—Ä–æ–±–ª–µ–º–∞
–ü–æ—Å–ª–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è Mark Price WebSocket, –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–µ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, —á—Ç–æ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π mark_price –¥–ª—è –≤—Å–µ—Ö –ø–æ–∑–∏—Ü–∏–π –∫—Ä–æ–º–µ –æ–¥–Ω–æ–π.

### Root Cause
–ú–µ—Ç–æ–¥ `_run_mark_stream()` –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–æ–≥–∏–∫–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–æ–∫ –ø–æ—Å–ª–µ reconnect.

### Solution
–î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥ `_restore_subscriptions()` –∏ –≤—ã–∑—ã–≤–∞—Ç—å –µ–≥–æ –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è Mark Price stream.

### Impact
- üî¥ **–ö–†–ò–¢–ò–ß–ù–û**: –ë–µ–∑ —Ñ–∏–∫—Å–∞ Trailing Stop –ù–ï —Ä–∞–±–æ—Ç–∞–µ—Ç
- üü° **–í–´–°–û–ö–ò–ô –†–ò–°–ö**: –ü–æ–∑–∏—Ü–∏–∏ –Ω–µ –∑–∞—â–∏—â–µ–Ω—ã
- üü¢ **–†–ï–®–ê–ï–¢–°–Ø**: –ü—Ä–æ—Å—Ç–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∫–æ–¥–∞

### Effort
- Development: 30 –º–∏–Ω—É—Ç
- Testing: 1 —á–∞—Å
- Deployment: 15 –º–∏–Ω—É—Ç
- Total: ~2 —á–∞—Å–∞

---

**–°—Ç–∞—Ç—É—Å**: READY FOR IMPLEMENTATION
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô
**Assigned to**: Developer
**Deadline**: ASAP
