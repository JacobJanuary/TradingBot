# ‚ö†Ô∏è BYBIT HAS THE SAME SUBSCRIPTION LOSS VULNERABILITY

## üîç Investigation Date
2025-11-03 11:45 UTC

## üìã Summary

**Bybit –∏–º–µ–µ—Ç –¢–û–ß–ù–û –¢–ê–ö–£–Æ –ñ–ï —É—è–∑–≤–∏–º–æ—Å—Ç—å** –∫–∞–∫ –±—ã–ª–∞ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –≤ Binance!

## üêõ Vulnerability Details

### Architecture (bybit_hybrid_stream.py)

```python
# Line 88: Queue-based subscription management
self.subscription_queue = asyncio.Queue()

# Line 523-526: Subscription requests go to queue
async def _request_ticker_subscription(self, symbol: str, subscribe: bool):
    """Request ticker subscription/unsubscription (queued)"""
    await self.subscription_queue.put((symbol, subscribe))

# Line 576-594: Restore ONLY subscribed_tickers (not pending!)
async def _restore_ticker_subscriptions(self):
    """Restore ticker subscriptions after reconnection"""
    if not self.subscribed_tickers:
        return
    
    # Re-subscribe to all tickers
    topics = [f"tickers.{symbol}" for symbol in self.subscribed_tickers]
    # ... restore only confirmed subscriptions
```

### Missing Protection

‚ùå **NO** `pending_subscriptions` set  
‚ùå **NO** persistence of queued subscription requests  
‚ùå **NO** health check to detect lost subscriptions  

### Periodic Reconnection

‚úÖ Bybit **DOES** have periodic reconnection (Line 133, 651):
```python
# ‚úÖ PHASE 2: Periodic reconnection (every 10 minutes)
self.reconnection_task = asyncio.create_task(
    self._periodic_reconnection_task(interval_seconds=600)
)
```

## üéØ Race Condition Scenario

**Exact same timeline as Binance:**

```
T+0.000s: Position opened ‚Üí _request_ticker_subscription(SYMBOL)
T+0.001s: Symbol added to subscription_queue
T+0.002s: Periodic reconnect triggers (every 10 min)
T+0.003s: subscription_queue cleared (new Queue created)
T+0.010s: _restore_ticker_subscriptions() called
          ‚Üí Only restores subscribed_tickers
          ‚Üí Queued subscription LOST FOREVER
Result: Position receives 0 price updates until next restart
```

## üìä Impact Assessment

### Current Bybit Positions: 11

1. PEAQUSDT
2. ESUSDT  
3. BEAMUSDT
4. CROUSDT
5. APEXUSDT
6. SOLAYERUSDT
7. MNTUSDT
8. ETHBTCUSDT
9. HNTUSDT
10. SUNDOGUSDT
11. WAVESUSDT

**Risk Window**: Positions opened within ~3 seconds of periodic reconnect

### Probability Calculation

- Reconnection interval: 600 seconds (10 minutes)
- Vulnerable window: ~3 seconds
- Probability per position: 3/600 = 0.5%
- With 11 positions, risk of at least one affected: ~5.4%

## üîß Solution

Apply **EXACT SAME FIX** as implemented for Binance:

1. Add `self.pending_subscriptions: Set[str] = set()`
2. Mark intent in `_request_ticker_subscription()`
3. Clear from pending after successful subscription
4. Restore both `subscribed_tickers` + `pending_subscriptions`
5. Add periodic health check (every 120s)

### Files to Modify

- `websocket/bybit_hybrid_stream.py` (apply same pattern as binance_hybrid_stream.py)

### Lines to Change

Similar pattern to commit `6a7c34f`:
- Add `pending_subscriptions` to `__init__`
- Modify `_request_ticker_subscription` (line ~523)
- Modify `_subscribe_ticker` (line ~530)
- Modify `_restore_ticker_subscriptions` (line ~576)
- Add `_verify_subscriptions_health` method
- Add `_periodic_health_check_task` method
- Update `start()` and `stop()` methods

## üìù Recommendation

**Priority: MEDIUM**

**Reasoning:**
- Problem is real and confirmed (same architecture as Binance)
- Risk is ~5.4% per 10-minute period with current load
- Fix is proven (working on Binance for 7+ minutes without issues)
- Implementation time: ~15-20 minutes (copy pattern from Binance fix)

**Action:**
1. Monitor Bybit positions for any signs of missing price updates
2. If problem is observed ‚Üí apply fix immediately (–í–´–°–û–ö–ò–ô –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)
3. If no problems ‚Üí apply proactively during next maintenance window (–°–†–ï–î–ù–ò–ô –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)

## üîó References

- Binance fix: commit `6a7c34f`
- Investigation: `PRICE_UPDATE_FAILURE_INVESTIGATION.md`
- Binance implementation: `websocket/binance_hybrid_stream.py:84,690-776`

---

**Status**: üü° VULNERABILITY IDENTIFIED, FIX AVAILABLE, AWAITING DECISION
