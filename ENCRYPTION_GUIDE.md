# Руководство по шифрованию API ключей

## Описание
Система теперь поддерживает шифрование чувствительных данных (API ключи, пароли) для повышения безопасности.

## Быстрый старт

### 1. Установка зависимостей
```bash
pip install cryptography
```

### 2. Шифрование существующих ключей
```bash
python scripts/encrypt_keys.py
```

Выберите опцию 1 для генерации нового мастер-ключа при первом запуске.

### 3. Сохраните мастер-ключ
После шифрования скрипт выведет мастер-ключ:
```
MASTER_KEY=your_generated_master_key_here
```

**ВАЖНО:** Сохраните этот ключ в безопасном месте (менеджер паролей, vault)!

### 4. Использование зашифрованных ключей

#### Вариант 1: Переменная окружения
```bash
export MASTER_KEY=your_master_key_here
python main.py
```

#### Вариант 2: Отдельный файл (НЕ коммитить в git!)
```bash
echo 'MASTER_KEY=your_master_key_here' > .env.master
```

Затем загрузите его в основном скрипте.

## Как это работает

1. **Шифрование**: Чувствительные значения в .env шифруются и сохраняются с префиксом `ENC:`
   ```
   BINANCE_API_KEY=ENC:gAAAAABhZ...encrypted_data...
   ```

2. **Дешифрование**: При запуске бота значения с префиксом `ENC:` автоматически расшифровываются

3. **Поддерживаемые поля**:
   - DB_PASSWORD
   - BINANCE_API_KEY / BINANCE_API_SECRET
   - BYBIT_API_KEY / BYBIT_API_SECRET
   - Webhook URL и токены

## Безопасность

### ✅ Рекомендации:
- Храните мастер-ключ отдельно от кода
- Используйте разные мастер-ключи для dev/staging/production
- Регулярно меняйте мастер-ключ и перешифровывайте данные
- Никогда не коммитьте .env или .env.master в git

### ⚠️ Предупреждения:
- Без мастер-ключа расшифровка невозможна
- Потеря мастер-ключа = потеря доступа к зашифрованным данным
- Всегда делайте резервную копию перед шифрованием (.env.backup)

## Восстановление

Если нужно вернуться к незашифрованным ключам:
1. Восстановите из резервной копии: `cp .env.backup .env`
2. Или расшифруйте вручную с помощью скрипта

## Интеграция

Модули, поддерживающие шифрование:
- `core/exchange_manager.py` - API ключи бирж
- `config/settings.py` - все настройки
- `utils/crypto_manager.py` - основной модуль шифрования

## Troubleshooting

### Ошибка "Decryption failed"
- Проверьте правильность мастер-ключа
- Убедитесь, что значение действительно зашифровано (префикс ENC:)

### Бот не видит API ключи
- Установите переменную MASTER_KEY
- Проверьте, что ключи зашифрованы в .env

### Как проверить, что шифрование работает
```python
from utils.crypto_manager import decrypt_env_value
key = decrypt_env_value('BINANCE_API_KEY')
print(f"Decrypted: {key[:4]}...")  # Покажет первые 4 символа
```