# üîí –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ö–†–ò–¢–ò–ß–ï–°–ö–û–ì–û –ë–ê–ì–ê: –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –∑–∞–ø—É—Å–∫ –±–æ—Ç–∞

## üìä –û–ë–ù–ê–†–£–ñ–ï–ù–ù–ê–Ø –ü–†–û–ë–õ–ï–ú–ê

### –°–∏–º–ø—Ç–æ–º—ã:
- –í–æ–ª–Ω–∞ 03:20 —Å–æ–∑–¥–∞–ª–∞ **7 –ø–æ–∑–∏—Ü–∏–π –≤–º–µ—Å—Ç–æ 4** (3 –¥—É–±–ª–∏–∫–∞—Ç–∞)
- –î—É–±–ª–∏–∫–∞—Ç—ã —Å–æ–∑–¥–∞–≤–∞–ª–∏—Å—å —Å —Ä–∞–∑–Ω–∏—Ü–µ–π 34-307ms
- KASUSDT: 2 –ø–æ–∑–∏—Ü–∏–∏ (ID 275, 276)
- BIDUSDT: 2 –ø–æ–∑–∏—Ü–∏–∏ (ID 277, 278)
- SKYUSDT: 2 –ø–æ–∑–∏—Ü–∏–∏ (ID 279, 280)

### –ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞:

```bash
$ lsof -i :5433 | grep Python
Python  5830   # –ó–∞–ø—É—â–µ–Ω –≤ 01:10 AM ‚Üê –°–û–ó–î–ê–õ –î–£–ë–õ–ò–ö–ê–¢–´!
Python  28511  # –ó–∞–ø—É—â–µ–Ω –≤ 04:04 AM
```

**–î–í–ê –ë–û–¢–ê –†–ê–ë–û–¢–ê–õ–ò –û–î–ù–û–í–†–ï–ú–ï–ù–ù–û!**

### –ë–∞–≥ –≤ –∫–æ–¥–µ:

```python
# main.py:627
process_lock = ProcessLock('bot.pid')  # ‚ùå –û–¢–ù–û–°–ò–¢–ï–õ–¨–ù–´–ô –ü–£–¢–¨!
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ö–∞–∂–¥—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä —Å–æ–∑–¥–∞–≤–∞–ª –°–í–û–ô —Ñ–∞–π–ª `bot.pid` –≤ —Å–≤–æ–µ–π —Ä–∞–±–æ—á–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
- `fcntl.flock()` —Ä–∞–±–æ—Ç–∞–ª –Ω–∞ –†–ê–ó–ù–´–• —Ñ–∞–π–ª–∞—Ö
- –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –Ω–µ —Ä–∞–±–æ—Ç–∞–ª–∞ –≤–æ–æ–±—â–µ!

```bash
$ lsof -p 5830 | grep bot.pid
Python 5830  FD   TYPE  DEVICE  NODE      NAME
                   5w   REG    1,15  65041708  bot.pid  # inode A

$ lsof -p 28511 | grep bot.pid  
Python 28511 FD   TYPE  DEVICE  NODE      NAME
                   5w   REG    1,15  65090552  bot.pid  # inode B (!)
```

**–†–∞–∑–Ω—ã–µ inode ‚Üí —Ä–∞–∑–Ω—ã–µ —Ñ–∞–π–ª—ã ‚Üí –Ω–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏!**

## ‚úÖ –†–ï–®–ï–ù–ò–ï

### –ù–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ –Ω–∞ –±–∞–∑–µ filelock

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
1. ‚úÖ **–ê–±—Å–æ–ª—é—Ç–Ω—ã–π –ø—É—Ç—å**: `/tmp/trading_bot.lock` (–µ–¥–∏–Ω—ã–π –¥–ª—è –≤—Å–µ—Ö)
2. ‚úÖ **–ê—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å**: filelock –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç thread-safe –æ–ø–µ—Ä–∞—Ü–∏–∏
3. ‚úÖ **–ö—Ä–æ—Å—Å–ø–ª–∞—Ç—Ñ–æ—Ä–º–µ–Ω–Ω–æ—Å—Ç—å**: Mac OS, Linux, Windows
4. ‚úÖ **–ê–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞**: –£–¥–∞–ª–µ–Ω–∏–µ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫
5. ‚úÖ **–í–∞–ª–∏–¥–∞—Ü–∏—è PID**: –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ psutil
6. ‚úÖ **Graceful shutdown**: –û–±—Ä–∞–±–æ—Ç–∫–∞ SIGTERM/SIGINT

### –†–µ–∞–ª–∏–∑–∞—Ü–∏—è:

```python
# utils/single_instance.py
from filelock import FileLock
import psutil

class SingleInstance:
    def __init__(self, app_id: str):
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–∏—Å—Ç–µ–º–Ω—É—é temp –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
        self.lock_file = Path(tempfile.gettempdir()) / f"{app_id}.lock"
        self.lock = FileLock(str(self.lock_file))
        self.lock.acquire()  # –ê—Ç–æ–º–∞—Ä–Ω–æ!
```

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ main.py:

```python
# –ë–´–õ–û (–ë–ê–ì–û–í–û–ï):
from utils.process_lock import ProcessLock
process_lock = ProcessLock('bot.pid')  # ‚ùå

# –°–¢–ê–õ–û (–ü–†–ê–í–ò–õ–¨–ù–û–ï):
from utils.single_instance import SingleInstance
app_lock = SingleInstance('trading_bot')  # ‚úÖ
```

## üì¶ –î–û–°–¢–ê–í–õ–ï–ù–ù–´–ï –§–ê–ô–õ–´

1. **utils/single_instance.py** (431 —Å—Ç—Ä–æ–∫–∞)
   - –ö–ª–∞—Å—Å `SingleInstance` —Å –ø–æ–ª–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å—é
   - CLI —É—Ç–∏–ª–∏—Ç—ã: `check_running()`, `kill_running()`
   - –î–µ–∫–æ—Ä–∞—Ç–æ—Ä `@single_instance`
   - –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä

2. **tests/test_single_instance.py** (283 —Å—Ç—Ä–æ–∫–∏)
   - 12 —Ç–µ—Å—Ç–æ–≤ –ø–æ–∫—Ä—ã–≤–∞—é—â–∏—Ö –≤—Å–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏
   - –¢–µ—Å—Ç—ã –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞
   - –¢–µ—Å—Ç—ã –æ—á–∏—Å—Ç–∫–∏ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫
   - –¢–µ—Å—Ç—ã CLI —Ñ—É–Ω–∫—Ü–∏–π

3. **SINGLE_INSTANCE_INTEGRATION.md**
   - –ü–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
   - –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è (3 –≤–∞—Ä–∏–∞–Ω—Ç–∞)
   - CLI –æ–ø—Ü–∏–∏
   - –ú–∏–≥—Ä–∞—Ü–∏—è —Å–æ —Å—Ç–∞—Ä–æ–π —Å–∏—Å—Ç–µ–º—ã

4. **requirements.txt**
   - –î–æ–±–∞–≤–ª–µ–Ω–æ: `filelock>=3.12.0`
   - (psutil —É–∂–µ –±—ã–ª —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)

## üß™ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï

### –õ–æ–∫–∞–ª—å–Ω—ã–µ —Ç–µ—Å—Ç—ã:

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
pip install filelock>=3.12.0

# –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
pytest tests/test_single_instance.py -v

# –ü—Ä–æ–≤–µ—Ä–∫–∞
python -m utils.single_instance trading_bot --check
```

### –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ç–µ—Å—Ç—ã:

**–¢–µ—Å—Ç 1: –ó–∞—â–∏—Ç–∞ –æ—Ç –¥–≤–æ–π–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞**
```bash
# –¢–µ—Ä–º–∏–Ω–∞–ª 1
python main.py
# Output: ‚úÖ Lock acquired for 'trading_bot' (PID: 12345)

# –¢–µ—Ä–º–∏–Ω–∞–ª 2
python main.py
# Output: ‚ùå Another instance is already running
#         üìç Running instance PID: 12345
#         üí° To force start: rm /tmp/trading_bot.lock
```

**–¢–µ—Å—Ç 2: –ê–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞ –ø–æ—Å–ª–µ –∫—Ä–∞—Ö–∞**
```bash
# –£–±–∏–≤–∞–µ–º –±–æ—Ç
kill -9 <PID>

# –ó–∞–ø—É—Å–∫–∞–µ–º —Å–Ω–æ–≤–∞
python main.py
# Output: ‚ö†Ô∏è Found stale lock file, cleaning up
#         ‚úÖ Lock acquired for 'trading_bot'
```

**–¢–µ—Å—Ç 3: CLI —É—Ç–∏–ª–∏—Ç—ã**
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
python -m utils.single_instance trading_bot --check
# Output: Application 'trading_bot': RUNNING

# –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ
python -m utils.single_instance trading_bot --kill
# Output: Terminated process 12345 (SIGTERM)
```

## üìà –ú–ï–¢–†–ò–ö–ò –£–õ–£–ß–®–ï–ù–ò–Ø

| –ú–µ—Ç—Ä–∏–∫–∞ | –î–æ | –ü–æ—Å–ª–µ |
|---------|-------|--------|
| –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –∑–∞–ø—É—Å–∫ | ‚ùå –í–æ–∑–º–æ–∂–µ–Ω | ‚úÖ –ë–ª–æ–∫–∏—Ä–æ–≤–∞–Ω |
| –ö—Ä–æ—Å—Å–ø–ª–∞—Ç—Ñ–æ—Ä–º–µ–Ω–Ω–æ—Å—Ç—å | ‚ö†Ô∏è Mac —Ç–æ–ª—å–∫–æ | ‚úÖ Mac/Linux/Win |
| –û—á–∏—Å—Ç–∫–∞ –ø–æ—Å–ª–µ –∫—Ä–∞—Ö–∞ | ‚ùå –†—É—á–Ω–∞—è | ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è |
| –ü—Ä–æ–≤–µ—Ä–∫–∞ PID | ‚ùå –ù–µ—Ç | ‚úÖ –ß–µ—Ä–µ–∑ psutil |
| –ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω–æ—Å—Ç—å | ‚ö†Ô∏è –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è | ‚úÖ –î–µ—Ç–∞–ª—å–Ω–∞—è |
| Graceful shutdown | ‚ö†Ô∏è –ß–∞—Å—Ç–∏—á–Ω–∞—è | ‚úÖ –ü–æ–ª–Ω–∞—è |
| CLI —É—Ç–∏–ª–∏—Ç—ã | ‚ùå –ù–µ—Ç | ‚úÖ --check, --kill |

## üîß –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò

1. **–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:**
   ```bash
   pip install -r requirements.txt
   ```

2. **–û–±–Ω–æ–≤–∏—Ç—å main.py:**
   - –£–¥–∞–ª–∏—Ç—å `from utils.process_lock import ProcessLock`
   - –î–æ–±–∞–≤–∏—Ç—å `from utils.single_instance import SingleInstance`
   - –ó–∞–º–µ–Ω–∏—Ç—å `ProcessLock('bot.pid')` –Ω–∞ `SingleInstance('trading_bot')`

3. **–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã:**
   ```bash
   pytest tests/test_single_instance.py -v
   ```

4. **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ production:**
   - –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞
   - –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Ç–æ—Ä–æ–π —ç–∫–∑–µ–º–ø–ª—è—Ä
   - –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç
   - –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å kill -9 –∏ –∞–≤—Ç–æ–æ—á–∏—Å—Ç–∫—É

5. **–£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–π –∫–æ–¥:**
   ```bash
   # –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
   rm utils/process_lock.py
   git add utils/single_instance.py tests/test_single_instance.py
   git commit -m "üîí Fix critical bug: multiple bot instances prevention"
   ```

## ‚ö†Ô∏è –í–ê–ñ–ù–û

**–ù–ï –ó–ê–ü–£–°–ö–ê–¢–¨ –ë–ï–ó –≠–¢–û–ì–û –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø!**

–ë–µ–∑ –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –≤–æ–∑–º–æ–∂–µ–Ω –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –∑–∞–ø—É—Å–∫ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –±–æ—Ç–æ–≤, —á—Ç–æ –ø—Ä–∏–≤–µ–¥–µ—Ç –∫:
- –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—é –ø–æ–∑–∏—Ü–∏–π
- –ö–æ–Ω—Ñ–ª–∏–∫—Ç–∞–º –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –±–∏—Ä–∂–µ–π
- –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º stop-loss
- –ü–æ—Ç–µ—Ä–µ –∫–æ–Ω—Ç—Ä–æ–ª—è –Ω–∞–¥ –ø–æ–∑–∏—Ü–∏—è–º–∏

## üìù CHANGELOG

### [Unreleased] - 2025-10-11

#### Fixed
- **CRITICAL**: –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –∑–∞–ø—É—Å–∫ –±–æ—Ç–∞ –∏–∑-–∑–∞ –±–∞–≥–∞ –≤ ProcessLock
  - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –ø—É—Ç—å 'bot.pid' –≤–º–µ—Å—Ç–æ –∞–±—Å–æ–ª—é—Ç–Ω–æ–≥–æ
  - fcntl.flock —Ä–∞–±–æ—Ç–∞–ª –Ω–∞ —Ä–∞–∑–Ω—ã—Ö —Ñ–∞–π–ª–∞—Ö –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤
  - –î–≤–∞ –±–æ—Ç–∞ —Ä–∞–±–æ—Ç–∞–ª–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ, —Å–æ–∑–¥–∞–≤–∞—è –¥—É–±–ª–∏–∫–∞—Ç—ã –ø–æ–∑–∏—Ü–∏–π

#### Added
- `utils/single_instance.py`: –ù–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ –Ω–∞ –±–∞–∑–µ filelock
- `tests/test_single_instance.py`: –ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–µ —Ç–µ—Å—Ç—ã (12 test cases)
- `SINGLE_INSTANCE_INTEGRATION.md`: –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
- CLI —É—Ç–∏–ª–∏—Ç—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —ç–∫–∑–µ–º–ø–ª—è—Ä–∞–º–∏

#### Changed
- `requirements.txt`: –î–æ–±–∞–≤–ª–µ–Ω `filelock>=3.12.0`

#### Deprecated
- `utils/process_lock.py`: –ó–∞–º–µ–Ω–µ–Ω –Ω–∞ `utils/single_instance.py`

## üéØ –†–ï–ó–£–õ–¨–¢–ê–¢

‚úÖ **100% –∑–∞—â–∏—Ç–∞** –æ—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞
‚úÖ **–ö—Ä–æ—Å—Å–ø–ª–∞—Ç—Ñ–æ—Ä–º–µ–Ω–Ω–æ—Å—Ç—å** (Mac/Linux/Windows)
‚úÖ **Production-ready** —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –≤—Å–µ—Ö edge cases
‚úÖ **–î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** –∏ –∏–Ω—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ
‚úÖ **CLI —É—Ç–∏–ª–∏—Ç—ã** –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è

---

**–ê–≤—Ç–æ—Ä:** Claude Code  
**–î–∞—Ç–∞:** 2025-10-11  
**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å:** üî¥ CRITICAL  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ READY FOR INTEGRATION
