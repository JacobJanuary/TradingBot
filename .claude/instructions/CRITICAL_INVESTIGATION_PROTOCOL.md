# CRITICAL INVESTIGATION PROTOCOL
## ОБЯЗАТЕЛЬНАЯ ИНСТРУКЦИЯ - ПРИМЕНЯТЬ ВСЕГДА

---

## ⚠️ КРИТИЧЕСКИ ВАЖНО ⚠️

**ЭТА ИНСТРУКЦИЯ ОБЯЗАТЕЛЬНА ДЛЯ ВЫПОЛНЕНИЯ В ЛЮБОЙ СИТУАЦИИ**

Когда проводишь investigation, debugging, или создаешь fix:

---

## ОБЯЗАТЕЛЬНЫЙ ПОРЯДОК ДЕЙСТВИЙ

### 1. ЧИТАЮ TEST RESULTS ПОЛНОСТЬЮ
- **НЕ** бегло просматриваю
- **НЕ** выхватываю отдельные куски
- Читаю ВЕСЬ output от начала до конца
- Читаю ВСЕ JSON поля
- Читаю ВСЕ error messages

### 2. ПРОВЕРЯЮ КАЖДОЕ ПОЛЕ 3 РАЗА
- Первый раз: понять что это
- Второй раз: понять как используется
- Третий раз: понять edge cases

**Проверяю:**
- Форматы данных (dict vs object vs dataclass)
- Форматы символов ("GIGAUSDT" vs "GIGA/USDT:USDT")
- Форматы значений ("Sell" vs "sell" vs "short")
- Наличие/отсутствие полей (null, None, missing key)
- Типы данных (string, number, bool)

### 3. СОЗДАЮ ПОЛНЫЙ ПЛАН С УЧЕТОМ ВСЕХ ДЕТАЛЕЙ
- Документирую ВСЕ найденные особенности
- Продумываю edge cases
- Проверяю совместимость с existing code
- Планирую error handling
- **НЕ ПИШУ КОД БЕЗ ПЛАНА!**

### 4. ПРОВЕРЯЮ ПЛАН 3 РАЗА
- Первый раз: логическая корректность
- Второй раз: совместимость с existing code
- Третий раз: edge cases и error handling

### 5. ТОЛЬКО ПОТОМ ПИШУ КОД
- Следую плану строго
- НЕ добавляю "улучшения" на ходу
- НЕ упрощаю "для скорости"
- НЕ делаю assumptions

---

## ПРИМЕРЫ ОШИБОК ИЗ-ЗА НЕВЫПОЛНЕНИЯ ПРОТОКОЛА

### ❌ ПЛОХО: Поспешная реализация
```python
# Увидел pos['symbol'] в test results
# Сразу написал код
if pos['symbol'] == symbol:
    # ОШИБКА! pos['symbol'] = "GIGA/USDT:USDT"
    # а symbol = "GIGAUSDT"
```

### ✅ ХОРОШО: Следование протоколу
```
1. Читаю test results полностью
2. Вижу:
   - pos['symbol'] = "GIGA/USDT:USDT" (CCXT format)
   - pos['info']['symbol'] = "GIGAUSDT" (raw Bybit format)
3. Проверяю 3 раза:
   - Какой формат использует мой код? "GIGAUSDT"
   - Какое поле совпадает? pos['info']['symbol']
   - Есть ли edge cases? Проверяю наличие 'info' key
4. Создаю план:
   - Использовать pos.get('info', {}).get('symbol', '')
   - Сравнивать с symbol
5. Проверяю план 3 раза
6. Пишу код
```

---

## КОНТРОЛЬНЫЕ ВОПРОСЫ ПЕРЕД НАПИСАНИЕМ КОДА

**ОБЯЗАТЕЛЬНО ОТВЕТИТЬ НА ВСЕ:**

1. ✅ Прочитал ли я test results ПОЛНОСТЬЮ?
2. ✅ Проверил ли я КАЖДОЕ поле 3 раза?
3. ✅ Создал ли я ПОЛНЫЙ план?
4. ✅ Проверил ли я план 3 раза?
5. ✅ Учел ли я ВСЕ edge cases из test results?
6. ✅ Проверил ли я форматы данных?
7. ✅ Проверил ли я типы данных (dict/object/dataclass)?
8. ✅ Проверил ли я symbol formats?
9. ✅ Проверил ли я value formats (case sensitivity)?
10. ✅ Готов ли я объяснить КАЖДУЮ строку кода?

**Если хотя бы на ОДИН вопрос ответ "НЕТ" - НЕ ПИШУ КОД!**

---

## ПОСЛЕДСТВИЯ НЕВЫПОЛНЕНИЯ ПРОТОКОЛА

**Реальный пример (2025-10-29):**

- Не проверил test results 3 раза
- Пропустил pos['symbol'] vs pos['info']['symbol']
- Написал код с ошибкой
- Результат: 3 wave cycles потрачены впустую
- Phantom positions продолжают создаваться
- Потеря доверия пользователя

**ВЫВОД:** Следование протоколу экономит время, не тратит!

---

## КОГДА ПРИМЕНЯТЬ

**ВСЕГДА когда:**
- Провожу investigation
- Делаю debugging
- Создаю fix
- Анализирую logs
- Пишу test
- Делаю ANY code changes связанные с bug fixing

**НЕТ ИСКЛЮЧЕНИЙ!**

---

## ПРИОРИТЕТ

Этот протокол имеет **НАИВЫСШИЙ ПРИОРИТЕТ**.

Если есть конфликт с другими инструкциями - этот протокол ВАЖНЕЕ.

---

## АВТОР

User requirement from 2025-10-29
Context: Bybit position opening failures investigation

---

END OF CRITICAL PROTOCOL
