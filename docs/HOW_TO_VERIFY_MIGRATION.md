# –ö–∞–∫ –û—Ç—Å–ª–µ–¥–∏—Ç—å –ß—Ç–æ –ë–æ—Ç –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ –ë–î

**–í–æ–ø—Ä–æ—Å**: –ö–∞–∫ –æ—Ç—Å–ª–µ–¥–∏—Ç—å —á—Ç–æ –±–æ—Ç —Ä–µ–∞–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ –±–∞–∑—ã? –≠—Ç–æ –±—É–¥–µ—Ç –≤–∏–¥–Ω–æ –≤ –ª–æ–≥–∞—Ö? –ö–∞–∫ –æ—Ç—Å–ª–µ–¥–∏—Ç—å —á—Ç–æ TS –ø—Ä–∞–≤–∏–ª—å–Ω–æ –º–æ–Ω–∏—Ç–æ—Ä–∏—Ç –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –¥–ª—è –∫–∞–∂–¥–æ–π –∏–∑ –ø–æ–∑–∏—Ü–∏–∏ –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö —É—Ä–æ–≤–Ω—è—Ö?

**–û—Ç–≤–µ—Ç**: –î–∞! –£ –Ω–∞—Å –µ—Å—Ç—å 3 —Å–ø–æ—Å–æ–±–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏.

---

## ‚úÖ –°–ø–æ—Å–æ–± 1: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ü—Ä–æ–≤–µ—Ä–∫–∞ (–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

### –°–∫—Ä–∏–ø—Ç –ü—Ä–æ–≤–µ—Ä–∫–∏ –ë–î –∏ –°–æ—Å—Ç–æ—è–Ω–∏—è

```bash
python tools/verify_params_migration.py
```

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç**:
- ‚úÖ monitoring.params —Å–æ–¥–µ—Ä–∂–∏—Ç —Ä–∞–∑–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è Binance –∏ Bybit
- ‚úÖ monitoring.positions –∏–º–µ–µ—Ç –∫–æ–ª–æ–Ω–∫–∏ trailing_activation_percent –∏ trailing_callback_percent
- ‚úÖ –ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏ —Å–æ—Ö—Ä–∞–Ω–∏–ª–∏ trailing params
- ‚úÖ –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç .env config –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è

**–í—ã–≤–æ–¥**:
```
üìä STEP 1: Checking monitoring.params (per-exchange parameters)
+----+----------+---------+-----------------+---------------+
| ID | Exchange | SL %    | TS Activation % | TS Callback % |
+====+==========+=========+=================+===============+
| 1  | binance  | 4.0000% | 2.0000%         | 0.5000%       |
| 2  | bybit    | 6.0000% | 2.5000%         | 0.5000%       |
+----+----------+---------+-----------------+---------------+

‚úÖ CONFIRMED: Different SL% - Binance: 4.0000% vs Bybit: 6.0000%
‚úÖ CONFIRMED: Different TS Activation% - Binance: 2.0000% vs Bybit: 2.5000%
```

**–ß—Ç–æ –∏—Å–∫–∞—Ç—å**:
- ‚úÖ "‚úÖ CONFIRMED: Different SL%" - –∑–Ω–∞—á–∏—Ç per-exchange –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –µ—Å—Ç—å
- ‚úÖ "‚úÖ CONFIRMED: Different TS Activation%" - –∑–Ω–∞—á–∏—Ç trailing params —Ä–∞–∑–Ω—ã–µ
- ‚ùå "No data in monitoring.params" - –ü–†–û–ë–õ–ï–ú–ê! –ë–î –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞

---

## ‚úÖ –°–ø–æ—Å–æ–± 2: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ê–∫—Ç–∏–≤–∞—Ü–∏–π –≤ –†–µ–∞–ª—å–Ω–æ–º –í—Ä–µ–º–µ–Ω–∏

### –°–∫—Ä–∏–ø—Ç –ñ–∏–≤–æ–≥–æ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ TS

```bash
python tools/monitor_ts_activations.py
```

**–ß—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç** (–æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥):
- üî¥ –¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞ vs —Ü–µ–Ω–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏
- üî¥ –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ (%)
- üî¥ **–û–¢–ö–£–î–ê –í–ó–Ø–¢–´ –ü–ê–†–ê–ú–ï–¢–†–´** (DB vs .env)

**–í—ã–≤–æ–¥**:
```
üìä Exchange: BINANCE
   DB Params: activation=2.0%, callback=0.5%

+----------+------+---------------+------------------+----------------+---------------------+
| Symbol   | Side | Current Price | Activation Price | Distance       | Activation % Source |
+==========+======+===============+==================+================+=====================+
| BTCUSDT  | LONG | 67891.23      | 69249.05         | ‚ö™ 2.00%       | ‚úÖ DB (2.0%)        |
| ETHUSDT  | LONG | 3298.45       | 3310.58          | üü° 0.37%       | ‚úÖ DB (2.0%)        |
+----------+------+---------------+------------------+----------------+---------------------+

üìä Exchange: BYBIT
   DB Params: activation=2.5%, callback=0.5%

+----------+------+---------------+------------------+----------------+---------------------+
| Symbol   | Side | Current Price | Activation Price | Distance       | Activation % Source |
+==========+======+===============+==================+================+=====================+
| SOLUSDT  | LONG | 145.80        | 146.06           | üî• 0.18%       | ‚úÖ DB (2.5%)        |
+----------+------+---------------+------------------+----------------+---------------------+
```

**–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û**:
- ‚úÖ **"‚úÖ DB (2.0%)"** - –ü–†–ê–í–ò–õ–¨–ù–û! –ë–æ—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ monitoring.params
- ‚úÖ **"üìå Position (2.0%)"** - –û–ö! –ë–æ—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç per-position –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (Variant B)
- ‚ùå **"‚ö†Ô∏è  Config (3.0%)"** - –ü–õ–û–•–û! –ë–æ—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç .env fallback (–º–∏–≥—Ä–∞—Ü–∏—è –ù–ï —Ä–∞–±–æ—Ç–∞–µ—Ç!)

**–û–±—Ä–∞—Ç–∏ –≤–Ω–∏–º–∞–Ω–∏–µ**:
- Binance positions –¥–æ–ª–∂–Ω—ã –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å: **2.0%** activation
- Bybit positions –¥–æ–ª–∂–Ω—ã –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å: **2.5%** activation
- –ï—Å–ª–∏ –≤—Å–µ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, 3.0%) ‚Üí –±–æ—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç .env ‚Üí –ü–†–û–ë–õ–ï–ú–ê!

---

## ‚úÖ –°–ø–æ—Å–æ–± 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ –õ–æ–≥–æ–≤

### –õ–æ–≥–∏ –ü—Ä–∏ –û—Ç–∫—Ä—ã—Ç–∏–∏ –ü–æ–∑–∏—Ü–∏–∏

**–ö–æ–º–∞–Ω–¥–∞**:
```bash
tail -f logs/bot.log | grep "üìä Using trailing"
```

**–ü–†–ê–í–ò–õ–¨–ù–´–ô –≤—ã–≤–æ–¥** (–∫–æ–≥–¥–∞ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è Binance –ø–æ–∑–∏—Ü–∏—è):
```
2025-10-28 15:30:45 [DEBUG] üìä Using trailing_activation_filter from DB for binance: 2.0%
2025-10-28 15:30:45 [DEBUG] üìä Using trailing_distance_filter from DB for binance: 0.5%
```

**–ü–†–ê–í–ò–õ–¨–ù–´–ô –≤—ã–≤–æ–¥** (–∫–æ–≥–¥–∞ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è Bybit –ø–æ–∑–∏—Ü–∏—è):
```
2025-10-28 15:30:50 [DEBUG] üìä Using trailing_activation_filter from DB for bybit: 2.5%
2025-10-28 15:30:50 [DEBUG] üìä Using trailing_distance_filter from DB for bybit: 0.5%
```

**üî¥ RED FLAG** (–º–∏–≥—Ä–∞—Ü–∏—è –ù–ï —Ä–∞–±–æ—Ç–∞–µ—Ç):
```
2025-10-28 15:30:45 [WARNING] ‚ö†Ô∏è  trailing_activation_filter not in DB for binance, using .env fallback: 3.0%
```

–ï—Å–ª–∏ –≤–∏–¥–∏—à—å —ç—Ç–æ WARNING ‚Üí –∑–Ω–∞—á–∏—Ç:
- ‚ùå monitoring.params –ø—É—Å—Ç–∞—è –∏–ª–∏ NULL
- ‚ùå –ë–æ—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—Ç–∞—Ä—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ .env
- ‚ùå –ú–∏–≥—Ä–∞—Ü–∏—è –ø—Ä–æ–≤–∞–ª–∏–ª–∞—Å—å

---

### –õ–æ–≥–∏ –ü—Ä–∏ –°–æ–∑–¥–∞–Ω–∏–∏ Trailing Stop

**–ö–æ–º–∞–Ω–¥–∞**:
```bash
tail -f logs/bot.log | grep "Using per-position trailing params"
```

**–ü–†–ê–í–ò–õ–¨–ù–´–ô –≤—ã–≤–æ–¥**:
```
2025-10-28 15:30:46 [DEBUG] üìä BTCUSDT: Using per-position trailing params: activation=2.0%, callback=0.5%
2025-10-28 15:30:51 [DEBUG] üìä SOLUSDT: Using per-position trailing params: activation=2.5%, callback=0.5%
```

**üî¥ RED FLAG**:
```
2025-10-28 15:30:46 [DEBUG] üìä BTCUSDT: Using config trailing params (fallback): activation=3.0%, callback=1.0%
```

–ï—Å–ª–∏ –≤–∏–¥–∏—à—å "Using config trailing params (fallback)" ‚Üí –∑–Ω–∞—á–∏—Ç:
- ‚ùå –ü–æ–∑–∏—Ü–∏—è –Ω–µ —Å–æ—Ö—Ä–∞–Ω–∏–ª–∞ trailing params –≤ –ë–î
- ‚ùå create_trailing_stop() –Ω–µ –ø–æ–ª—É—á–∏–ª position_params
- ‚ùå TS –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—Ç–∞—Ä—É—é –ª–æ–≥–∏–∫—É (.env)

---

## üéØ –ö—Ä–∞—Ç–∫–∏–π –ß–µ–∫–ª–∏—Å—Ç

### ‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è –†–ê–ë–û–¢–ê–ï–¢ –µ—Å–ª–∏:

1. **–í –ë–î**:
   ```bash
   python tools/verify_params_migration.py
   ```
   - ‚úÖ –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –†–ê–ó–ù–´–ï –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è Binance –∏ Bybit
   - ‚úÖ –ù–æ–≤—ã–µ –ø–æ–∑–∏—Ü–∏–∏ –∏–º–µ—é—Ç non-NULL trailing params

2. **–í –õ–æ–≥–∞—Ö**:
   ```bash
   grep "üìä Using trailing_activation_filter from DB" logs/bot.log
   ```
   - ‚úÖ –í–∏–¥–∏—à—å "from DB for binance: 2.0%"
   - ‚úÖ –í–∏–¥–∏—à—å "from DB for bybit: 2.5%" (–†–ê–ó–ù–´–ï!)
   - ‚ùå –ù–ï –≤–∏–¥–∏—à—å "using .env fallback"

3. **–í –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–µ**:
   ```bash
   python tools/monitor_ts_activations.py
   ```
   - ‚úÖ –í—Å–µ –ø–æ–∑–∏—Ü–∏–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç "‚úÖ DB (X%)"
   - ‚úÖ Binance: 2.0%, Bybit: 2.5% (–†–ê–ó–ù–´–ï!)

---

### ‚ùå –ú–∏–≥—Ä–∞—Ü–∏—è –ù–ï –†–ê–ë–û–¢–ê–ï–¢ –µ—Å–ª–∏:

1. **–í –õ–æ–≥–∞—Ö –≤–∏–¥–∏—à—å**:
   - ‚ùå "‚ö†Ô∏è  trailing_activation_filter not in DB, using .env fallback"
   - ‚ùå "Using config trailing params (fallback)"
   - ‚ùå –û–¥–∏–Ω–∞–∫–æ–≤—ã–µ –ø—Ä–æ—Ü–µ–Ω—Ç—ã –¥–ª—è Binance –∏ Bybit

2. **–í –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–µ –≤–∏–¥–∏—à—å**:
   - ‚ùå "‚ö†Ô∏è  Config (3.0%)" –≤–º–µ—Å—Ç–æ "‚úÖ DB (2.0%)"
   - ‚ùå –í—Å–µ –ø–æ–∑–∏—Ü–∏–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è

3. **–í –ë–î**:
   - ‚ùå monitoring.params –ø—É—Å—Ç–∞—è
   - ‚ùå –ù–æ–≤—ã–µ –ø–æ–∑–∏—Ü–∏–∏ –∏–º–µ—é—Ç NULL trailing params

---

## üìù –ü—Ä–∏–º–µ—Ä: –ö–∞–∫ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ü–æ—Å–ª–µ –î–µ–ø–ª–æ—è

### –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä—å –ë–î
```bash
python tools/verify_params_migration.py
```
–î–æ–ª–∂–µ–Ω –ø–æ–∫–∞–∑–∞—Ç—å –†–ê–ó–ù–´–ï –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è Binance (2.0%) –∏ Bybit (2.5%)

### –®–∞–≥ 2: –ó–∞–ø—É—Å—Ç–∏ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
```bash
python tools/monitor_ts_activations.py
```
–û—Å—Ç–∞–≤—å —Ä–∞–±–æ—Ç–∞—Ç—å –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ. –°–ª–µ–¥–∏ –∑–∞ –∫–æ–ª–æ–Ω–∫–æ–π "Activation % Source".

### –®–∞–≥ 3: –û—Ç–∫—Ä–æ–π –ü–æ–∑–∏—Ü–∏—é
–ö–æ–≥–¥–∞ –ø—Ä–∏–¥–µ—Ç —Å–∏–≥–Ω–∞–ª –∏ –æ—Ç–∫—Ä–æ–µ—Ç—Å—è –ø–æ–∑–∏—Ü–∏—è, –ø—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏:
```bash
tail -n 100 logs/bot.log | grep "üìä Using trailing"
```

### –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä—å –†–µ–∑—É–ª—å—Ç–∞—Ç
–î–æ–ª–∂–µ–Ω —É–≤–∏–¥–µ—Ç—å:
```
üìä Using trailing_activation_filter from DB for binance: 2.0%
üìä BTCUSDT: Using per-position trailing params: activation=2.0%, callback=0.5%
```

–ï—Å–ª–∏ –≤–∏–¥–∏—à—å "using .env fallback" –∏–ª–∏ "Using config trailing params" ‚Üí –ü–†–û–ë–õ–ï–ú–ê!

---

## üö® –ß—Ç–æ –î–µ–ª–∞—Ç—å –ï—Å–ª–∏ –í–∏–¥–∏—à—å –ü—Ä–æ–±–ª–µ–º—É?

### –ü—Ä–æ–±–ª–µ–º–∞: "trailing_activation_filter not in DB"

**–ü—Ä–∏—á–∏–Ω–∞**: monitoring.params –ø—É—Å—Ç–∞—è

**–†–µ—à–µ–Ω–∏–µ**:
```sql
-- –ü—Ä–æ–≤–µ—Ä—å monitoring.params
SELECT * FROM monitoring.params;

-- –ï—Å–ª–∏ –ø—É—Å—Ç–∞—è, –≤—Ä—É—á–Ω—É—é –∑–∞–ø–æ–ª–Ω–∏:
INSERT INTO monitoring.params (exchange_id, trailing_activation_filter, trailing_distance_filter, stop_loss_filter, max_trades_filter)
VALUES
    (1, 2.0, 0.5, 4.0, 6),  -- Binance
    (2, 2.5, 0.5, 6.0, 4)   -- Bybit
ON CONFLICT (exchange_id) DO UPDATE SET
    trailing_activation_filter = EXCLUDED.trailing_activation_filter,
    trailing_distance_filter = EXCLUDED.trailing_distance_filter;
```

---

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

**–ü–æ–ª–Ω—ã–π guide**: `docs/PARAMS_MIGRATION_VERIFICATION_GUIDE.md`
- –î–µ—Ç–∞–ª—å–Ω—ã–µ SQL –∑–∞–ø—Ä–æ—Å—ã
- Troubleshooting
- Test scenarios

**–ü–ª–∞–Ω –º–∏–≥—Ä–∞—Ü–∏–∏**: `docs/SL_TS_PARAMS_MIGRATION_ULTRA_DETAILED_PLAN.md`
- –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
- –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–¥–∞
- Rollback procedures

---

**–ò–¢–û–ì**: –£ —Ç–µ–±—è –µ—Å—Ç—å **3 –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞** –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:
1. üîß **verify_params_migration.py** - –ø—Ä–æ–≤–µ—Ä–∫–∞ –ë–î –∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è
2. üìä **monitor_ts_activations.py** - –∂–∏–≤–æ–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ TS (–≤–∏–¥–Ω–æ –æ—Ç–∫—É–¥–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã!)
3. üìù **–õ–æ–≥–∏** - grep –ø–æ –ø–∞—Ç—Ç–µ—Ä–Ω–∞–º –≤—ã—à–µ

–í—Å–µ –ª–æ–≥–∏ —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ –∫–æ–¥, –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –≥–æ—Ç–æ–≤—ã –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!
