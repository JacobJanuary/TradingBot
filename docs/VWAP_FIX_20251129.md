# VWAP DatetimeIndex Fix - 2025-11-29

## Проблема

При тестировании Smart Entry Hunter появилась ошибка:
```
[!] VWAP requires an ordered DatetimeIndex.
```

## Причина

pandas_ta библиотека требует, чтобы DataFrame имел упорядоченный DatetimeIndex, но функция `_candles_to_df()` создавала обычную колонку 'timestamp', а не индекс.

## Решение

Обновлена функция `_candles_to_df()` в `core/smart_entry_hunter.py`:

```python
def _candles_to_df(candles) -> pd.DataFrame:
    """Convert CCXT candles to pandas DataFrame with DatetimeIndex"""
    df = pd.DataFrame(
        candles,
        columns=['timestamp', 'open', 'high', 'low', 'close', 'volume']
    )
    
    # Convert timestamp to datetime and set as index (required for pandas_ta)
    df['timestamp'] = pd.to_datetime(df['timestamp'], unit='ms')
    df = df.set_index('timestamp')    # ← КРИТИЧНО: устанавливаем как индекс
    df = df.sort_index()                # ← КРИТИЧНО: сортируем
    
    # Convert to float
    df = df.astype({
        'open': float,
        'high': float,
        'low': float,
        'close': float,
        'volume': float
    })
    return df
```

## Изменения

1. **set_index('timestamp')** - устанавливает timestamp как индекс DataFrame
2. **sort_index()** - гарантирует упорядоченность (required by pandas_ta)

## Следующие шаги

Перезапустить тест:
```bash
# Остановить текущий (Ctrl+C)
# Запустить снова
python tests/smart_entry_hunter_test.py LSKUSDT ORCAUSDT API3USDT GPSUSDT IOSTUSDT
```

Ошибка "VWAP requires an ordered DatetimeIndex" должна исчезнуть.
