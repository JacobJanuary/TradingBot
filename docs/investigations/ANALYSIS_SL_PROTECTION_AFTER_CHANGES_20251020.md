# –ê–Ω–∞–ª–∏–∑: –ó–∞—â–∏—Ç–∞ SL –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π Initial SL

**–î–∞—Ç–∞**: 2025-10-20
**–í–æ–ø—Ä–æ—Å**: –ß—Ç–æ –±—É–¥–µ—Ç –µ—Å–ª–∏ –ø–æ–∑–∏—Ü–∏—è –Ω–µ –∏–º–µ–µ—Ç SL (–ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª, zombie manager —Å–ª—É—á–∞–π–Ω–æ —É–¥–∞–ª–∏–ª –∏–ª–∏ —á—Ç–æ-—Ç–æ –µ—â–µ)?

## TL;DR - –ö—Ä–∞—Ç–∫–∏–π –æ—Ç–≤–µ—Ç

‚úÖ **Protection Manager –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –∫–∞–∫ –∏ —Ä–∞–Ω—å—à–µ!**

**–î–æ –∏–∑–º–µ–Ω–µ–Ω–∏–π**:
- AtomicPositionManager —Å–æ–∑–¥–∞—ë—Ç SL
- TS –ù–ï —É–ø—Ä–∞–≤–ª—è–µ—Ç SL –¥–æ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ (1.5%)
- Protection Manager —Å–ª–µ–¥–∏—Ç –∑–∞ –≤—Å–µ–º–∏ –ø–æ–∑–∏—Ü–∏—è–º–∏
- –ï—Å–ª–∏ SL –ø—Ä–æ–ø–∞–ª ‚Üí Protection Manager –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç

**–ü–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π**:
- AtomicPositionManager —Å–æ–∑–¥–∞—ë—Ç SL (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
- TS —É–ø—Ä–∞–≤–ª—è–µ—Ç SL —Å –º–æ–º–µ–Ω—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è ‚Üê –ù–û–í–û–ï
- Protection Manager —Å–ª–µ–¥–∏—Ç –∑–∞ –≤—Å–µ–º–∏ –ø–æ–∑–∏—Ü–∏—è–º–∏ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
- –ï—Å–ª–∏ SL –ø—Ä–æ–ø–∞–ª ‚Üí Protection Manager –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)

**–í—ã–≤–æ–¥**: –ó–∞—â–∏—Ç–∞ —Å—Ç–∞–ª–∞ –°–ò–õ–¨–ù–ï–ï, –∞ –Ω–µ —Å–ª–∞–±–µ–µ!

## –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑

### 1. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∑–∞—â–∏—Ç—ã SL (–º–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è)

```
–£—Ä–æ–≤–µ–Ω—å 1: AtomicPositionManager
  ‚Üì –°–æ–∑–¥–∞—ë—Ç –ø–æ–∑–∏—Ü–∏—é + SL –∞—Ç–æ–º–∞—Ä–Ω–æ
  ‚Üì –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å ‚Üí rollback, –ø–æ–∑–∏—Ü–∏–∏ –Ω–µ –±—É–¥–µ—Ç –≤–æ–æ–±—â–µ

–£—Ä–æ–≤–µ–Ω—å 2: Trailing Stop Manager (NEW!)
  ‚Üì –£–ø—Ä–∞–≤–ª—è–µ—Ç SL —Å –º–æ–º–µ–Ω—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è
  ‚Üì –û–±–Ω–æ–≤–ª—è–µ—Ç SL –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ü–µ–Ω—ã
  ‚Üì –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç ts_last_update_time –ø—Ä–∏ –∫–∞–∂–¥–æ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏

–£—Ä–æ–≤–µ–Ω—å 3: Protection Manager (WATCHDOG)
  ‚Üì –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –í–°–ï –ø–æ–∑–∏—Ü–∏–∏ –∫–∞–∂–¥—ã–µ N —Å–µ–∫—É–Ω–¥
  ‚Üì –ï—Å–ª–∏ SL –ø—Ä–æ–ø–∞–ª ‚Üí –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç
  ‚Üì –ï—Å–ª–∏ TS –Ω–µ–∞–∫—Ç–∏–≤–µ–Ω > 5 –º–∏–Ω—É—Ç ‚Üí –∑–∞–±–∏—Ä–∞–µ—Ç –∫–æ–Ω—Ç—Ä–æ–ª—å
```

### 2. –õ–æ–≥–∏–∫–∞ Protection Manager (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π!)

**–ö–æ–¥**: `core/position_manager.py:2480-2743`

#### –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è SL –Ω–∞ –±–∏—Ä–∂–µ (—Å—Ç—Ä–æ–∫–∏ 2501-2510)
```python
sl_manager = StopLossManager(exchange.exchange, position.exchange)
has_sl_on_exchange, sl_price = await sl_manager.has_stop_loss(symbol)
```

–ü—Ä–æ–≤–µ—Ä—è–µ—Ç:
1. Position-attached SL (Bybit —á–µ—Ä–µ–∑ `position.info.stopLoss`)
2. Conditional stop orders (—á–µ—Ä–µ–∑ `fetch_open_orders`)

#### –®–∞–≥ 2: –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è (—Å—Ç—Ä–æ–∫–∏ 2512-2528)
```python
position.has_stop_loss = has_sl_on_exchange

if has_sl_on_exchange and sl_price:
    # –û–±–Ω–æ–≤–∏—Ç—å –ë–î
    await self.repository.update_position(
        position.id,
        has_stop_loss=True,
        stop_loss_price=sl_price
    )
    # –£–±—Ä–∞—Ç—å –∏–∑ —Å–ø–∏—Å–∫–∞ –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö
    if symbol in self.positions_without_sl_time:
        del self.positions_without_sl_time[symbol]
```

#### –®–∞–≥ 3: –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–∑–∏—Ü–∏–π –±–µ–∑ SL (—Å—Ç—Ä–æ–∫–∏ 2529-2581)

**–°–ª—É—á–∞–π 1: –ü–æ–∑–∏—Ü–∏—è —Å –∞–∫—Ç–∏–≤–Ω—ã–º TS** (—Å—Ç—Ä–æ–∫–∏ 2531-2578)
```python
if position.has_trailing_stop and position.trailing_activated:
    ts_last_update = position.ts_last_update_time

    if ts_last_update:
        ts_inactive_minutes = (datetime.now() - ts_last_update).total_seconds() / 60

        if ts_inactive_minutes > 5:
            # TS –ú–Å–†–¢–í > 5 –º–∏–Ω—É—Ç ‚Üí –ó–ê–ë–†–ê–¢–¨ –ö–û–ù–¢–†–û–õ–¨
            logger.warning("TS Manager inactive, Protection Manager taking over")

            position.has_trailing_stop = False
            position.trailing_activated = False
            position.sl_managed_by = 'protection'

            unprotected_positions.append(position)  # –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å SL
        else:
            # TS –∞–∫—Ç–∏–≤–µ–Ω - –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å (TS —Å–∞–º –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç)
            continue
    else:
        # TS —Ç–æ–ª—å–∫–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω - –¥–∞—Ç—å –≤—Ä–µ–º—è
        continue
```

**–°–ª—É—á–∞–π 2: –û–±—ã—á–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è –±–µ–∑ TS** (—Å—Ç—Ä–æ–∫–∞ 2581)
```python
# –°—Ä–∞–∑—É –¥–æ–±–∞–≤–∏—Ç—å –≤ —Å–ø–∏—Å–æ–∫ –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
unprotected_positions.append(position)
```

#### –®–∞–≥ 4: –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ SL (—Å—Ç—Ä–æ–∫–∏ 2605-2743)
```python
for position in unprotected_positions:
    # 1. –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â—É—é —Ü–µ–Ω—É
    ticker = await exchange.fetch_ticker(position.symbol)
    current_price = float(ticker['last'])

    # 2. –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π SL (—Å —É—á—ë—Ç–æ–º –¥—Ä–∏—Ñ—Ç–∞ —Ü–µ–Ω—ã!)
    stop_loss_price = calculate_stop_loss(...)

    # 3. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å SL —á–µ—Ä–µ–∑ StopLossManager
    sl_manager = StopLossManager(exchange.exchange, position.exchange)
    success, order_id = await sl_manager.verify_and_fix_missing_sl(
        position=position,
        stop_price=stop_loss_price,
        max_retries=3  # 3 –ø–æ–ø—ã—Ç–∫–∏!
    )

    # 4. –û–±–Ω–æ–≤–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    if success:
        position.has_stop_loss = True
        position.stop_loss_price = stop_loss_price
        await self.repository.update_position_stop_loss(...)
```

### 3. –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å –≤ –∑–∞—â–∏—Ç–µ?

#### –î–û –∏–∑–º–µ–Ω–µ–Ω–∏–π:
```
–°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏:
  AtomicPositionManager ‚Üí SL —Å–æ–∑–¥–∞–Ω
  TS Manager ‚Üí –ù–ï —É–ø—Ä–∞–≤–ª—è–µ—Ç (initial_stop=None)
  Protection Manager ‚Üí –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–∞–∂–¥—ã–µ N —Å–µ–∫—É–Ω–¥

–ï—Å–ª–∏ SL –ø—Ä–æ–ø–∞–ª:
  Protection Manager ‚Üí –û–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ—Ç
  Protection Manager ‚Üí –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç
```

#### –ü–û–°–õ–ï –∏–∑–º–µ–Ω–µ–Ω–∏–π:
```
–°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏:
  AtomicPositionManager ‚Üí SL —Å–æ–∑–¥–∞–Ω
  TS Manager ‚Üí –£–ü–†–ê–í–õ–Ø–ï–¢ —Å –º–æ–º–µ–Ω—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è ‚Üê –ù–û–í–û–ï
  Protection Manager ‚Üí –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–∞–∂–¥—ã–µ N —Å–µ–∫—É–Ω–¥

–ï—Å–ª–∏ SL –ø—Ä–æ–ø–∞–ª:
  TS Manager ‚Üí –û–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ—Ç –ø—Ä–∏ update_price()
  TS Manager ‚Üí –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —á–µ—Ä–µ–∑ _place_stop_order()

  –ï–°–õ–ò TS –Ω–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–ª –∑–∞ 5 –º–∏–Ω—É—Ç:
    Protection Manager ‚Üí –ó–∞–±–∏—Ä–∞–µ—Ç –∫–æ–Ω—Ç—Ä–æ–ª—å
    Protection Manager ‚Üí –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: –ó–∞—â–∏—Ç–∞ —Å—Ç–∞–ª–∞ **–î–í–£–•–£–†–û–í–ù–ï–í–û–ô** –≤–º–µ—Å—Ç–æ –æ–¥–Ω–æ—É—Ä–æ–≤–Ω–µ–≤–æ–π!

### 4. –°—Ü–µ–Ω–∞—Ä–∏–∏ –æ—Ç–∫–∞–∑–∞ –∏ –∑–∞—â–∏—Ç–∞

#### –°—Ü–µ–Ω–∞—Ä–∏–π 1: SL –Ω–µ —Å–æ–∑–¥–∞–ª—Å—è –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –ø–æ–∑–∏—Ü–∏–∏
**–ü—Ä–∏—á–∏–Ω–∞**: –°–±–æ–π API –±–∏—Ä–∂–∏ –≤–æ –≤—Ä–µ–º—è AtomicPositionManager

**–ó–∞—â–∏—Ç–∞**:
1. AtomicPositionManager –æ–±–Ω–∞—Ä—É–∂–∏—Ç —Å–±–æ–π
2. –í—ã–ø–æ–ª–Ω–∏—Ç rollback (–∑–∞–∫—Ä–æ–µ—Ç –ø–æ–∑–∏—Ü–∏—é)
3. –ü–æ–∑–∏—Ü–∏—è –ù–ï –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ tracking
4. ‚ùå –ü–æ–∑–∏—Ü–∏–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç ‚Üí –∑–∞—â–∏—Ç–∞ –Ω–µ –Ω—É–∂–Ω–∞

**–°—Ç–∞—Ç—É—Å**: ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ —Ä–∞–Ω—å—à–µ

#### –°—Ü–µ–Ω–∞—Ä–∏–π 2: SL —É–¥–∞–ª—ë–Ω zombie manager
**–ü—Ä–∏—á–∏–Ω–∞**: Zombie manager –æ—à–∏–±–æ—á–Ω–æ —Å—á—ë–ª SL orphan-–æ—Ä–¥–µ—Ä–æ–º

**–ó–∞—â–∏—Ç–∞ –î–û –∏–∑–º–µ–Ω–µ–Ω–∏–π**:
1. Protection Manager –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–∞–∂–¥—ã–µ N —Å–µ–∫—É–Ω–¥
2. –û–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ SL
3. –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç SL

**–ó–∞—â–∏—Ç–∞ –ü–û–°–õ–ï –∏–∑–º–µ–Ω–µ–Ω–∏–π**:
1. TS Manager –æ–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ—Ç –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º update_price()
2. TS –ø—ã—Ç–∞–µ—Ç—Å—è –æ–±–Ω–æ–≤–∏—Ç—å SL ‚Üí –≤–∏–¥–∏—Ç, —á—Ç–æ SL –Ω–µ—Ç
3. TS –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —á–µ—Ä–µ–∑ _place_stop_order()

–ï–°–õ–ò TS –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª:
4. Protection Manager –ø—Ä–æ–≤–µ—Ä—è–µ—Ç (—Å—Ç—Ä–æ–∫–∞ 2503)
5. –í–∏–¥–∏—Ç: `has_trailing_stop=True` –Ω–æ `has_sl_on_exchange=False`
6. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç `ts_last_update_time`
7. –ï—Å–ª–∏ > 5 –º–∏–Ω—É—Ç ‚Üí –∑–∞–±–∏—Ä–∞–µ—Ç –∫–æ–Ω—Ç—Ä–æ–ª—å –∏ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç

**–°—Ç–∞—Ç—É—Å**: ‚úÖ –ó–∞—â–∏—Ç–∞ –£–°–ò–õ–ï–ù–ê (2 —É—Ä–æ–≤–Ω—è –≤–º–µ—Å—Ç–æ 1)

#### –°—Ü–µ–Ω–∞—Ä–∏–π 3: TS Manager –∑–∞–≤–∏—Å/crashed
**–ü—Ä–∏—á–∏–Ω–∞**: –ë–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π deadlock, exception, –∏–ª–∏ –¥—Ä—É–≥–æ–π —Å–±–æ–π

**–ó–∞—â–∏—Ç–∞**:
1. TS –ø–µ—Ä–µ—Å—Ç–∞—ë—Ç –æ–±–Ω–æ–≤–ª—è—Ç—å `ts_last_update_time`
2. Protection Manager –≤–∏–¥–∏—Ç (—Å—Ç—Ä–æ–∫–∞ 2536):
   ```python
   ts_inactive_minutes = (datetime.now() - ts_last_update).total_seconds() / 60
   ```
3. –ï—Å–ª–∏ > 5 –º–∏–Ω—É—Ç ‚Üí fallback:
   ```python
   position.has_trailing_stop = False
   position.sl_managed_by = 'protection'
   unprotected_positions.append(position)
   ```
4. Protection Manager –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∫–æ–Ω—Ç—Ä–æ–ª—å

**–°—Ç–∞—Ç—É—Å**: ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç (–∫–æ–¥ –≤ —Å—Ç—Ä–æ–∫–∞—Ö 2540-2564)

#### –°—Ü–µ–Ω–∞—Ä–∏–π 4: –ë–∏—Ä–∂–∞ —Å–ª—É—á–∞–π–Ω–æ –∑–∞–∫—Ä—ã–ª–∞ SL –æ—Ä–¥–µ—Ä
**–ü—Ä–∏—á–∏–Ω–∞**: –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π —Å–±–æ–π –±–∏—Ä–∂–∏, –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ API

**–ó–∞—â–∏—Ç–∞**:
1. TS Manager –ø—Ä–∏ update_price() –Ω–µ –Ω–∞–π–¥—ë—Ç –æ—Ä–¥–µ—Ä
2. TS –ø–æ–ø—ã—Ç–∞–µ—Ç—Å—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —á–µ—Ä–µ–∑ _place_stop_order()
3. –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ Protection Manager –ø—Ä–æ–≤–µ—Ä—è–µ—Ç
4. –ï—Å–ª–∏ TS –Ω–µ —É—Å–ø–µ–ª ‚Üí Protection Manager –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç

**–°—Ç–∞—Ç—É—Å**: ‚úÖ –ó–∞—â–∏—Ç–∞ –£–°–ò–õ–ï–ù–ê

#### –°—Ü–µ–Ω–∞—Ä–∏–π 5: TS —Å–æ–∑–¥–∞–ª initial_stop, –Ω–æ –æ—Ä–¥–µ—Ä –Ω–µ –ø—Ä–æ—à—ë–ª
**–ü—Ä–∏—á–∏–Ω–∞**: –ë–∏—Ä–∂–∞ –æ—Ç–∫–ª–æ–Ω–∏–ª–∞ –æ—Ä–¥–µ—Ä (rate limit, validation error)

**–ó–∞—â–∏—Ç–∞**:
```python
# trailing_stop.py:353-356
if initial_stop:
    ts.current_stop_price = Decimal(str(initial_stop))
    await self._place_stop_order(ts)  # –ú–æ–∂–µ—Ç —É–ø–∞—Å—Ç—å!
```

–ï—Å–ª–∏ `_place_stop_order()` —É–ø–∞–ª:
1. TS —É—Å—Ç–∞–Ω–æ–≤–∏—Ç `current_stop_price` –Ω–æ –æ—Ä–¥–µ—Ä –ù–ï —Å–æ–∑–¥–∞–Ω
2. –ü—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º `update_price()` TS —É–≤–∏–¥–∏—Ç —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ
3. TS –ø–æ–ø—ã—Ç–∞–µ—Ç—Å—è –∑–∞–Ω–æ–≤–æ —á–µ—Ä–µ–∑ `_place_stop_order()`
4. –ï—Å–ª–∏ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç ‚Üí Protection Manager (—á–µ—Ä–µ–∑ 5 –º–∏–Ω—É—Ç fallback)

**–°—Ç–∞—Ç—É—Å**: ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç (TS retry + Protection fallback)

### 5. –§–ª–∞–≥–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏ –∑–æ–Ω—ã –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏

#### has_trailing_stop (bool)
**–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è**: –ü—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º —Å–æ–∑–¥–∞–Ω–∏–∏ TS (—Å—Ç—Ä–æ–∫–∞ 1035)
**–°–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è**: –ö–æ–≥–¥–∞ Protection Manager –∑–∞–±–∏—Ä–∞–µ—Ç –∫–æ–Ω—Ç—Ä–æ–ª—å (—Å—Ç—Ä–æ–∫–∞ 2547)

**–õ–æ–≥–∏–∫–∞**:
- `True` ‚Üí TS —É–ø—Ä–∞–≤–ª—è–µ—Ç SL
- `False` ‚Üí Protection Manager —É–ø—Ä–∞–≤–ª—è–µ—Ç SL

#### trailing_activated (bool)
**–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è**: –ö–æ–≥–¥–∞ –ø–æ–∑–∏—Ü–∏—è –¥–æ—Å—Ç–∏–≥–∞–µ—Ç 1.5% –ø—Ä–æ—Ñ–∏—Ç–∞
**–°–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è**: –ü—Ä–∏ fallback –∫ Protection Manager (—Å—Ç—Ä–æ–∫–∞ 2548)

**–õ–æ–≥–∏–∫–∞**:
- `True` + `has_trailing_stop=True` ‚Üí TS –∞–∫—Ç–∏–≤–Ω–æ —Ç—Ä–µ–π–ª–∏—Ç
- `False` + `has_trailing_stop=True` ‚Üí TS —Å–ª–µ–¥–∏—Ç, –Ω–æ –Ω–µ —Ç—Ä–µ–π–ª–∏—Ç (INACTIVE/WAITING)

#### ts_last_update_time (datetime)
**–û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è**: –ü—Ä–∏ –∫–∞–∂–¥–æ–º –≤—ã–∑–æ–≤–µ `update_price()` –≤ TS
**–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è**: Protection Manager –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–¥–æ—Ä–æ–≤—å—è TS

**–õ–æ–≥–∏–∫–∞**:
```python
if ts_inactive_minutes > 5:
    # TS –ú–Å–†–¢–í ‚Üí –∑–∞–±—Ä–∞—Ç—å –∫–æ–Ω—Ç—Ä–æ–ª—å
```

### 6. –ö–æ–¥ Protection Manager - –∫–ª—é—á–µ–≤—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏

#### –ü—Ä–æ–≤–µ—Ä–∫–∞ 1: –ï—Å—Ç—å –ª–∏ SL –Ω–∞ –±–∏—Ä–∂–µ? (—Å—Ç—Ä–æ–∫–∞ 2503)
```python
has_sl_on_exchange, sl_price = await sl_manager.has_stop_loss(symbol)
```
‚úÖ **–†–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –í–°–ï–• –ø–æ–∑–∏—Ü–∏–π** (TS –∏ –Ω–µ-TS)

#### –ü—Ä–æ–≤–µ—Ä–∫–∞ 2: TS –ø–æ–∑–∏—Ü–∏—è –ë–ï–ó SL? (—Å—Ç—Ä–æ–∫–∞ 2531)
```python
if position.has_trailing_stop and position.trailing_activated:
```
‚úÖ **–°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è TS –ø–æ–∑–∏—Ü–∏–π**

#### –ü—Ä–æ–≤–µ—Ä–∫–∞ 3: TS –∂–∏–≤? (—Å—Ç—Ä–æ–∫–∞ 2540)
```python
if ts_inactive_minutes > 5:
    # –ó–∞–±—Ä–∞—Ç—å –∫–æ–Ω—Ç—Ä–æ–ª—å
```
‚úÖ **Fallback –º–µ—Ö–∞–Ω–∏–∑–º —Ä–∞–±–æ—Ç–∞–µ—Ç**

#### –ü—Ä–æ–≤–µ—Ä–∫–∞ 4: –û–±—ã—á–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è –ë–ï–ó SL? (—Å—Ç—Ä–æ–∫–∞ 2581)
```python
unprotected_positions.append(position)
```
‚úÖ **–ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ**

### 7. –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ä–∞–º–∫–∏ –∑–∞—â–∏—Ç—ã

| –°–æ–±—ã—Ç–∏–µ | –í—Ä–µ–º—è –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è | –í—Ä–µ–º—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è |
|---------|------------------|---------------------|
| SL –ø—Ä–æ–ø–∞–ª (TS –ø–æ–∑–∏—Ü–∏—è) | –ü—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º update_price (~1-5 —Å–µ–∫) | ~1-2 —Å–µ–∫ (TS –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç) |
| TS –∑–∞–≤–∏—Å | 5 –º–∏–Ω—É—Ç | ~5-10 —Å–µ–∫ (Protection Manager) |
| SL –ø—Ä–æ–ø–∞–ª (–Ω–µ-TS –ø–æ–∑–∏—Ü–∏—è) | –°–ª–µ–¥—É—é—â–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ Protection (~30 —Å–µ–∫?) | ~5-10 —Å–µ–∫ |
| AtomicPositionManager —É–ø–∞–ª | –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ | N/A (rollback, –ø–æ–∑–∏—Ü–∏–∏ –Ω–µ—Ç) |

### 8. –ß—Ç–æ —É–ª—É—á—à–∏–ª–æ—Å—å?

#### –î–û –∏–∑–º–µ–Ω–µ–Ω–∏–π:
- **1 —É—Ä–æ–≤–µ–Ω—å –∑–∞—â–∏—Ç—ã**: Protection Manager
- **–í—Ä–µ–º—è –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è**: ~30 —Å–µ–∫—É–Ω–¥ (—Ü–∏–∫–ª –ø—Ä–æ–≤–µ—Ä–∫–∏)
- **–í—Ä–µ–º—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è**: ~5-10 —Å–µ–∫—É–Ω–¥

**–ò—Ç–æ–≥–æ**: –ü–æ–∑–∏—Ü–∏—è –º–æ–∂–µ—Ç –±—ã—Ç—å –±–µ–∑ SL –¥–æ 40 —Å–µ–∫—É–Ω–¥

#### –ü–û–°–õ–ï –∏–∑–º–µ–Ω–µ–Ω–∏–π:
- **2 —É—Ä–æ–≤–Ω—è –∑–∞—â–∏—Ç—ã**: TS Manager ‚Üí Protection Manager
- **–í—Ä–µ–º—è –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è**: ~1-5 —Å–µ–∫—É–Ω–¥ (TS) –∏–ª–∏ ~30 —Å–µ–∫—É–Ω–¥ (Protection)
- **–í—Ä–µ–º—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è**: ~1-2 —Å–µ–∫—É–Ω–¥—ã (TS) –∏–ª–∏ ~5-10 —Å–µ–∫—É–Ω–¥ (Protection)

**–ò—Ç–æ–≥–æ**: –ü–æ–∑–∏—Ü–∏—è –º–æ–∂–µ—Ç –±—ã—Ç—å –±–µ–∑ SL –¥–æ 5-10 —Å–µ–∫—É–Ω–¥ (TS) –∏–ª–∏ 40 —Å–µ–∫—É–Ω–¥ (fallback)

**–£–ª—É—á—à–µ–Ω–∏–µ**: **80-90% –±—ã—Å—Ç—Ä–µ–µ** –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ!

### 9. –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

#### –ü—Ä–æ–±–ª–µ–º–∞ 1: –ö–æ–Ω—Ñ–ª–∏–∫—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
**–°—Ü–µ–Ω–∞—Ä–∏–π**: TS –∏ Protection Manager –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –ø—ã—Ç–∞—é—Ç—Å—è —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å SL

**–ó–∞—â–∏—Ç–∞**:
```python
# Protection Manager –ø—Ä–æ–≤–µ—Ä—è–µ—Ç (—Å—Ç—Ä–æ–∫–∞ 2531):
if position.has_trailing_stop and position.trailing_activated:
    # –ï—Å–ª–∏ TS –∞–∫—Ç–∏–≤–µ–Ω - –ù–ï –≤–º–µ—à–∏–≤–∞—Ç—å—Å—è
    if ts_inactive_minutes <= 5:
        continue  # –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å
```

**–°—Ç–∞—Ç—É—Å**: ‚úÖ –ö–æ–Ω—Ñ–ª–∏–∫—Ç –∏—Å–∫–ª—é—á—ë–Ω (—Ç–æ–ª—å–∫–æ 1 –º–µ–Ω–µ–¥–∂–µ—Ä –∞–∫—Ç–∏–≤–µ–Ω)

#### –ü—Ä–æ–±–ª–µ–º–∞ 2: Race condition –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –∫–æ–Ω—Ç—Ä–æ–ª—è
**–°—Ü–µ–Ω–∞—Ä–∏–π**:
1. TS –Ω–µ–∞–∫—Ç–∏–≤–µ–Ω 4:59 –º–∏–Ω—É—Ç
2. TS –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç SL
3. Protection Manager –≤–∏–¥–∏—Ç 5:00 –º–∏–Ω—É—Ç ‚Üí –∑–∞–±–∏—Ä–∞–µ—Ç –∫–æ–Ω—Ç—Ä–æ–ª—å
4. –¢–µ–ø–µ—Ä—å 2 –æ—Ä–¥–µ—Ä–∞ SL?

**–ó–∞—â–∏—Ç–∞**:
1. Protection Manager —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç `has_trailing_stop=False` (—Å—Ç—Ä–æ–∫–∞ 2547)
2. TS –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º update_price() —É–≤–∏–¥–∏—Ç —Ñ–ª–∞–≥ –∏ –ø—Ä–µ–∫—Ä–∞—Ç–∏—Ç —Ä–∞–±–æ—Ç—É
3. –°—Ç–∞—Ä—ã–π SL –æ—Ä–¥–µ—Ä –æ—Ç TS –±—É–¥–µ—Ç –∑–∞–º–µ–Ω—ë–Ω Protection Manager

**–°—Ç–∞—Ç—É—Å**: ‚ö†Ô∏è  –í–æ–∑–º–æ–∂–Ω–∞ –∫—Ä–∞—Ç–∫–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ, –Ω–æ –±–µ–∑–æ–ø–∞—Å–Ω–∞

#### –ü—Ä–æ–±–ª–µ–º–∞ 3: TS –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–ª—Å—è –ü–û–°–õ–ï —Ç–æ–≥–æ –∫–∞–∫ Protection –∑–∞–±—Ä–∞–ª –∫–æ–Ω—Ç—Ä–æ–ª—å
**–°—Ü–µ–Ω–∞—Ä–∏–π**:
1. TS –∑–∞–≤–∏—Å –Ω–∞ 6 –º–∏–Ω—É—Ç
2. Protection Manager –∑–∞–±—Ä–∞–ª –∫–æ–Ω—Ç—Ä–æ–ª—å (—Å–±—Ä–æ—Å–∏–ª `has_trailing_stop=False`)
3. TS –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –∏ –ø—ã—Ç–∞–µ—Ç—Å—è –æ–±–Ω–æ–≤–∏—Ç—å SL

**–ó–∞—â–∏—Ç–∞**:
```python
# TS –¥–æ–ª–∂–µ–Ω –ø—Ä–æ–≤–µ—Ä—è—Ç—å —Ñ–ª–∞–≥ –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º:
if not position.has_trailing_stop:
    return  # –ö–æ–Ω—Ç—Ä–æ–ª—å –ø–æ—Ç–µ—Ä—è–Ω
```

**–°—Ç–∞—Ç—É—Å**: ‚ö†Ô∏è  –ù—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–¥ TS –Ω–∞ —ç—Ç—É –∑–∞—â–∏—Ç—É

### 10. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

#### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è 1: –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É —Ñ–ª–∞–≥–∞ –≤ TS
–£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ TS –ø—Ä–æ–≤–µ—Ä—è–µ—Ç `position.has_trailing_stop` –ø–µ—Ä–µ–¥ –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏:
```python
async def update_price(self, symbol: str, price: float):
    if symbol not in self.trailing_stops:
        return None

    # NEW: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–ª–∞–¥–µ–Ω–∏–µ
    position = position_manager.positions.get(symbol)
    if position and not position.has_trailing_stop:
        logger.warning(f"TS lost control of {symbol}, removing from tracking")
        del self.trailing_stops[symbol]
        return None
```

#### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è 2: –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–π –∫–æ–Ω—Ç—Ä–æ–ª—è
–î–æ–±–∞–≤–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ –≤ event_logger –ø—Ä–∏ fallback:
```python
await event_logger.log_event(
    EventType.TS_FALLBACK_TO_PROTECTION,
    {
        'symbol': symbol,
        'ts_inactive_minutes': ts_inactive_minutes,
        'reason': 'ts_timeout'
    }
)
```

#### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è 3: –ú–µ—Ç—Ä–∏–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è TS
–î–æ–±–∞–≤–∏—Ç—å –≤ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ fallback —Å–æ–±—ã—Ç–∏–π
- –°—Ä–µ–¥–Ω—è—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ TS
- –ß–∞—Å—Ç–æ—Ç–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–π SL

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

### –í–æ–ø—Ä–æ—Å: "–ß—Ç–æ –±—É–¥–µ—Ç –µ—Å–ª–∏ –ø–æ–∑–∏—Ü–∏—è –Ω–µ –∏–º–µ–µ—Ç SL?"

**–û—Ç–≤–µ—Ç**: Protection Manager –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç SL, –∫–∞–∫ –∏ —Ä–∞–Ω—å—à–µ!

### –ò–∑–º–µ–Ω–∏–ª–æ—Å—å –ª–∏ —á—Ç–æ-—Ç–æ –≤ –∑–∞—â–∏—Ç–µ?

‚úÖ **–î–ê, –∑–∞—â–∏—Ç–∞ —Å—Ç–∞–ª–∞ –°–ò–õ–¨–ù–ï–ï**:

**–î–û**:
- 1 —É—Ä–æ–≤–µ–Ω—å (Protection Manager)
- –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ: ~30 —Å–µ–∫—É–Ω–¥
- –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ: ~40 —Å–µ–∫—É–Ω–¥

**–ü–û–°–õ–ï**:
- 2 —É—Ä–æ–≤–Ω—è (TS ‚Üí Protection)
- –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ: ~1-5 —Å–µ–∫—É–Ω–¥ (TS) –∏–ª–∏ ~30 —Å–µ–∫—É–Ω–¥ (fallback)
- –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ: ~5-10 —Å–µ–∫—É–Ω–¥ (TS) –∏–ª–∏ ~40 —Å–µ–∫—É–Ω–¥ (fallback)

### –†–∏—Å–∫–∏

üü¢ **–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ**:
- Protection Manager —Ä–∞–±–æ—Ç–∞–µ—Ç –ë–ï–ó –∏–∑–º–µ–Ω–µ–Ω–∏–π
- TS –¥–æ–±–∞–≤–ª—è–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å –∑–∞—â–∏—Ç—ã
- Fallback –º–µ—Ö–∞–Ω–∏–∑–º (5 –º–∏–Ω—É—Ç) –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ
- AtomicPositionManager –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç SL –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏

### –ß—Ç–æ –ù–ï —Ä–∞–±–æ—Ç–∞–µ—Ç

‚ùå **–ù–∏—á–µ–≥–æ –Ω–µ —Å–ª–æ–º–∞–ª–æ—Å—å**:
- AtomicPositionManager ‚Üí –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
- Protection Manager ‚Üí –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
- Zombie Manager ‚Üí –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
- StopLossManager ‚Üí –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π

### –ò—Ç–æ–≥

**–ò–∑–º–µ–Ω–µ–Ω–∏—è Initial SL –ù–ï –æ—Å–ª–∞–±–∏–ª–∏ –∑–∞—â–∏—Ç—É, –∞ –£–°–ò–õ–ò–õ–ò –µ—ë!**

Protection Manager –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –∫–∞–∫ watchdog –¥–ª—è –í–°–ï–• –ø–æ–∑–∏—Ü–∏–π, –≤–∫–ª—é—á–∞—è TS –ø–æ–∑–∏—Ü–∏–∏. –î–æ–±–∞–≤–∏–ª—Å—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å –∑–∞—â–∏—Ç—ã —á–µ—Ä–µ–∑ TS Manager, –∫–æ—Ç–æ—Ä—ã–π –±—ã—Å—Ç—Ä–µ–µ –æ–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ—Ç –∏ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –ø—Ä–æ–ø–∞–≤—à–∏–µ SL.

---

**–°—Ç–∞—Ç—É—Å**: ‚úÖ –ó–∞—â–∏—Ç–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç, —Ä–∏—Å–∫–∏ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã
**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**: –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å fallback –º–µ—Ö–∞–Ω–∏–∑–º (—Å–∏–º—É–ª—è—Ü–∏—è –∑–∞–≤–∏—Å–∞–Ω–∏—è TS)
