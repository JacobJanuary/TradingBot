# üî¥ CRITICAL FIX: TS Restore Peaks Inconsistency
## –î–∞—Ç–∞: 2025-10-20 23:15
## Commit: 4a424f4

---

## üìä EXECUTIVE SUMMARY

–û–±–Ω–∞—Ä—É–∂–µ–Ω –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –±–∞–≥ –≤ –ª–æ–≥–∏–∫–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è TS state –∏–∑ –ë–î –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞.

**–°—Ç–∞—Ç—É—Å**: ‚úÖ **–ò–°–ü–†–ê–í–õ–ï–ù–û**

**–°—É—Ç—å –ø—Ä–æ–±–ª–µ–º—ã**: –ü—Ä–∏ restore –∏–∑ –ë–î peaks (highest/lowest) —Å–±—Ä–∞—Å—ã–≤–∞–ª–∏—Å—å –≤ entry_price, –Ω–æ current_stop_price –±—Ä–∞–ª—Å—è –∏–∑ –ë–î ‚Üí –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ ‚Üí TS "–∑–∞–º–æ—Ä–∞–∂–∏–≤–∞–ª—Å—è" –∏ –Ω–µ –æ–±–Ω–æ–≤–ª—è–ª—Å—è.

---

## üî¥ –ü–†–û–ë–õ–ï–ú–ê

### –°–∏–º–ø—Ç–æ–º—ã:

–ü–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞ –¥–ª—è –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö TS –ø–æ–∑–∏—Ü–∏–π:
1. **TS –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è** - SL –æ—Å—Ç–∞–µ—Ç—Å—è –Ω–∞ –ø—Ä–µ–∂–Ω–µ–º —É—Ä–æ–≤–Ω–µ
2. **current_stop > highest** –¥–ª—è LONG –ø–æ–∑–∏—Ü–∏–π (–ª–æ–≥–∏—á–µ—Å–∫–∏ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ!)
3. **SL –Ω–∞ –±–∏—Ä–∂–µ –Ω–µ –¥–≤–∏–≥–∞–µ—Ç—Å—è** –∑–∞ —Ü–µ–Ω–æ–π

### –ü—Ä–∏–º–µ—Ä: SSVUSDT (LONG)

**–î–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ (19:45)**:
```
highest_price: 5.888
current_stop_price: 5.85856
–§–æ—Ä–º—É–ª–∞: 5.85856 = 5.888 * 0.995 ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ
```

**–ü–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ (19:50)**:
```
highest_price: 5.73 (entry!) ‚Üê –°–ë–†–û–®–ï–ù!
current_stop_price: 5.85856 ‚Üê –ò–ó –ë–î
–ü—Ä–æ–±–ª–µ–º–∞: 5.85856 > 5.73 ‚ùå –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –¥–ª—è LONG!
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç**:
```
potential_stop = 5.73 * 0.995 = 5.70135
Check: 5.70135 > 5.85856? –ù–ï–¢!
‚Üí SL –ù–ï –û–ë–ù–û–í–õ–Ø–ï–¢–°–Ø!
```

---

## üîç –ö–û–†–ù–ï–í–ê–Ø –ü–†–ò–ß–ò–ù–ê

### –§–∞–π–ª: `protection/trailing_stop.py:252-253`

**–°–¢–ê–†–´–ô –ö–û–î (–ø—Ä–æ–±–ª–µ–º–Ω—ã–π)**:
```python
# FIX: Reset peaks to entry_price on restore - first update_price() will set correct current price
# This ensures peaks update correctly from current market price, not stale DB values
highest_price=Decimal(str(state_data['entry_price'])) if state_data['side'] == 'long' else UNINITIALIZED_PRICE_HIGH,
lowest_price=UNINITIALIZED_PRICE_HIGH if state_data['side'] == 'long' else Decimal(str(state_data['entry_price'])),
```

**–ß—Ç–æ –¥–µ–ª–∞–ª**:
- `highest_price` / `lowest_price` —Å–±—Ä–∞—Å—ã–≤–∞–ª–∏—Å—å –≤ `entry_price`
- `current_stop_price` –±—Ä–∞–ª—Å—è –∏–∑ –ë–î (line 256)

**–ú–æ—Ç–∏–≤–∞—Ü–∏—è —Å—Ç–∞—Ä–æ–≥–æ –∫–æ–¥–∞**:
–ò–∑–±–µ–∂–∞—Ç—å "stale peaks" (—É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –ø–∏–∫–æ–≤) –≤ —Å–ª—É—á–∞–µ, –µ—Å–ª–∏ –±–æ—Ç –±—ã–ª –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –¥–æ–ª–≥–æ –∏ —Ü–µ–Ω–∞ —Å–∏–ª—å–Ω–æ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å.

**–ü—Ä–æ–±–ª–µ–º–∞**:
–°–æ–∑–¥–∞–ª **–Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ** –º–µ–∂–¥—É peaks –∏ current_stop_price:
- Peaks —Å–±—Ä–æ—à–µ–Ω—ã ‚Üí –º–∞–ª–µ–Ω—å–∫–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è
- current_stop –∏–∑ –ë–î ‚Üí –±–æ–ª—å—à–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ (–æ—Ç —Å—Ç–∞—Ä—ã—Ö –≤—ã—Å–æ–∫–∏—Ö peaks)
- –£—Å–ª–æ–≤–∏–µ `potential_stop > current_stop` –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è
- **TS "–∑–∞–º–æ—Ä–∞–∂–∏–≤–∞–µ—Ç—Å—è"**

---

## ‚úÖ –†–ï–®–ï–ù–ò–ï

### –ù–û–í–´–ô –ö–û–î:
```python
# Restore peaks from DB - these are the actual highest/lowest reached
# update_price() will naturally update them if price moves beyond these levels
highest_price=Decimal(str(state_data.get('highest_price', state_data['entry_price']))) if state_data['side'] == 'long' else UNINITIALIZED_PRICE_HIGH,
lowest_price=UNINITIALIZED_PRICE_HIGH if state_data['side'] == 'long' else Decimal(str(state_data.get('lowest_price', state_data['entry_price']))),
```

**–õ–æ–≥–∏–∫–∞**:
1. –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º peaks **–ò–ó –ë–î** (–∫–∞–∫ –µ—Å—Ç—å)
2. –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º current_stop **–ò–ó –ë–î** (–∫–∞–∫ –µ—Å—Ç—å)
3. **Consistency –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∞**: current_stop = highest * (1 - callback%)
4. –ü—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º `update_price()`:
   - –ï—Å–ª–∏ —Ü–µ–Ω–∞ > highest ‚Üí –æ–±–Ω–æ–≤–∏—Ç—å highest –∏ current_stop ‚úÖ
   - –ï—Å–ª–∏ —Ü–µ–Ω–∞ < highest ‚Üí –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞—Ç—å (trailing stop –Ω–µ –æ—Ç–∫–∞—Ç—ã–≤–∞–µ—Ç—Å—è) ‚úÖ

**–ï—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ**: TS –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –∫–∞–∫ –¥–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞!

---

## üß™ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –î–ê–ù–ù–´–• –í –ë–î

–î–≤–µ –ø–æ–∑–∏—Ü–∏–∏ –∏–º–µ–ª–∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ—Å–ª–µ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–æ–≤:

### SSVUSDT:
```sql
-- –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
highest_price: 5.80 ‚ùå
current_stop_price: 5.85856

-- –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
UPDATE monitoring.trailing_stop_state
SET highest_price = 5.888
WHERE symbol = 'SSVUSDT';

-- –ü—Ä–æ–≤–µ—Ä–∫–∞:
5.85856 / 5.888 = 0.995 ‚úÖ
```

### DOGUSDT:
```sql
-- –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
highest_price: 0.001448 ‚ùå
current_stop_price: 0.001521

-- –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
UPDATE monitoring.trailing_stop_state
SET highest_price = 0.001529
WHERE symbol = 'DOGUSDT';

-- –ü—Ä–æ–≤–µ—Ä–∫–∞:
0.001521 / 0.001529 = 0.995 ‚úÖ
```

---

## üìà –í–ê–õ–ò–î–ê–¶–ò–Ø

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:

```sql
SELECT
    symbol,
    entry_price,
    highest_price,
    current_stop_price,
    ROUND((current_stop_price / highest_price)::numeric, 5) as ratio
FROM monitoring.trailing_stop_state
WHERE symbol IN ('SSVUSDT', 'DOGUSDT');
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç**:
```
 symbol  | entry_price | highest_price | current_stop_price | ratio
---------+-------------+---------------+--------------------+-------
 DOGUSDT |    0.001448 |      0.001529 |           0.001521 | 0.995 ‚úÖ
 SSVUSDT |        5.73 |         5.888 |            5.85856 | 0.995 ‚úÖ
```

**–û–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –ø–æ—Å–ª–µ —Å–ª–µ–¥—É—é—â–µ–≥–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞**:
1. Peaks –≤–æ—Å—Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –∏–∑ –ë–î –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
2. TS –±—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª—è—Ç—å—Å—è –ø—Ä–∏ –¥–≤–∏–∂–µ–Ω–∏–∏ —Ü–µ–Ω—ã
3. –ù–∏–∫–∞–∫–æ–≥–æ "–∑–∞–º–æ—Ä–∞–∂–∏–≤–∞–Ω–∏—è"

---

## üéØ IMPACT ANALYSIS

### –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
- ‚ùå 2 –∏–∑ 5 –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–π (40%) –∏–º–µ–ª–∏ "–∑–∞–º–æ—Ä–æ–∂–µ–Ω–Ω—ã–π" TS
- ‚ùå SL –Ω–µ –æ–±–Ω–æ–≤–ª—è–ª—Å—è –ø—Ä–∏ —Ä–æ—Å—Ç–µ —Ü–µ–Ω—ã
- ‚ö†Ô∏è –†–µ–∞–ª—å–Ω—ã–π SL –Ω–∞ –±–∏—Ä–∂–µ –±—ã–ª –Ω–∞ initial —É—Ä–æ–≤–Ω–µ (–Ω–µ trailing)

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
- ‚úÖ TS –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∏–∑ –ë–î
- ‚úÖ SL –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ –ø—Ä–∏ –¥–≤–∏–∂–µ–Ω–∏–∏ —Ü–µ–Ω—ã
- ‚úÖ Consistency –º–µ–∂–¥—É peaks –∏ current_stop –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∞
- ‚úÖ –ù–∏–∫–∞–∫–æ–≥–æ "–∑–∞–º–æ—Ä–∞–∂–∏–≤–∞–Ω–∏—è"

---

## üìù –•–†–û–ù–û–õ–û–ì–ò–Ø –ë–ê–ì–ê

### 16:26 - –ù–æ—Ä–º–∞–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞:
```
SSVUSDT: highest=5.888, current_stop=5.85856 ‚úÖ
update_count=17, –≤—Å–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã
```

### 19:45 - –ü–æ—Å–ª–µ–¥–Ω–∏–π restore —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏:
```
SSVUSDT RESTORED: highest=5.888, current_stop=5.85856 ‚úÖ
```

### 19:50 - –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å –±–∞–≥–æ–º:
```
SSVUSDT RESTORED: highest=5.73 (entry!), current_stop=5.85856 ‚ùå
Peaks —Å–±—Ä–æ—à–µ–Ω—ã, current_stop –∏–∑ –ë–î ‚Üí –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ
```

### 19:50+ - TS "–∑–∞–º–æ—Ä–æ–∂–µ–Ω":
```
update_price() –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è, –Ω–æ:
potential_stop (5.70) < current_stop (5.85) ‚Üí skip update
SL –Ω–∞ –±–∏—Ä–∂–µ –æ—Å—Ç–∞–µ—Ç—Å—è 5.615 (initial SL)
```

### 22:19 - –ü–æ—Å–ª–µ–¥–Ω–∏–π –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø–µ—Ä–µ–¥ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º:
```
SSVUSDT RESTORED: highest=5.73, current_stop=5.85856 ‚ùå
–ü—Ä–æ–±–ª–µ–º–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è
```

### 23:15 - –ò–°–ü–†–ê–í–õ–ï–ù–û:
```
‚úÖ –ö–æ–¥ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω: peaks –±–µ—Ä—É—Ç—Å—è –∏–∑ –ë–î
‚úÖ –ë–î –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞: highest –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ 5.888
‚úÖ –ö–æ–º–º–∏—Ç —Å–æ–∑–¥–∞–Ω: 4a424f4
```

---

## üîß –î–ï–¢–ê–õ–ò –ö–û–ú–ú–ò–¢–ê

**Commit**: `4a424f4`
**Branch**: `feature/initial-sl-and-cleanup`
**Files changed**: `protection/trailing_stop.py` (1 file, 4 insertions, 4 deletions)

**–ò–∑–º–µ–Ω–µ–Ω–∏—è**:
- Line 252: –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ highest_price –∏–∑ –ë–î
- Line 253: –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ lowest_price –∏–∑ –ë–î
- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ–±–Ω–æ–≤–ª–µ–Ω: –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –ø–æ–≤–µ–¥–µ–Ω–∏—è

---

## üí≠ LESSONS LEARNED

### –ß—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫:

1. **Partial State Reset**: –°–±—Ä–æ—Å —Ç–æ–ª—å–∫–æ —á–∞—Å—Ç–∏ state (peaks) –±–µ–∑ —Å–±—Ä–æ—Å–∞ –∑–∞–≤–∏—Å–∏–º—ã—Ö –ø–æ–ª–µ–π (current_stop)
2. **Over-Engineering**: –ü–æ–ø—ã—Ç–∫–∞ —Ä–µ—à–∏—Ç—å –≥–∏–ø–æ—Ç–µ—Ç–∏—á–µ—Å–∫—É—é –ø—Ä–æ–±–ª–µ–º—É ("stale peaks") —Å–æ–∑–¥–∞–ª–∞ —Ä–µ–∞–ª—å–Ω—É—é –ø—Ä–æ–±–ª–µ–º—É
3. **–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**: –ë–∞–≥ –Ω–µ –ø—Ä–æ—è–≤–ª—è–ª—Å—è —Å—Ä–∞–∑—É, —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ —Å –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ TS

### –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ–¥—Ö–æ–¥:

1. **"Keep It Simple"**: –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å state –∏–∑ –ë–î –∫–∞–∫ –µ—Å—Ç—å
2. **Trust the Data**: –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∞–Ω—ã –≤ –ë–î, –æ–Ω–∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –Ω–∞ —Ç–æ—Ç –º–æ–º–µ–Ω—Ç
3. **Natural Updates**: –ü–æ–∑–≤–æ–ª–∏—Ç—å update_price() –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ –æ–±–Ω–æ–≤–ª—è—Ç—å peaks –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
4. **Consistency First**: –í—Å–µ–≥–¥–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å consistency –º–µ–∂–¥—É —Å–≤—è–∑–∞–Ω–Ω—ã–º–∏ –ø–æ–ª—è–º–∏

---

## ‚úÖ –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò

1. ‚úÖ **–ö–æ–¥ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω** - peaks –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è –∏–∑ –ë–î
2. ‚úÖ **–ë–î –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞** - highest_price –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –¥–ª—è 2 –ø–æ–∑–∏—Ü–∏–π
3. ‚úÖ **–ö–æ–º–º–∏—Ç —Å–æ–∑–¥–∞–Ω** - –∏–∑–º–µ–Ω–µ–Ω–∏—è –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω—ã
4. ‚è≥ **–¢—Ä–µ–±—É–µ—Ç—Å—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –±–æ—Ç–∞** - –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
5. ‚è≥ **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ TS –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞

---

## üìä VALIDATION CHECKLIST

–ü–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:

```sql
-- 1. –í—Å–µ TS states –∏–º–µ—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ ratios
SELECT
    symbol,
    side,
    highest_price,
    lowest_price,
    current_stop_price,
    CASE
        WHEN side = 'long' AND highest_price != 999999
            THEN ROUND((current_stop_price / highest_price)::numeric, 5)
        WHEN side = 'short' AND lowest_price != 999999
            THEN ROUND((current_stop_price / lowest_price)::numeric, 5)
    END as ratio
FROM monitoring.trailing_stop_state
WHERE is_activated = true;
-- Expected: ratio ‚âà 0.995 –¥–ª—è –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö
```

```sql
-- 2. –ù–µ—Ç –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–π peaks vs current_stop
SELECT
    symbol,
    side,
    entry_price,
    highest_price,
    lowest_price,
    current_stop_price,
    CASE
        WHEN side = 'long' AND current_stop_price > highest_price
            THEN '‚ùå current_stop > highest'
        WHEN side = 'short' AND current_stop_price < lowest_price
            THEN '‚ùå current_stop < lowest'
        ELSE '‚úÖ OK'
    END as consistency_check
FROM monitoring.trailing_stop_state
WHERE is_activated = true;
-- Expected: –≤—Å–µ ‚úÖ OK
```

---

## üéØ CONCLUSION

**–ü—Ä–æ–±–ª–µ–º–∞**: –°–±—Ä–æ—Å peaks –ø—Ä–∏ restore —Å–æ–∑–¥–∞–≤–∞–ª inconsistency —Å current_stop ‚Üí TS "–∑–∞–º–æ—Ä–∞–∂–∏–≤–∞–ª—Å—è"

**–†–µ—à–µ–Ω–∏–µ**: –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å peaks –∏–∑ –ë–î ‚Üí –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ ‚Üí consistency –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∞

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: TS —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞, –Ω–∏–∫–∞–∫–æ–≥–æ "–∑–∞–º–æ—Ä–∞–∂–∏–≤–∞–Ω–∏—è"

**Priority**: P0 (Critical) - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ ‚úÖ

---

**Fix –≤—ã–ø–æ–ª–Ω–µ–Ω**: Claude Code
**–°—Ç–∞—Ç—É—Å**: ‚úÖ Ready for production
