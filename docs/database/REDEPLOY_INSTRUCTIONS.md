# üîÑ –ò–ù–°–¢–†–£–ö–¶–ò–Ø –ü–û –ü–ï–†–ï–†–ê–ó–í–ï–†–¢–´–í–ê–ù–ò–Æ –ë–î

## ‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: –í–°–ï –î–ê–ù–ù–´–ï –ë–£–î–£–¢ –£–î–ê–õ–ï–ù–´!

–≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é —É–¥–∞–ª—è–µ—Ç —Å—Ç–∞—Ä—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ë–î –∏ —Å–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—É—é —Å –Ω—É–ª—è.

---

## üéØ –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å

- –£ –≤–∞—Å –µ—Å—Ç—å —Å—Ç–∞—Ä–∞—è —Å—Ö–µ–º–∞ –∏–∑ –Ω–µ–¥–æ–¥–µ–ª–∞–Ω–Ω–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞
- –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ë–î –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç production
- –ù—É–∂–Ω–æ –ø–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å –ë–î —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π
- –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `has_trailing_stop`)

---

## üìã –ß—Ç–æ –¥–µ–ª–∞–µ—Ç —Å–∫—Ä–∏–ø—Ç

1. **DROP SCHEMA monitoring CASCADE** - —É–¥–∞–ª—è–µ—Ç –≤—Å—ë –∏–∑ monitoring
2. **DROP SCHEMA fas CASCADE** - —É–¥–∞–ª—è–µ—Ç legacy FAS (–µ—Å–ª–∏ –µ—Å—Ç—å)
3. **DROP FUNCTION update_updated_at_column()** - —É–¥–∞–ª—è–µ—Ç orphaned —Ñ—É–Ω–∫—Ü–∏–∏
4. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—á–∏—Å—Ç–∫–∏** - –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç —á—Ç–æ –≤—Å—ë —É–¥–∞–ª–µ–Ω–æ
5. **\i database/DEPLOY_SCHEMA.sql** - —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ—Ç —Å–≤–µ–∂—É—é —Å—Ö–µ–º—É v3.0
6. **–§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞** - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —á—Ç–æ —Å–æ–∑–¥–∞–Ω–æ

---

## üöÄ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ß–µ—Ä–µ–∑ bash —Å–∫—Ä–∏–ø—Ç (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

```bash
# –ó–∞–ø—É—Å–∫ —Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º
bash database/redeploy_clean.sh

# –ò–ª–∏ —Å —è–≤–Ω—ã–º —É–∫–∞–∑–∞–Ω–∏–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
bash database/redeploy_clean.sh fox_crypto evgeniyyanvarskiy localhost 5432
```

**–°–∫—Ä–∏–ø—Ç –ø–æ–ø—Ä–æ—Å–∏—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ:**
```
‚ö†Ô∏è  WARNING: DESTRUCTIVE OPERATION ‚ö†Ô∏è
...
Are you ABSOLUTELY sure? Type 'YES' to continue:
```

–í–≤–µ–¥–∏—Ç–µ `YES` (–∑–∞–≥–ª–∞–≤–Ω—ã–º–∏!) –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è.

### –í–∞—Ä–∏–∞–Ω—Ç 2: –ù–∞–ø—Ä—è–º—É—é —á–µ—Ä–µ–∑ psql

```bash
# –° –ø–∞—Ä–æ–ª–µ–º –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è
PGPASSWORD='your_password' psql -h localhost -U evgeniyyanvarskiy -d fox_crypto -f database/REDEPLOY_CLEAN.sql

# –ò–ª–∏ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ (–ø–æ–ø—Ä–æ—Å–∏—Ç –ø–∞—Ä–æ–ª—å)
psql -h localhost -U evgeniyyanvarskiy -d fox_crypto -f database/REDEPLOY_CLEAN.sql
```

---

## üìä –ß—Ç–æ –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω–æ

–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Å–∫—Ä–∏–ø—Ç–∞ –≤—ã –ø–æ–ª—É—á–∏—Ç–µ:

### ‚úÖ 1 Schema
- `monitoring` - –≤—Å—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–æ—Ç–∞

### ‚úÖ 10 Tables
1. `monitoring.positions` - –ø–æ–∑–∏—Ü–∏–∏ (—Å `has_trailing_stop`, `has_stop_loss`, `error_details`)
2. `monitoring.orders` - –æ—Ä–¥–µ—Ä–∞
3. `monitoring.trades` - —Å–¥–µ–ª–∫–∏
4. `monitoring.events` - —Å–æ–±—ã—Ç–∏—è
5. `monitoring.trailing_stop_state` - trailing stop —Å–æ—Å—Ç–æ—è–Ω–∏—è
6. `monitoring.performance_metrics` - –º–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
7. `monitoring.event_performance_metrics` - event-based –º–µ—Ç—Ä–∏–∫–∏
8. `monitoring.risk_events` - —Ä–∏—Å–∫ —Å–æ–±—ã—Ç–∏—è
9. `monitoring.risk_violations` - –Ω–∞—Ä—É—à–µ–Ω–∏—è —Ä–∏—Å–∫-–ø—Ä–∞–≤–∏–ª
10. `monitoring.transaction_log` - –ª–æ–≥ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π

### ‚úÖ 37 Indexes
- –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–ª—è –≤—Å–µ—Ö —á–∞—Å—Ç—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- Partial indexes –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
- Composite indexes –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

### ‚úÖ 2 Triggers
- `update_positions_updated_at` - –∞–≤—Ç–æ-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ updated_at –¥–ª—è positions
- `update_trades_updated_at` - –∞–≤—Ç–æ-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ updated_at –¥–ª—è trades

### ‚úÖ 1 Foreign Key
- `trailing_stop_state.position_id` ‚Üí `positions.id` (ON DELETE CASCADE)

---

## üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞

–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Å–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–∫–∞–∂–µ—Ç:

```
‚úÖ Schema: monitoring | table_count: 10
‚úÖ Total indexes: 37
‚úÖ Total triggers: 2
```

–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Ä—É—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞:

```sql
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–∞–±–ª–∏—Ü—ã
SELECT schemaname, tablename
FROM pg_tables
WHERE schemaname = 'monitoring'
ORDER BY tablename;

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ has_trailing_stop —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
\d monitoring.positions

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã
SELECT COUNT(*) FROM pg_indexes WHERE schemaname = 'monitoring';
```

---

## ‚ö° –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç (–¥–ª—è –Ω–µ—Ç–µ—Ä–ø–µ–ª–∏–≤—ã—Ö)

```bash
# 1. –û—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –±–æ—Ç–∞ (–µ—Å–ª–∏ –∑–∞–ø—É—â–µ–Ω)
pkill -f "python.*main.py"

# 2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –ø–µ—Ä–µ—Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ
bash database/redeploy_clean.sh

# 3. –í–≤–µ–¥–∏—Ç–µ YES –∫–æ–≥–¥–∞ –ø–æ–ø—Ä–æ—Å–∏—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ

# 4. –î–æ–∂–¥–∏—Ç–µ—Å—å "üéâ SUCCESS!"

# 5. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞ —Å–Ω–æ–≤–∞
python main.py
```

---

## üõ°Ô∏è –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –ß—Ç–æ –ù–ï —É–¥–∞–ª—è–µ—Ç—Å—è:
- ‚ùå –°–∞–º–∞ –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö `fox_crypto`
- ‚ùå –î—Ä—É–≥–∏–µ —Å—Ö–µ–º—ã (public, pg_catalog, etc.)
- ‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∏ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞

### –ß—Ç–æ —É–¥–∞–ª—è–µ—Ç—Å—è:
- ‚úÖ –í—Å—è —Å—Ö–µ–º–∞ `monitoring` —Å–æ –≤—Å–µ–º–∏ –¥–∞–Ω–Ω—ã–º–∏
- ‚úÖ –í—Å–µ –ø–æ–∑–∏—Ü–∏–∏, –æ—Ä–¥–µ—Ä–∞, —Å–¥–µ–ª–∫–∏, —Å–æ–±—ã—Ç–∏—è
- ‚úÖ –í—Å—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –º–µ—Ç—Ä–∏–∫–∏
- ‚úÖ Legacy —Å—Ö–µ–º–∞ `fas` (–µ—Å–ª–∏ –±—ã–ª–∞)

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:
1. **–°–¥–µ–ª–∞–π—Ç–µ backup** –µ—Å–ª–∏ –Ω—É–∂–Ω—ã –¥–∞–Ω–Ω—ã–µ:
   ```bash
   pg_dump -h localhost -U evgeniyyanvarskiy -d fox_crypto -n monitoring > backup_monitoring.sql
   ```

2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –±–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω** –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ—Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ–º

3. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –Ω–∞ —Ç–µ—Å—Ç–æ–≤–æ–π –ë–î** —Å–Ω–∞—á–∞–ª–∞:
   ```bash
   bash database/redeploy_clean.sh fox_crypto_test
   ```

---

## üÜò Troubleshooting

### –û—à–∏–±–∫–∞: "database does not exist"
```bash
createdb fox_crypto
```

### –û—à–∏–±–∫–∞: "permission denied"
–£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–º–µ–µ—Ç –ø—Ä–∞–≤–∞:
```sql
ALTER DATABASE fox_crypto OWNER TO evgeniyyanvarskiy;
```

### –û—à–∏–±–∫–∞: "cannot drop schema monitoring because other objects depend on it"
–≠—Ç–æ –Ω–µ –¥–æ–ª–∂–Ω–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç—å (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è CASCADE), –Ω–æ –µ—Å–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–æ:
```sql
-- –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞
DROP SCHEMA monitoring CASCADE;
DROP SCHEMA fas CASCADE;
```

### –°–∫—Ä–∏–ø—Ç –∑–∞–≤–∏—Å –Ω–∞ "Are you ABSOLUTELY sure?"
–í–≤–µ–¥–∏—Ç–µ `YES` (–∑–∞–≥–ª–∞–≤–Ω—ã–º–∏ –±—É–∫–≤–∞–º–∏), –Ω–µ `yes` –∏–ª–∏ `Yes`.

---

## üìù –ü–æ—Å–ª–µ –ø–µ—Ä–µ—Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è

1. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—É**:
   ```sql
   \d monitoring.positions
   ```
   –î–æ–ª–∂–Ω—ã –±—ã—Ç—å –∫–æ–ª–æ–Ω–∫–∏: `has_trailing_stop`, `has_stop_loss`, `error_details`

2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –±–æ—Ç–∞**:
   ```bash
   python3 -c "
   from database.repository import Repository
   import asyncio

   async def test():
       repo = Repository()
       await repo.connect()
       print('‚úÖ Connection successful!')
       await repo.close()

   asyncio.run(test())
   "
   ```

3. **–ó–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞** –∏ —É–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –Ω–µ—Ç –æ—à–∏–±–æ–∫ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å –ë–î

---

## ‚úÖ –ì–æ—Ç–æ–≤–æ!

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —É –≤–∞—Å –±—É–¥–µ—Ç:
- ‚úÖ –ß–∏—Å—Ç–∞—è –ë–î —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π (v3.0)
- ‚úÖ –í—Å–µ –Ω—É–∂–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã –∏ –∫–æ–ª–æ–Ω–∫–∏
- ‚úÖ –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã
- ‚úÖ –†–∞–±–æ—Ç–∞—é—â–∏–µ —Ç—Ä–∏–≥–≥–µ—Ä—ã
- ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ production –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é

**–¢–µ–ø–µ—Ä—å –±–æ—Ç –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π –ë–î!** üéâ
