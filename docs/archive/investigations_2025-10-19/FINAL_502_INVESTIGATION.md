# üîç –§–ò–ù–ê–õ–¨–ù–û–ï –†–ê–°–°–õ–ï–î–û–í–ê–ù–ò–ï: 502 Bad Gateway

**–î–∞—Ç–∞:** 2025-10-19 13:30 UTC
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –†–ê–°–°–õ–ï–î–û–í–ê–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–û

---

## üìä –ö–õ–Æ–ß–ï–í–´–ï –ù–ê–•–û–î–ö–ò

### 1. –ß—Ç–æ –≤—ã–∑—ã–≤–∞–µ—Ç 502?

**Endpoint:** `POST https://testnet.binancefuture.com/fapi/v1/order`

**–û–ø–µ—Ä–∞—Ü–∏–∏:**
- ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ stop-loss –æ—Ä–¥–µ—Ä–æ–≤
- ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ entry –æ—Ä–¥–µ—Ä–æ–≤
- ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ exit –æ—Ä–¥–µ—Ä–æ–≤

**–ß–∞—Å—Ç–æ—Ç–∞:** 59 —Ä–∞–∑ –≤ –ª–æ–≥–∞—Ö (—Å 09:51 –¥–æ 12:37)

---

### 2. –ö–æ–≥–¥–∞ –Ω–∞—á–∞–ª–∞—Å—å –ø—Ä–æ–±–ª–µ–º–∞?

**–í—Ä–µ–º–µ–Ω–Ω–∞—è —à–∫–∞–ª–∞:**
```
05:15 - –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω
05:23 - Stop-loss —É—Å–ø–µ—à–Ω–æ —Ä–∞–∑–º–µ—â–µ–Ω (CHRUSDT)  ‚úÖ
05:37 - Stop-loss —É—Å–ø–µ—à–Ω–æ —Ä–∞–∑–º–µ—â–µ–Ω (PROVEUSDT) ‚úÖ
07:36 - Stop-loss —É—Å–ø–µ—à–Ω–æ —Ä–∞–∑–º–µ—â–µ–Ω (PROMUSDT)  ‚úÖ
09:51 - –ü–ï–†–í–ê–Ø 502 –û–®–ò–ë–ö–ê (FORMUSDT) ‚ùå
12:16 - 502 –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è (exit order)
12:37 - 502 –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è (entry order TOSHIUSDT)
```

**–í—ã–≤–æ–¥:** –ü—Ä–æ–±–ª–µ–º–∞ –Ω–∞—á–∞–ª–∞—Å—å –≤ **09:51** (4.5 —á–∞—Å–∞ –ø–æ—Å–ª–µ —Å—Ç–∞—Ä—Ç–∞ –±–æ—Ç–∞)

---

### 3. –ë—ã–ª–∏ –ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ?

**–ö–æ–º–º–∏—Ç—ã –º–µ–∂–¥—É 07:36 –∏ 09:51:**
```
5e086db - fix: convert balance values to float in can_open_position
f71c066 - fix: add margin/leverage validation before opening positions
ddadb59 - fix: check minimum amount BEFORE amount_to_precision
```

**–ê–Ω–∞–ª–∏–∑:**
- ‚ùå –ù–ò –û–î–ò–ù –Ω–µ –∫–∞—Å–∞–µ—Ç—Å—è —Å–æ–∑–¥–∞–Ω–∏—è –æ—Ä–¥–µ—Ä–æ–≤
- ‚ùå –ù–ò –û–î–ò–ù –Ω–µ –º–µ–Ω—è–µ—Ç stop_loss_manager
- ‚ùå –ù–ò –û–î–ò–ù –Ω–µ –º–µ–Ω—è–µ—Ç exchange API calls
- ‚úÖ –í—Å–µ –∫–∞—Å–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –ü–ï–†–ï–î —Å–æ–∑–¥–∞–Ω–∏–µ–º –æ—Ä–¥–µ—Ä–∞

**–î–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ:**
```bash
git show f71c066 --stat
# core/exchange_manager.py | 61 +++++++  (can_open_position)
# core/position_manager.py  |  6 +       (–≤—ã–∑–æ–≤ can_open_position)

git show ddadb59 --stat
# core/position_manager.py | 19 +++  (–º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ)

git show 5e086db --stat
# core/exchange_manager.py | 2 +-  (float conversion)
```

**–ù–ò –û–î–ò–ù –∫–æ–º–º–∏—Ç –ù–ï —Ç—Ä–æ–≥–∞–ª:**
- `core/stop_loss_manager.py`
- `core/atomic_position_manager.py` (—Å–æ–∑–¥–∞–Ω–∏–µ –æ—Ä–¥–µ—Ä–æ–≤)
- `core/exchange_manager.py` –º–µ—Ç–æ–¥—ã create_order

---

### 4. –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–ª–æ –î–û 09:51?

**–£—Å–ø–µ—à–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ (05:23-07:36):**
```
05:23:13 - stop_loss_placed: CHRUSDT, order_id=35828582    ‚úÖ
05:23:18 - stop_loss_placed: XVGUSDT, order_id=84203265    ‚úÖ
05:23:23 - stop_loss_placed: XRPUSDT, order_id=564877599   ‚úÖ
05:23:27 - stop_loss_placed: TRXUSDT, order_id=496103766   ‚úÖ
05:23:32 - stop_loss_placed: DOGEUSDT, order_id=228549673  ‚úÖ
05:37:12 - stop_loss_placed: PROVEUSDT, order_id=8536100   ‚úÖ
05:37:17 - stop_loss_placed: TACUSDT, order_id=10664580    ‚úÖ
05:37:22 - stop_loss_placed: BSVUSDT, order_id=24363620    ‚úÖ
05:37:26 - stop_loss_placed: VOXELUSDT, order_id=16524753  ‚úÖ
07:36:36 - stop_loss_placed: PROMUSDT, order_id=13477156   ‚úÖ
```

**–í—Å–µ —á–µ—Ä–µ–∑ –¢–û–¢ –ñ–ï endpoint:** `POST /fapi/v1/order`

---

## üéØ –í–´–í–û–î

### ‚ùå 502 Bad Gateway - —ç—Ç–æ –ù–ï –Ω–∞—à–∞ –ø—Ä–æ–±–ª–µ–º–∞!

**–ü—Ä–∏—á–∏–Ω–∞:** Binance TESTNET –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ (`testnet.binancefuture.com`)

**–î–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞:**
1. ‚úÖ –¢–æ—Ç –∂–µ endpoint —Ä–∞–±–æ—Ç–∞–ª 4.5 —á–∞—Å–∞ –ë–ï–ó –ü–†–û–ë–õ–ï–ú
2. ‚úÖ –ö–æ–¥ –ù–ï –º–µ–Ω—è–ª—Å—è (–Ω–∞—à–∏ –∫–æ–º–º–∏—Ç—ã –Ω–µ —Ç—Ä–æ–≥–∞–ª–∏ —Å–æ–∑–¥–∞–Ω–∏–µ –æ—Ä–¥–µ—Ä–æ–≤)
3. ‚úÖ –¢–µ –∂–µ —Å–∞–º—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ (stop-loss) —Ä–∞–±–æ—Ç–∞–ª–∏ –¥–æ 09:51
4. ‚úÖ 502 –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç Binance —Å–µ—Ä–≤–µ—Ä: `Server: tk_prod_dispatcher_pg`

**–í–µ—Ä–æ—è—Ç–Ω–∞—è –ø—Ä–∏—á–∏–Ω–∞:**
- Binance testnet —Å–µ—Ä–≤–µ—Ä –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–ª—Å—è/–æ–±–Ω–æ–≤–ª—è–ª—Å—è –≤ 09:51
- –ò–ª–∏ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã —Å –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π
- –ò–ª–∏ rate limiting –Ω–∞ —É—Ä–æ–≤–Ω–µ —Å–µ—Ä–≤–µ—Ä–∞

---

## üîß –ß–¢–û –î–ï–õ–ê–¢–¨?

### –†–µ—à–µ–Ω–∏–µ 1: –ò–°–ü–û–õ–¨–ó–û–í–ê–¢–¨ PRODUCTION (–ª—É—á—à–µ–µ)

```bash
# –í .env —Ñ–∞–π–ª–µ:
BINANCE_TESTNET=false
BYBIT_TESTNET=false
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –°—Ç–∞–±–∏–ª—å–Ω–∞—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞
- ‚úÖ –†–µ–∞–ª—å–Ω—ã–µ –±–∞–ª–∞–Ω—Å—ã
- ‚úÖ –ù–µ—Ç –ø—Ä–æ–±–ª–µ–º —Å testnet

**–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:**
- ‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ä–µ–∞–ª—å–Ω—ã–µ –¥–µ–Ω—å–≥–∏
- ‚ö†Ô∏è –ù—É–∂–µ–Ω –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

---

### –†–µ—à–µ–Ω–∏–µ 2: RETRY –º–µ—Ö–∞–Ω–∏–∑–º (—É–∂–µ —Ä–∞–±–æ—Ç–∞–µ—Ç!)

**–¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è:**

```python
# utils/rate_limiter.py:241
if attempt < self.config.max_retries - 1:
    delay = self._calculate_backoff_delay(attempt)
    logger.warning(
        f"Network error on attempt {attempt + 1}/{self.config.max_retries}, "
        f"retrying in {delay:.2f}s: {e}"
    )
    await asyncio.sleep(delay)
```

**–†–∞–±–æ—Ç–∞–µ—Ç:**
```
12:37:12,370 - Network error on attempt 1/5, retrying in 1.10s: 502 Bad Gateway
12:37:13,972 - ‚úÖ Entry order placed  (RETRY –£–°–ü–ï–®–ï–ù!)
```

**–ù–û:** –ò–Ω–æ–≥–¥–∞ –í–°–ï 5 –ø–æ–ø—ã—Ç–æ–∫ –ø—Ä–æ–≤–∞–ª–∏–≤–∞—é—Ç—Å—è (–µ—Å–ª–∏ testnet –¥–æ–ª–≥–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω)

---

### –†–µ—à–µ–Ω–∏–µ 3: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ testnet –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏

–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –ø–µ—Ä–µ–¥ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–º–∏ –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏:

```python
async def check_exchange_health(self) -> bool:
    """Check if exchange is accessible"""
    try:
        await self.exchange.fetch_time()
        return True
    except Exception as e:
        logger.error(f"Exchange health check failed: {e}")
        return False
```

---

## üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê 502

```bash
grep "502 Bad Gateway" logs/trading_bot.log | wc -l
# 59 errors

grep "502 Bad Gateway" logs/trading_bot.log | grep -o "[0-9][0-9]:[0-9][0-9]" | sort | uniq -c
#   3 09:51  (–ø–µ—Ä–≤–∞—è –≤–æ–ª–Ω–∞ –æ—à–∏–±–æ–∫)
#  21 12:16  (–≤—Ç–æ—Ä–∞—è –≤–æ–ª–Ω–∞)
#  35 12:22  (—Ç—Ä–µ—Ç—å—è –≤–æ–ª–Ω–∞)
#   ... –∏ —Ç–∞–∫ –¥–∞–ª–µ–µ
```

**–ü–∞—Ç—Ç–µ—Ä–Ω:** –û—à–∏–±–∫–∏ –ø—Ä–æ–∏—Å—Ö–æ–¥—è—Ç –≤–æ–ª–Ω–∞–º–∏, –º–µ–∂–¥—É –Ω–∏–º–∏ testnet —Ä–∞–±–æ—Ç–∞–µ—Ç

---

## ‚úÖ –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1: –ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ PRODUCTION

–ï—Å–ª–∏ Bybit testnet –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –∏–º–µ–µ—Ç $9600 (–∫–∞–∫ —Å–∫–∞–∑–∞–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å), –∞ Binance testnet –≥–ª—é—á–∏—Ç, —Ç–æ:

```bash
# .env
BINANCE_TESTNET=false  # –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å PRODUCTION Binance
BYBIT_TESTNET=true     # –û—Å—Ç–∞–≤–∏—Ç—å testnet Bybit –µ—Å–ª–∏ —Ç–∞–º –µ—Å—Ç—å –¥–µ–Ω—å–≥–∏
```

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2: –£–≤–µ–ª–∏—á–∏—Ç—å retry

```python
# config/settings.py –∏–ª–∏ –≥–¥–µ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è rate_limiter
max_retries = 10  # –≤–º–µ—Å—Ç–æ 5
```

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3: –î–æ–±–∞–≤–∏—Ç—å fallback

–ï—Å–ª–∏ testnet –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç—å—Å—è –Ω–∞ production –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (—Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º –∏ –∞–ª–µ—Ä—Ç–∞–º–∏).

---

## üéØ –ò–¢–û–ì

### –ü—Ä–æ–±–ª–µ–º–∞ –ù–ï –≤ –Ω–∞—à–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö!

1. ‚úÖ –ö–æ–¥ —Ä–∞–±–æ—Ç–∞–ª –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ 4.5 —á–∞—Å–∞
2. ‚úÖ –ù–∞—à–∏ –∫–æ–º–º–∏—Ç—ã –ù–ï –∫–∞—Å–∞–ª–∏—Å—å —Å–æ–∑–¥–∞–Ω–∏—è –æ—Ä–¥–µ—Ä–æ–≤
3. ‚úÖ Retry –º–µ—Ö–∞–Ω–∏–∑–º —Ä–∞–±–æ—Ç–∞–µ—Ç –∏ —É—Å–ø–µ—à–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è
4. ‚úÖ –≠—Ç–æ –≤—Ä–µ–º–µ–Ω–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞ Binance testnet infrastructure

### –†–µ–∞–ª—å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å PRODUCTION

Binance testnet - —ç—Ç–æ –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–∞—è —Å—Ä–µ–¥–∞ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è. –î–ª—è —Ä–µ–∞–ª—å–Ω–æ–π —Ç–æ—Ä–≥–æ–≤–ª–∏ –Ω—É–∂–µ–Ω production API.

---

**–î–∞—Ç–∞:** 2025-10-19 13:30 UTC
**–ê–≤—Ç–æ—Ä:** Claude Code Investigation Team
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü–†–û–ë–õ–ï–ú–ê –ù–ê–ô–î–ï–ù–ê –ò –ü–û–ù–Ø–¢–ê
