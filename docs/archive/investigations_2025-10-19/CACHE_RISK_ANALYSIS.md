# üîç –ê–ù–ê–õ–ò–ó –†–ò–°–ö–û–í –ö–≠–®–ò–†–û–í–ê–ù–ò–Ø fetch_positions()

**–î–∞—Ç–∞:** 2025-10-19
**–í–æ–ø—Ä–æ—Å:** –ë–µ–∑–æ–ø–∞—Å–Ω–æ –ª–∏ –∫—ç—à–∏—Ä–æ–≤–∞—Ç—å fetch_positions() –Ω–∞ 10 —Å–µ–∫—É–Ω–¥?

---

## üìä –°–¶–ï–ù–ê–†–ò–ô –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Ø

### –ì–¥–µ –í—ã–∑—ã–≤–∞–µ—Ç—Å—è can_open_position()

**–ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–µ –º–µ—Å—Ç–æ:** `core/position_manager.py:1539`
```python
# –í _calculate_position_size(), –ü–ï–†–ï–î –æ—Ç–∫—Ä—ã—Ç–∏–µ–º –ø–æ–∑–∏—Ü–∏–∏
can_open, reason = await exchange.can_open_position(symbol, size_usd)
```

### –ö–æ–≥–¥–∞ –≠—Ç–æ –ü—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç

**–¢–æ–ª—å–∫–æ –≤ –≤–æ–ª–Ω–∞—Ö**, –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–∏–≥–Ω–∞–ª–∞:

```
07:36:09.139 - Signal 1 (can_open_position –≤—ã–∑–≤–∞–Ω)
07:36:11.321 - Signal 2 (gap: 2.2s - –ö–≠–® –ï–©–ï –í–ê–õ–ò–î–ù–´–ô)
07:36:16.176 - Signal 3 (gap: 4.9s –æ—Ç 2-–≥–æ, 7.0s –æ—Ç 1-–≥–æ - –ö–≠–® –í–ê–õ–ò–î–ù–´–ô)
07:36:20.718 - Signal 4 (gap: 4.5s –æ—Ç 3-–≥–æ, 11.6s –æ—Ç 1-–≥–æ - –ö–≠–® –ò–°–¢–ï–ö!)
07:36:22.514 - Signal 5 (gap: 1.8s –æ—Ç 4-–≥–æ)
```

**–í–ê–ñ–ù–û:** –ú–µ–∂–¥—É —Å–∏–≥–Ω–∞–ª–∞–º–∏ 2-5 —Å–µ–∫—É–Ω–¥, –ù–û —Å—É–º–º–∞—Ä–Ω–æ–µ –≤—Ä–µ–º—è –º–æ–∂–µ—Ç –ø—Ä–µ–≤—ã—Å–∏—Ç—å 10s!

---

## üéØ –ß–¢–û –ü–†–û–í–ï–†–Ø–ï–¢ can_open_position()

### 1. Free Balance
```python
free_usdt = balance.get('USDT', {}).get('free', 0)
if free_usdt < notional_usd:
    return False, "Insufficient free balance"
```

**–ê–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å:** fetch_balance() –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –°–í–ï–ñ–ò–ô –∫–∞–∂–¥—ã–π —Ä–∞–∑ ‚úÖ

### 2. Total Notional (–∏–∑ positions)
```python
positions = await self.exchange.fetch_positions()  # ‚Üê –ö–≠–®!
total_notional = sum(abs(float(p.get('notional', 0)))
                    for p in positions if float(p.get('contracts', 0)) > 0)
```

**–ß—Ç–æ –º–æ–∂–µ—Ç –∏–∑–º–µ–Ω–∏—Ç—å—Å—è:**
- ‚ùå –ù–æ–≤–∞—è –ø–æ–∑–∏—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∞ –í –≠–¢–û–ô –ñ–ï –í–û–õ–ù–ï
- ‚ùå –ü–æ–∑–∏—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∞ –ø–æ SL (–æ—á–µ–Ω—å —Ä–µ–¥–∫–æ –∑–∞ 10s)
- ‚ùå Notional –∏–∑–º–µ–Ω–∏–ª—Å—è –∏–∑-–∑–∞ –¥–≤–∏–∂–µ–Ω–∏—è —Ü–µ–Ω—ã

### 3. Utilization Check
```python
utilization = (total_notional + notional_usd) / total_balance
if utilization > 0.80:
    return False, "Would exceed safe utilization"
```

**–ó–∞–≤–∏—Å–∏—Ç –æ—Ç:** total_notional (–∏–∑ –∫—ç—à–∞)

---

## ‚ö†Ô∏è –†–ò–°–ö–ò –ö–≠–®–ò–†–û–í–ê–ù–ò–Ø

### –†–∏—Å–∫ 1: –ü–æ–∑–∏—Ü–∏—è –û—Ç–∫—Ä—ã—Ç–∞ –í –¢–æ–π –ñ–µ –í–æ–ª–Ω–µ

**–°—Ü–µ–Ω–∞—Ä–∏–π:**
```
09:00:00.000 - Signal 1: can_open_position()
              ‚îî‚îÄ fetch_positions() ‚Üí cache [31 positions, total_notional: $6200]
09:00:05.000 - Signal 1: Position OPENED ‚Üí [32 positions, total_notional: $6400]
09:00:06.000 - Signal 2: can_open_position()
              ‚îî‚îÄ fetch_positions() ‚Üí cache HIT [31 positions, total_notional: $6200] ‚ùå –£–°–¢–ê–†–ï–õ!
```

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- total_notional –∑–∞–Ω–∏–∂–µ–Ω –Ω–∞ $200 (—Ä–∞–∑–º–µ—Ä 1-–π –ø–æ–∑–∏—Ü–∏–∏)
- utilization –∑–∞–Ω–∏–∂–µ–Ω: –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç 60% –≤–º–µ—Å—Ç–æ 62%
- –ú–æ–∂–µ—Ç –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é –∫–æ—Ç–æ—Ä–∞—è –ø—Ä–µ–≤—ã—Å–∏—Ç 80%

**–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å:** üî¥ –í–´–°–û–ö–ê–Ø (100% –≤ –≤–æ–ª–Ω–∞—Ö)

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å:** üü° –°–†–ï–î–ù–Ø–Ø
- –£—Ç–∏–ª–∏–∑–∞—Ü–∏—è –∑–∞–Ω–∏–∂–µ–Ω–∞ –º–∞–∫—Å–∏–º—É–º –Ω–∞ (5 √ó $200) / $10000 = 10%
- –ï—Å–ª–∏ —Ä–µ–∞–ª—å–Ω–∞—è —É—Ç–∏–ª–∏–∑–∞—Ü–∏—è 75%, –ø–æ–∫–∞–∂–µ—Ç 65% ‚Üí –ø—Ä–æ–ø—É—Å—Ç–∏—Ç
- –ï—Å–ª–∏ —Ä–µ–∞–ª—å–Ω–∞—è —É—Ç–∏–ª–∏–∑–∞—Ü–∏—è 85%, –ø–æ–∫–∞–∂–µ—Ç 75% ‚Üí –ø—Ä–æ–ø—É—Å—Ç–∏—Ç (–ü–†–û–ë–õ–ï–ú–ê!)

### –†–∏—Å–∫ 2: –ü–æ–∑–∏—Ü–∏—è –ó–∞–∫—Ä—ã—Ç–∞ –ø–æ SL

**–°—Ü–µ–Ω–∞—Ä–∏–π:**
```
09:00:00.000 - fetch_positions() ‚Üí cache [32 positions, $6400]
09:00:03.000 - BTCUSDT –∑–∞–∫—Ä—ã—Ç–∞ –ø–æ SL ‚Üí [31 positions, $6200]
09:00:06.000 - can_open_position() ‚Üí cache HIT [32 positions, $6400] ‚ùå –ó–ê–í–´–®–ï–ù!
```

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- total_notional –∑–∞–≤—ã—à–µ–Ω ‚Üí –º–æ–∂–µ—Ç –æ—Ç–∫–ª–æ–Ω–∏—Ç—å –≤–∞–ª–∏–¥–Ω—É—é –ø–æ–∑–∏—Ü–∏—é
- –ù–æ –ù–ï –ø—Ä–æ–ø—É—Å—Ç–∏—Ç –Ω–µ–≤–∞–ª–∏–¥–Ω—É—é ‚úÖ (–±–µ–∑–æ–ø–∞—Å–Ω–∞—è —Å—Ç–æ—Ä–æ–Ω–∞ –æ—à–∏–±–∫–∏)

**–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å:** üü¢ –ù–ò–ó–ö–ê–Ø (<1% –∑–∞ 10s)

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å:** üü¢ –ù–ò–ó–ö–ê–Ø (–ª–æ–∂–Ω–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ, –Ω–µ –æ–ø–∞—Å–Ω–æ)

### –†–∏—Å–∫ 3: Notional –ò–∑–º–µ–Ω–∏–ª—Å—è –∏–∑-–∑–∞ –¶–µ–Ω—ã

**–°—Ü–µ–Ω–∞—Ä–∏–π:**
```
09:00:00.000 - BTC @ $50,000, notional = $1000
09:00:10.000 - BTC @ $51,000, notional = $1020 (+2%)
```

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- total_notional –º–æ–∂–µ—Ç –æ—Ç–ª–∏—á–∞—Ç—å—Å—è –Ω–∞ ¬±2-5% –∑–∞ 10s
- –ü—Ä–∏ 30 –ø–æ–∑–∏—Ü–∏—è—Ö: –æ—à–∏–±–∫–∞ –¥–æ $300-500

**–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å:** üü° –°–†–ï–î–ù–Ø–Ø (–≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å)

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å:** üü¢ –ù–ò–ó–ö–ê–Ø (–Ω–µ–±–æ–ª—å—à–∞—è –æ—à–∏–±–∫–∞ –≤ —É—Ç–∏–ª–∏–∑–∞—Ü–∏–∏)

---

## üìä –†–ê–°–ß–ï–¢ –ú–ê–ö–°–ò–ú–ê–õ–¨–ù–û–ì–û GAP

### Worst Case Scenario

**–í–æ–ª–Ω–∞ –∏–∑ 6 –ø–æ–∑–∏—Ü–∏–π, –∫–∞–∂–¥–∞—è –ø–æ $200:**

```
T+0s:   Signal 1 - fetch_positions() ‚Üí cache [30 pos, $6000]
T+5s:   Signal 1 opened ‚Üí [31 pos, $6200] (–∫—ç—à —É—Å—Ç–∞—Ä–µ–ª –Ω–∞ $200)
T+6s:   Signal 2 - cache HIT ‚Üí shows $6000 ‚ùå real $6200
T+11s:  Signal 2 opened ‚Üí [32 pos, $6400] (–∫—ç—à —É—Å—Ç–∞—Ä–µ–ª –Ω–∞ $400)
T+12s:  Signal 3 - cache EXPIRED ‚Üí fetch fresh [32 pos, $6400] ‚úÖ
T+17s:  Signal 3 opened ‚Üí [33 pos, $6600]
T+18s:  Signal 4 - cache HIT ‚Üí shows $6400 ‚ùå real $6600
T+23s:  Signal 4 opened ‚Üí [34 pos, $6800]
T+24s:  Signal 5 - cache EXPIRED ‚Üí fetch fresh [34 pos, $6800] ‚úÖ
```

**–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ:**
- Signal 2: –∫—ç—à –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç $6000, —Ä–µ–∞–ª—å–Ω–æ $6200 (gap: $200 = 3.3%)
- Signal 4: –∫—ç—à –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç $6400, —Ä–µ–∞–ª—å–Ω–æ $6600 (gap: $200 = 3.1%)

**–ü—Ä–∏ –±–∞–ª–∞–Ω—Å–µ $10,000:**
- –†–µ–∞–ª—å–Ω–∞—è —É—Ç–∏–ª–∏–∑–∞—Ü–∏—è Signal 2: 62%
- –ü–æ–∫–∞–∑–∞–Ω–Ω–∞—è —É—Ç–∏–ª–∏–∑–∞—Ü–∏—è: 60%
- **–û—à–∏–±–∫–∞: 2% –ø—É–Ω–∫—Ç–∞**

### Best Case Scenario

**TTL = 5s –≤–º–µ—Å—Ç–æ 10s:**

```
T+0s:   Signal 1 - fetch_positions() ‚Üí cache [30 pos, $6000]
T+5s:   Signal 1 opened ‚Üí [31 pos, $6200]
T+6s:   Signal 2 - cache EXPIRED ‚Üí fetch fresh [31 pos, $6200] ‚úÖ
T+11s:  Signal 2 opened ‚Üí [32 pos, $6400]
T+12s:  Signal 3 - cache EXPIRED ‚Üí fetch fresh [32 pos, $6400] ‚úÖ
```

**–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ:** 0% (–∫—ç—à –≤—Å–µ–≥–¥–∞ —Å–≤–µ–∂–∏–π)

**–ù–û:** –≠–∫–æ–Ω–æ–º–∏—è –≤—Ä–µ–º–µ–Ω–∏ —É–º–µ–Ω—å—à–∞–µ—Ç—Å—è!
- TTL=10s: 5 –∫—ç—à —Ö–∏—Ç–æ–≤ –∏–∑ 6 = —ç–∫–æ–Ω–æ–º–∏—è 5√ó758ms = 3.79s
- TTL=5s: 2-3 –∫—ç—à —Ö–∏—Ç–∞ –∏–∑ 6 = —ç–∫–æ–Ω–æ–º–∏—è 2-3√ó758ms = 1.5-2.3s

---

## ‚úÖ –ë–ï–ó–û–ü–ê–°–ù–´–ï –ê–õ–¨–¢–ï–†–ù–ê–¢–ò–í–´

### –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ 1: –ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –ö—ç—à–∞ –ü–æ—Å–ª–µ –û—Ç–∫—Ä—ã—Ç–∏—è

**–ò–¥–µ—è:** –û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à positions —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –æ—Ç–∫—Ä—ã—Ç–∏—è –ø–æ–∑–∏—Ü–∏–∏

```python
# –í position_manager.py, –ø–æ—Å–ª–µ atomic_position.create()
if position:
    # Clear positions cache - next call will fetch fresh data
    await exchange.clear_positions_cache()
    return position
```

**–ü–ª—é—Å—ã:**
- ‚úÖ –ö—ç—à –≤—Å–µ–≥–¥–∞ –∞–∫—Ç—É–∞–ª–µ–Ω –¥–ª—è –°–õ–ï–î–£–Æ–©–ï–ô –ø–æ–∑–∏—Ü–∏–∏
- ‚úÖ –ù–µ—Ç —Ä–∏—Å–∫–∞ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –í—Å–µ –µ—â–µ —ç–∫–æ–Ω–æ–º–∏–º –≤—Ä–µ–º—è (–∫—ç—à —Ä–∞–±–æ—Ç–∞–µ—Ç –º–µ–∂–¥—É –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏)

**–ú–∏–Ω—É—Å—ã:**
- ‚ö†Ô∏è –ú–µ–Ω—å—à–µ –∫—ç—à —Ö–∏—Ç–æ–≤ (—Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ –æ–¥–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏)
- ‚ö†Ô∏è –ú–µ–Ω—å—à–∞—è —ç–∫–æ–Ω–æ–º–∏—è –≤—Ä–µ–º–µ–Ω–∏

**–≠–∫–æ–Ω–æ–º–∏—è:**
- can_open_position() –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –≤ _calculate_position_size()
- –ú–µ–∂–¥—É –≤—ã–∑–æ–≤–æ–º –∏ –æ—Ç–∫—Ä—ã—Ç–∏–µ–º –ø–æ–∑–∏—Ü–∏–∏ –ø—Ä–æ—Ö–æ–¥–∏—Ç –µ—â–µ validate, format, atomic create
- –ö—ç—à –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è? –ù–ï–¢ - —Ä–∞–∑–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏ –æ—Ç–∫—Ä—ã–≤–∞—é—Ç—Å—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ

**–í–´–í–û–î:** –≠—Ç–∞ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ –ù–ï –î–ê–°–¢ –≤—ã–∏–≥—Ä—ã—à–∞! ‚ùå

### –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ 2: –ö—ç—à –¢–æ–ª—å–∫–æ –í–Ω—É—Ç—Ä–∏ –í–æ–ª–Ω—ã

**–ò–¥–µ—è:**
1. –í–æ–ª–Ω–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è ‚Üí fetch_positions() –û–î–ò–ù –†–ê–ó
2. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –≤–æ–ª–Ω—ã
3. –í—Å–µ —Å–∏–≥–Ω–∞–ª—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç –û–î–ù–ò –ò –¢–ï –ñ–ï –¥–∞–Ω–Ω—ã–µ
4. –í–æ–ª–Ω–∞ –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è ‚Üí –æ—á–∏—Å—Ç–∏—Ç—å

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**

```python
# –í signal_processor_websocket.py

async def _execute_wave_signals(self, signals):
    """Execute validated signals for this wave"""

    # –ù–û–í–û–ï: Fetch positions –û–î–ò–ù –†–ê–ó –¥–ª—è –≤—Å–µ–π –≤–æ–ª–Ω—ã
    initial_positions = await self.exchange_manager.exchange.fetch_positions()
    initial_total_notional = sum(abs(float(p.get('notional', 0)))
                                for p in initial_positions
                                if float(p.get('contracts', 0)) > 0)

    logger.info(f"Wave start: {len(initial_positions)} positions, ${initial_total_notional:.2f} notional")

    executed_count = 0

    for idx, signal_result in enumerate(final_signals):
        if executed_count >= max_trades:
            break

        # Calculate ESTIMATED notional after previous positions
        estimated_notional = initial_total_notional + (executed_count * 200)  # Assume $200 per position

        # Pass to position manager
        success = await self._execute_signal(
            signal,
            estimated_total_notional=estimated_notional
        )

        if success:
            executed_count += 1
```

**–ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å can_open_position():**

```python
async def can_open_position(
    self,
    symbol: str,
    notional_usd: float,
    estimated_total_notional: Optional[float] = None  # NEW
) -> Tuple[bool, str]:
    """Check if we can open position"""

    # If estimated provided, use it (–≤–æ–ª–Ω–æ–≤–æ–π —Ä–µ–∂–∏–º)
    if estimated_total_notional is not None:
        total_notional = estimated_total_notional
    else:
        # Normal mode - fetch fresh
        positions = await self.exchange.fetch_positions()
        total_notional = sum(...)

    # Rest of checks...
```

**–ü–ª—é—Å—ã:**
- ‚úÖ –¢–û–ß–ù–û–ï –∑–Ω–∞–Ω–∏–µ —Å–∫–æ–ª—å–∫–æ –ø–æ–∑–∏—Ü–∏–π –æ—Ç–∫—Ä–æ–µ–º –≤ –≤–æ–ª–Ω–µ
- ‚úÖ –ü—Ä–æ—Å—Ç–∞—è –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞—Ü–∏—è ($200 –∑–∞ –ø–æ–∑–∏—Ü–∏—é)
- ‚úÖ –ù–ï–¢ —Ä–∏—Å–∫–∞ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —ç–∫–æ–Ω–æ–º–∏—è –≤—Ä–µ–º–µ–Ω–∏ (—Ç–æ–ª—å–∫–æ 1 fetch –¥–ª—è –≤—Å–µ–π –≤–æ–ª–Ω—ã!)

**–ú–∏–Ω—É—Å—ã:**
- ‚ö†Ô∏è –ï—Å–ª–∏ –ø–æ–∑–∏—Ü–∏—è –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞ (–Ω–µ –æ—Ç–∫—Ä—ã–ª–∞—Å—å), –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç –Ω–µ–≤–µ—Ä–Ω—ã–π
- ‚ö†Ô∏è –ù—É–∂–Ω–æ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å estimated —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–ª–æ–µ–≤ —Ñ—É–Ω–∫—Ü–∏–π

**–≠–∫–æ–Ω–æ–º–∏—è:**
- –ë—ã–ª–æ: 6 √ó 758ms = 4548ms
- –°—Ç–∞–ª–æ: 1 √ó 758ms = 758ms
- **–í—ã–∏–≥—Ä—ã—à: 3790ms (3.8s)** üöÄ

### –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ 3: TTL = 5 –°–µ–∫—É–Ω–¥ (–ö–æ–º–ø—Ä–æ–º–∏—Å—Å)

**–ò–¥–µ—è:** –£–º–µ–Ω—å—à–∏—Ç—å TTL —á—Ç–æ–±—ã –∫—ç—à —á–∞—â–µ –æ–±–Ω–æ–≤–ª—è–ª—Å—è

**–ü–ª—é—Å—ã:**
- ‚úÖ –ú–µ–Ω—å—à–µ —Ä–∏—Å–∫ —É—Å—Ç–∞—Ä–µ–≤–∞–Ω–∏—è
- ‚úÖ –ü—Ä–æ—â–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å
- ‚úÖ –í—Å–µ –µ—â–µ –¥–∞–µ—Ç –≤—ã–∏–≥—Ä—ã—à

**–ú–∏–Ω—É—Å—ã:**
- ‚ö†Ô∏è –ú–µ–Ω—å—à–∞—è —ç–∫–æ–Ω–æ–º–∏—è –≤—Ä–µ–º–µ–Ω–∏ (2-3 —Ö–∏—Ç–∞ –≤–º–µ—Å—Ç–æ 5)

**–≠–∫–æ–Ω–æ–º–∏—è:**
- –ü—Ä–∏–º–µ—Ä–Ω–æ 50% –æ—Ç TTL=10s
- **–í—ã–∏–≥—Ä—ã—à: ~1.5-2s** üü°

### –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ 4: –£–±—Ä–∞—Ç—å can_open_position() –í–æ–æ–±—â–µ

**–ò–¥–µ—è:** –ü–æ–ª–∞–≥–∞—Ç—å—Å—è –Ω–∞ Binance –∫–æ—Ç–æ—Ä—ã–π –æ—Ç–∫–ª–æ–Ω–∏—Ç –µ—Å–ª–∏ –ø—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç

**–ü–ª—é—Å—ã:**
- ‚úÖ –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –ø—Ä–æ—Å—Ç–æ—Ç–∞
- ‚úÖ –ù–µ—Ç –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –≤–æ–æ–±—â–µ
- ‚úÖ –≠–∫–æ–Ω–æ–º–∏—è 6.5s!

**–ú–∏–Ω—É—Å—ã:**
- ‚ùå –ü–æ–∑–∏—Ü–∏—è —Å–æ–∑–¥–∞–µ—Ç—Å—è –≤ –ë–î, –ø–æ—Ç–æ–º –æ—Ç–∫–∞—Ç—ã–≤–∞–µ—Ç—Å—è
- ‚ùå Atomic operation —Ä–∞—Å—Ö–æ–¥—É–µ—Ç—Å—è –≤–ø—É—Å—Ç—É—é
- ‚ùå –õ–æ–≥–∏ –∑–∞—Å–æ—Ä—è—é—Ç—Å—è –æ—à–∏–±–∫–∞–º–∏
- ‚ùå –¢–µ—Ä—è–µ–º –ø—Ä–æ–∞–∫—Ç–∏–≤–Ω—É—é –∑–∞—â–∏—Ç—É

**–í–´–í–û–î:** –ù–ï —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è ‚ùå

---

## üéØ –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–Ø

### –õ–£–ß–®–ï–ï –†–ï–®–ï–ù–ò–ï: –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ 2 (–í–æ–ª–Ω–æ–≤–æ–π –ö—ç—à)

**–ü–æ—á–µ–º—É:**
1. ‚úÖ **–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å** - –∑–Ω–∞–µ–º —Å–∫–æ–ª—å–∫–æ –ø–æ–∑–∏—Ü–∏–π –æ—Ç–∫—Ä–æ–µ–º
2. ‚úÖ **–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å** - —Ç–æ–ª—å–∫–æ 1 fetch –Ω–∞ –≤–æ–ª–Ω—É
3. ‚úÖ **–ù–µ—Ç —Ä–∏—Å–∫–æ–≤** - –∏—Å–ø–æ–ª—å–∑—É–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ + –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç
4. ‚úÖ **–ü—Ä–æ—Å—Ç–∞—è –ª–æ–≥–∏–∫–∞** - estimated_notional = initial + (count √ó 200)

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**

```python
# –í signal_processor_websocket.py
initial_notional = fetch_positions_once()

for i, signal in enumerate(signals):
    estimated_notional = initial_notional + (i √ó 200)

    can_open = await exchange.can_open_position(
        signal.symbol,
        200,
        estimated_total_notional=estimated_notional
    )

    if can_open:
        position = await open_position(signal)
```

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- `core/signal_processor_websocket.py`: –¥–æ–±–∞–≤–∏—Ç—å fetch –≤ –Ω–∞—á–∞–ª–µ –≤–æ–ª–Ω—ã
- `core/exchange_manager.py`: –¥–æ–±–∞–≤–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä estimated_total_notional
- ~30 —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞

**–≠–∫–æ–Ω–æ–º–∏—è:** 3.8s (–±—ã–ª–æ 6.5s, —Å—Ç–∞–Ω–µ—Ç 2.7s –Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—é)

### –ö–û–ú–ü–†–û–ú–ò–°–°: –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ 3 (TTL=5s)

**–ï—Å–ª–∏ –≤–æ–ª–Ω–æ–≤–æ–π –∫—ç—à —Å–ª–æ–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å:**

```python
self._cache_ttl = 5  # –í–º–µ—Å—Ç–æ 10 —Å–µ–∫—É–Ω–¥
```

**–≠–∫–æ–Ω–æ–º–∏—è:** ~1.5-2s (–±—ã–ª–æ 6.5s, —Å—Ç–∞–Ω–µ—Ç 4.5-5s)

**–†–∏—Å–∫:** –°—Ä–µ–¥–Ω–∏–π (2% –æ—à–∏–±–∫–∞ –≤ —É—Ç–∏–ª–∏–∑–∞—Ü–∏–∏ –º–∞–∫—Å–∏–º—É–º)

---

## üìä –°–†–ê–í–ù–ò–¢–ï–õ–¨–ù–ê–Ø –¢–ê–ë–õ–ò–¶–ê

| –†–µ—à–µ–Ω–∏–µ | –≠–∫–æ–Ω–æ–º–∏—è | –†–∏—Å–∫ | –°–ª–æ–∂–Ω–æ—Å—Ç—å | –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è |
|---------|----------|------|-----------|--------------|
| TTL=10s (–ø–ª–∞–Ω 2C) | 3.6s | üî¥ –í—ã—Å–æ–∫–∏–π (10% –æ—à–∏–±–∫–∞) | üü¢ –ù–∏–∑–∫–∞—è | ‚ùå –ù–ï —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è |
| TTL=5s | 1.5-2s | üü° –°—Ä–µ–¥–Ω–∏–π (2% –æ—à–∏–±–∫–∞) | üü¢ –ù–∏–∑–∫–∞—è | üü° –ö–æ–º–ø—Ä–æ–º–∏—Å—Å |
| –í–æ–ª–Ω–æ–≤–æ–π –∫—ç—à (Alt 2) | 3.8s | üü¢ –ù–∏–∑–∫–∏–π (—Ç–æ—á–Ω—ã–π) | üü° –°—Ä–µ–¥–Ω—è—è | ‚úÖ –õ–£–ß–®–ï–ï |
| –£–±—Ä–∞—Ç—å can_open | 6.5s | üî¥ –û—á–µ–Ω—å –≤—ã—Å–æ–∫–∏–π | üü¢ –ù–∏–∑–∫–∞—è | ‚ùå –ù–ï —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è |
| –ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ—Å–ª–µ open | 0s | üü¢ –ù–∏–∑–∫–∏–π | üü° –°—Ä–µ–¥–Ω—è—è | ‚ùå –ù–µ—Ç –≤—ã–∏–≥—Ä—ã—à–∞ |

---

## ‚úÖ –§–ò–ù–ê–õ–¨–ù–ê–Ø –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–Ø

**–ò–°–ü–û–õ–¨–ó–û–í–ê–¢–¨ –ê–õ–¨–¢–ï–†–ù–ê–¢–ò–í–£ 2: –í–æ–ª–Ω–æ–≤–æ–π –ö—ç—à**

**–ü–ª–∞–Ω:**
1. Fetch positions –û–î–ò–ù –†–ê–ó –≤ –Ω–∞—á–∞–ª–µ –≤–æ–ª–Ω—ã
2. –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å estimated_notional –¥–ª—è –∫–∞–∂–¥–æ–π –ø–æ–∑–∏—Ü–∏–∏
3. –ü–µ—Ä–µ–¥–∞–≤–∞—Ç—å estimated –≤ can_open_position()
4. –ï—Å–ª–∏ –ø–æ–∑–∏—Ü–∏—è –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞ - –ù–ï –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å

**–ö–æ–¥ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≥–æ—Ç–æ–≤ –≤ —Å–ª–µ–¥—É—é—â–µ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ –µ—Å–ª–∏ –æ–¥–æ–±—Ä–∏—à—å!**

---

**–î–∞—Ç–∞:** 2025-10-19
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ê–ù–ê–õ–ò–ó –ó–ê–í–ï–†–®–ï–ù
**–í—ã–≤–æ–¥:** –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å TTL=10s **–†–ò–°–ö–û–í–ê–ù–ù–û**, –∏—Å–ø–æ–ª—å–∑—É–µ–º **–í–æ–ª–Ω–æ–≤–æ–π –ö—ç—à** –≤–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ!
