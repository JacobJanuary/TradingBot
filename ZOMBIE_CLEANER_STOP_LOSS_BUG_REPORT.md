# üö® –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –ë–ê–ì: Zombie Cleaner —É–¥–∞–ª—è–µ—Ç STOP-LOSS –æ—Ä–¥–µ—Ä–∞

**–î–∞—Ç–∞:** 2025-10-11
**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å:** üî¥ **CRITICAL** - –ü–æ–∑–∏—Ü–∏–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∑–∞—â–∏—Ç—ã!
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞ –Ω–∞–π–¥–µ–Ω–∞

---

## üìã –°–ò–ú–ü–¢–û–ú–´

**–ß—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ:**
1. –ë–æ—Ç—ã –±—ã–ª–∏ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã (shutdown)
2. –í—Å–µ –æ—Ä–¥–µ—Ä–∞ –Ω–∞ Binance **–∏—Å—á–µ–∑–ª–∏**
3. –ü–æ–∑–∏—Ü–∏–∏ –æ—Å—Ç–∞–ª–∏—Å—å –æ—Ç–∫—Ä—ã—Ç—ã–º–∏
4. –¢–∞–±–ª–∏—Ü–∞ `monitoring.orders` –≤ –ë–î **–ø–æ–ª–Ω–æ—Å—Ç—å—é –ø—É—Å—Ç–∞—è**

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- ‚ö†Ô∏è 7 –∞–∫—Ç–∏–≤–Ω—ã—Ö SHORT –ø–æ–∑–∏—Ü–∏–π –ë–ï–ó STOP-LOSS –∑–∞—â–∏—Ç—ã
- ‚ö†Ô∏è –ü–æ–∑–∏—Ü–∏–∏ –Ω–∞ —Å—É–º–º—É ~$500 –ø–æ–¥–≤–µ—Ä–∂–µ–Ω—ã —Ä–∏—Å–∫—É –ª–∏–∫–≤–∏–¥–∞—Ü–∏–∏
- ‚ö†Ô∏è –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞—Ç—å —É–±—ã—Ç–∫–∏

---

## üîç –†–ê–°–°–õ–ï–î–û–í–ê–ù–ò–ï

### –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è

**–ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏ –≤ –ë–î:**
```sql
SELECT COUNT(*) FROM monitoring.positions WHERE status = 'active';
-- –†–µ–∑—É–ª—å—Ç–∞—Ç: 7 –ø–æ–∑–∏—Ü–∏–π
```

**–û—Ä–¥–µ—Ä–∞ –≤ –ë–î:**
```sql
SELECT COUNT(*) FROM monitoring.orders;
-- –†–µ–∑—É–ª—å—Ç–∞—Ç: 0 –æ—Ä–¥–µ—Ä–æ–≤ (!!)
```

### –®–∞–≥ 2: –ê–Ω–∞–ª–∏–∑ –ª–æ–≥–æ–≤

**–¢–∞–π–º–ª–∞–π–Ω —Å–æ–±—ã—Ç–∏–π –∏–∑ logs/trading_bot.log:**

```log
04:25:13 - üßπ Starting enhanced zombie order cleanup...
04:25:13 - üîß Running advanced Binance zombie cleanup for binance
04:25:13 - ‚úÖ Fetched 10 orders
04:25:16 - üßü Found 10 zombie orders total:
04:25:16 - ‚úÖ Cancelled orphaned order 5949443  ‚Üê STOP-LOSS –¥–ª—è XPINUSDT!
04:25:17 - ‚úÖ Cancelled orphaned order 15015758 ‚Üê STOP-LOSS –¥–ª—è RENDERUSDT!
04:25:19 - ‚úÖ Cancelled orphaned order 4441222  ‚Üê STOP-LOSS –¥–ª—è BLESSUSDT!
04:25:20 - ‚úÖ Cancelled orphaned order 21672217 ‚Üê STOP-LOSS –¥–ª—è QNTUSDT!
04:25:21 - ‚úÖ Cancelled orphaned order 9382962  ‚Üê STOP-LOSS –¥–ª—è BSVUSDT!
04:25:22 - ‚úÖ Cleanup complete: 10/10 removed
04:25:20 - Shutdown initiated...
```

**üö® –ö–†–ò–¢–ò–ß–ù–ê–Ø –ù–ê–•–û–î–ö–ê:**
- –ó–∞ 7 —Å–µ–∫—É–Ω–¥ –î–û shutdown Zombie Cleaner —É–¥–∞–ª–∏–ª **–í–°–ï 10 STOP-LOSS –æ—Ä–¥–µ—Ä–æ–≤**
- –ü—Ä–∏—á–∏–Ω–∞: –°—á–∏—Ç–∞–ª –∏—Ö "orphaned" (–æ—Å–∏—Ä–æ—Ç–µ–≤—à–∏–º–∏)

### –®–∞–≥ 3: –ê–Ω–∞–ª–∏–∑ –∫–æ–¥–∞

**–§–∞–π–ª:** `core/binance_zombie_manager.py`

#### –ü—Ä–æ–±–ª–µ–º–Ω–∞—è –ª–æ–≥–∏–∫–∞ (—Å—Ç—Ä–æ–∫–∏ 291-299):

```python
# Build list of symbols with actual balances
active_symbols = set()
min_balance_usd = 10  # Minimum balance to consider active

for asset, amounts in balance['total'].items():
    if amounts and float(amounts) > 0:  # ‚ùå –ü–†–û–í–ï–†–Ø–ï–¢ –¢–û–õ–¨–ö–û –ë–ê–õ–ê–ù–°–´!
        # Add common quote pairs for this asset
        for quote in ['USDT', 'BUSD', 'FDUSD', 'BTC', 'ETH', 'BNB']:
            active_symbols.add(f"{asset}/{quote}")
            active_symbols.add(f"{asset}{quote}")  # Binance format
```

#### –ü—Ä–æ–≤–µ—Ä–∫–∞ orphaned orders (—Å—Ç—Ä–æ–∫–∏ 375-391):

```python
# 1. Check for orphaned orders (no balance for symbol)
symbol_clean = symbol.replace(':', '')  # Remove Binance perp suffix
if symbol not in active_symbols and symbol_clean not in active_symbols:
    return BinanceZombieOrder(
        order_id=order_id,
        client_order_id=client_order_id,
        symbol=symbol,
        side=side,
        order_type=order_type,  # ‚ùå –ù–ï –ü–†–û–í–ï–†–Ø–ï–¢ –¢–ò–ü! STOP_LOSS —Ç–æ–∂–µ —Å—á–∏—Ç–∞–µ—Ç—Å—è orphaned!
        amount=amount,
        price=price,
        status=status,
        timestamp=timestamp,
        zombie_type='orphaned',  # ‚ùå STOP-LOSS –ú–ê–†–ö–ò–†–£–ï–¢–°–Ø –ö–ê–ö ORPHANED!
        reason='No balance for trading pair',
        order_list_id=order_list_id if order_list_id != -1 else None
    )
```

---

## üéØ –ö–û–†–ù–ï–í–ê–Ø –ü–†–ò–ß–ò–ù–ê

### –ü—Ä–æ–±–ª–µ–º–∞ #1: –ü—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –ë–ê–õ–ê–ù–°–´, –Ω–µ –ü–û–ó–ò–¶–ò–ò

**–õ–æ–≥–∏–∫–∞:**
```python
active_symbols = —Å—Ç—Ä–æ–∏—Ç—Å—è –Ω–∞ –æ—Å–Ω–æ–≤–µ balance['total']
```

**–î–ª—è FUTURES SHORT –ø–æ–∑–∏—Ü–∏–π:**
- –ë–∞–ª–∞–Ω—Å –±–∞–∑–æ–≤–æ–≥–æ –∞–∫—Ç–∏–≤–∞ (XPIN, RENDER, BLESS, QNT, BSV) = **0**
- –ú—ã –Ω–µ –¥–µ—Ä–∂–∏–º —Å–∞–º–∏ –∞–∫—Ç–∏–≤—ã, –º—ã –¥–µ—Ä–∂–∏–º SHORT –ø–æ–∑–∏—Ü–∏–∏!
- `active_symbols` –ù–ï –°–û–î–ï–†–ñ–ò–¢ —ç—Ç–∏ —Å–∏–º–≤–æ–ª—ã

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```
XPINUSDT: –±–∞–ª–∞–Ω—Å XPIN = 0 ‚ùå ‚Üí –Ω–µ –≤ active_symbols ‚Üí STOP-LOSS = orphaned
RENDERUSDT: –±–∞–ª–∞–Ω—Å RENDER = 0 ‚ùå ‚Üí –Ω–µ –≤ active_symbols ‚Üí STOP-LOSS = orphaned
...
```

### –ü—Ä–æ–±–ª–µ–º–∞ #2: –ù–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –¢–ò–ü –æ—Ä–¥–µ—Ä–∞

**–ö–æ–¥ –ù–ï –∏—Å–∫–ª—é—á–∞–µ—Ç –∑–∞—â–∏—Ç–Ω—ã–µ –æ—Ä–¥–µ—Ä–∞:**
```python
if symbol not in active_symbols:
    # –ú–∞—Ä–∫–∏—Ä—É–µ—Ç –í–°–ï –æ—Ä–¥–µ—Ä–∞ –∫–∞–∫ orphaned:
    # - LIMIT –æ—Ä–¥–µ—Ä–∞ ‚úì (–ø—Ä–∞–≤–∏–ª—å–Ω–æ)
    # - STOP_LOSS –æ—Ä–¥–µ—Ä–∞ ‚úó (–û–®–ò–ë–ö–ê!)
    # - TAKE_PROFIT –æ—Ä–¥–µ—Ä–∞ ‚úó (–û–®–ò–ë–ö–ê!)
    return BinanceZombieOrder(zombie_type='orphaned', ...)
```

### –ü—Ä–æ–±–ª–µ–º–∞ #3: –ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–∑–∏—Ü–∏—è—Ö

**–í—ã–∑–æ–≤ –∏–∑ position_manager.py (—Å—Ç—Ä–æ–∫–∞ 1617):**
```python
results = await integration.cleanup_zombies(dry_run=False)
```

**–ù–ï –ü–ï–†–ï–î–ê–Æ–¢–°–Ø:**
- –°–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–π
- –°–∏–º–≤–æ–ª—ã —Å –æ—Ç–∫—Ä—ã—Ç—ã–º–∏ –ø–æ–∑–∏—Ü–∏—è–º–∏
- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞—â–∏—Ç–Ω—ã—Ö –æ—Ä–¥–µ—Ä–∞—Ö

---

## üí° –†–ï–®–ï–ù–ò–ï

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ò—Å–∫–ª—é—á–∏—Ç—å –∑–∞—â–∏—Ç–Ω—ã–µ –æ—Ä–¥–µ—Ä–∞ (–†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø)

**–°–∞–º–æ–µ –ø—Ä–æ—Å—Ç–æ–µ –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ:**

```python
# –í –º–µ—Ç–æ–¥–µ _analyze_order (—Å—Ç—Ä–æ–∫–∞ 375+)

# –î–û–ë–ê–í–ò–¢–¨ –ü–ï–†–ï–î –ü–†–û–í–ï–†–ö–û–ô ORPHANED:
# Skip protective orders - –æ–Ω–∏ –ø—Ä–∏–≤—è–∑–∞–Ω—ã –∫ –ø–æ–∑–∏—Ü–∏—è–º, –Ω–µ –∫ –±–∞–ª–∞–Ω—Å–∞–º
if order_type in ['STOP_LOSS', 'STOP_LOSS_LIMIT', 'TAKE_PROFIT',
                   'TAKE_PROFIT_LIMIT', 'STOP_MARKET', 'TAKE_PROFIT_MARKET',
                   'TRAILING_STOP_MARKET']:
    return None  # –ù–µ —Å—á–∏—Ç–∞–µ–º –∑–∞—â–∏—Ç–Ω—ã–µ –æ—Ä–¥–µ—Ä–∞ orphaned

# 1. Check for orphaned orders (no balance for symbol)
symbol_clean = symbol.replace(':', '')
if symbol not in active_symbols and symbol_clean not in active_symbols:
    return BinanceZombieOrder(...)
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–¥–∞
- ‚úÖ 100% –±–µ–∑–æ–ø–∞—Å–Ω–æ - –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ —É–¥–∞–ª–∏—Ç STOP-LOSS
- ‚úÖ –ù–µ —Ç—Ä–µ–±—É–µ—Ç –ø–µ—Ä–µ–¥–∞—á–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–∑–∏—Ü–∏—è—Ö
- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –ø–æ–∑–∏—Ü–∏–π (LONG/SHORT, SPOT/FUTURES)

**–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:**
- ‚ö†Ô∏è –ù–µ –æ—á–∏—Å—Ç–∏—Ç –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –æ—Å–∏—Ä–æ—Ç–µ–≤—à–∏–µ STOP-LOSS (–µ—Å–ª–∏ –ø–æ–∑–∏—Ü–∏—è –±—ã–ª–∞ –∑–∞–∫—Ä—ã—Ç–∞ –≤–Ω–µ –±–æ—Ç–∞)

### –í–∞—Ä–∏–∞–Ω—Ç 2: –ü—Ä–æ–≤–µ—Ä—è—Ç—å –ü–û–ó–ò–¶–ò–ò, –Ω–µ —Ç–æ–ª—å–∫–æ –±–∞–ª–∞–Ω—Å—ã

**–ë–æ–ª–µ–µ —Å–ª–æ–∂–Ω–æ–µ, –Ω–æ –ø–æ–ª–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ:**

```python
# –í –º–µ—Ç–æ–¥–µ detect_zombie_orders (–ø–æ—Å–ª–µ —Å—Ç—Ä–æ–∫–∏ 283)

# Fetch open positions (for futures)
active_symbols = set()

# 1. Add symbols with balances (SPOT)
for asset, amounts in balance['total'].items():
    if amounts and float(amounts) > 0:
        for quote in ['USDT', 'BUSD', 'FDUSD', 'BTC', 'ETH', 'BNB']:
            active_symbols.add(f"{asset}/{quote}")
            active_symbols.add(f"{asset}{quote}")

# 2. Add symbols with open positions (FUTURES) ‚Üê –ù–û–í–û–ï!
try:
    await self.check_and_wait_rate_limit('fetch_positions')
    positions = await self.exchange.fetch_positions()

    for pos in positions:
        if pos.get('contracts', 0) > 0 or pos.get('notional', 0) != 0:
            symbol = pos['symbol']
            active_symbols.add(symbol)
            active_symbols.add(symbol.replace('/', ''))
            active_symbols.add(symbol.replace(':', ''))
except Exception as e:
    logger.warning(f"Could not fetch positions: {e}")
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –ü–æ–ª–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ (–±–∞–ª–∞–Ω—Å—ã + –ø–æ–∑–∏—Ü–∏–∏)
- ‚úÖ –û—á–∏—Å—Ç–∏—Ç –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –æ—Å–∏—Ä–æ—Ç–µ–≤—à–∏–µ –æ—Ä–¥–µ—Ä–∞

**–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:**
- ‚ö†Ô∏è –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π API –≤—ã–∑–æ–≤ (weight +5)
- ‚ö†Ô∏è –ë–æ–ª–µ–µ —Å–ª–æ–∂–Ω–∞—è –ª–æ–≥–∏–∫–∞
- ‚ö†Ô∏è –ú–æ–∂–µ—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞—Ç—å –¥–ª—è –≤—Å–µ—Ö –±–∏—Ä–∂

### –í–∞—Ä–∏–∞–Ω—Ç 3: –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π (–û–ü–¢–ò–ú–ê–õ–¨–ù–´–ô)

**–°–æ—á–µ—Ç–∞–µ—Ç –æ–±–∞ –ø–æ–¥—Ö–æ–¥–∞:**

```python
# 1. –ò—Å–∫–ª—é—á–∏—Ç—å –∑–∞—â–∏—Ç–Ω—ã–µ –æ—Ä–¥–µ—Ä–∞ –∏–∑ orphaned –ø—Ä–æ–≤–µ—Ä–∫–∏
if order_type in ['STOP_LOSS', 'STOP_LOSS_LIMIT', 'TAKE_PROFIT', ...]:
    # –î–ª—è –∑–∞—â–∏—Ç–Ω—ã—Ö –æ—Ä–¥–µ—Ä–æ–≤ –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –ø–æ–∑–∏—Ü–∏–∏ –æ—Ç–¥–µ–ª—å–Ω–æ
    if not await self._has_position_for_symbol(symbol):
        return BinanceZombieOrder(
            zombie_type='orphaned_protective',
            reason='Protective order without position'
        )
    return None  # –ó–∞—â–∏—Ç–Ω—ã–π –æ—Ä–¥–µ—Ä —Å –ø–æ–∑–∏—Ü–∏–µ–π - OK

# 2. –û–±—ã—á–Ω—ã–µ –æ—Ä–¥–µ—Ä–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ –±–∞–ª–∞–Ω—Å–∞–º
if symbol not in active_symbols:
    return BinanceZombieOrder(zombie_type='orphaned', ...)
```

---

## ‚ö†Ô∏è –í–†–ï–ú–ï–ù–ù–û–ï –†–ï–®–ï–ù–ò–ï (HOTFIX)

**–î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–æ–¥–∞:**

### 1. –û—Ç–∫–ª—é—á–∏—Ç—å zombie cleanup –≤ periodic sync:

**–§–∞–π–ª:** `core/position_manager.py` (—Å—Ç—Ä–æ–∫–∞ 547)

```python
# –í–†–ï–ú–ï–ù–ù–û –ó–ê–ö–û–ú–ú–ï–ù–¢–ò–†–û–í–ê–¢–¨:
# await self.cleanup_zombie_orders()
```

### 2. –ò–ª–∏ –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É —Ç–∏–ø–∞ –æ—Ä–¥–µ—Ä–∞:

**–ë—ã—Å—Ç—Ä—ã–π –ø–∞—Ç—á –≤ `core/binance_zombie_manager.py` (–ø–æ—Å–ª–µ —Å—Ç—Ä–æ–∫–∏ 374):**

```python
# HOTFIX: –ù–µ —Ç—Ä–æ–≥–∞—Ç—å –∑–∞—â–∏—Ç–Ω—ã–µ –æ—Ä–¥–µ—Ä–∞
if order_type in ['STOP_LOSS', 'STOP_LOSS_LIMIT', 'STOP_MARKET',
                   'TAKE_PROFIT', 'TAKE_PROFIT_LIMIT', 'TAKE_PROFIT_MARKET',
                   'TRAILING_STOP_MARKET']:
    logger.debug(f"Skipping protective order {order_id} ({order_type})")
    return None

# Skip if already closed
if status in ['closed', 'canceled', 'filled', 'rejected', 'expired']:
    return None
```

---

## üìä –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –†–ï–®–ï–ù–ò–Ø

### –¢–µ—Å—Ç 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞—â–∏—Ç–Ω—ã—Ö –æ—Ä–¥–µ—Ä–æ–≤

```python
# –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
zombie_manager = BinanceZombieManager(exchange)
zombies = await zombie_manager.detect_zombie_orders()

# STOP-LOSS –æ—Ä–¥–µ—Ä–∞ –ù–ï –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤ zombies['orphaned']
assert all(
    z.order_type not in ['STOP_LOSS', 'STOP_LOSS_LIMIT', 'STOP_MARKET']
    for z in zombies['orphaned']
)
```

### –¢–µ—Å—Ç 2: SHORT –ø–æ–∑–∏—Ü–∏–∏ —Å –Ω—É–ª–µ–≤—ã–º –±–∞–ª–∞–Ω—Å–æ–º

```python
# –û—Ç–∫—Ä—ã—Ç—å SHORT –ø–æ–∑–∏—Ü–∏—é –Ω–∞ XPINUSDT
# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å STOP-LOSS
# –ó–∞–ø—É—Å—Ç–∏—Ç—å zombie cleanup
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ STOP-LOSS –ù–ï —É–¥–∞–ª–µ–Ω

positions = await exchange.fetch_positions()
orders = await exchange.fetch_open_orders()

xpin_position = [p for p in positions if p['symbol'] == 'XPIN/USDT']
xpin_stop_loss = [o for o in orders if o['symbol'] == 'XPIN/USDT' and o['type'] == 'STOP_LOSS']

assert len(xpin_position) > 0  # –ü–æ–∑–∏—Ü–∏—è –µ—Å—Ç—å
assert len(xpin_stop_loss) > 0  # STOP-LOSS –ù–ï —É–¥–∞–ª–µ–Ω
```

### –¢–µ—Å—Ç 3: –î–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ orphaned –æ—Ä–¥–µ—Ä–∞

```python
# –°–æ–∑–¥–∞—Ç—å LIMIT –æ—Ä–¥–µ—Ä –Ω–∞ —Å–∏–º–≤–æ–ª –±–µ–∑ –±–∞–ª–∞–Ω—Å–∞ –∏ –ø–æ–∑–∏—Ü–∏–∏
# –ó–∞–ø—É—Å—Ç–∏—Ç—å zombie cleanup
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –æ—Ä–¥–µ—Ä –£–î–ê–õ–ï–ù

# –≠—Ç–æ—Ç –æ—Ä–¥–µ—Ä –î–û–õ–ñ–ï–ù –±—ã—Ç—å —É–¥–∞–ª–µ–Ω
```

---

## üìà –ú–ï–¢–†–ò–ö–ò –î–û/–ü–û–°–õ–ï

| –ú–µ—Ç—Ä–∏–∫–∞ | –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è | –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è |
|---------|----------------|-------------------|
| **STOP-LOSS —É–¥–∞–ª—è—é—Ç—Å—è** | ‚ùå –î–ê (100% —Å–ª—É—á–∞–µ–≤ –ø—Ä–∏ SHORT) | ‚úÖ –ù–ï–¢ (0% —Å–ª—É—á–∞–µ–≤) |
| **–ü–æ–∑–∏—Ü–∏–∏ –±–µ–∑ –∑–∞—â–∏—Ç—ã** | ‚ùå –î–ê (7 –ø–æ–∑–∏—Ü–∏–π) | ‚úÖ –ù–ï–¢ (0 –ø–æ–∑–∏—Ü–∏–π) |
| **False positives** | ‚ùå 100% –¥–ª—è –∑–∞—â–∏—Ç–Ω—ã—Ö –æ—Ä–¥–µ—Ä–æ–≤ | ‚úÖ 0% |
| **True positives** | ‚úÖ –£–¥–∞–ª—è–µ—Ç orphaned LIMIT | ‚úÖ –£–¥–∞–ª—è–µ—Ç orphaned LIMIT |
| **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** | üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò –û–ü–ê–°–ù–û | üü¢ –ë–ï–ó–û–ü–ê–°–ù–û |

---

## üéØ –ü–õ–ê–ù –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø

### –≠—Ç–∞–ø 1: Hotfix (–°–†–û–ß–ù–û!)

1. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É —Ç–∏–ø–∞ –æ—Ä–¥–µ—Ä–∞ –≤ `_analyze_order`
2. ‚úÖ –ò—Å–∫–ª—é—á–∏—Ç—å STOP_LOSS, TAKE_PROFIT –∏–∑ orphaned –ø—Ä–æ–≤–µ—Ä–∫–∏
3. ‚úÖ –î–µ–ø–ª–æ–π –≤ –ø—Ä–æ–¥–∞–∫—à–Ω
4. ‚úÖ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ 24 —á–∞—Å–∞

**–í—Ä–µ–º—è:** 15 –º–∏–Ω—É—Ç
**–†–∏—Å–∫:** –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π

### –≠—Ç–∞–ø 2: –ü–æ–ª–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ

1. ‚è≥ –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –ø–æ–∑–∏—Ü–∏–π –≤ `detect_zombie_orders`
2. ‚è≥ –£–ª—É—á—à–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ (–ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø—Ä–∏—á–∏–Ω—É –∏—Å–∫–ª—é—á–µ–Ω–∏—è)
3. ‚è≥ –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏ (—Å–∫–æ–ª—å–∫–æ –∑–∞—â–∏—Ç–Ω—ã—Ö –æ—Ä–¥–µ—Ä–æ–≤ –ø—Ä–æ–ø—É—â–µ–Ω–æ)
4. ‚è≥ –ù–∞–ø–∏—Å–∞—Ç—å unit —Ç–µ—Å—Ç—ã
5. ‚è≥ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã –Ω–∞ testnet

**–í—Ä–µ–º—è:** 2-3 —á–∞—Å–∞
**–†–∏—Å–∫:** –ù–∏–∑–∫–∏–π

### –≠—Ç–∞–ø 3: –î–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ

1. ‚è≥ –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥: –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–∑–∏—Ü–∏—è—Ö –≤ zombie_manager
2. ‚è≥ –°–æ–∑–¥–∞—Ç—å enum –¥–ª—è –∑–∞—â–∏—Ç–Ω—ã—Ö —Ç–∏–ø–æ–≤ –æ—Ä–¥–µ—Ä–æ–≤
3. ‚è≥ –î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é (–∫–∞–∫–∏–µ —Ç–∏–ø—ã –∏—Å–∫–ª—é—á–∞—Ç—å)
4. ‚è≥ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

---

## üîí –í–´–í–û–î–´

### –ß—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫:

1. ‚ùå Zombie cleaner –ø—Ä–æ–≤–µ—Ä—è–ª —Ç–æ–ª—å–∫–æ –ë–ê–õ–ê–ù–°–´, –Ω–µ –ü–û–ó–ò–¶–ò–ò
2. ‚ùå –ù–µ —É—á–∏—Ç—ã–≤–∞–ª—Å—è –¢–ò–ü –æ—Ä–¥–µ—Ä–∞ (–∑–∞—â–∏—Ç–Ω—ã–π vs —Ç–æ—Ä–≥–æ–≤—ã–π)
3. ‚ùå –î–ª—è FUTURES SHORT –±–∞–ª–∞–Ω—Å—ã –±–∞–∑–æ–≤–æ–≥–æ –∞–∫—Ç–∏–≤–∞ = 0
4. ‚ùå –í—Å–µ STOP-LOSS –æ—Ä–¥–µ—Ä–∞ –º–∞—Ä–∫–∏—Ä–æ–≤–∞–ª–∏—Å—å –∫–∞–∫ orphaned
5. ‚ùå Zombie cleaner —É–¥–∞–ª—è–ª –∏—Ö –ø—Ä—è–º–æ –ø–µ—Ä–µ–¥ shutdown

### –£—Ä–æ–∫–∏:

1. ‚úÖ –ó–∞—â–∏—Ç–Ω—ã–µ –æ—Ä–¥–µ—Ä–∞ (STOP_LOSS, TAKE_PROFIT) –ø—Ä–∏–≤—è–∑–∞–Ω—ã –∫ –ü–û–ó–ò–¶–ò–Ø–ú, –Ω–µ –∫ –ë–ê–õ–ê–ù–°–ê–ú
2. ‚úÖ –î–ª—è FUTURES –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å positions, –Ω–µ balance
3. ‚úÖ –¢–∏–ø –æ—Ä–¥–µ—Ä–∞ –∫—Ä–∏—Ç–∏—á–µ–Ω –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è orphaned
4. ‚úÖ Zombie cleanup –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∫–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω—ã–º (–ª—É—á—à–µ –Ω–µ —É–¥–∞–ª–∏—Ç—å, —á–µ–º —É–¥–∞–ª–∏—Ç—å STOP-LOSS)

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:

1. üéØ –°–†–û–ß–ù–û: –ü—Ä–∏–º–µ–Ω–∏—Ç—å Hotfix (–∏—Å–∫–ª—é—á–∏—Ç—å –∑–∞—â–∏—Ç–Ω—ã–µ –æ—Ä–¥–µ—Ä–∞)
2. üéØ –î–æ–±–∞–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥: alert –µ—Å–ª–∏ –ø–æ–∑–∏—Ü–∏–∏ –±–µ–∑ STOP-LOSS > 0
3. üéØ –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ —É–¥–∞–ª–µ–Ω–∏—è –æ—Ä–¥–µ—Ä–æ–≤ —Å –ø—Ä–∏—á–∏–Ω–æ–π
4. üéØ –î–æ–±–∞–≤–∏—Ç—å dry_run —Ä–µ–∂–∏–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –Ω–æ–≤—ã—Ö exchanges
5. üéØ Unit —Ç–µ—Å—Ç—ã –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –æ—Ä–¥–µ—Ä–æ–≤

---

**–ê–≤—Ç–æ—Ä:** Claude Code
**–î–∞—Ç–∞:** 2025-10-11
**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å:** üî¥ CRITICAL
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞ –Ω–∞–π–¥–µ–Ω–∞, —Ä–µ—à–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ
