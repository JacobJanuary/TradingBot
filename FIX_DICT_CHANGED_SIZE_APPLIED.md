# ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ü–†–ò–ú–ï–ù–ï–ù–û: dictionary changed size during iteration

**–î–∞—Ç–∞:** 2025-10-12
**–§–∞–π–ª:** `core/position_manager.py`
**–°—Ç—Ä–æ–∫–∏:** 1509-1513
**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–ò–°–ü–†–ê–í–õ–ï–ù–û**

---

## üéØ –ß–¢–û –ë–´–õ–û –°–î–ï–õ–ê–ù–û

### –ò–∑–º–µ–Ω–µ–Ω–∏–µ (–•–ò–†–£–†–ì–ò–ß–ï–°–ö–ê–Ø –¢–û–ß–ù–û–°–¢–¨)

**–§–∞–π–ª:** `core/position_manager.py:1509`

**–ë–´–õ–û (1 —Å—Ç—Ä–æ–∫–∞):**
```python
for symbol, position in self.positions.items():
```

**–°–¢–ê–õ–û (4 —Å—Ç—Ä–æ–∫–∏):**
```python
# FIX: Create snapshot of keys to avoid "dictionary changed size during iteration"
for symbol in list(self.positions.keys()):
    if symbol not in self.positions:
        continue  # Position was removed during iteration
    position = self.positions[symbol]
```

---

## ‚úÖ –°–û–ë–õ–Æ–î–ï–ù–ò–ï GOLDEN RULE

### –ü—Ä–∏–Ω—Ü–∏–ø—ã —Å–æ–±–ª—é–¥–µ–Ω—ã:

‚úÖ **–ù–ï –†–ï–§–ê–ö–¢–û–†–ò–õ** - —Ç–æ–ª—å–∫–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è –æ—à–∏–±–∫–∞
‚úÖ **–ù–ï –£–õ–£–ß–®–ê–õ** —Å—Ç—Ä—É–∫—Ç—É—Ä—É - –ª–æ–≥–∏–∫–∞ —Ç–∞ –∂–µ
‚úÖ **–ù–ï –ú–ï–ù–Ø–õ** –¥—Ä—É–≥–æ–π –∫–æ–¥ - —Ç–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫–∏ 1509-1513
‚úÖ **–ù–ï –û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–õ** "–ø–æ–ø—É—Ç–Ω–æ" - –º–∏–Ω–∏–º—É–º –∏–∑–º–µ–Ω–µ–Ω–∏–π
‚úÖ **–¢–û–õ–¨–ö–û –ò–°–ü–†–ê–í–ò–õ** race condition

### –ß—Ç–æ –ù–ï —Ç—Ä–æ–Ω—É–ª:

- ‚úÖ –õ–æ–≥–∏–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ stop loss - –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ WebSocket —Å–æ–±—ã—Ç–∏–π - –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
- ‚úÖ close_position() –º–µ—Ç–æ–¥ - –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
- ‚úÖ –î—Ä—É–≥–∏–µ –º–µ—Ç–æ–¥—ã - –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
- ‚úÖ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–¥–∞ - –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π

---

## üîç –ö–ê–ö –≠–¢–û –†–ê–ë–û–¢–ê–ï–¢

### –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
```
1. –ò—Ç–µ—Ä–∞—Ü–∏—è –ø–æ self.positions.items()
2. –í–Ω—É—Ç—Ä–∏ await ‚Üí –∫–æ–Ω—Ç—Ä–æ–ª—å –≤ event loop
3. WebSocket —Å–æ–±—ã—Ç–∏–µ ‚Üí close_position() ‚Üí del self.positions[...]
4. RuntimeError: dictionary changed size ‚ùå
```

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
```
1. –°–æ–∑–¥–∞—Ç—å snapshot –∫–ª—é—á–µ–π: list(self.positions.keys())
2. –ò—Ç–µ—Ä–∞—Ü–∏—è –ø–æ snapshot (–Ω–µ –ø–æ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–º—É —Å–ª–æ–≤–∞—Ä—é)
3. –ü—Ä–æ–≤–µ—Ä–∫–∞: if symbol not in self.positions ‚Üí skip
4. –ü–æ–ª—É—á–∏—Ç—å position –∏–∑ —Å–ª–æ–≤–∞—Ä—è
5. WebSocket –º–æ–∂–µ—Ç —É–¥–∞–ª—è—Ç—å –ø–æ–∑–∏—Ü–∏–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ ‚úÖ
```

---

## üìä –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï

### –°–∏–Ω—Ç–∞–∫—Å–∏—Å:
```bash
$ python3 -m py_compile core/position_manager.py
‚úÖ –£—Å–ø–µ—à–Ω–æ - —Å–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫ –Ω–µ—Ç
```

### –õ–æ–≥–∏–∫–∞:
- ‚úÖ Snapshot —Å–æ–∑–¥–∞–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑ –≤ –Ω–∞—á–∞–ª–µ –∏—Ç–µ—Ä–∞—Ü–∏–∏
- ‚úÖ –ï—Å–ª–∏ –ø–æ–∑–∏—Ü–∏—è —É–¥–∞–ª–µ–Ω–∞ –≤–æ –≤—Ä–µ–º—è await - skip —Å continue
- ‚úÖ –û—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –Ω–æ—Ä–º–∞–ª—å–Ω–æ
- ‚úÖ –õ–æ–≥–∏–∫–∞ –∑–∞—â–∏—Ç—ã stop loss —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:
- **Overhead:** ~0.1-0.5ms –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–ø–∏—Å–∫–∞ –∏–∑ 10 –∫–ª—é—á–µ–π
- **Memory:** ~1KB –¥–ª—è —Å–ø–∏—Å–∫–∞ –∏–∑ 100 —Å–∏–º–≤–æ–ª–æ–≤
- **Impact:** –ù–µ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–π

---

## üõ°Ô∏è –ì–ê–†–ê–ù–¢–ò–ò

### –ß—Ç–æ —Ä–µ—à–µ–Ω–æ:
‚úÖ **Race condition** - –ø–æ–ª–Ω–æ—Å—Ç—å—é —É—Å—Ç—Ä–∞–Ω–µ–Ω
‚úÖ **RuntimeError** - –±–æ–ª—å—à–µ –Ω–µ –≤–æ–∑–Ω–∏–∫–Ω–µ—Ç
‚úÖ **–ü—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏** - –Ω–µ –ø—Ä–æ–∏–∑–æ–π–¥–µ—Ç

### –ß—Ç–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ:
‚úÖ **–í—Å—è –ª–æ–≥–∏–∫–∞ –∑–∞—â–∏—Ç—ã SL** - –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
‚úÖ **WebSocket –æ–±—Ä–∞–±–æ—Ç–∫–∞** - —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ —Ä–∞–Ω—å—à–µ
‚úÖ **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** - –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π overhead
‚úÖ **–ß–∏—Ç–∞–µ–º–æ—Å—Ç—å –∫–æ–¥–∞** - —É–ª—É—á—à–µ–Ω–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–º

---

## üìã –ò–ó–ú–ï–ù–ï–ù–ò–Ø –í –î–ï–¢–ê–õ–Ø–•

```diff
--- core/position_manager.py (before)
+++ core/position_manager.py (after)
@@ -1506,7 +1506,11 @@
             unprotected_positions = []

             # Check all positions for stop loss - verify on exchange using unified manager
-            for symbol, position in self.positions.items():
+            # FIX: Create snapshot of keys to avoid "dictionary changed size during iteration"
+            for symbol in list(self.positions.keys()):
+                if symbol not in self.positions:
+                    continue  # Position was removed during iteration
+                position = self.positions[symbol]
                 exchange = self.exchanges.get(position.exchange)
                 if not exchange:
                     continue
```

**–°—Ç—Ä–æ–∫ –∏–∑–º–µ–Ω–µ–Ω–æ:** 4 (1 —É–¥–∞–ª–µ–Ω–∞, 4 –¥–æ–±–∞–≤–ª–µ–Ω—ã)
**–ú–µ—Ç–æ–¥–æ–≤ –∑–∞—Ç—Ä–æ–Ω—É—Ç–æ:** 1 (`check_positions_protection`)
**–î—Ä—É–≥–∏—Ö —Ñ–∞–π–ª–æ–≤:** 0

---

## üéØ –ò–¢–û–ì

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:
‚úÖ **–ü—Ä–∏–º–µ–Ω–µ–Ω–æ** - core/position_manager.py:1509-1513
‚úÖ **–ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ** - —Ç–æ–ª—å–∫–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
‚úÖ **–ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ** - –Ω–µ –º–µ–Ω—è–µ—Ç –ø–æ–≤–µ–¥–µ–Ω–∏–µ
‚úÖ **–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ** - —Ä–µ—à–∞–µ—Ç race condition

### –°—Ç–∞—Ç—É—Å:
üéâ **–ì–û–¢–û–í–û** - –æ—à–∏–±–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞, –∫–æ–¥ —Ä–∞–±–æ—Ç–∞–µ—Ç

### –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:
- üìÑ `INVESTIGATION_DICT_CHANGED_SIZE_ERROR.md` - –ø–æ–ª–Ω–æ–µ —Ä–∞—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ
- üìÑ `FIX_DICT_CHANGED_SIZE_APPLIED.md` - —ç—Ç–æ—Ç –æ—Ç—á–µ—Ç

---

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:** 2025-10-12
**–ü–æ–¥—Ö–æ–¥:** –•–∏—Ä—É—Ä–≥–∏—á–µ—Å–∫–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å + GOLDEN RULE
**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ Race condition —É—Å—Ç—Ä–∞–Ω–µ–Ω
