═══════════════════════════════════════════════════════════════════════════════
КРАТКАЯ СВОДКА: ЗАПИСИ В БАЗЕ ДАННЫХ ПРИ ОБРАБОТКЕ ВОЛН
═══════════════════════════════════════════════════════════════════════════════

Test ID: wave_test_20251017_204514
Период: 2025-10-17 20:45 - 21:10
Волн: 2 | Позиций: 10

───────────────────────────────────────────────────────────────────────────────
ТАБЛИЦЫ И КОЛИЧЕСТВО ЗАПИСЕЙ
───────────────────────────────────────────────────────────────────────────────

┌─────────────────────────────┬──────────────┬───────────────┬──────────────┐
│ Таблица                     │ На 1 позицию │ Всего (10 поз)│ Назначение   │
├─────────────────────────────┼──────────────┼───────────────┼──────────────┤
│ monitoring.positions        │      1       │      10       │ Позиции      │
│ monitoring.orders           │      2       │      22       │ Ордера       │
│ monitoring.trades           │     1-2      │      12       │ Сделки       │
│ monitoring.trailing_stop    │      1       │      10       │ Трейлинг-стоп│
└─────────────────────────────┴──────────────┴───────────────┴──────────────┘

ИТОГО: Минимум 5 записей в БД на одну позицию

───────────────────────────────────────────────────────────────────────────────
ДЕТАЛИ ПО ТАБЛИЦАМ
───────────────────────────────────────────────────────────────────────────────

1. monitoring.positions (10 записей)
   ✓ 10 позиций создано (#594-603)
   ✓ 100% имеют has_stop_loss=true
   ✓ 8 активных, 2 закрыты (#599, #601)

2. monitoring.orders (22 записи)
   ✓ 10 entry MARKET ордеров (все FILLED)
   ✓ 10 STOP_MARKET ордеров (все NEW, ждут активации)
   ✓ 2 exit MARKET ордера (для закрытых позиций)

3. monitoring.trades (12 записей)
   ✓ 10 entry trades (исполнение входов)
   ✓ 2 exit trades (закрытие #599 и #601)

4. monitoring.trailing_stop_state (10 записей)
   ✓ По 1 записи на каждую позицию
   ✓ Все с trailing_activated=false (новые позиции)

───────────────────────────────────────────────────────────────────────────────
ХРОНОЛОГИЯ СОЗДАНИЯ (ДЛЯ ОДНОЙ ПОЗИЦИИ)
───────────────────────────────────────────────────────────────────────────────

T+0s    : Wave check started
T+63s   : Wave found (signals detected)
T+66s   :
          1. INSERT в positions (status=PENDING_ENTRY)
          2. INSERT в orders (MARKET entry)
          3. INSERT в trades (исполнение entry)
          4. UPDATE positions (status=ENTRY_PLACED)
T+68s   :
          5. INSERT в orders (STOP_MARKET)
          6. INSERT в trailing_stop_state
          7. UPDATE positions (status=ACTIVE, has_stop_loss=true)

Итого: 7 операций с БД за ~2 секунды

───────────────────────────────────────────────────────────────────────────────
КЛЮЧЕВЫЕ МЕТРИКИ
───────────────────────────────────────────────────────────────────────────────

Позиции:
  • Создано: 10
  • Со стоп-лоссом: 10 (100%) ✅
  • Активных: 8
  • Закрыто: 2

Ордера:
  • Entry MARKET: 10 (все FILLED)
  • STOP_MARKET: 10 (все NEW)
  • Exit MARKET: 2 (закрытие позиций)

Сделки:
  • Entry trades: 10
  • Exit trades: 2
  • Всего объем: ~$1,200 USDT

Тайминги:
  • Entry → Stop-Loss: 1-2 секунды ✅
  • Между позициями: 3-5 секунд
  • Полный цикл (5 позиций): ~20 секунд

───────────────────────────────────────────────────────────────────────────────
ЗАКРЫТЫЕ ПОЗИЦИИ
───────────────────────────────────────────────────────────────────────────────

#601 ORCAUSDT LONG:
  ├─ Открыта: 20:06:13 @ 1.33654
  ├─ Закрыта: 20:12:09 @ 1.33475 (через 6 минут)
  └─ PnL: -0.179 USDT ❌

#599 SPKUSDT SHORT:
  ├─ Открыта: 20:06:06 @ 0.03559
  ├─ Закрыта: 20:39:00 @ 0.03644 (через 33 минуты)
  └─ PnL: -4.77 USDT ❌

───────────────────────────────────────────────────────────────────────────────
ВЫВОДЫ
───────────────────────────────────────────────────────────────────────────────

✅ ЧТО РАБОТАЕТ ПРАВИЛЬНО:

1. Атомарность создания позиций
   → Все позиции либо полностью созданы со стоп-лоссом, либо не созданы

2. 100% покрытие стоп-лоссами
   → has_stop_loss=true для всех 10 позиций

3. Быстрое исполнение
   → Полный цикл создания позиции: ~2 секунды
   → Entry ордера исполнены за 1-2 секунды

4. Консистентность данных
   → Все связи между таблицами корректны
   → Quantity и цены совпадают в orders и trades

5. Правильная последовательность
   → Entry → Trade → Stop-Loss → Active (как ожидается)

⚠️  НАБЛЮДЕНИЯ:

1. Быстрое закрытие позиций
   → #601 закрыта через 6 минут (возможно триггер стоп-лосса?)
   → #599 закрыта через 33 минуты

2. Exit ордера без exchange order ID
   → Ордера #1124 и #1134 не имеют order_id
   → Возможно, закрытие через другой механизм

3. 20% позиций закрыты с убытком
   → Обе закрытые позиции показали отрицательный PnL
   → Требует анализа причин закрытия

───────────────────────────────────────────────────────────────────────────────
СТРУКТУРА ДАННЫХ ДЛЯ ОДНОЙ ПОЗИЦИИ
───────────────────────────────────────────────────────────────────────────────

positions
    │
    ├─ 1 запись (основная информация)
    │
orders
    │
    ├─ 1 MARKET entry (FILLED)
    ├─ 1 STOP_MARKET (NEW)
    └─ [опционально] 1 MARKET exit (FILLED)
    │
trades
    │
    ├─ 1 entry trade
    └─ [опционально] 1 exit trade
    │
trailing_stop_state
    │
    └─ 1 состояние трейлинг-стопа

───────────────────────────────────────────────────────────────────────────────

Полный детальный отчет: DATABASE_RECORDS_REPORT.md
Дата: 2025-10-17 21:10:00
Статус: ✅ Анализ завершен
