# –ü–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π Age Detector Module
## –í–∞—Ä–∏–∞–Ω—Ç B: –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º –æ—Ä–¥–µ—Ä–∞–º–∏

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 2025-10-15
**–°—Ç–∞—Ç—É—Å:** –ü–õ–ê–ù - –ö –ò–°–ü–û–õ–ù–ï–ù–ò–Æ
**–°—Ç—Ä–∞—Ç–µ–≥–∏—è:** –ü–æ—ç—Ç–∞–ø–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–π —Ñ–∞–∑—ã
**Git —Å—Ç—Ä–∞—Ç–µ–≥–∏—è:** –û—Ç–¥–µ–ª—å–Ω—ã–π –∫–æ–º–º–∏—Ç –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–π —Ñ–∞–∑—ã

---

## üìã –û–±—â–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–ª–∞–Ω–∞

**–ü—Ä–∏–Ω—Ü–∏–ø—ã:**
- ‚úÖ –û–¥–∏–Ω —Ñ–∏–∫—Å = –æ–¥–Ω–∞ —Ñ–∞–∑–∞
- ‚úÖ Git commit –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–π —É—Å–ø–µ—à–Ω–æ–π —Ñ–∞–∑—ã
- ‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–π —Ñ–∞–∑—ã
- ‚úÖ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ—Ç–∫–∞—Ç–∞ –Ω–∞ –ª—é–±–æ–º —ç—Ç–∞–ø–µ
- ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∫–∞–∂–¥–æ–π —Ñ–∞–∑—ã

**–í—Å–µ–≥–æ —Ñ–∞–∑:** 8 (6 –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö + 2 —É–ª—É—á—à–µ–Ω–∏—è)

**–û–±—â–µ–µ –≤—Ä–µ–º—è:** 8-10 —á–∞—Å–æ–≤ (–≤–∫–ª—é—á–∞—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)

---

## üéØ –§–ê–ó–ê 0: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∏ –±–∞–∑–æ–≤–∞—è –ª–∏–Ω–∏—è

### –¶–µ–ª—å
–°–æ–∑–¥–∞—Ç—å —Ç–æ—á–∫—É –æ—Ç—Å—á–µ—Ç–∞ –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –æ–∫—Ä—É–∂–µ–Ω–∏–µ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π.

### –ó–∞–¥–∞—á–∏

#### 0.1 –°–æ–∑–¥–∞–Ω–∏–µ feature-–≤–µ—Ç–∫–∏
```bash
git checkout -b fix/age-detector-order-proliferation
```

#### 0.2 –°–æ–∑–¥–∞–Ω–∏–µ baseline-–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
–°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª `AGE_DETECTOR_BASELINE.md` —Å:
- –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–æ–¥–∞ (—Ö–µ—à–∏ —Ñ–∞–π–ª–æ–≤)
- Snapshot –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ (.env –ø–∞—Ä–∞–º–µ—Ç—Ä—ã Age Detector)
- –ü–æ—Å–ª–µ–¥–Ω–∏–µ –º–µ—Ç—Ä–∏–∫–∏ –∏–∑ –ª–æ–≥–æ–≤ (—Å–∫–æ–ª—å–∫–æ –æ—Ä–¥–µ—Ä–æ–≤ —Å–æ–∑–¥–∞–Ω–æ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π —á–∞—Å)

#### 0.3 Backup —Ç–µ–∫—É—â–∏—Ö –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤
```bash
# –°–æ–∑–¥–∞—Ç—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è backup
mkdir -p backups/age_detector_fix_20251015/

# –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ñ–∞–π–ª—ã, –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥–µ–º –º–µ–Ω—è—Ç—å
cp core/aged_position_manager.py backups/age_detector_fix_20251015/
cp core/exchange_manager_enhanced.py backups/age_detector_fix_20251015/
```

#### 0.4 –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è
- [ ] –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ testnet –¥–æ—Å—Ç—É–ø–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö –ø–æ–∑–∏—Ü–∏–π (–∏–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∏—Ö —Å–æ–∑–¥–∞—Ç—å)
- [ ] –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–∫–ª—é—á–µ–Ω–æ
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —Å–∫—Ä–∏–ø—Ç `monitor_age_detector.py` –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è

#### 0.5 –ó–∞–ø—É—Å–∫ baseline-–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ (5 –º–∏–Ω—É—Ç)
```bash
# –í –æ—Ç–¥–µ–ª—å–Ω–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ –∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞ (–µ—Å–ª–∏ –µ—â–µ –Ω–µ –∑–∞–ø—É—â–µ–Ω)
# python main.py

# –ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ—Ä–æ—Ç–∫–∏–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –¥–ª—è baseline
timeout 300 python monitor_age_detector.py logs/trading_bot.log
```

–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ `baseline_metrics_age_detector.json`

### Git commit
```bash
git add backups/ AGE_DETECTOR_BASELINE.md baseline_metrics_age_detector.json
git commit -m "üìä Phase 0: Baseline for Age Detector fixes

- Created feature branch fix/age-detector-order-proliferation
- Backed up current implementation
- Documented baseline metrics
- Confirmed testnet availability

Related to: AGE_DETECTOR_AUDIT_REPORT_RU.md (Bug #1)"
```

### –ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞
- ‚úÖ –í–µ—Ç–∫–∞ —Å–æ–∑–¥–∞–Ω–∞
- ‚úÖ Baseline-–º–µ—Ç—Ä–∏–∫–∏ —Å–æ–±—Ä–∞–Ω—ã
- ‚úÖ Backup —Ñ–∞–π–ª–æ–≤ —Å–æ–∑–¥–∞–Ω
- ‚úÖ –û–∫—Ä—É–∂–µ–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ

### –í—Ä–µ–º—è
30 –º–∏–Ω—É—Ç

---

## üî¥ –§–ê–ó–ê 1: –°–æ–∑–¥–∞–Ω–∏–µ —É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –º–µ—Ç–æ–¥–∞ –≤ EnhancedExchangeManager

### –¶–µ–ª—å
–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –º–µ—Ç–æ–¥ `create_or_update_exit_order()` –≤ EnhancedExchangeManager, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –≤—Å—é –ª–æ–≥–∏–∫—É —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è exit-–æ—Ä–¥–µ—Ä–∞–º–∏.

### –ó–∞–¥–∞—á–∏

#### 1.1 –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –º–µ—Ç–æ–¥ `create_or_update_exit_order()`

**–§–∞–π–ª:** `core/exchange_manager_enhanced.py`

**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** –ü–æ—Å–ª–µ –º–µ—Ç–æ–¥–∞ `create_limit_exit_order()` (–ø–æ—Å–ª–µ —Å—Ç—Ä–æ–∫–∏ ~180)

**–ß—Ç–æ –¥–æ–±–∞–≤–∏—Ç—å:**
- –ú–µ—Ç–æ–¥ `create_or_update_exit_order()` —Å —Å–∏–≥–Ω–∞—Ç—É—Ä–æ–π:
  ```python
  async def create_or_update_exit_order(
      self,
      symbol: str,
      side: str,
      amount: float,
      price: float,
      min_price_diff_pct: float = 0.5
  ) -> Optional[Dict]:
  ```

**–õ–æ–≥–∏–∫–∞ –º–µ—Ç–æ–¥–∞:**
1. –í—ã–∑–≤–∞—Ç—å `_check_existing_exit_order(symbol, side, price)` - —Å –ø–µ—Ä–µ–¥–∞—á–µ–π price!
2. –ï—Å–ª–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –æ—Ä–¥–µ—Ä –Ω–∞–π–¥–µ–Ω:
   - –í—ã—á–∏—Å–ª–∏—Ç—å —Ä–∞–∑–Ω–∏—Ü—É –≤ —Ü–µ–Ω–µ
   - –ï—Å–ª–∏ < min_price_diff_pct: –≤–µ—Ä–Ω—É—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Å —Ñ–ª–∞–≥–æ–º `_was_updated=False`
   - –ï—Å–ª–∏ >= min_price_diff_pct:
     - –û—Ç–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ä—ã–π —á–µ—Ä–µ–∑ `safe_cancel_with_verification()`
     - –ñ–¥–∞—Ç—å 0.5 —Å–µ–∫
     - –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —á–µ—Ä–µ–∑ `create_limit_exit_order(..., check_duplicates=False)`
     - –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ñ–ª–∞–≥ `_was_updated=True`
3. –ï—Å–ª–∏ –Ω–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ:
   - –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —á–µ—Ä–µ–∑ `create_limit_exit_order(..., check_duplicates=True)`
   - –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ñ–ª–∞–≥ `_was_updated=False`

**–í–∞–∂–Ω–æ:**
- –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–∂–¥–æ–≥–æ —à–∞–≥–∞
- –î–æ–±–∞–≤–∏—Ç—å docstring —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- –û–±—Ä–∞–±–æ—Ç–∞—Ç—å –≤—Å–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è

#### 1.2 –î–æ–±–∞–≤–∏—Ç—å unit-—Ç–µ—Å—Ç –¥–ª—è –Ω–æ–≤–æ–≥–æ –º–µ—Ç–æ–¥–∞

**–§–∞–π–ª:** `tests/unit/test_exchange_manager_enhanced.py` (—Å–æ–∑–¥–∞—Ç—å –µ—Å–ª–∏ –Ω–µ—Ç)

**–¢–µ—Å—Ç-–∫–µ–π—Å—ã:**
- `test_create_or_update_exit_order_no_existing` - —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ
- `test_create_or_update_exit_order_exists_price_ok` - —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, —Ü–µ–Ω–∞ OK
- `test_create_or_update_exit_order_exists_price_changed` - —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –Ω—É–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å
- `test_create_or_update_exit_order_cancel_fails` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏ –æ—Ç–º–µ–Ω—ã

#### 1.3 –ó–∞–ø—É—Å—Ç–∏—Ç—å unit-—Ç–µ—Å—Ç—ã
```bash
pytest tests/unit/test_exchange_manager_enhanced.py -v
```

#### 1.4 –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –≤ EnhancedExchangeManager

–î–æ–±–∞–≤–∏—Ç—å –≤ `self.stats`:
```python
'orders_updated_by_unified_method': 0,
'orders_created_by_unified_method': 0,
```

–ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ `create_or_update_exit_order()` —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ.

### Git commit
```bash
git add core/exchange_manager_enhanced.py tests/unit/test_exchange_manager_enhanced.py
git commit -m "‚ú® Phase 1: Add create_or_update_exit_order() unified method

Implements centralized exit order management:
- Single method handles both creation and updates
- Automatic duplicate detection
- Proper price difference checking
- Returns _was_updated flag for statistics

Fixes: Bug #1 (Order Proliferation) - Part 1/2
Tests: Added unit tests for all scenarios

File: core/exchange_manager_enhanced.py
Related to: AGE_DETECTOR_AUDIT_REPORT_RU.md Section 7.1 (Variant B)"
```

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–∑—ã 1

**–¶–µ–ª—å:** –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –Ω–æ–≤—ã–π –º–µ—Ç–æ–¥ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ.

**–®–∞–≥–∏:**
1. –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ unit-—Ç–µ—Å—Ç—ã:
   ```bash
   pytest tests/unit/test_exchange_manager_enhanced.py -v
   ```

2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —Å—Ç–∞—Ä—ã–µ —Ç–µ—Å—Ç—ã –Ω–µ —Å–ª–æ–º–∞–ª–∏—Å—å:
   ```bash
   pytest tests/unit/ -v
   ```

3. Manual smoke test (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):
   ```python
   # –í Python REPL
   from core.exchange_manager_enhanced import EnhancedExchangeManager
   # –°–æ–∑–¥–∞—Ç—å instance —Å mock exchange
   # –í—ã–∑–≤–∞—Ç—å create_or_update_exit_order()
   # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
   ```

### –ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞ —Ñ–∞–∑—ã 1
- ‚úÖ –ú–µ—Ç–æ–¥ `create_or_update_exit_order()` –¥–æ–±–∞–≤–ª–µ–Ω
- ‚úÖ –í—Å–µ unit-—Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç (–∑–µ–ª–µ–Ω—ã–µ)
- ‚úÖ Docstring –ø–æ–ª–Ω—ã–π –∏ –ø–æ–Ω—è—Ç–Ω—ã–π
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –∫–∞–∂–¥–æ–º —à–∞–≥–µ
- ‚úÖ Git commit —Å–æ–∑–¥–∞–Ω

### Rollback plan
–ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫:
```bash
git reset --hard HEAD~1
git clean -fd
```

### –í—Ä–µ–º—è
1.5 —á–∞—Å–∞

---

## üî¥ –§–ê–ó–ê 2: –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ AgedPositionManager –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ –º–µ—Ç–æ–¥–∞

### –¶–µ–ª—å
–ó–∞–º–µ–Ω–∏—Ç—å –±–∞–≥–æ–≤–∞–Ω–Ω—É—é –ª–æ–≥–∏–∫—É —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—Ä–¥–µ—Ä–∞–º–∏ –≤ `aged_position_manager.py` –Ω–∞ –≤—ã–∑–æ–≤ –µ–¥–∏–Ω–æ–≥–æ –º–µ—Ç–æ–¥–∞ `create_or_update_exit_order()`.

### –ó–∞–¥–∞—á–∏

#### 2.1 –£–ø—Ä–æ—Å—Ç–∏—Ç—å –º–µ—Ç–æ–¥ `_update_single_exit_order()`

**–§–∞–π–ª:** `core/aged_position_manager.py`

**–°—Ç—Ä–æ–∫–∏ –¥–ª—è –∑–∞–º–µ–Ω—ã:** 266-432 (–≤–µ—Å—å –º–µ—Ç–æ–¥ `_update_single_exit_order`)

**–ù–æ–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
1. –û—Å—Ç–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ –æ—Å–Ω–æ–≤–Ω–æ–π –ø—É—Ç—å —á–µ—Ä–µ–∑ `EnhancedExchangeManager`
2. –£–¥–∞–ª–∏—Ç—å:
   - –†—É—á–Ω–æ–π –≤—ã–∑–æ–≤ `_check_existing_exit_order()` (—Å—Ç—Ä–æ–∫–∞ 295)
   - –í–µ—Å—å –±–ª–æ–∫ –ø—Ä–æ–≤–µ—Ä–∫–∏ `if existing:` (—Å—Ç—Ä–æ–∫–∏ 299-344)
   - –ë–ª–æ–∫ `else:` –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è (—Å—Ç—Ä–æ–∫–∏ 345-367)
   - –í–µ—Å—å fallback-–ø—É—Ç—å (—Å—Ç—Ä–æ–∫–∏ 369-432)
3. –ó–∞–º–µ–Ω–∏—Ç—å –Ω–∞:
   - –û–¥–∏–Ω –≤—ã–∑–æ–≤ `enhanced_manager.create_or_update_exit_order()`
   - –û–±—Ä–∞–±–æ—Ç–∫—É –≤–æ–∑–≤—Ä–∞—â–∞–µ–º–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è
   - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ñ–ª–∞–≥–∞ `_was_updated`

**–ù–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –º–µ—Ç–æ–¥–∞ (~40 —Å—Ç—Ä–æ–∫ –≤–º–µ—Å—Ç–æ 167):**
```
async def _update_single_exit_order(self, position, target_price, phase):
    try:
        # 1. –ü–æ–ª—É—á–∏—Ç—å exchange –∏ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å side
        # 2. –°–æ–∑–¥–∞—Ç—å EnhancedExchangeManager
        # 3. –í—ã–∑–≤–∞—Ç—å create_or_update_exit_order()
        # 4. –û–±—Ä–∞–±–æ—Ç–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        # 5. –û–±–Ω–æ–≤–∏—Ç—å self.managed_positions
        # 6. –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É (orders_created vs orders_updated)
    except ccxt.ExchangeError:
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã—Ö –æ—à–∏–±–æ–∫ –±–∏—Ä–∂–∏
    except Exception:
        # –û–±—â–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
```

#### 2.2 –û–±–Ω–æ–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫

–î–æ–±–∞–≤–∏—Ç—å —Å–ø–µ—Ü–∏–∞–ª—å–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É –¥–ª—è:
- –ì–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏—Ö –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π (–∫–æ–¥ 170209)
- –û—à–∏–±–æ–∫ —Ç–æ—á–Ω–æ—Å—Ç–∏ —Ü–µ–Ω—ã
- –ù–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –ø–æ–∑–∏—Ü–∏–∏ (–∫–æ–¥ 110017, -2022)

–°–æ—Ö—Ä–∞–Ω—è—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã—Ö —Å–∏–º–≤–æ–ª–∞—Ö –≤ `self.managed_positions` —Å –ø–æ–ª–µ–º `skip_until`.

#### 2.3 –û–±–Ω–æ–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–ó–∞–º–µ–Ω–∏—Ç—å –ª–æ–≥–∏:
- `"üìù Creating initial exit order"` ‚Üí –æ—Å—Ç–∞–≤–∏—Ç—å (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ –Ω–æ–≤–æ–≥–æ –º–µ—Ç–æ–¥–∞)
- `"üìä Updating exit order"` ‚Üí –æ—Å—Ç–∞–≤–∏—Ç—å (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ –Ω–æ–≤–æ–≥–æ –º–µ—Ç–æ–¥–∞)
- –£–¥–∞–ª–∏—Ç—å –¥—É–±–ª–∏—Ä—É—é—â–∏–µ—Å—è –ª–æ–≥–∏

#### 2.4 –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É

–í –º–µ—Ç–æ–¥–µ `get_statistics()` –¥–æ–±–∞–≤–∏—Ç—å:
```python
'orders_created_unified': self.stats['orders_created'],
'orders_updated_unified': self.stats['orders_updated'],
```

### Git commit
```bash
git add core/aged_position_manager.py
git commit -m "üîß Phase 2: Refactor AgedPositionManager to use unified method

Simplified _update_single_exit_order():
- Replaced 167 lines with ~40 lines
- Removed manual duplicate checking
- Removed fallback path (dead code)
- Single call to create_or_update_exit_order()
- Improved error handling for geo restrictions

Fixes: Bug #1 (Order Proliferation) - Part 2/2
Fixes: Bug #2 (Double duplicate check)
Fixes: Bug #4 (Untested fallback path)

File: core/aged_position_manager.py (lines 266-432)
Related to: AGE_DETECTOR_AUDIT_REPORT_RU.md Section 7.1"
```

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–∑—ã 2

**–¶–µ–ª—å:** –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ Age Detector —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –Ω–æ–≤–æ–π –ª–æ–≥–∏–∫–æ–π –∏ –ù–ï —Å–æ–∑–¥–∞–µ—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–æ –æ—Ä–¥–µ—Ä–æ–≤.

#### 2.2.1 Static code check
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–∏–Ω—Ç–∞–∫—Å–∏—Å
python -m py_compile core/aged_position_manager.py

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–º–ø–æ—Ä—Ç—ã
python -c "from core.aged_position_manager import AgedPositionManager; print('OK')"
```

#### 2.2.2 Unit-—Ç–µ—Å—Ç—ã
```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã aged_position_manager
pytest tests/unit/test_aged_position_decimal_fix.py -v

# –ï—Å–ª–∏ –µ—Å—Ç—å –¥—Ä—É–≥–∏–µ —Ç–µ—Å—Ç—ã –¥–ª—è aged_position_manager
pytest tests/unit/ -k aged -v
```

#### 2.2.3 Integration test (testnet, 15 –º–∏–Ω—É—Ç)

**–®–∞–≥ 1:** –í—Ä–µ–º–µ–Ω–Ω–æ —Å–Ω–∏–∑–∏—Ç—å `MAX_POSITION_AGE_HOURS` –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:
```bash
# –í .env
MAX_POSITION_AGE_HOURS=0.1  # 6 –º–∏–Ω—É—Ç
```

**–®–∞–≥ 2:** –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞ –≤ testnet:
```bash
python main.py > test_phase2.log 2>&1 &
BOT_PID=$!
```

**–®–∞–≥ 3:** –í –¥—Ä—É–≥–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ –∑–∞–ø—É—Å—Ç–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:
```bash
python monitor_age_detector.py logs/trading_bot.log
```

**–®–∞–≥ 4:** –ß–µ—Ä–µ–∑ 15 –º–∏–Ω—É—Ç –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å:
```bash
kill $BOT_PID
```

**–®–∞–≥ 5:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞:
```bash
# –û—Ç–∫—Ä—ã—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–π JSON –æ—Ç—á–µ—Ç
ls -lt age_detector_diagnostic_*.json | head -1
```

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞:**
- ‚úÖ `proliferation_issues` = [] (–ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤)
- ‚úÖ `duplicates_prevented` > 0 (–¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç)
- ‚úÖ –ö–∞–∂–¥—ã–π —Å–∏–º–≤–æ–ª –∏–º–µ–µ—Ç –º–∞–∫—Å–∏–º—É–º 1-2 —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –æ—Ä–¥–µ—Ä–∞
- ‚úÖ –ù–µ—Ç –æ—à–∏–±–æ–∫ —Ç–∏–ø–∞ "multiple orders for same symbol"

**–®–∞–≥ 6:** –í–µ—Ä–Ω—É—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é:
```bash
# –í .env
MAX_POSITION_AGE_HOURS=3
```

#### 2.2.4 –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –Ω–æ–≤—ã–µ –ª–æ–≥–∏ –ø–æ—è–≤–ª—è—é—Ç—Å—è
grep "create_or_update_exit_order" logs/trading_bot.log | tail -20

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Å—Ç–∞—Ä—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
grep "üìù Creating initial" logs/trading_bot.log | wc -l  # –î–æ–ª–∂–Ω–æ –±—ã—Ç—å –º–∞–ª–æ
grep "Exit order already exists" logs/trading_bot.log | wc -l  # –î–æ–ª–∂–Ω–æ –±—ã—Ç—å > 0!
```

#### 2.2.5 –°–æ–∑–¥–∞—Ç—å –æ—Ç—á–µ—Ç –æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏

**–§–∞–π–ª:** `PHASE2_TEST_REPORT.md`

**–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ:**
- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã unit-—Ç–µ—Å—Ç–æ–≤
- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã integration-—Ç–µ—Å—Ç–∞ (JSON –æ—Ç –º–æ–Ω–∏—Ç–æ—Ä–∞)
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–∑ –ª–æ–≥–æ–≤
- –í—ã–≤–æ–¥—ã (–ø—Ä–æ—à–ª–∞ –ª–∏ —Ñ–∞–∑–∞ —É—Å–ø–µ—à–Ω–æ)

### –ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞ —Ñ–∞–∑—ã 2
- ‚úÖ –ö–æ–¥ —É–ø—Ä–æ—â–µ–Ω (—Å ~167 —Å—Ç—Ä–æ–∫ –¥–æ ~40)
- ‚úÖ –í—Å–µ unit-—Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç
- ‚úÖ Integration test: –Ω–µ—Ç order proliferation
- ‚úÖ –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç (duplicates_prevented > 0)
- ‚úÖ Git commit —Å–æ–∑–¥–∞–Ω
- ‚úÖ –û—Ç—á–µ—Ç –æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ —Å–æ–∑–¥–∞–Ω

### Rollback plan
```bash
# –û—Ç–∫–∞—Ç–∏—Ç—å –æ–±–∞ –∫–æ–º–º–∏—Ç–∞
git reset --hard HEAD~2
git clean -fd

# –ò–ª–∏ –æ—Ç–∫–∞—Ç–∏—Ç—å —Ç–æ–ª—å–∫–æ —Ñ–∞–∑—É 2
git reset --hard HEAD~1
git clean -fd
```

### –í—Ä–µ–º—è
2 —á–∞—Å–∞ (–≤–∫–ª—é—á–∞—è 15 –º–∏–Ω –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞)

---

## üü° –§–ê–ó–ê 3: –£–ª—É—á—à–µ–Ω–∏–µ –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∫—ç—à–∞ –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ –æ—Ä–¥–µ—Ä–æ–≤

### –¶–µ–ª—å
–ò—Å–ø—Ä–∞–≤–∏—Ç—å Bug #3: –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å, —á—Ç–æ –∫—ç—à –æ—Ä–¥–µ—Ä–æ–≤ –∏–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç—Å—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ –ø–æ—Å–ª–µ –æ—Ç–º–µ–Ω—ã, –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö.

### –ó–∞–¥–∞—á–∏

#### 3.1 –£–ª—É—á—à–∏—Ç—å –º–µ—Ç–æ–¥ `safe_cancel_with_verification()`

**–§–∞–π–ª:** `core/exchange_manager_enhanced.py`

**–°—Ç—Ä–æ–∫–∏:** ~277-320

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
1. –î–æ–±–∞–≤–∏—Ç—å –≤—ã–∑–æ–≤ `await self._invalidate_order_cache(symbol)` –°–†–ê–ó–£ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ—Ç–º–µ–Ω—ã (–ø–æ—Å–ª–µ —Å—Ç—Ä–æ–∫–∏ ~303)
2. –£–≤–µ–ª–∏—á–∏—Ç—å `await asyncio.sleep()` —Å —Ç–µ–∫—É—â–µ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è –¥–æ 0.5 —Å–µ–∫—É–Ω–¥
3. –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—é –∫—ç—à–∞ —Ç–∞–∫–∂–µ –≤ –±–ª–æ–∫–∞—Ö –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏—Å–∫–ª—é—á–µ–Ω–∏–π:
   - `except ccxt.OrderNotFound:` ‚Üí –¥–æ–±–∞–≤–∏—Ç—å –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—é
   - `except Exception:` ‚Üí –¥–æ–±–∞–≤–∏—Ç—å –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—é
4. –£–ª—É—á—à–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –ø—Ä–æ–±–ª–µ–º —Å –∫—ç—à–µ–º

#### 3.2 –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç—Ä–∏–∫—É –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è

–í `self.stats` –¥–æ–±–∞–≤–∏—Ç—å:
```python
'cache_invalidations': 0,
'stale_cache_detections': 0,
```

–ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏ –∫–∞–∂–¥–æ–π –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏–∏.

#### 3.3 –î–æ–±–∞–≤–∏—Ç—å debug-–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫—ç—à–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

–ü—Ä–∏ `LOG_LEVEL=DEBUG` –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å:
- –ö–æ–≥–¥–∞ –∫—ç—à –∏–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç—Å—è
- –í—Ä–µ–º—è –∂–∏–∑–Ω–∏ –∫—ç—à–∞
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ä–¥–µ—Ä–æ–≤ –≤ –∫—ç—à–µ

### Git commit
```bash
git add core/exchange_manager_enhanced.py
git commit -m "üîß Phase 3: Improve order cache invalidation timing

Enhanced safe_cancel_with_verification():
- Immediate cache invalidation after cancel
- Increased wait time to 0.5s (was 0.2s)
- Cache invalidation on all error paths
- Added cache metrics for monitoring

Fixes: Bug #3 (Cache invalidation race condition)

File: core/exchange_manager_enhanced.py (lines 277-320)
Related to: AGE_DETECTOR_AUDIT_REPORT_RU.md Section 7.1"
```

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–∑—ã 3

#### 3.1 Unit-—Ç–µ—Å—Ç –¥–ª—è –∫—ç—à-–∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏–∏

–î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç –≤ `tests/unit/test_exchange_manager_enhanced.py`:
```python
async def test_safe_cancel_invalidates_cache():
    # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ _invalidate_order_cache() –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è
    # –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ—Ç–º–µ–Ω—ã
    pass

async def test_safe_cancel_invalidates_cache_on_error():
    # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –∫—ç—à –∏–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç—Å—è –¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ
    pass
```

#### 3.2 Integration test (10 –º–∏–Ω—É—Ç)

```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞
python main.py &

# –ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å 10 –º–∏–Ω—É—Ç
timeout 600 python monitor_age_detector.py logs/trading_bot.log

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –∫—ç—à–∞
grep "cache_invalidations" logs/trading_bot.log
```

**–ö—Ä–∏—Ç–µ—Ä–∏–∏:**
- ‚úÖ –ù–µ—Ç –æ—à–∏–±–æ–∫ "order already cancelled"
- ‚úÖ –ú–µ—Ç—Ä–∏–∫–∞ `cache_invalidations` —Ä–∞—Å—Ç–µ—Ç
- ‚úÖ –í—Å–µ –µ—â–µ –Ω–µ—Ç order proliferation

### –ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞ —Ñ–∞–∑—ã 3
- ‚úÖ –ö—ç—à –∏–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç—Å—è –Ω–∞ –≤—Å–µ—Ö –ø—É—Ç—è—Ö
- ‚úÖ Unit-—Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç
- ‚úÖ –ú–µ—Ç—Ä–∏–∫–∏ –∫—ç—à–∞ —Ä–∞–±–æ—Ç–∞—é—Ç
- ‚úÖ Git commit —Å–æ–∑–¥–∞–Ω

### –í—Ä–µ–º—è
1 —á–∞—Å

---

## üü° –§–ê–ó–ê 4: –û–±—Ä–∞–±–æ—Ç–∫–∞ –≥–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏—Ö –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π

### –¶–µ–ª—å
–ò—Å–ø—Ä–∞–≤–∏—Ç—å Bug #5 —á–∞—Å—Ç–∏—á–Ω–æ: –¥–æ–±–∞–≤–∏—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ –≥–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏—Ö –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –±–∏—Ä–∂–∏, —á—Ç–æ–±—ã –Ω–µ —Å–ø–∞–º–∏—Ç—å –ª–æ–≥–∏ –∏ –Ω–µ –ø–æ–≤—Ç–æ—Ä—è—Ç—å –ø–æ–ø—ã—Ç–∫–∏ –¥–ª—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤.

### –ó–∞–¥–∞—á–∏

#### 4.1 –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É ExchangeError –≤ process_aged_position()

**–§–∞–π–ª:** `core/aged_position_manager.py`

**–ú–µ—Ç–æ–¥:** `process_aged_position()` (—Å—Ç—Ä–æ–∫–∏ ~134-203)

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
1. –û–±–µ—Ä–Ω—É—Ç—å –≤—ã–∑–æ–≤ `_update_single_exit_order()` –≤ `try-except`
2. –î–æ–±–∞–≤–∏—Ç—å —Å–ø–µ—Ü–∏–∞–ª—å–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É –¥–ª—è `ccxt.ExchangeError`:
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–¥ –æ—à–∏–±–∫–∏ '170209' (China region)
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–¥ –æ—à–∏–±–∫–∏ '170193' (Invalid price)
   - –î–ª—è geo-restriction: —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ `managed_positions` —Å `skip_until = now + 24h`
   - –î–ª—è price error: –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å WARNING –∏ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å
3. –£–ª—É—á—à–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –¥—Ä—É–≥–∏—Ö –æ—à–∏–±–æ–∫

#### 4.2 –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ "skip_until"

–î–æ–±–∞–≤–∏—Ç—å –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–π –º–µ—Ç–æ–¥:
```python
def _should_skip_position(self, position) -> bool:
    """Check if position should be skipped based on previous errors"""
    position_id = f"{position.symbol}_{position.exchange}"
    if position_id in self.managed_positions:
        skip_until = self.managed_positions[position_id].get('skip_until')
        if skip_until and datetime.now() < skip_until:
            return True
    return False
```

–í—ã–∑—ã–≤–∞—Ç—å –≤ –Ω–∞—á–∞–ª–µ `process_aged_position()`.

#### 4.3 –î–æ–±–∞–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É

–í `self.stats` –¥–æ–±–∞–≤–∏—Ç—å:
```python
'positions_skipped_geo_restricted': 0,
'positions_skipped_price_error': 0,
```

### Git commit
```bash
git add core/aged_position_manager.py
git commit -m "üõ°Ô∏è Phase 4: Handle geographic restrictions gracefully

Added proper error handling:
- Detect geo-restricted symbols (error 170209)
- Skip geo-restricted symbols for 24h
- Handle price precision errors (error 170193)
- Statistics for skipped positions

Fixes: Bug #5 (Error handling) - Part 1/2

File: core/aged_position_manager.py
Related to: AGE_DETECTOR_AUDIT_REPORT_RU.md Section 7.1 Fix #3"
```

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–∑—ã 4

#### 4.1 Unit-—Ç–µ—Å—Ç

```python
async def test_process_aged_position_geo_restricted():
    # Mock exchange error 170209
    # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –ø–æ–∑–∏—Ü–∏—è –ø–æ–º–µ—á–µ–Ω–∞ skip_until
    # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –≤—ã–∑–æ–≤ –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç –ø–æ–∑–∏—Ü–∏—é
    pass
```

#### 4.2 Manual test (–µ—Å–ª–∏ –µ—Å—Ç—å geo-restricted —Å–∏–º–≤–æ–ª—ã)

–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –¥–ª—è HNTUSDT –∏–ª–∏ –¥—Ä—É–≥–∏—Ö –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤:
```bash
grep "geo.*restricted\|China region" logs/trading_bot.log
```

–î–æ–ª–∂–Ω–æ –±—ã—Ç—å:
- ‚úÖ –û–¥–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
- ‚úÖ –ù–µ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è –∫–∞–∂–¥—ã–π —Ü–∏–∫–ª

### –ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞ —Ñ–∞–∑—ã 4
- ‚úÖ Geo-restricted —Å–∏–º–≤–æ–ª—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ Skip-–ª–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ –ù–µ—Ç —Å–ø–∞–º–∞ –≤ –ª–æ–≥–∞—Ö
- ‚úÖ Git commit —Å–æ–∑–¥–∞–Ω

### –í—Ä–µ–º—è
1 —á–∞—Å

---

## üü¢ –§–ê–ó–ê 5: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –≤–∑—è—Ç–∏—è –ø—Ä–∏–±—ã–ª–∏ (market close)

### –¶–µ–ª—å
–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å Improvement #1: –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ –∑–∞–∫—Ä—ã–≤–∞—Ç—å —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ –ø–æ–∑–∏—Ü–∏–∏ market-–æ—Ä–¥–µ—Ä–æ–º, –µ—Å–ª–∏ –æ–Ω–∏ –≤ –ø—Ä–∏–±—ã–ª–∏, –≤–º–µ—Å—Ç–æ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è limit-–æ—Ä–¥–µ—Ä–∞.

### –ó–∞–¥–∞—á–∏

#### 5.1 –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥ `_close_with_market_order()`

**–§–∞–π–ª:** `core/aged_position_manager.py`

**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** –ü–æ—Å–ª–µ –º–µ—Ç–æ–¥–∞ `_update_single_exit_order()`

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
```python
async def _close_with_market_order(self, position, current_price: float):
    """
    –ó–∞–∫—Ä—ã—Ç—å –ø–æ–∑–∏—Ü–∏—é –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ market-–æ—Ä–¥–µ—Ä–æ–º

    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –ø–æ–∑–∏—Ü–∏–π, –∫–æ—Ç–æ—Ä—ã–µ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ –ø—Ä–∏–±—ã–ª–∏
    """
    # 1. –ü–æ–ª—É—á–∏—Ç—å exchange
    # 2. –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å order_side (opposite of position.side)
    # 3. –°–æ–∑–¥–∞—Ç—å market order —Å reduceOnly=True
    # 4. –ó–∞–ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    # 5. –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
```

#### 5.2 –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –ø—Ä–∏–±—ã–ª—å–Ω–æ—Å—Ç–∏ –≤ process_aged_position()

**–§–∞–π–ª:** `core/aged_position_manager.py`

**–ú–µ—Ç–æ–¥:** `process_aged_position()`

**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** –ü–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è `current_price` (—Å—Ç—Ä–æ–∫–∞ ~170), –ü–ï–†–ï–î –≤—ã–∑–æ–≤–æ–º `_calculate_target_price()`

**–õ–æ–≥–∏–∫–∞:**
1. –í—ã—á–∏—Å–ª–∏—Ç—å, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –ø–æ–∑–∏—Ü–∏—è –≤ –ø—Ä–∏–±—ã–ª–∏:
   - Long: `current_price > entry_price * (1 + 0.002)` (> 0.2% –ø—Ä–∏–±—ã–ª–∏)
   - Short: `current_price < entry_price * (0.998)`
2. –ï—Å–ª–∏ –≤ –ø—Ä–∏–±—ã–ª–∏:
   - –ó–∞–ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å "üí∞ Aged position profitable, closing with market order"
   - –í—ã–∑–≤–∞—Ç—å `_close_with_market_order()`
   - –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å `self.stats['profitable_closes']`
   - –í–µ—Ä–Ω—É—Ç—å—Å—è (–Ω–µ –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å —Å limit-–æ—Ä–¥–µ—Ä–æ–º)

#### 5.3 –î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä

**–§–∞–π–ª:** `config/settings.py`

–î–æ–±–∞–≤–∏—Ç—å –≤ `TradingConfig`:
```python
aged_profitable_close_threshold_percent: Decimal = Decimal('0.2')  # –ü–æ—Ä–æ–≥ –ø—Ä–∏–±—ã–ª–∏ –¥–ª—è market close
```

–ó–∞–≥—Ä—É–∂–∞—Ç—å –∏–∑ `.env`:
```python
if val := os.getenv('AGED_PROFITABLE_CLOSE_THRESHOLD'):
    config.aged_profitable_close_threshold_percent = Decimal(val)
```

#### 5.4 –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É

–í `self.stats` –¥–æ–±–∞–≤–∏—Ç—å:
```python
'profitable_closes': 0,
'market_orders_placed': 0,
```

### Git commit
```bash
git add core/aged_position_manager.py config/settings.py
git commit -m "‚ú® Phase 5: Add profit-taking logic for aged positions

Implemented immediate market close for profitable aged positions:
- Close with market order if profit > 0.2%
- New method: _close_with_market_order()
- Configurable profit threshold
- Statistics tracking

Implements: Improvement #1 (Profit-taking logic)

Files: core/aged_position_manager.py, config/settings.py
Related to: AGE_DETECTOR_AUDIT_REPORT_RU.md Section 7.2"
```

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–∑—ã 5

#### 5.1 Unit-—Ç–µ—Å—Ç

```python
async def test_close_with_market_order():
    # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ market –æ—Ä–¥–µ—Ä–∞
    # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å reduceOnly=True
    # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å correct side
    pass

async def test_process_aged_position_profitable():
    # Mock profitable position
    # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è _close_with_market_order()
    # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –ù–ï —Å–æ–∑–¥–∞–µ—Ç—Å—è limit order
    pass
```

#### 5.2 Integration test

**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** –¢—Ä–µ–±—É–µ—Ç —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–∏–±—ã–ª—å–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏ –≤ testnet

**–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞:** Manual verification —á–µ—Ä–µ–∑ –ª–æ–≥–∏
```bash
# –ò—Å–∫–∞—Ç—å –≤ –ª–æ–≥–∞—Ö —Å–ª—É—á–∞–∏ profitable aged positions
grep "üí∞.*profitable" logs/trading_bot.log
```

### –ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞ —Ñ–∞–∑—ã 5
- ‚úÖ –ú–µ—Ç–æ–¥ `_close_with_market_order()` —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏–±—ã–ª—å–Ω–æ—Å—Ç–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ Market –æ—Ä–¥–µ—Ä–∞ —Å–æ–∑–¥–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ Unit-—Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç
- ‚úÖ Git commit —Å–æ–∑–¥–∞–Ω

### –í—Ä–µ–º—è
1.5 —á–∞—Å–∞

---

## üü¢ –§–ê–ó–ê 6: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è –æ—Ä–¥–µ—Ä–∞

### –¶–µ–ª—å
–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å Improvement #2: –ø—Ä–æ–≤–µ—Ä—è—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ—Ä–¥–µ—Ä–∞ –ø–µ—Ä–µ–¥ –ø–æ–ø—ã—Ç–∫–æ–π –µ–≥–æ –æ—Ç–º–µ–Ω—ã, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –æ—à–∏–±–æ–∫ "order not found" –∏ "already cancelled".

### –ó–∞–¥–∞—á–∏

#### 6.1 –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥ `_validate_order_state()`

**–§–∞–π–ª:** `core/exchange_manager_enhanced.py`

**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** –ü–æ—Å–ª–µ –º–µ—Ç–æ–¥–∞ `safe_cancel_with_verification()`

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
```python
async def _validate_order_state(self, order_id: str, symbol: str) -> Optional[str]:
    """
    –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –æ—Ä–¥–µ—Ä–∞ –ø–µ—Ä–µ–¥ –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–µ–π

    Returns:
        str: –°—Ç–∞—Ç—É—Å –æ—Ä–¥–µ—Ä–∞ ('open', 'new', 'partially_filled', etc.)
        None: –ï—Å–ª–∏ –æ—Ä–¥–µ—Ä —É–∂–µ –∑–∞–∫—Ä—ã—Ç/–æ—Ç–º–µ–Ω–µ–Ω/–Ω–µ –Ω–∞–π–¥–µ–Ω
    """
    # 1. –ü–æ–ø—ã—Ç–∞—Ç—å—Å—è –ø–æ–ª—É—á–∏—Ç—å –æ—Ä–¥–µ—Ä
    # 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å
    # 3. –í–µ—Ä–Ω—É—Ç—å —Å—Ç–∞—Ç—É—Å –∏–ª–∏ None
```

#### 6.2 –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –≤ `create_or_update_exit_order()`

**–ü–µ—Ä–µ–¥ –æ—Ç–º–µ–Ω–æ–π —Å—Ç–∞—Ä–æ–≥–æ –æ—Ä–¥–µ—Ä–∞:**
```python
# –ü–µ—Ä–µ–¥ –≤—ã–∑–æ–≤–æ–º safe_cancel_with_verification()
state = await self._validate_order_state(existing['id'], symbol)
if state and state not in ['closed', 'canceled', 'cancelled']:
    # –ë–µ–∑–æ–ø–∞—Å–Ω–æ –æ—Ç–º–µ–Ω—è—Ç—å
    await self.safe_cancel_with_verification(...)
else:
    # –û—Ä–¥–µ—Ä —É–∂–µ –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω, –ø—Ä–æ—Å—Ç–æ —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π
    logger.info(f"Old order {existing['id']} no longer active")
```

#### 6.3 –û–±—Ä–∞–±–æ—Ç–∞—Ç—å —á–∞—Å—Ç–∏—á–Ω–æ –∏—Å–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –æ—Ä–¥–µ—Ä–∞

–ï—Å–ª–∏ `state == 'partially_filled'`:
- –ó–∞–ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å WARNING
- –û—Ç–º–µ–Ω–∏—Ç—å –æ—Ä–¥–µ—Ä (—á—Ç–æ–±—ã –æ–±–Ω–æ–≤–∏—Ç—å –æ—Å—Ç–∞–≤—à—É—é—Å—è —á–∞—Å—Ç—å)
- –ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å amount –¥–ª—è –Ω–æ–≤–æ–≥–æ –æ—Ä–¥–µ—Ä–∞ (–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `remaining` –≤–º–µ—Å—Ç–æ `amount`)

#### 6.4 –î–æ–±–∞–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É

```python
'partially_filled_orders_found': 0,
'already_cancelled_orders_skipped': 0,
```

### Git commit
```bash
git add core/exchange_manager_enhanced.py
git commit -m "üîç Phase 6: Add order state validation before cancellation

Enhanced order management:
- Validate order state before cancel attempts
- Handle partially filled orders correctly
- Skip already cancelled/closed orders
- Detailed logging of order states

Implements: Improvement #2 (Order state validation)
Fixes: Bug #5 (Error handling) - Part 2/2

File: core/exchange_manager_enhanced.py
Related to: AGE_DETECTOR_AUDIT_REPORT_RU.md Section 7.2"
```

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–∑—ã 6

#### 6.1 Unit-—Ç–µ—Å—Ç—ã

```python
async def test_validate_order_state_open():
    # Order is open -> return 'open'
    pass

async def test_validate_order_state_cancelled():
    # Order is cancelled -> return None
    pass

async def test_validate_order_state_not_found():
    # Order not found -> return None
    pass

async def test_create_or_update_skips_cancelled_order():
    # If existing order is cancelled, should create new without cancel attempt
    pass
```

#### 6.2 –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤

```bash
# –ò—Å–∫–∞—Ç—å —Å–ª—É—á–∞–∏ –ø—Ä–æ–ø—É—Å–∫–∞ –æ—Ç–º–µ–Ω—ã
grep "no longer active" logs/trading_bot.log

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –æ—à–∏–±–æ–∫ "order not found"
grep -i "order not found" logs/trading_bot.log
```

### –ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞ —Ñ–∞–∑—ã 6
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –æ—Ä–¥–µ—Ä–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ –ù–µ –ø—ã—Ç–∞–µ–º—Å—è –æ—Ç–º–µ–Ω—è—Ç—å —É–∂–µ –æ—Ç–º–µ–Ω–µ–Ω–Ω—ã–µ –æ—Ä–¥–µ—Ä–∞
- ‚úÖ –ß–∞—Å—Ç–∏—á–Ω–æ –∏—Å–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –æ—Ä–¥–µ—Ä–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è
- ‚úÖ Unit-—Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç
- ‚úÖ Git commit —Å–æ–∑–¥–∞–Ω

### –í—Ä–µ–º—è
1 —á–∞—Å

---

## üîµ –§–ê–ó–ê 7: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –æ—Ä–¥–µ—Ä–æ–≤

### –¶–µ–ª—å
–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å Improvement #3: –∞–∫—Ç–∏–≤–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –¥–ª—è –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö exit-–æ—Ä–¥–µ—Ä–æ–≤ –Ω–∞ –±–∏—Ä–∂–µ (–µ—Å–ª–∏ –±–∞–≥ –≤—Å–µ –µ—â–µ –ø—Ä–æ—è–≤–ª—è–µ—Ç—Å—è).

### –ó–∞–¥–∞—á–∏

#### 7.1 –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥ `_detect_duplicate_orders()`

**–§–∞–π–ª:** `core/aged_position_manager.py`

**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** –ü–æ—Å–ª–µ –º–µ—Ç–æ–¥–∞ `get_statistics()`

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
```python
async def _detect_duplicate_orders(self) -> List[Dict]:
    """
    –ê–∫—Ç–∏–≤–Ω–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å –¥—É–±–ª–∏—Ä—É—é—â–∏–µ—Å—è exit-–æ—Ä–¥–µ—Ä–∞ –Ω–∞ –±–∏—Ä–∂–µ

    –î–æ–ª–∂–Ω–æ –≤—ã–∑—ã–≤–∞—Ç—å—Å—è –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ (–∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç)

    Returns:
        List[Dict]: –°–ø–∏—Å–æ–∫ —Å–∏–º–≤–æ–ª–æ–≤ —Å –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ exit-–æ—Ä–¥–µ—Ä–∞–º–∏
    """
    # 1. –î–ª—è –∫–∞–∂–¥–æ–π –±–∏—Ä–∂–∏
    # 2. –î–ª—è –∫–∞–∂–¥–æ–≥–æ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Å–∏–º–≤–æ–ª–∞ (–∏–∑ managed_positions)
    # 3. –ü–æ–ª—É—á–∏—Ç—å –æ—Ç–∫—Ä—ã—Ç—ã–µ –æ—Ä–¥–µ—Ä–∞
    # 4. –§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å: reduceOnly=True, type='limit', –ù–ï stop loss
    # 5. –ï—Å–ª–∏ > 1 –æ—Ä–¥–µ—Ä–∞: –¥–æ–±–∞–≤–∏—Ç—å –≤ —Å–ø–∏—Å–æ–∫ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
    # 6. –ó–∞–ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å CRITICAL error –µ—Å–ª–∏ –Ω–∞–π–¥–µ–Ω—ã
    # 7. –í–µ—Ä–Ω—É—Ç—å —Å–ø–∏—Å–æ–∫
```

#### 7.2 –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –≤ –≥–ª–∞–≤–Ω—ã–π —Ü–∏–∫–ª

**–§–∞–π–ª:** `main.py`

**–í –≥–ª–∞–≤–Ω–æ–º —Ü–∏–∫–ª–µ (–≥–¥–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è `check_and_process_aged_positions()`):**

–î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫—É—é –ø—Ä–æ–≤–µ—Ä–∫—É (–∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç):
```python
# –ü–æ—Å–ª–µ –≤—ã–∑–æ–≤–∞ aged_position_manager.check_and_process_aged_positions()
if time.time() - last_duplicate_check > 300:  # 5 –º–∏–Ω—É—Ç
    duplicates = await aged_position_manager._detect_duplicate_orders()
    if duplicates:
        logger.critical(f"üö® DUPLICATE ORDERS DETECTED: {len(duplicates)} symbols affected!")
    last_duplicate_check = time.time()
```

#### 7.3 –î–æ–±–∞–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏ –∞–ª–µ—Ä—Ç–∏–Ω–≥

```python
'duplicate_detection_runs': 0,
'symbols_with_duplicates': [],
'last_duplicate_check': None,
```

#### 7.4 –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

–î–æ–±–∞–≤–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:
```python
AGED_AUTO_CANCEL_DUPLICATES=false  # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –Ω–µ —Ç—Ä–æ–≥–∞–µ–º
```

–ï—Å–ª–∏ `true` –∏ –Ω–∞–π–¥–µ–Ω—ã –¥—É–±–ª–∏–∫–∞—Ç—ã:
- –û—Å—Ç–∞–≤–∏—Ç—å –æ—Ä–¥–µ—Ä —Å –ª—É—á—à–µ–π —Ü–µ–Ω–æ–π
- –û—Ç–º–µ–Ω–∏—Ç—å –æ—Å—Ç–∞–ª—å–Ω—ã–µ
- –ó–∞–ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ

### Git commit
```bash
git add core/aged_position_manager.py main.py config/settings.py
git commit -m "üìä Phase 7: Add duplicate orders monitoring

Implemented active duplicate detection:
- Periodic check every 5 minutes
- Detect multiple exit orders per symbol
- Critical alerts for duplicates
- Optional auto-cleanup (disabled by default)

Implements: Improvement #3 (Monitoring & Alerting)

Files: core/aged_position_manager.py, main.py
Related to: AGE_DETECTOR_AUDIT_REPORT_RU.md Section 7.2"
```

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–∑—ã 7

#### 7.1 Unit-—Ç–µ—Å—Ç

```python
async def test_detect_duplicate_orders_none():
    # No duplicates -> return []
    pass

async def test_detect_duplicate_orders_found():
    # Mock 2 exit orders for same symbol
    # Should return list with 1 item
    pass
```

#### 7.2 Integration test

–°–ª–æ–∂–Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –±–µ–∑ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥—É–±–ª–∏–∫–∞—Ç–æ–≤.

**–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –º–µ—Ç–æ–¥ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è:
```bash
grep "_detect_duplicate_orders" logs/trading_bot.log
```

### –ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞ —Ñ–∞–∑—ã 7
- ‚úÖ –ú–µ—Ç–æ–¥ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω –≤ –≥–ª–∞–≤–Ω—ã–π —Ü–∏–∫–ª
- ‚úÖ –ê–ª–µ—Ä—Ç–∏–Ω–≥ —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ Git commit —Å–æ–∑–¥–∞–Ω

### –í—Ä–µ–º—è
1 —á–∞—Å

---

## üéâ –§–ê–ó–ê 8: –§–∏–Ω–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

### –¶–µ–ª—å
–ü—Ä–æ–≤–µ—Å—Ç–∏ –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π –≤–º–µ—Å—Ç–µ, —Å–æ–∑–¥–∞—Ç—å –∏—Ç–æ–≥–æ–≤—É—é –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –∫ merge –≤ main.

### –ó–∞–¥–∞—á–∏

#### 8.1 –ö–æ–º–ø–ª–µ–∫—Å–Ω–æ–µ integration —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (2 —á–∞—Å–∞)

**–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞:**
```bash
# –ö–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ –∑–∞–ø—É—Å–∫–∞
cat > .env.test << EOF
MAX_POSITION_AGE_HOURS=1
AGED_GRACE_PERIOD_HOURS=4
AGED_LOSS_STEP_PERCENT=0.3
AGED_MAX_LOSS_PERCENT=5.0
AGED_PROFITABLE_CLOSE_THRESHOLD=0.2
EOF
```

**–ó–∞–ø—É—Å–∫:**
```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞ –≤ testnet
python main.py --testnet &
BOT_PID=$!

# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ (2 —á–∞—Å–∞)
timeout 7200 python monitor_age_detector.py logs/trading_bot.log

# –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
mv age_detector_diagnostic_*.json phase8_final_test_results.json
```

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å:**
1. Order proliferation:
   - `proliferation_issues` –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø—É—Å—Ç
   - –ö–∞–∂–¥—ã–π —Å–∏–º–≤–æ–ª: –º–∞–∫—Å–∏–º—É–º 2-3 –æ—Ä–¥–µ—Ä–∞ –∑–∞ 2 —á–∞—Å–∞ (–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è)

2. –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è:
   - `duplicates_prevented` > 0
   - "Exit order already exists" –ø–æ—è–≤–ª—è–µ—Ç—Å—è –≤ –ª–æ–≥–∞—Ö

3. –ü—Ä–∏–±—ã–ª—å–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏:
   - –ï—Å–ª–∏ –µ—Å—Ç—å, –¥–æ–ª–∂–Ω—ã –∑–∞–∫—Ä—ã–≤–∞—Ç—å—Å—è market-–æ—Ä–¥–µ—Ä–æ–º
   - `profitable_closes` > 0

4. –û—à–∏–±–∫–∏:
   - –ù–µ—Ç –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö –∏—Å–∫–ª—é—á–µ–Ω–∏–π
   - Geo-restricted —Å–∏–º–≤–æ–ª—ã –ø—Ä–æ–ø—É—Å–∫–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

#### 8.2 –ê–Ω–∞–ª–∏–∑ –º–µ—Ç—Ä–∏–∫

```bash
# –ò–∑–≤–ª–µ—á—å —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
grep "Aged positions processed" logs/trading_bot.log | tail -20

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏–∑ —Å–∞–º–æ–≥–æ –º–æ–¥—É–ª—è
python -c "
import asyncio
from core.aged_position_manager import AgedPositionManager
# ... load and print statistics
"
```

–°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª `PHASE8_FINAL_METRICS.md` —Å:
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–π
- –°–æ–∑–¥–∞–Ω–Ω—ã—Ö vs –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –æ—Ä–¥–µ—Ä–æ–≤
- –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–Ω—ã—Ö –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
- Profitable closes
- Geo-restricted skips

#### 8.3 –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å baseline

**–°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª:** `BEFORE_AFTER_COMPARISON.md`

| –ú–µ—Ç—Ä–∏–∫–∞ | –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π (Baseline) | –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π (Phase 8) | –£–ª—É—á—à–µ–Ω–∏–µ |
|---------|---------------------------|------------------------------|-----------|
| –°–æ–∑–¥–∞–Ω–æ "initial" –æ—Ä–¥–µ—Ä–æ–≤ –∑–∞ —á–∞—Å | ~300 | ~14 | -95% |
| –î—É–±–ª–∏–∫–∞—Ç–æ–≤ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–æ | 0 | >15 | ‚àû |
| –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –æ—Ä–¥–µ—Ä–æ–≤ –Ω–∞ —Å–∏–º–≤–æ–ª | –î–∞ (30+) | –ù–µ—Ç (0) | ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ |
| –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ geo-restrictions | –°–ø–∞–º –≤ –ª–æ–≥–∞—Ö | –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø—Ä–æ–ø—É—â–µ–Ω–æ | ‚úÖ –£–ª—É—á—à–µ–Ω–æ |
| Profitable positions | –ù–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–ª–∏—Å—å | Market close | ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ |

#### 8.4 –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏

**–§–∞–π–ª—ã –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:**

1. **README.md** (–µ—Å–ª–∏ –µ—Å—Ç—å —Å–µ–∫—Ü–∏—è –ø—Ä–æ Age Detector):
   - –î–æ–±–∞–≤–∏—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–æ–≤–µ–¥–µ–Ω–∏—è
   - –û–±–Ω–æ–≤–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã

2. **–°–æ–∑–¥–∞—Ç—å CHANGELOG_AGE_DETECTOR.md**:
   ```markdown
   # Age Detector Module - Changelog

   ## Version 2.0 - 2025-10-15

   ### Fixed
   - üî¥ [CRITICAL] Order proliferation bug - multiple orders no longer created
   - üü° Double duplicate checking removed
   - üü° Cache invalidation timing improved
   - üü° Geographic restrictions handled gracefully

   ### Added
   - ‚ú® Profit-taking logic (market close for profitable aged positions)
   - ‚ú® Order state validation before cancellation
   - ‚ú® Duplicate orders monitoring
   - ‚ú® Comprehensive error handling

   ### Changed
   - üîß Simplified order management logic (167 lines ‚Üí 40 lines)
   - üîß Centralized order operations in EnhancedExchangeManager

   ### Metrics
   - Order creation reduced by 95%
   - Zero order proliferation detected in 2h test
   - Duplicate prevention now working (15+ prevented in test)
   ```

3. **–û–±–Ω–æ–≤–∏—Ç—å AGE_DETECTOR_AUDIT_SUMMARY_RU.md**:
   - –î–æ–±–∞–≤–∏—Ç—å —Å–µ–∫—Ü–∏—é "–ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø –ü–†–ò–ú–ï–ù–ï–ù–´"
   - –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å: ‚ùå ‚Üí ‚úÖ
   - –°—Å—ã–ª–∫–∞ –Ω–∞ CHANGELOG

#### 8.5 Code review checklist

**–°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª:** `PHASE8_CODE_REVIEW_CHECKLIST.md`

–ü—Ä–æ–≤–µ—Ä–∏—Ç—å:
- [ ] –í—Å–µ TODO/FIXME –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ —É–¥–∞–ª–µ–Ω—ã –∏–ª–∏ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã
- [ ] Docstrings –∞–∫—Ç—É–∞–ª—å–Ω—ã
- [ ] –¢–∏–ø—ã –∞–Ω–Ω–æ—Ç–∏—Ä–æ–≤–∞–Ω—ã (–≥–¥–µ –≤–æ–∑–º–æ–∂–Ω–æ)
- [ ] –ù–µ—Ç dead code
- [ ] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Ä–æ–≤–Ω–µ–π –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ (DEBUG/INFO/WARNING/ERROR/CRITICAL)
- [ ] –ù–µ—Ç hardcoded –∑–Ω–∞—á–µ–Ω–∏–π (–≤—Å—ë —á–µ—Ä–µ–∑ –∫–æ–Ω—Ñ–∏–≥)
- [ ] –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–π –ø–æ–ª–Ω–∞—è
- [ ] Unit-—Ç–µ—Å—Ç—ã –ø–æ–∫—Ä—ã–≤–∞—é—Ç –Ω–æ–≤—ã–π –∫–æ–¥
- [ ] –ù–µ—Ç —Å–µ–∫—Ä–µ—Ç–æ–≤ –≤ –∫–æ–¥–µ

#### 8.6 –°–æ–∑–¥–∞–Ω–∏–µ Pull Request –æ–ø–∏—Å–∞–Ω–∏—è

**–§–∞–π–ª:** `PR_DESCRIPTION.md`

```markdown
# Fix: Age Detector Order Proliferation Bug

## Problem
Age Detector module was creating multiple limit exit orders for each position instead of updating a single order.

Evidence: 7,165 orders created in 23h vs expected ~14 (one per position).

## Solution
Implemented centralized order management through unified method `create_or_update_exit_order()`.

## Changes
- ‚úÖ Phase 1: Added unified method in EnhancedExchangeManager
- ‚úÖ Phase 2: Refactored AgedPositionManager (167‚Üí40 lines)
- ‚úÖ Phase 3: Improved cache invalidation
- ‚úÖ Phase 4: Handled geographic restrictions
- ‚úÖ Phase 5: Added profit-taking logic
- ‚úÖ Phase 6: Added order state validation
- ‚úÖ Phase 7: Added duplicate monitoring
- ‚úÖ Phase 8: Comprehensive testing

## Testing
- Unit tests: All passing ‚úÖ
- Integration test (2h): Zero proliferation detected ‚úÖ
- Duplicate prevention: Working (15+ prevented) ‚úÖ
- Performance: 95% reduction in order creation ‚úÖ

## Metrics
See: BEFORE_AFTER_COMPARISON.md

## Documentation
- CHANGELOG_AGE_DETECTOR.md
- PHASE8_FINAL_METRICS.md
- Updated audit report status

## Rollback Plan
All changes in feature branch `fix/age-detector-order-proliferation`
Each phase is a separate commit - can rollback to any phase.
```

### Git commits

```bash
# –°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤–∏—Ç—å –≤—Å–µ –º–µ—Ç—Ä–∏–∫–∏ –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é
git add PHASE8_FINAL_METRICS.md BEFORE_AFTER_COMPARISON.md \
        CHANGELOG_AGE_DETECTOR.md PHASE8_CODE_REVIEW_CHECKLIST.md \
        PR_DESCRIPTION.md

git commit -m "üìù Phase 8: Final testing and documentation

Completed comprehensive testing:
- 2h integration test in testnet: PASSED
- Zero order proliferation detected
- Duplicate prevention working
- All metrics improved

Documentation:
- Before/After comparison
- Changelog created
- PR description prepared
- Code review checklist

Ready for merge to main.

Files: Multiple documentation files
Related to: AGE_DETECTOR_AUDIT_REPORT_RU.md (all sections)"

# Merge –≤—Å–µ—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –æ–¥–∏–Ω squash commit (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
git rebase -i HEAD~8  # –ï—Å–ª–∏ —Ö–æ—Ç–∏–º squash –≤ 1 –∫–æ–º–º–∏—Ç

# –ò–ª–∏ –æ—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å - 8 –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –∫–æ–º–º–∏—Ç–æ–≤ –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏
```

### –ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞ —Ñ–∞–∑—ã 8
- ‚úÖ Integration test (2—á) –ø—Ä–æ–π–¥–µ–Ω —É—Å–ø–µ—à–Ω–æ
- ‚úÖ –í—Å–µ –º–µ—Ç—Ä–∏–∫–∏ —É–ª—É—á—à–µ–Ω—ã vs baseline
- ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ–ª–Ω–∞—è –∏ –∞–∫—Ç—É–∞–ª—å–Ω–∞—è
- ‚úÖ Code review checklist –≤—ã–ø–æ–ª–Ω–µ–Ω
- ‚úÖ PR description –≥–æ—Ç–æ–≤
- ‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç
- ‚úÖ Git commits —á–∏—Å—Ç—ã–µ –∏ –ø–æ–Ω—è—Ç–Ω—ã–µ

### –í—Ä–µ–º—è
3 —á–∞—Å–∞ (–≤–∫–ª—é—á–∞—è 2—á –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞)

---

## üì¶ –§–ê–ó–ê 9: Merge –∏ deployment

### –¶–µ–ª—å
–ë–µ–∑–æ–ø–∞—Å–Ω–æ –≤–ª–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ main –∏ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å –≤ production —Å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–æ–º.

### –ó–∞–¥–∞—á–∏

#### 9.1 Pre-merge –ø—Ä–æ–≤–µ—Ä–∫–∏

```bash
# –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –Ω–∞ –∞–∫—Ç—É–∞–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–∏ main
git checkout main
git pull origin main

# –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ feature branch
git checkout fix/age-detector-order-proliferation

# Rebase –Ω–∞ –∞–∫—Ç—É–∞–ª—å–Ω—ã–π main (–µ—Å–ª–∏ –±—ã–ª–∏ –¥—Ä—É–≥–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è)
git rebase main

# –†–∞–∑—Ä–µ—à–∏—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã –µ—Å–ª–∏ –µ—Å—Ç—å

# –ó–∞–ø—É—Å—Ç–∏—Ç—å –í–°–ï —Ç–µ—Å—Ç—ã –ø–æ—Å–ª–µ rebase
pytest tests/ -v

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç
python -m py_compile core/*.py
```

#### 9.2 –°–æ–∑–¥–∞–Ω–∏–µ Pull Request

**GitHub/GitLab:**
1. Push feature branch:
   ```bash
   git push origin fix/age-detector-order-proliferation
   ```

2. –°–æ–∑–¥–∞—Ç—å PR —á–µ—Ä–µ–∑ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å:
   - Title: "Fix: Age Detector Order Proliferation Bug"
   - Description: –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∏–∑ `PR_DESCRIPTION.md`
   - Labels: `bug`, `critical`, `tested`
   - Reviewers: –ù–∞–∑–Ω–∞—á–∏—Ç—å —Ä–µ–≤—å—é–µ—Ä–æ–≤

3. –ü—Ä–∏–ª–æ–∂–∏—Ç—å:
   - `BEFORE_AFTER_COMPARISON.md`
   - `CHANGELOG_AGE_DETECTOR.md`
   - Screenshots –º–µ—Ç—Ä–∏–∫ (–µ—Å–ª–∏ –µ—Å—Ç—å)

#### 9.3 Code review –ø—Ä–æ—Ü–µ—Å—Å

–î–æ–∂–¥–∞—Ç—å—Å—è:
- [ ] –ú–∏–Ω–∏–º—É–º 1 approval –æ—Ç reviewer
- [ ] –í—Å–µ CI/CD checks –ø—Ä–æ—à–ª–∏ (–µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã)
- [ ] –ù–µ—Ç –±–ª–æ–∫–∏—Ä—É—é—â–∏—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤

–ò—Å–ø—Ä–∞–≤–∏—Ç—å feedback –µ—Å–ª–∏ –µ—Å—Ç—å.

#### 9.4 Merge –≤ main

**–°—Ç—Ä–∞—Ç–µ–≥–∏—è merge:** Squash (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è) –∏–ª–∏ Merge commit (–µ—Å–ª–∏ –≤–∞–∂–Ω–∞ –¥–µ—Ç–∞–ª—å–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è)

```bash
# –ü–æ—Å–ª–µ approval —á–µ—Ä–µ–∑ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
# –ò–õ–ò –ª–æ–∫–∞–ª—å–Ω–æ:
git checkout main
git merge --squash fix/age-detector-order-proliferation
git commit -m "Fix: Age Detector order proliferation bug (#ISSUE_NUMBER)

- Unified order management method
- 95% reduction in order creation
- Duplicate prevention working
- Comprehensive testing passed

Fixes #ISSUE_NUMBER
See: CHANGELOG_AGE_DETECTOR.md"

git push origin main
```

#### 9.5 Deployment –≤ production

**–í–ê–ñ–ù–û:** –ü–æ—ç—Ç–∞–ø–Ω–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ!

##### 9.5.1 Pre-deployment checklist

- [ ] Backup production database
- [ ] Backup .env —Ñ–∞–π–ª–∞
- [ ] –°–æ–∑–¥–∞—Ç—å rollback plan
- [ ] –£–≤–µ–¥–æ–º–∏—Ç—å –∫–æ–º–∞–Ω–¥—É –æ deployment
- [ ] –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

##### 9.5.2 Deployment steps

```bash
# –ù–∞ production —Å–µ—Ä–≤–µ—Ä–µ
cd /path/to/TradingBot

# –°–æ–∑–¥–∞—Ç—å backup
./scripts/backup_before_deployment.sh

# Pull –∏–∑–º–µ–Ω–µ–Ω–∏–π
git fetch origin
git checkout main
git pull origin main

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å .env –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
# –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∫–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–µ—Ä–≤—ã–µ 24—á:
cat >> .env << EOF
# Conservative settings for first 24h after Age Detector fix
MAX_POSITION_AGE_HOURS=6
AGED_GRACE_PERIOD_HOURS=12
AGED_LOSS_STEP_PERCENT=0.3
AGED_MAX_LOSS_PERCENT=5.0
AGED_PROFITABLE_CLOSE_THRESHOLD=0.2
EOF

# Restart —Å–µ—Ä–≤–∏—Å–∞
sudo systemctl restart trading-bot

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è
sudo systemctl status trading-bot

# –ù–∞—á–∞—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
tail -f logs/trading_bot.log | grep -i "aged\|exit order"
```

##### 9.5.3 Post-deployment –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ (24 —á–∞—Å–∞)

**–ü–µ—Ä–≤—ã–µ 15 –º–∏–Ω—É—Ç:**
```bash
# –í –æ—Ç–¥–µ–ª—å–Ω–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ –∑–∞–ø—É—Å—Ç–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä
python monitor_age_detector.py logs/trading_bot.log

# –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã:
# - proliferation_issues = []
# - duplicates_prevented > 0
# - –ù–µ—Ç –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫
```

**–ü–µ—Ä–≤—ã–µ 2 —á–∞—Å–∞:**
- –ü—Ä–æ–≤–µ—Ä—è—Ç—å –ª–æ–≥–∏ –∫–∞–∂–¥—ã–µ 30 –º–∏–Ω—É—Ç
- –°–ª–µ–¥–∏—Ç—å –∑–∞ –º–µ—Ç—Ä–∏–∫–∞–º–∏:
  ```bash
  grep "Aged positions processed" logs/trading_bot.log | tail -10
  ```
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –æ—Ä–¥–µ—Ä–æ–≤ –Ω–∞ –±–∏—Ä–∂–µ –≤—Ä—É—á–Ω—É—é

**–ü–µ—Ä–≤—ã–µ 24 —á–∞—Å–∞:**
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∫–∞–∂–¥—ã–µ 4 —á–∞—Å–∞
- –°—Ä–∞–≤–Ω–∏—Ç—å —Å baseline –º–µ—Ç—Ä–∏–∫–∞–º–∏
- –°–æ–±—Ä–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É

**–°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª:** `PRODUCTION_DEPLOYMENT_LOG.md`
```markdown
# Production Deployment - Age Detector Fix

## Deployment Info
- Date: 2025-10-15
- Time: [–í–†–ï–ú–Ø]
- Deployed by: [–ò–ú–Ø]
- Commit: [GIT HASH]

## Pre-deployment
- [x] Database backup created: backup_20251015.sql
- [x] .env backup created
- [x] Team notified

## Deployment
- [x] Code pulled from main
- [x] Service restarted
- [x] Initial monitoring started

## Monitoring Results

### T+15min
- proliferation_issues: []
- duplicates_prevented: 12
- errors: 0
- Status: ‚úÖ GOOD

### T+2h
- positions_processed: 87
- orders_created: 14
- orders_updated: 23
- duplicates_prevented: 50
- Status: ‚úÖ GOOD

### T+24h
- [TO BE FILLED]

## Issues Found
- None

## Rollback Required
- No
```

##### 9.5.4 Rollback plan (–µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫)

```bash
# –ù–ï–ú–ï–î–õ–ï–ù–ù–´–ô –û–¢–ö–ê–¢

# 1. –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–æ—Ç–∞
sudo systemctl stop trading-bot

# 2. –û—Ç–∫–∞—Ç–∏—Ç—å –∫–æ–¥
git checkout [PREVIOUS_COMMIT_HASH]

# 3. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å .env (–µ—Å–ª–∏ –º–µ–Ω—è–ª—Å—è)
cp .env.backup .env

# 4. –ó–∞–ø—É—Å—Ç–∏—Ç—å
sudo systemctl start trading-bot

# 5. –£–≤–µ–¥–æ–º–∏—Ç—å –∫–æ–º–∞–Ω–¥—É
# 6. –°–æ–∑–¥–∞—Ç—å post-mortem –æ—Ç—á–µ—Ç
```

#### 9.6 –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–µ —É–∂–µ—Å—Ç–æ—á–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤

–ü–æ—Å–ª–µ 24—á —É—Å–ø–µ—à–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å –∫–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏:

```bash
# –î–µ–Ω—å 2-3: –°—Ä–µ–¥–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
MAX_POSITION_AGE_HOURS=4
AGED_GRACE_PERIOD_HOURS=10

# –î–µ–Ω—å 4-7: –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
MAX_POSITION_AGE_HOURS=3
AGED_GRACE_PERIOD_HOURS=8
AGED_LOSS_STEP_PERCENT=0.5
AGED_MAX_LOSS_PERCENT=10.0
```

–ö–∞–∂–¥—ã–π —Ä–∞–∑:
- Restart —Å–µ—Ä–≤–∏—Å–∞
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ 2 —á–∞—Å–∞
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–µ—Ç—Ä–∏–∫

### Git tag

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ deployment:
```bash
git tag -a v2.0.0-age-detector-fix -m "Age Detector order proliferation fix deployed

- Zero proliferation in 24h production test
- Duplicate prevention working
- All metrics improved

Deployed: 2025-10-15
See: CHANGELOG_AGE_DETECTOR.md"

git push origin v2.0.0-age-detector-fix
```

### –ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞ —Ñ–∞–∑—ã 9
- ‚úÖ PR —Å–æ–∑–¥–∞–Ω –∏ approved
- ‚úÖ Merged –≤ main
- ‚úÖ Deployed –≤ production
- ‚úÖ 24h –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ—à–µ–ª —É—Å–ø–µ—à–Ω–æ
- ‚úÖ –ú–µ—Ç—Ä–∏–∫–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
- ‚úÖ Tag —Å–æ–∑–¥–∞–Ω

### –í—Ä–µ–º—è
1 —á–∞—Å (deployment) + 24 —á–∞—Å–∞ (–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥)

---

## üìä –°—É–º–º–∞—Ä–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –≤—Å–µ—Ö —Ñ–∞–∑

| –§–∞–∑–∞ | –ù–∞–∑–≤–∞–Ω–∏–µ | –í—Ä–µ–º—è | –°—Ç–∞—Ç—É—Å | Git Commit |
|------|----------|-------|--------|------------|
| 0 | –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∏ baseline | 30 –º–∏–Ω | ‚è≥ Pending | ‚úÖ |
| 1 | –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –º–µ—Ç–æ–¥ –≤ EnhancedExchangeManager | 1.5 —á | ‚è≥ Pending | ‚úÖ |
| 2 | –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ AgedPositionManager | 2 —á | ‚è≥ Pending | ‚úÖ |
| 3 | –£–ª—É—á—à–µ–Ω–∏–µ –∫—ç—à-–∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏–∏ | 1 —á | ‚è≥ Pending | ‚úÖ |
| 4 | –û–±—Ä–∞–±–æ—Ç–∫–∞ geo-–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π | 1 —á | ‚è≥ Pending | ‚úÖ |
| 5 | –õ–æ–≥–∏–∫–∞ –≤–∑—è—Ç–∏—è –ø—Ä–∏–±—ã–ª–∏ | 1.5 —á | ‚è≥ Pending | ‚úÖ |
| 6 | –í–∞–ª–∏–¥–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –æ—Ä–¥–µ—Ä–∞ | 1 —á | ‚è≥ Pending | ‚úÖ |
| 7 | –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ | 1 —á | ‚è≥ Pending | ‚úÖ |
| 8 | –§–∏–Ω–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ | 3 —á | ‚è≥ Pending | ‚úÖ |
| 9 | Merge –∏ deployment | 1 —á + 24—á | ‚è≥ Pending | ‚úÖ |

**–ò—Ç–æ–≥–æ:** ~12 —á–∞—Å–æ–≤ –∞–∫—Ç–∏–≤–Ω–æ–π —Ä–∞–±–æ—Ç—ã + 24 —á–∞—Å–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

---

## üéØ –ö—Ä–∏—Ç–µ—Ä–∏–∏ –ø–æ–ª–Ω–æ–≥–æ —É—Å–ø–µ—Ö–∞ –ø—Ä–æ–µ–∫—Ç–∞

### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏
- ‚úÖ Order proliferation = 0 (–Ω–µ—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –æ—Ä–¥–µ—Ä–æ–≤)
- ‚úÖ Duplicate prevention —Ä–∞–±–æ—Ç–∞–µ—Ç (–º–µ—Ç—Ä–∏–∫–∞ > 0)
- ‚úÖ –í—Å–µ unit-—Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç
- ‚úÖ Integration test 2—á –ø—Ä–æ—à–µ–ª —É—Å–ø–µ—à–Ω–æ
- ‚úÖ Production deployment —É—Å–ø–µ—à–µ–Ω
- ‚úÖ 24—á production –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –±–µ–∑ –ø—Ä–æ–±–ª–µ–º

### –ú–µ—Ç—Ä–∏–∫–∏ —É–ª—É—á—à–µ–Ω–∏—è
- ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ –æ—Ä–¥–µ—Ä–æ–≤ —Å–æ–∫—Ä–∞—Ç–∏–ª–æ—Å—å –Ω–∞ 95%
- ‚úÖ "Exit order already exists" –ø–æ—è–≤–ª—è–µ—Ç—Å—è –≤ –ª–æ–≥–∞—Ö
- ‚úÖ –ù–µ—Ç –æ—à–∏–±–æ–∫ "multiple orders for symbol"
- ‚úÖ Geo-restricted —Å–∏–º–≤–æ–ª—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –±–µ–∑ —Å–ø–∞–º–∞
- ‚úÖ Profitable positions –∑–∞–∫—Ä—ã–≤–∞—é—Ç—Å—è market-–æ—Ä–¥–µ—Ä–æ–º

### –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- ‚úÖ CHANGELOG —Å–æ–∑–¥–∞–Ω
- ‚úÖ Audit report –æ–±–Ω–æ–≤–ª–µ–Ω (—Å—Ç–∞—Ç—É—Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π)
- ‚úÖ Before/After —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –∑–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ
- ‚úÖ PR description –ø–æ–ª–Ω—ã–π
- ‚úÖ Production deployment log –∑–∞–ø–æ–ª–Ω–µ–Ω

### –ü—Ä–æ—Ü–µ—Å—Å
- ‚úÖ –ö–∞–∂–¥–∞—è —Ñ–∞–∑–∞ –∏–º–µ–µ—Ç –æ—Ç–¥–µ–ª—å–Ω—ã–π git commit
- ‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–π —Ñ–∞–∑—ã
- ‚úÖ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ—Ç–∫–∞—Ç–∞ –Ω–∞ –ª—é–±–æ–º —ç—Ç–∞–ø–µ
- ‚úÖ Code review –≤—ã–ø–æ–ª–Ω–µ–Ω
- ‚úÖ Team notified –æ deployment

---

## üìù Tracking –ø—Ä–æ–≥—Ä–µ—Å—Å–∞

**–°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª:** `IMPLEMENTATION_PROGRESS.md`

–û–±–Ω–æ–≤–ª—è—Ç—å –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–π —Ñ–∞–∑—ã:

```markdown
# Age Detector Fix - Implementation Progress

Last updated: [–î–ê–¢–ê –í–†–ï–ú–Ø]

## Phase Status

- [x] Phase 0: Baseline ‚úÖ Completed 2025-10-15 10:00
- [ ] Phase 1: Unified method ‚è≥ In Progress
- [ ] Phase 2: Refactor AgedPositionManager
- [ ] Phase 3: Cache invalidation
- [ ] Phase 4: Geo restrictions
- [ ] Phase 5: Profit taking
- [ ] Phase 6: Order validation
- [ ] Phase 7: Duplicate monitoring
- [ ] Phase 8: Final testing
- [ ] Phase 9: Deployment

## Current Phase Details

### Phase 1: Unified Method
- Started: 2025-10-15 10:30
- Expected completion: 2025-10-15 12:00
- Status: Writing create_or_update_exit_order() method
- Blockers: None
- Next step: Add unit tests

## Issues Log

(Empty - no issues yet)

## Notes

- Using testnet for all testing
- Conservative config for first deployment
- Team notified about planned deployment
```

---

## üö® –í–∞–∂–Ω—ã–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è

### –ü–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º –∫–∞–∂–¥–æ–π —Ñ–∞–∑—ã
1. ‚úÖ –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –ø—Ä–µ–¥—ã–¥—É—â–∞—è —Ñ–∞–∑–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ
2. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –≤—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç
3. ‚úÖ –°–æ–∑–¥–∞—Ç—å git commit –ø—Ä–µ–¥—ã–¥—É—â–µ–π —Ñ–∞–∑—ã
4. ‚úÖ –û–±–Ω–æ–≤–∏—Ç—å `IMPLEMENTATION_PROGRESS.md`

### –í–æ –≤—Ä–µ–º—è —Ñ–∞–∑—ã
1. ‚úÖ –î–µ–ª–∞—Ç—å —á–∞—Å—Ç—ã–µ –ª–æ–∫–∞–ª—å–Ω—ã–µ –∫–æ–º–º–∏—Ç—ã (–º–æ–∂–Ω–æ squash –ø–æ–∑–∂–µ)
2. ‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ –º–µ—Ä–µ –Ω–∞–ø–∏—Å–∞–Ω–∏—è
3. ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã
4. ‚úÖ –ù–µ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç—å –∫ —Å–ª–µ–¥—É—é—â–µ–π —Ñ–∞–∑–µ –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö

### –ü–æ—Å–ª–µ –∫–∞–∂–¥–æ–π —Ñ–∞–∑—ã
1. ‚úÖ –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Ç–µ—Å—Ç—ã
2. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –Ω–∏—á–µ–≥–æ –Ω–µ —Å–ª–æ–º–∞–ª–æ—Å—å
3. ‚úÖ –°–æ–∑–¥–∞—Ç—å —á–∏—Å—Ç—ã–π git commit —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º
4. ‚úÖ –û–±–Ω–æ–≤–∏—Ç—å progress tracker
5. ‚úÖ –°–¥–µ–ª–∞—Ç—å short break –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–µ–π —Ñ–∞–∑–æ–π

### –ü—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º—ã
1. üõë STOP - –Ω–µ –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å –¥–∞–ª—å—à–µ
2. üìù –ó–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—É
3. üîç –ò—Å—Å–ª–µ–¥–æ–≤–∞—Ç—å –ø—Ä–∏—á–∏–Ω—É
4. üîß –ò—Å–ø—Ä–∞–≤–∏—Ç—å
5. ‚úÖ –ü–µ—Ä–µ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å
6. ‚û°Ô∏è –¢–æ–ª—å–∫–æ —Ç–æ–≥–¥–∞ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å

---

## üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã –∏ —ç—Å–∫–∞–ª–∞—Ü–∏—è

**–ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã:**

1. **–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –≤–æ–ø—Ä–æ—Å—ã:** –°–º. `AGE_DETECTOR_AUDIT_REPORT_RU.md`
2. **–ü—Ä–æ–±–ª–µ–º—ã —Å —Ç–µ—Å—Ç–∞–º–∏:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å `IMPLEMENTATION_PROGRESS.md` ‚Üí Issues Log
3. **Production –ø—Ä–æ–±–ª–µ–º—ã:** –ù–µ–º–µ–¥–ª–µ–Ω–Ω—ã–π rollback ‚Üí Post-mortem

---

**–ö–û–ù–ï–¶ –ü–õ–ê–ù–ê**

–≠—Ç–æ—Ç –ø–ª–∞–Ω –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—é. –ù–∞—á–∏–Ω–∞–π—Ç–µ —Å –§–∞–∑—ã 0.

–£–¥–∞—á–∏! üöÄ
