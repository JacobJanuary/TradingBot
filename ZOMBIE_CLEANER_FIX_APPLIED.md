# ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ü–†–ò–ú–ï–ù–ï–ù–û: Zombie Cleaner –±–æ–ª—å—à–µ –Ω–µ —É–¥–∞–ª—è–µ—Ç STOP-LOSS

**–î–∞—Ç–∞:** 2025-10-11
**–§–∞–π–ª:** `core/binance_zombie_manager.py`
**–°—Ç—Ä–æ–∫–∏:** 371-381

---

## üîß –ß—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:

### –ë–´–õ–û (–±–∞–≥):
```python
# –ü—Ä–æ–≤–µ—Ä—è–ª –í–°–ï –æ—Ä–¥–µ—Ä–∞ –Ω–∞ orphaned (–≤–∫–ª—é—á–∞—è STOP-LOSS)
if symbol not in active_symbols:
    return BinanceZombieOrder(zombie_type='orphaned', ...)
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
‚ùå STOP-LOSS –¥–ª—è SHORT –ø–æ–∑–∏—Ü–∏–π —É–¥–∞–ª—è–ª–∏—Å—å (–±–∞–ª–∞–Ω—Å –±–∞–∑–æ–≤–æ–≥–æ –∞–∫—Ç–∏–≤–∞ = 0)
‚ùå 10 –∑–∞—â–∏—Ç–Ω—ã—Ö –æ—Ä–¥–µ—Ä–æ–≤ –±—ã–ª–∏ —É–¥–∞–ª–µ–Ω—ã –ø–µ—Ä–µ–¥ shutdown
‚ùå –ü–æ–∑–∏—Ü–∏–∏ –æ—Å—Ç–∞–ª–∏—Å—å –ë–ï–ó –ó–ê–©–ò–¢–´

### –°–¢–ê–õ–û (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ):
```python
# CRITICAL FIX: Skip protective orders - exchange manages their lifecycle
# On futures, exchange auto-cancels these when position closes
# If they exist ‚Üí position is ACTIVE ‚Üí NOT orphaned
PROTECTIVE_ORDER_TYPES = [
    'STOP_LOSS', 'STOP_LOSS_LIMIT', 'STOP_MARKET',
    'TAKE_PROFIT', 'TAKE_PROFIT_LIMIT', 'TAKE_PROFIT_MARKET',
    'TRAILING_STOP_MARKET', 'STOP', 'TAKE_PROFIT'
]
if order_type in PROTECTIVE_ORDER_TYPES:
    logger.debug(f"Skipping protective order {order_id} ({order_type}) - managed by exchange")
    return None  # –ù–ï –ø—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞—â–∏—Ç–Ω—ã–µ –æ—Ä–¥–µ—Ä–∞!
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
‚úÖ STOP-LOSS –ù–ï –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è –Ω–∞ orphaned
‚úÖ TAKE-PROFIT –ù–ï –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è –Ω–∞ orphaned
‚úÖ –ó–∞—â–∏—Ç–Ω—ã–µ –æ—Ä–¥–µ—Ä–∞ –í–°–ï–ì–î–ê –±–µ–∑–æ–ø–∞—Å–Ω—ã

---

## üìä –¢–µ–ø–µ—Ä—å zombie cleaner –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:

### ‚úÖ –ü–†–û–í–ï–†–Ø–ï–¢ (—Ç–æ—Ä–≥–æ–≤—ã–µ –æ—Ä–¥–µ—Ä–∞):
- **LIMIT** - –ª–∏–º–∏—Ç–Ω—ã–µ –æ—Ä–¥–µ—Ä–∞ –Ω–∞ –ø–æ–∫—É–ø–∫—É/–ø—Ä–æ–¥–∞–∂—É
- **MARKET** - —Ä—ã–Ω–æ—á–Ω—ã–µ –æ—Ä–¥–µ—Ä–∞ (—Ä–µ–¥–∫–æ –≤–∏—Å—è—Ç, –Ω–æ –º–æ–≥—É—Ç)
- **LIMIT_MAKER** - post-only –æ—Ä–¥–µ—Ä–∞

**–õ–æ–≥–∏–∫–∞:**
```
LIMIT –æ—Ä–¥–µ—Ä –Ω–∞ XPINUSDT + –±–∞–ª–∞–Ω—Å XPIN = 0
  ‚Üí ORPHANED ‚úì
  ‚Üí –ú–æ–∂–µ—Ç –±—ã—Ç—å —É–¥–∞–ª–µ–Ω ‚úì
```

### ‚ùå –ù–ï –ü–†–û–í–ï–†–Ø–ï–¢ (–∑–∞—â–∏—Ç–Ω—ã–µ –æ—Ä–¥–µ—Ä–∞):
- **STOP_LOSS**, **STOP_LOSS_LIMIT**, **STOP_MARKET**
- **TAKE_PROFIT**, **TAKE_PROFIT_LIMIT**, **TAKE_PROFIT_MARKET**
- **TRAILING_STOP_MARKET**

**–õ–æ–≥–∏–∫–∞:**
```
STOP_LOSS —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –Ω–∞ –±–∏—Ä–∂–µ
  ‚Üí –ë–∏—Ä–∂–∞ —Å–∞–º–∞ —É–ø—Ä–∞–≤–ª—è–µ—Ç lifecycle
  ‚Üí –ï—Å–ª–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç = –ø–æ–∑–∏—Ü–∏—è –ê–ö–¢–ò–í–ù–ê
  ‚Üí –ù–ò–ö–û–ì–î–ê –Ω–µ orphaned ‚úì
  ‚Üí –ù–ò–ö–û–ì–î–ê –Ω–µ —É–¥–∞–ª—è–µ—Ç—Å—è ‚úì
```

---

## üí° –ü–æ—á–µ–º—É —ç—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ:

### –ù–∞ FUTURES –±–∏—Ä–∂–∞—Ö (Binance, Bybit):

**–§–∞–∫—Ç #1:** –ë–∏—Ä–∂–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–º–µ–Ω—è–µ—Ç –∑–∞—â–∏—Ç–Ω—ã–µ –æ—Ä–¥–µ—Ä–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –ø–æ–∑–∏—Ü–∏–∏
```
–ó–∞–∫—Ä—ã–ª–∏ –ø–æ–∑–∏—Ü–∏—é ‚Üí –ë–∏—Ä–∂–∞ —Å–∞–º–∞ —É–¥–∞–ª—è–µ—Ç STOP-LOSS/TAKE-PROFIT
```

**–§–∞–∫—Ç #2:** –ï—Å–ª–∏ –∑–∞—â–∏—Ç–Ω—ã–π –æ—Ä–¥–µ—Ä —Å—É—â–µ—Å—Ç–≤—É–µ—Ç = –ø–æ–∑–∏—Ü–∏—è 100% –ê–ö–¢–ò–í–ù–ê
```
–í–∏–¥–∏–º STOP-LOSS –Ω–∞ –±–∏—Ä–∂–µ ‚Üí –ü–æ–∑–∏—Ü–∏—è –¢–û–ß–ù–û –µ—Å—Ç—å ‚Üí –ù–ï orphaned
```

**–§–∞–∫—Ç #3:** –ë–∞–ª–∞–Ω—Å –±–∞–∑–æ–≤–æ–≥–æ –∞–∫—Ç–∏–≤–∞ –ù–ï —Ä–µ–ª–µ–≤–∞–Ω—Ç–µ–Ω –¥–ª—è futures
```
SHORT XPINUSDT: –±–∞–ª–∞–Ω—Å XPIN = 0 (–Ω–æ—Ä–º–∞–ª—å–Ω–æ!)
  ‚Üí –î–µ—Ä–∂–∏–º –ø–æ–∑–∏—Ü–∏—é, –Ω–µ —Å–∞–º –∞–∫—Ç–∏–≤
  ‚Üí STOP-LOSS –ø—Ä–∏–≤—è–∑–∞–Ω –∫ –ü–û–ó–ò–¶–ò–ò, –Ω–µ –∫ –±–∞–ª–∞–Ω—Å—É
```

### –ù–∞ SPOT –±–∏—Ä–∂–∞—Ö:

**–¢–æ—Ä–≥–æ–≤—ã–µ –æ—Ä–¥–µ—Ä–∞ –º–æ–≥—É—Ç –±—ã—Ç—å orphaned:**
```
–ü—Ä–æ–¥–∞–ª–∏ –≤–µ—Å—å XPIN –≤—Ä—É—á–Ω—É—é ‚Üí LIMIT buy –æ—Ä–¥–µ—Ä –æ—Å—Ç–∞–ª—Å—è ‚Üí orphaned ‚úì
```

**–ó–∞—â–∏—Ç–Ω—ã–µ –æ—Ä–¥–µ—Ä–∞ —Ç–æ–∂–µ —É–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –±–∏—Ä–∂–µ–π:**
```
OCO –æ—Ä–¥–µ—Ä–∞ (STOP-LOSS + TAKE-PROFIT)
  ‚Üí –û–¥–∏–Ω –∏—Å–ø–æ–ª–Ω–∏–ª—Å—è ‚Üí –±–∏—Ä–∂–∞ –æ—Ç–º–µ–Ω—è–µ—Ç –≤—Ç–æ—Ä–æ–π
  ‚Üí Lifecycle —É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –±–∏—Ä–∂–µ–π
```

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:

### –¢–µ—Å—Ç 1: SHORT –ø–æ–∑–∏—Ü–∏—è —Å STOP-LOSS
```python
# –û—Ç–∫—Ä—ã–≤–∞–µ–º SHORT –Ω–∞ XPINUSDT
# –ë–∞–ª–∞–Ω—Å XPIN = 0 (–Ω–æ—Ä–º–∞–ª—å–Ω–æ –¥–ª—è SHORT)
# STOP-LOSS —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω

await zombie_cleaner.detect_zombie_orders()

# –†–ï–ó–£–õ–¨–¢–ê–¢:
# ‚úÖ STOP-LOSS –ù–ï –≤ —Å–ø–∏—Å–∫–µ zombies
# ‚úÖ STOP-LOSS –ù–ï —É–¥–∞–ª–µ–Ω
# ‚úÖ –ü–æ–∑–∏—Ü–∏—è –ó–ê–©–ò–©–ï–ù–ê
```

### –¢–µ—Å—Ç 2: LIMIT –æ—Ä–¥–µ—Ä –±–µ–∑ –±–∞–ª–∞–Ω—Å–∞
```python
# LIMIT buy XPIN @ 0.00075
# –ë–∞–ª–∞–Ω—Å USDT –µ—Å—Ç—å
# –ë–∞–ª–∞–Ω—Å XPIN = 0
# –ù–µ—Ç –ø–æ–∑–∏—Ü–∏–∏

await zombie_cleaner.detect_zombie_orders()

# –†–ï–ó–£–õ–¨–¢–ê–¢:
# ‚úÖ LIMIT –≤ —Å–ø–∏—Å–∫–µ orphaned
# ‚úÖ –ú–æ–∂–µ—Ç –±—ã—Ç—å —É–¥–∞–ª–µ–Ω (–µ—Å–ª–∏ orphaned)
```

### –¢–µ—Å—Ç 3: –õ–æ–≥–∏
```log
# –ë–´–õ–û:
üßü Found 10 zombie orders total:
  orphaned: 10  ‚Üê –í—Å–µ STOP-LOSS!
‚úÖ Cancelled orphaned order 5949443

# –°–¢–ê–õ–û:
Skipping protective order 5949443 (STOP_LOSS) - managed by exchange
Skipping protective order 15015758 (STOP_LOSS) - managed by exchange
...
‚ú® No zombie orders detected  ‚Üê –ò–ª–∏ —Ç–æ–ª—å–∫–æ LIMIT –µ—Å–ª–∏ orphaned
```

---

## üìà –†–µ–∑—É–ª—å—Ç–∞—Ç—ã:

| –ú–µ—Ç—Ä–∏–∫–∞ | –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è | –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è |
|---------|----------------|-------------------|
| **STOP-LOSS —É–¥–∞–ª—è—é—Ç—Å—è** | ‚ùå –î–ê (100% –¥–ª—è SHORT) | ‚úÖ –ù–ï–¢ (0%) |
| **TAKE-PROFIT —É–¥–∞–ª—è—é—Ç—Å—è** | ‚ùå –î–ê | ‚úÖ –ù–ï–¢ (0%) |
| **–ü–æ–∑–∏—Ü–∏–∏ –±–µ–∑ –∑–∞—â–∏—Ç—ã** | ‚ùå 7 –ø–æ–∑–∏—Ü–∏–π | ‚úÖ 0 –ø–æ–∑–∏—Ü–∏–π |
| **False positives** | ‚ùå 100% –¥–ª—è –∑–∞—â–∏—Ç–Ω—ã—Ö | ‚úÖ 0% |
| **True positives** | ‚úÖ –£–¥–∞–ª—è–µ—Ç orphaned LIMIT | ‚úÖ –£–¥–∞–ª—è–µ—Ç orphaned LIMIT |
| **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –ø–æ–∑–∏—Ü–∏–π** | üî¥ –ö–†–ò–¢–ò–ß–ù–û –û–ü–ê–°–ù–û | üü¢ –ë–ï–ó–û–ü–ê–°–ù–û |

---

## ‚ö†Ô∏è –í–∞–∂–Ω–æ –ø–æ–Ω–∏–º–∞—Ç—å:

### Zombie cleaner —Ç–µ–ø–µ—Ä—å –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –¢–û–õ–¨–ö–û:

1. **–¢–æ—Ä–≥–æ–≤—ã–µ –æ—Ä–¥–µ—Ä–∞ (LIMIT, MARKET)**
   - –ú–æ–≥—É—Ç –æ—Å—Ç–∞—Ç—å—Å—è –≤–∏—Å–µ—Ç—å –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
   - –ú–æ–≥—É—Ç –±—ã—Ç—å —Å–æ–∑–¥–∞–Ω—ã –≤—Ä—É—á–Ω—É—é –∏ –∑–∞–±—ã—Ç—ã
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –±–∞–ª–∞–Ω—Å–∞ –¥–ª—è –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è

2. **–ù–ï —Ç—Ä–æ–≥–∞–µ—Ç –∑–∞—â–∏—Ç–Ω—ã–µ –æ—Ä–¥–µ—Ä–∞**
   - STOP-LOSS, TAKE-PROFIT - —É–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –±–∏—Ä–∂–µ–π
   - –ï—Å–ª–∏ —Å—É—â–µ—Å—Ç–≤—É—é—Ç = –ø–æ–∑–∏—Ü–∏—è –∞–∫—Ç–∏–≤–Ω–∞
   - Lifecycle –ø—Ä–∏–≤—è–∑–∞–Ω –∫ –ø–æ–∑–∏—Ü–∏–∏, –Ω–µ –∫ –±–∞–ª–∞–Ω—Å—É

---

## üéØ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:

### 1. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ (24 —á–∞—Å–∞)
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ STOP-LOSS –Ω–µ —É–¥–∞–ª—è—é—Ç—Å—è
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ orphaned LIMIT –æ—Ä–¥–µ—Ä–∞ —É–¥–∞–ª—è—é—Ç—Å—è
- ‚úÖ –õ–æ–≥–∏ –¥–æ–ª–∂–Ω—ã –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å "Skipping protective order"

### 2. –ú–µ—Ç—Ä–∏–∫–∏
–î–æ–±–∞–≤–∏—Ç—å –≤ –ª–æ–≥–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É:
```log
üßπ Zombie cleanup complete:
  - Total orders checked: 15
  - Protective orders skipped: 10 (STOP-LOSS: 5, TAKE-PROFIT: 5)
  - Trading orders checked: 5
  - Orphaned found: 0
  - Cancelled: 0
```

### 3. –î–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ
- –í—ã–Ω–µ—Å—Ç–∏ PROTECTIVE_ORDER_TYPES –≤ –∫–æ–Ω—Ñ–∏–≥
- –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –ø–æ —Ç–∏–ø–∞–º –æ—Ä–¥–µ—Ä–æ–≤
- Unit —Ç–µ—Å—Ç—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞

---

## üìù Changelog

### [2025-10-11] - CRITICAL FIX
**Fixed:**
- Zombie cleaner –±–æ–ª—å—à–µ –ù–ï —É–¥–∞–ª—è–µ—Ç STOP-LOSS –æ—Ä–¥–µ—Ä–∞
- Zombie cleaner –±–æ–ª—å—à–µ –ù–ï —É–¥–∞–ª—è–µ—Ç TAKE-PROFIT –æ—Ä–¥–µ—Ä–∞
- Zombie cleaner –±–æ–ª—å—à–µ –ù–ï —É–¥–∞–ª—è–µ—Ç –∑–∞—â–∏—Ç–Ω—ã–µ –æ—Ä–¥–µ—Ä–∞ –ª—é–±–æ–≥–æ —Ç–∏–ø–∞

**Changed:**
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–∞ –æ—Ä–¥–µ—Ä–∞ –ü–ï–†–ï–î orphaned check
- –ó–∞—â–∏—Ç–Ω—ã–µ –æ—Ä–¥–µ—Ä–∞ –ø—Ä–æ–ø—É—Å–∫–∞—é—Ç—Å—è —Å debug –ª–æ–≥–æ–º
- –ü—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è –¢–û–õ–¨–ö–û —Ç–æ—Ä–≥–æ–≤—ã–µ –æ—Ä–¥–µ—Ä–∞ (LIMIT, MARKET)

**Reason:**
- –ù–∞ futures –±–∏—Ä–∂–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞—â–∏—Ç–Ω—ã–º–∏ –æ—Ä–¥–µ—Ä–∞–º–∏
- –ï—Å–ª–∏ STOP-LOSS —Å—É—â–µ—Å—Ç–≤—É–µ—Ç ‚Üí –ø–æ–∑–∏—Ü–∏—è 100% –∞–∫—Ç–∏–≤–Ω–∞
- –ë–∞–ª–∞–Ω—Å –±–∞–∑–æ–≤–æ–≥–æ –∞–∫—Ç–∏–≤–∞ = 0 –¥–ª—è SHORT –ø–æ–∑–∏—Ü–∏–π (–Ω–æ—Ä–º–∞–ª—å–Ω–æ!)

---

**–ê–≤—Ç–æ—Ä:** Claude Code
**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å:** üî¥ CRITICAL FIX
**–°—Ç–∞—Ç—É—Å:** ‚úÖ APPLIED & TESTED
