# üö® –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –ë–ê–ì: WebSocket Mark Price –ù–ï –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –Ω–∞ –Ω–æ–≤—ã–µ –ø–æ–∑–∏—Ü–∏–∏

## üìã EXECUTIVE SUMMARY

–ü—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –Ω–æ–≤—ã—Ö –ø–æ–∑–∏—Ü–∏–π (QNTUSDT, DOGSUSDT, MOODENGUSDT) WebSocket –ø–æ–ª—É—á–∞–ª position updates –æ—Ç User Stream, –Ω–æ **mark_price=0** - —Ü–µ–Ω—ã –Ω–µ –∑–∞–≥—Ä—É–∂–∞–ª–∏—Å—å –≤ –ë–î. –ü—Ä–∏—à–ª–æ—Å—å –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞—Ç—å –±–æ—Ç–∞.

## üîç ROOT CAUSE ANALYSIS

### **–ì–ª–∞–≤–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞**: Mark Price Stream –±—ã–ª –æ—Ç–∫–ª—é—á–µ–Ω –≤–æ –≤—Ä–µ–º—è –æ—Ç–∫—Ä—ã—Ç–∏—è –ø–æ–∑–∏—Ü–∏–π

**–§–∞–π–ª**: `websocket/binance_hybrid_stream.py:786`
**–ú–µ—Ç–æ–¥**: `_subscription_manager()`

```python
# –°—Ç—Ä–æ–∫–∞ 786
if self.mark_connected and self.mark_ws and not self.mark_ws.closed:
    if subscribe:
        await self._subscribe_mark_price(symbol)
```

**–ü–†–û–ë–õ–ï–ú–ê**: –ï—Å–ª–∏ `mark_connected=False`, –∑–∞–ø—Ä–æ—Å—ã –ø–æ–¥–ø–∏—Å–∫–∏ **–∏–≥–Ω–æ—Ä–∏—Ä—É—é—Ç—Å—è**!

---

## ‚è±Ô∏è –î–ï–¢–ê–õ–¨–ù–ê–Ø –í–†–ï–ú–ï–ù–ù–ê–Ø –õ–ò–ù–ò–Ø

| –í—Ä–µ–º—è | –°–æ–±—ã—Ç–∏–µ | Mark Stream Status | –†–µ–∑—É–ª—å—Ç–∞—Ç |
|-------|---------|-------------------|-----------|
| **07:55:40** | Mark stream –ø–æ–¥–∫–ª—é—á–µ–Ω | ‚úÖ Connected | –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–ª 1 –ø–æ–∑–∏—Ü–∏—é (CFXUSDT) |
| **11:45:39** | CFXUSDT –∑–∞–∫—Ä—ã–ª–∞—Å—å | ‚úÖ Connected | Unsubscribed CFXUSDT ‚Üí **0 –ø–æ–¥–ø–∏—Å–æ–∫** |
| **11:45 - 16:06** | **4+ —á–∞—Å–∞ –¢–ò–®–ò–ù–´** | ‚ö†Ô∏è **SILENT DISCONNECT** | Mark stream –º–æ–ª—á–∞–ª, –ª–æ–≥–æ–≤ –Ω–µ—Ç |
| **15:47:14** | QNTUSDT –æ—Ç–∫—Ä—ã–ª–∞—Å—å | ‚ùå **Disconnected** | `mark_price=0` (4 —Ä–∞–∑–∞) |
| **16:03:18** | DOGSUSDT –æ—Ç–∫—Ä—ã–ª–∞—Å—å | ‚ùå **Disconnected** | `mark_price=0` (1 —Ä–∞–∑) |
| **16:03:24** | MOODENGUSDT –æ—Ç–∫—Ä—ã–ª–∞—Å—å | ‚ùå **Disconnected** | `mark_price=0` (2 —Ä–∞–∑–∞) |
| **16:06:56** | Health check cancelled | ‚ùå Disconnected | –ß—Ç–æ-—Ç–æ —Ç—Ä–∏–≥–≥–µ—Ä–Ω—É–ª–æ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ |
| **16:07:08** | Mark stream **RECONNECT** | ‚úÖ **Reconnected** | - |
| **16:07:11** | –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∏–∑ –ë–î | ‚úÖ Connected | –ü–æ–¥–ø–∏—Å–∞–ª–∏—Å—å –Ω–∞ 3 —Å–∏–º–≤–æ–ª–∞ –∏–∑ –ë–î |

---

## üêõ –¢–†–ò –ö–†–ò–¢–ò–ß–ï–°–ö–ò–• –ë–ê–ì–ê

### **–ë–ê–ì #1: Silent Disconnect**
Mark stream –æ—Ç–∫–ª—é—á–∏–ª—Å—è **–±–µ–∑ –ª–æ–≥–æ–≤** –ø–æ—Å–ª–µ unsubscribe –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–∏–º–≤–æ–ª–∞ (11:45). –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:
- Idle timeout –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ Binance (–Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫)
- Heartbeat failure –±–µ–∑ –æ–±—Ä–∞–±–æ—Ç–∫–∏
- WebSocket –∑–∞–∫—Ä—ã–ª—Å—è "—Ç–∏—Ö–æ" –±–µ–∑ –∏—Å–∫–ª—é—á–µ–Ω–∏—è

### **–ë–ê–ì #2: –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–ø–∏—Å–æ–∫ –ø—Ä–∏ –æ—Ç–∫–ª—é—á–µ–Ω–Ω–æ–º stream**
`_subscription_manager()` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç `if self.mark_connected` **–î–û** –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–æ–¥–ø–∏—Å–æ–∫. –ï—Å–ª–∏ stream –æ—Ç–∫–ª—é—á–µ–Ω - –ø–æ–¥–ø–∏—Å–∫–∏ —Ç–µ—Ä—è—é—Ç—Å—è.

**–ß—Ç–æ –¥–æ–ª–∂–Ω–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç—å**:
1. –°–∏–º–≤–æ–ª –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ `pending_subscriptions` ‚úÖ
2. –ü–æ–¥–ø–∏—Å–∫–∞ –æ—Ç–∫–ª–∞–¥—ã–≤–∞–µ—Ç—Å—è –¥–æ reconnect ‚úÖ
3. –ü–æ—Å–ª–µ reconnect `_restore_subscriptions()` –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç pending ‚úÖ

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –Ω–∞ –ø—Ä–∞–∫—Ç–∏–∫–µ**:
1. –°–∏–º–≤–æ–ª –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ `pending_subscriptions` ‚úÖ
2. –ü–æ–¥–ø–∏—Å–∫–∞ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è (mark_connected=False) ‚ùå
3. `pending_subscriptions` –ù–ï –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è, –ø–æ—Ç–æ–º—É —á—Ç–æ reconnect –Ω–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —á–∞—Å–∞–º–∏! ‚ùå

### **–ë–ê–ì #3: –ù–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –ø—Ä–∏ 0 –ø–æ–¥–ø–∏—Å–∫–∞—Ö**
–ö–æ–≥–¥–∞ –≤—Å–µ —Å–∏–º–≤–æ–ª—ã unsubscribed, mark stream –æ—Å—Ç–∞–µ—Ç—Å—è –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã–º, –Ω–æ **–Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–º**. –ü—Ä–∏ silent disconnect –Ω–µ—Ç –º–µ—Ö–∞–Ω–∏–∑–º–∞ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è.

---

## üí° –ü–õ–ê–ù –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø

### **–ü–†–ò–û–†–ò–¢–ï–¢ 1 (CRITICAL)**: Fix `_subscription_manager()`

**–†–µ—à–µ–Ω–∏–µ**: –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å pending subscriptions –ø–æ—Å–ª–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è

### **–ü–†–ò–û–†–ò–¢–ï–¢ 2 (HIGH)**: –î–æ–±–∞–≤–∏—Ç—å heartbeat monitoring –¥–ª—è mark stream

**–†–µ—à–µ–Ω–∏–µ**: –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å silent disconnects —á–µ—Ä–µ–∑ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –¥–∞–Ω–Ω—ã—Ö

### **–ü–†–ò–û–†–ò–¢–ï–¢ 3 (MEDIUM)**: –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ pending subscriptions

**–†–µ—à–µ–Ω–∏–µ**: –ö–∞–∂–¥—ã–µ 2 –º–∏–Ω—É—Ç—ã –ø—Ä–æ–≤–µ—Ä—è—Ç—å –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å pending

---

## ‚úÖ –ü–†–û–í–ï–†–ö–ê –¢–ï–ö–£–©–ï–ì–û –°–û–°–¢–û–Ø–ù–ò–Ø

- ‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä—É–µ—Ç (14 —Ç–∞–±–ª–∏—Ü –≤ monitoring schema)
- ‚úÖ User WebSocket —Ä–∞–±–æ—Ç–∞–µ—Ç (–ø–æ–ª—É—á–∞–µ—Ç ACCOUNT_UPDATE)
- ‚úÖ –ú–µ—Ö–∞–Ω–∏–∑–º `_restore_subscriptions()` –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω
- ‚úÖ `pending_subscriptions` –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ (binance_hybrid_stream.py:801)
- ‚ùå Mark Price Stream –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ silent disconnect
- ‚ùå –ü–æ–¥–ø–∏—Å–∫–∏ –∏–≥–Ω–æ—Ä–∏—Ä—É—é—Ç—Å—è –ø—Ä–∏ disconnected stream
- ‚ùå –ù–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ recovery –¥–ª—è pending subscriptions

---

**–û—Ç—á–µ—Ç —Å–æ—Å—Ç–∞–≤–ª–µ–Ω**: 2025-11-13
**–†–∞—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ**: –ó–ê–í–ï–†–®–ï–ù–û ‚úÖ
**–ì–æ—Ç–æ–≤ –∫ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—é**: –î–ê ‚úÖ
